\documentclass[runningheads]{llncs}

\usepackage[utf8]{inputenc}
\usepackage{ccicons}

\usepackage{adjustbox}
\usepackage{marvosym}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amscd}
\usepackage{xcolor}

\usepackage{bbold}
\usepackage{url}
\usepackage{upgreek}
\usepackage{stmaryrd}

\usepackage{lipsum}
\usepackage{tikz}
\usetikzlibrary{cd}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}

\usepackage{bussproofs}
\EnableBpAbbreviations

\input{macros}

\newtheorem{exmpl}{Example}

\newcommand{\ininv}[2]{(\tin^{-1}_{\onet +
  \beta \times \phi (\phi\beta)})_{#1}\, #2}
\renewcommand{\P}{\mathcal{A}}
\newcommand{\pred}{\mathsf{Fam}}
\newcommand{\set}{\mathsf{Set}}
\renewcommand{\S}{\mathcal S}
\newcommand{\D}{\mathcal{D}}
\renewcommand{\id}{\mathit{id}}
\newcommand{\map}{\mathsf{map}}
\newcommand{\pid}{\underline{\mathit{id}}}
\newcommand{\pcirc}{\,\underline{\circ}\,}
\newcommand{\pzero}{\underline{0}}
\newcommand{\pone}{\underline{1}}
\newcommand{\psum}{\,\underline{+}\,}
\newcommand{\pinl}{\underline{\mathit{inL}}\,}
\newcommand{\pinr}{\underline{\mathit{inR}}\,}
\newcommand{\ptimes}{\,\underline{\times}\,}
\newcommand{\ppi}{\underline{\pi_1}}
\newcommand{\pppi}{\underline{\pi_2}}
\newcommand{\pmu}{\underline{\mu}}
\newcommand{\semmap}{\mathit{map}}
\newcommand{\subst}{\mathit{subst}}


\newcommand{\emptyfun}{{[]}}
\newcommand{\fold}{\mathsf{fold}}
\newcommand{\F}{\mathcal{F}}
\newcommand{\N}{\mathcal{N}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\B}{\mathcal{B}}
\renewcommand{\P}{\mathcal{A}}
\newcommand{\env}{\mathsf{Env}}
\renewcommand{\S}{\mathcal S}
\newcommand{\A}{\mathcal{A}}
\renewcommand{\id}{\mathit{id}}
\newcommand{\inl}{\mathsf{inL}\,}
\newcommand{\inr}{\mathsf{inR}\,}


\makeatletter
\RequirePackage[bookmarks,unicode,colorlinks=true]{hyperref}%
   \def\@citecolor{blue}%
   \def\@urlcolor{blue}%
   \def\@linkcolor{blue}%
\def\UrlFont{\rmfamily}
\def\orcidID#1{\smash{\href{http://orcid.org/#1}{\protect\raisebox{-1.25pt}{\protect\includegraphics{orcid_color.eps}}}}}
\makeatother

\usepackage{verbatim}



\newcommand{\tb}[1]{~~ \mbox{#1} ~~}
\newcommand{\listt}[1]{(\mu \phi. \lambda \beta . \onet + \beta \times
  \phi \beta) #1} 
\newcommand{\filtype}{\Nat^\emptyset 
 (\Nat^\emptyset \, \alpha \, \mathit{Bool})\, (\Nat^\emptyset 
  (List \, \alpha) \, (List \, \alpha))} 
\newcommand{\filtypeGRose}{\Nat^\emptyset 
 (\Nat^\emptyset \, \alpha \, \mathit{Bool})\, (\Nat^\emptyset 
  (\mathit{GRose}\,\psi \, \alpha) \, (\mathit{GRose}\,\psi \, (\alpha
  + \onet)))} 
\newcommand{\maplist}{\mathit{map}_{\lambda A. \setsem{\emptyset; \alpha
      \vdash \mathit{List} \, \alpha} \rho[\alpha := A]}} 
\newcommand{\PLeaves}{\mathsf{PLeaves}}
\newcommand{\swap}{\mathsf{swap}}
\newcommand{\reverse}{\mathsf{reverse}}
\newcommand{\Bcons}{\mathit{Bcons}}
\newcommand{\Bnil}{\mathit{Bnil}}

\begin{document}


\titlerunning{Parametricity for Primitive Nested Types}
\authorrunning{P.~Johann, E.~Ghiorzi, and D.~Jeffries}

\title{Parametricity for Primitive Nested Types\vspace*{-0.2in}} 
\author{Patricia Johann\,\Letter \and Enrico Ghiorzi
\and Daniel Jeffries \vspace*{-0.12in}} 
\institute{Appalachian State University, Boone, NC, USA\\
  \email{\{johannp,ghiorzie,jeffriesd\}@appstate.edu}}

\maketitle

\begin{abstract}

\vspace*{-0.25in}

This paper considers parametricity and its consequent free theorems
for nested data types. Rather than representing nested types via their
Church encodings in a higher-kinded or dependently typed extension of
System F, we adopt a functional programming perspective and design a
Hindley-Milner-style calculus with primitives for constructing nested
types directly as fixpoints. Our calculus can express all nested types
appearing in the literature, including truly nested types. At the
level of terms, it supports primitive pattern matching, map functions,
and fold combinators for nested types. Our main contribution is the
construction of a parametric model for our calculus. This is both
delicate and challenging. In particular, to ensure the existence of
semantic fixpoints interpreting nested types, and thus to establish a
suitable Identity Extension Lemma for our calculus, our type system
must explicitly track functoriality of types, and cocontinuity
conditions on the functors interpreting them must be appropriately
threaded throughout the model construction. We also prove that our
model satisfies an appropriate Abstraction Theorem, as well as that it
verifies all standard consequences of parametricity in the presence of
primitive nested types.
\end{abstract}

\vspace*{-0.4in}

\section{Introduction}\label{sec:intro}

\vspace*{-0.1in}

{\em Algebraic data types} (ADTs), both built-in and user-defined,
have long been at the core of functional languages such as Haskell,
ML, Agda, Epigram, and Idris. ADTs, such as that of natural numbers,
can be unindexed. But they can also be indexed over other types. For
example, the ADT of lists (here coded in Agda)

{\small
\[\begin{array}{l}
\mathtt{data\; List \;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{nil\;:\; List\;A}\\
\hspace*{0.4in}\mathtt{cons\;:\;A \rightarrow List\;A \rightarrow List\;A}
\end{array}\]}

\noindent
is indexed over its element type $\mathtt{A}$.  The instance of
$\mathtt{List}$ at index $\mathtt{A}$ depends only on itself, and so is
independent of $\mathtt{List\,B}$ for any other index $\mathtt{B}$.
That is, $\mathtt{List}$, like all other ADTs, defines a {\em family
  of inductive types}, one for each index type.

Over time, there has been a notable trend toward data types whose
non-regular indexing can capture invariants and other sophisticated
properties that can be used for program verification and other
applications.  A simple example of such a type is given by Bird and
Meertens'~\cite{bm98} prototypical nested type
\[\begin{array}{l}
\mathtt{data\; PTree\;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{pleaf\;:\;A \rightarrow PTree\;A}\\
\hspace*{0.4in}\mathtt{pnode\;:\;PTree\;(A \times A) \rightarrow PTree\;A}
\end{array}\]
\noindent
of perfect trees, which can be thought of as constraining lists to
have lengths that are powers of 2.  The above code makes clear that
perfect trees at index type $\mathtt{A}$ are defined in terms of
perfect trees at index type $\mathtt{A \times A}$. This is typical of
nested types, one type instance of which can depend on others, so that
the entire family of types must actually be defined at once. A nested
type thus defines not a family of inductive types, but rather an {\em
  inductive family of types}.  Nested types include simple nested
types, like perfect trees, none of whose recursive occurrences occur
below another type constructor; ``deep'' nested types~\cite{jp20},
such as the nested type {\small
\[\begin{array}{l}
\mathtt{data\; PForest\;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{fempty\;:\;PForest\;A}\\
\hspace*{0.4in}\mathtt{fnode\;:\; A \rightarrow PTree\;(PForest\;A) \to
PForest\;A}
\end{array}\]}
\hspace{-0.04in}of perfect forests, whose recursive occurrences appear
below type constructors for other nested types; and truly nested
types,
%\footnote{Nested types that are defined over themselves are known
%  as {\em truly nested types}.}
such as the nested type {\small
\[\begin{array}{l}
\mathtt{data\; Bush\;(A : Set)\;:\;Set\;where}\\
\hspace*{0.4in}\mathtt{bnil\;:\; Bush\;A}\\
\hspace*{0.4in}\mathtt{bcons\;:\;A \rightarrow Bush\;(Bush \; A)
  \rightarrow Bush\;A} 
\end{array}\]}
\hspace{-0.04in}of bushes, whose recursive occurrences appear below
their own type constructors.

{\em Relational parametricity} encodes a powerful notion of
type-uniformity, or representation independence, for data types in
polymorphic languages. It formalizes the intuition that a polymorphic
program must act uniformly on all of its possible type instantiations
by requiring that every such program preserves all relations between
pairs of types at which it is instantiated. Parametricity was
originally put forth by Reynolds~\cite{rey83} for System
F~\cite{gir72}, the calculus at the core of all polymorphic functional
languages. It was later popularized as Wadler's ``theorems for
free''~\cite{wad89}, so called because it can deduce properties of
programs in such languages solely from their types, i.e., with no
knowledge whatsoever of the text of the programs involved.  Most of
Wadler's free theorems are consequences of naturality for polymorphic
list-processing functions. However, parametricity can also derive
results that go beyond just naturality, such as correctness for ADTs
of the program optimization known as {\em short cut
  fusion}~\cite{glp93,joh02}.

But what about nested types? Does parametricity still hold if such
types are added to polymorphic calculi? More practically, can we
justifiably reason type-independently about (functions over) nested
types in functional languages?

Type-independent reasoning about ADTs in functional languages is
usually justified by first representing ADTs by their Church
encodings, and then reasoning type-independently about these
encodings. This is typically justified by constructing a parametric
model --- i.e, a model in which polymorphic functions preserve
relations {\em \'a la} Reynolds --- for a suitable fragment of System
F, demonstrating that an initial algebra exists for the positive type
constructor corresponding to the functor underlying an ADT of
interest, and showing that each such initial algebra is suitably
isomorphic to its corresponding Church encoding. In fact, this
isomorphism of initial algebras and their Church encodings is one of
the ``litmus tests'' for the goodness of a parametric model.

This approach works well for ADTs, which are always fixpoints of {\em
  first-order} functors, and whose Church encodings, which involve
quantification over only type variables, are always expressible in
System F. For example, $\mathtt{List\,A}$ is the fixpoint of the
first-order functor $F\,X = 1 + A \times X$ and has Church encoding
$\forall \alpha. \, \alpha \to (\mathtt{A} \to \alpha \to \alpha) \to
\alpha$. But despite Cardelli's~\cite{car97} claim that ``virtually
any basic type of interest can be encoded within F$_2$'' --- i.e.,
within System F --- non-ADT nested types cannot.  Not even our
prototypical nested type of perfect trees has a Church encoding
expressible in System F!  Indeed, $\mathtt{PTree\,A}$ cannot be
represented as the fixpoint of any {\em first-order} functor. However,
it can be seen as the instance at index $\mathtt{A}$ of the fixpoint
of the {\em higher-order} functor $H\,F\,A\,=\, (A \to F\,A) \to (F
\,(A \times A) \to F\,A) \to F\,A$. It thus has Church encoding
$\forall f.\, (\forall \alpha.\,\alpha \to f\alpha) \to (\forall
\alpha. \,f (\alpha \times \alpha) \to f\alpha) \to \forall \alpha.\,
f\alpha$, which requires quantification at the higher kind $* \to *$
for $f$. A similar situation obtains for any (non-ADT) nested
type. Unfortunately, higher-kinded quantification is not available in
System F, so if we want to reason type-independently about nested
types in a language based on it we have only two options: {\em
  i})\,move to an extension of System F, such as the higher-kinded
calculus F$_\omega$ or a dependent type theory, and reason via their
Church encodings in a known parametric model for that extension, or
{\em ii})\, add nested types to System F as primitives --- i.e., as
primitive type-level fixpoints --- and construct a parametric model
for the result.

Since the type systems of F$_\omega$ and dependent type theories are
designed to extend System F with far more than non-ADT data types, it
seems like serious overkill to pass to their parametric models to
reason about nested types in System F. Indeed, such calculi support
fundamentally new features that add complexity to their models that is
entirely unnecessary for reasoning about nested types. This paper
therefore pursues the second option above.  We first design a
Hindley-Milner-style calculus supporting primitive nested types,
together with primitive types of natural transformations representing
morphisms between them. Our calculus can express all nested types
appearing in the literature, including truly nested types.  At the
term-level, it supports primitive pattern matching, map functions, and
fold combinators for nested types.\footnote{We leave incorporating
  general term-level recursion to future work because, as
  Pitts~\cite{pit00} reminds us, ``it is hard to construct models of
  both impredicative polymorphism and fixpoint recursion''. In fact,
  as the development in this paper shows, constructing a parametric
  model even for our predicative calculus with primitive nested types
  --- and even without term-level fixpoints --- is already rather
  involved.
%  in part because, as
%  Pitts~\cite{pit00} reminds us, ``it is hard to construct models of
%  both impredicative polymorphism and fixpoint recursion'', and in
%  part because constructing a parametric model even for a predicative
%  calculus with primitive nested types is already rather involved.
  On
  the other hand, our calculus is strongly normalizing, so it perhaps
  edges us toward the kind of provably total practical programming
  language proposed in~\cite{wad89}.}  Our main contribution is the
construction of a parametric model for our calculus. This is both
delicate and challenging. To ensure the existence of semantic
fixpoints interpreting nested types, and thus to establish a suitable
Identity Extension Lemma, our type system must explicitly track
functoriality of types, and cocontinuity conditions on the functors
interpreting them must be appropriately threaded throughout the model
construction. Our model validates all standard consequences of
parametricity in the presence of primitive nested types, including the
isomorphism of primitive ADTs and their Church encodings, and
correctness of short cut fusion for nested types. The relationship
between naturality and parametricity has long been of interest, and
our inclusion of a primitive type of natural transformations allows us
to clearly delineate those consequences of parametricity that follow
from naturality, from those, such as short cut fusion for nested
types, that require the full power of parametricity.

\vspace*{0.1in}

\noindent
{\bf Structure of this Paper}\/ We introduce our calculus in
Section~\ref{sec:calculus}.  Its type system is based on the
level-2-truncation of the higher-kinded grammar from~\cite{jp19},
augmented with a primitive type of natural
transformations. (Since~\cite{jp19} contains no term calculus, the
issue of parametricity could not even be raised there.)  In
Section~\ref{sec:type-interp} we give set and relational
interpretations of our types. Set interpretations are possible
precisely because our calculus is predicative --- as ensured by our
primitive natural transformation types --- and~\cite{jp19} guarantees
that local finite presentability of $\set$ makes it suitable for
interpreting nested types.  As is standard in categorical models,
types are interpreted as functors from environments interpreting their
type variable contexts to sets or relations, as appropriate. To ensure
that these functors satisfy the cocontinuity properties needed for the
semantic fixpoints interpreting nested types to exist, set environments
must map $k$-ary type constructor variables to appropriately
cocontinuous $k$-ary functors on sets, relation environments must map
$k$-ary type constructor variables to appropriately cocontinuous
$k$-ary relation transformers, and these cocontinuity conditions must
be threaded through our type interpretations in such a way that an
Identity Extension Lemma (Theorem~\ref{thm:iel}) can be
proved. Properly propagating the cocontinuity conditions requires
considerable care, and Section~\ref{sec:iel}, where it is done, is
(apart from tracking functoriality in the calculus so that it is
actually possible) where the bulk of the work in constructing our
model lies.

In Section~\ref{sec:term-interp}, we give set and relational
interpretations for the terms of our calculus. As usual in categorical
models, terms are interpreted as natural transformations from
interpretations of their term contexts to interpretations of their
types, and these must cohere in what is essentially a fibred way.  In
Section~\ref{sec:Nat-type-terms} we prove a scheme deriving free
theorems that are consequences of naturality of polymorphic functions
over nested types. This scheme is very general, and is parameterized
over both the data type and the type of the polymorphic function at
hand. It has, for example, analogues for nested types of Wadler's
map-rearrangement free theorems as instances. In
Section~\ref{sec:thms} we prove that our model satisfies an
Abstraction Theorem (Theorem~\ref{thm:abstraction}), which we use to
derive other parametricity results that go beyond naturality. We
conclude in Section~\ref{sec:conclusion}.

\vspace*{0.05in}

\noindent
{\bf Related Work}\/ There is a long line of work on categorical
models of parametricity for System F; see,
e.g.,~\cite{bfss90,bm05,dr04,gjfor15,has94,jac99,mr92,rr94}.  To our
knowledge, all such models treat ADTs via their Church encodings,
verifying in the just-constructed parametric model that each Church
encoding is isomorphic to the data type it encodes.  The present paper
draws on this rich tradition of categorical models of parametricity
for System F, but modifies them to treat nested types (and therefore
ADTs) as primitive data types.

The only other extensions we know of System F with primitive data
types are those in~\cite{mat11,mg01,pit98,pit00,wad89}.
Wadler~\cite{wad89} treats full System F, and sketches parametricity
for its extension with lists. Martin and Gibbons~\cite{mg01} outline a
semantics for a grammar of primitive nested types similar to that
in~\cite{jp19}, but treat only polynomial nested types, i.e., nested
types that are fixpoints of polynomial higher-order
functors. Unfortunately, the model suggested in~\cite{mg01} is not
entirely correct (see~\cite{jp19}), and parametricity is nowhere
mentioned.  Matthes~\cite{mat11} treats System F with non-polynomial
ADTs and nested types, but his focus is on expressivity of generalized
Mendler iteration for them. He gives no semantics.

In~\cite{pit00}, Pitts adds list ADTs to full System F with a
term-level fixpoint primitive. Other ADTs are included
in~\cite{pit98}, but nested types are not expressible in either
syntax. Pitts constructs parametric models for his calculi based on
operational, rather than categorical, semantics. A benefit of using
operational semantics to build parametric models is that it avoids
needing to work in a suitable metatheory to accommodate System F's
impredicativity. It is well-known that there are no set-based
parametric models of System F~\cite{rey84}, so parametric models for
it and its extensions are often constructed in a syntactic metatheory
such as the impredicative Calculus of Inductive Constructions (iCIC).
By adding primitive nested types to a Hindley-Milner-style calculus
and working in a categorical setting we side-step such metatheoretic
distractions. It is important to note that different consequences of
parametricity are available in syntactic and semantic
metatheories. Consequences of parametricity are possible for both
closed and open System F terms in a syntactic metatheory --- although
not all that can be formulated can be always proved; see, e.g., the
end of Section~7 of~\cite{bm98}. By contrast, in a categorical
metatheory consequences of parametricity are expressible only for {\em
  closed} terms. For this reason, validating the standard consequences
of parametricity for closed terms is --- going all the way back to
Reynolds~\cite{rey83} --- all that is required for a model of
parametricity to be considered good.

Atkey~\cite{atk12} treats parametricity for arbitrary higher kinds,
constructing a parametric model for System F$_\omega$ within iCIC,
rather than in a semantic category. His construction is in some ways
similar to ours, but he represents (now higher-kinded) data types
using Church encodings rather than as primitives. Moreover, the
$\mathit{fmap}$ functions associated to Atkey's functors must be {\em
  given}, presumably by the programmer, together with their underlying
type constructors. This absolves him of imposing cocontinuity
conditions on his model to ensure that fixpoints of his functors
exist, but, unfortunately, he does not indicate which type
constructors support $\mathit{fmap}$ functions. We suspect explicitly
spelling out which types can be interpreted as strictly positive
functors would result in a full higher-kinded extension of a calculus
akin to that presented here.

\vspace*{-0.1in}

\section{The Calculus}\label{sec:calculus}

\vspace*{-0.1in}

\subsection{Types}

\vspace*{-0.1in}

For each $k \ge 0$, we assume countable sets $\tvars^k$ of \emph{type
  constructor variables of arity $k$} {\color{red} (i.e., of kind
  $\mathtt{* \to ... \to * \to *}$, where there are $k$ arrows and
  $k+1$ copies of $*$ in this sequence)} and $\fvars^k$ of
\emph{functorial variables of arity $k$}, all mutually disjoint.  The
sets of all type constructor variables and functorial variables are
$\tvars = \bigcup_{k \ge 0} \tvars^k$ and $\fvars = \bigcup_{k \ge 0}
\fvars^k$, respectively, and a \emph{type variable} is any element of
$\tvars \cup \fvars$.  We use lower case Greek letters for type
variables, writing $\phi^k$ to indicate that $\phi \in \tvars^k \cup
\fvars^k$, and omitting the arity indicator $k$ when convenient.
Letters from the beginning of the alphabet denote type variables of
arity $0$, i.e., elements of $\tvars^0 \cup \fvars^0$. We write
$\overline{\phi}$ for either a set $\{\phi_1,...,\phi_n\}$ of type
constructor variables or a set of functorial variables when the
cardinality $n$ of the set is unimportant or clear from context. If
$V$ is a set of type variables we write $V, \overline{\phi}$ for $V\,
\cup \overline{\phi}$ when $V\, \cap \overline{\phi} = \emptyset$.  We
omit the vector notation for a singleton set, thus writing $\phi$,
instead of $\overline{\phi}$, for $\{\phi\}$.

If $\Gamma$ is a finite subset of\, $\tvars$, $\Phi$ is a finite
subset of\, $\fvars$, $\overline{\alpha}$ is a finite subset of\,
$\fvars^0$ disjoint from $\Phi$, and $\phi^k \in \fvars^k \setminus
\Phi$, then the set $\F$ of well-formed types is given in
Definition~\ref{def:wftypes}.  The notation there entails that type
application $\phi F_1...F_k$ is allowed only when $\phi$ is a type
variable of arity $k$, or $\phi$ is a subexpression of the form $\mu
\psi^{k}.\lambda \alpha_1...\alpha_k.F'$. Moreover, if $\phi$ has
arity $k$ then $\phi$ must be applied to exactly $k$ arguments.
Accordingly, an overbar indicates a sequence of subexpressions whose
length matches the arity of the type applied to it. Requiring that
types are always in such \emph{$\eta$-long normal form} avoids having
to consider $\beta$-conversion of types. In a subexpression
$\Nat^{\ol{\alpha}}F\,G$, the $\Nat$ operator binds all occurrences of
the variables in $\ol{\alpha}$ in $F$ and $G$; intuitively, $\Nat^{\ol
  \alpha}F\,G$ represents the type of a natural transformation in $\ol
\alpha$ from the functor $F$ to the functor $G$.  In a subexpression
$\mu \phi^k.\lambda \ol{\alpha}.F$, the $\mu$ operator binds all
occurrences of the variable $\phi$, and the $\lambda$ operator binds
all occurrences of the variables in $\ol{\alpha}$, in the body $F$.

A {\em type constructor}, or {\em non-functorial}, {\em context} is a
finite set $\Gamma$ of type constructor variables, and a {\em
  functorial context} is a finite set $\Phi$ of functorial
variables. In Definition~\ref{def:wftypes}, a judgment of the form
$\Gamma;\Phi \vdash F$ indicates that the type $F$ is intended to be
functorial in the variables in $\Phi$ but not necessarily in those in
$\Gamma$.
\begin{definition}\label{def:wftypes}
  The formation rules for the set $\F$ of\, {\em (well-formed) types}
  are

\vspace*{-0.1in}

\[\begin{array}{cccc}
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \zerot$}
\DisplayProof\hspace*{0.05in}
&
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \onet$}
\DisplayProof\hspace*{0.05in}
&
\AXC{$\Gamma;\Phi \vdash F$}
\AXC{$\Gamma;\Phi \vdash G$}
\BIC{$\Gamma; \Phi \vdash F + G$}
\DisplayProof\hspace*{0.05in}
&
\AXC{$\Gamma;\Phi \vdash F$}
\AXC{$\Gamma;\Phi \vdash G$}
\BIC{$\Gamma; \Phi \vdash F \times G$}
\DisplayProof
\end{array}\]

\vspace*{-0.05in}

\[\begin{array}{cc}
\AXC{$\Gamma;\ol{\alpha^0} \vdash F$}
\AXC{$\Gamma;\ol{\alpha^0}  \vdash G$}
\BIC{$\Gamma;\emptyset \vdash \Nat^{\ol{\alpha^0}}F \,G$}
\DisplayProof\hspace*{0.05in}
&
\AXC{$\phi^k \in \Gamma \cup \Phi$}
\AXC{$\quad\quad\ol{\Gamma;\Phi \vdash F}$}
\BIC{$\Gamma;\Phi \vdash \phi^k \ol{F}$}
\DisplayProof
\end{array}\]

\vspace*{-0.05in}

\[\begin{array}{c}
\AXC{$\Gamma;{\color{red}\ol{\gamma^0},}\ol{\alpha^0},\phi^k \vdash F$}
\AXC{$\quad\quad\ol{\Gamma;\Phi{\color{red},\ol{\gamma^0}} \vdash G}$}
\BIC{$\Gamma;\Phi {\color{red},\ol{\gamma^0}} \vdash (\mu \phi^k.\lambda
  \ol{\alpha^0}. \,F)\,\ol{G}$} 
\DisplayProof
\end{array}\]

\end{definition}
We write $\vdash F$ for $\emptyset;\emptyset \vdash F$.
Definition~\ref{def:wftypes} ensures that the expected weakening rules
for well-formed types hold (but weakening does not change the contexts
in which types can be formed). If $\Gamma;\emptyset \vdash F$ and
$\Gamma;\emptyset \vdash G$, then our rules allow formation of
$\Gamma;\emptyset \vdash \Nat^\emptyset F \,G$, which represents the
arrow type $\Gamma \vdash F \to G$ in our calculus.  The type $\Gamma;
\emptyset \vdash \Nat^{\ol\alpha} \,\onet \,F$ represents the
$\forall$-type $\Gamma; \emptyset \vdash \forall \ol\alpha . F$.  Some
System F types, such as $\forall \alpha.\, (\alpha \to \alpha) \to
\alpha$, are not representable in our calculus.

{\color{red} 
Note that since the body F of a type $(\mu \phi. \lambda
\ol\alpha. F)\ol{G}$ can only be functorial in $\phi$ and the
variables in $\ol{\alpha}$, the representation of
$\mathit{List}\,\alpha$ as the ADT $\mu \beta. \,\onet + \alpha \times
\beta$ cannot be functorial in $\alpha$. By contrast, if
$\mathit{List}\,\alpha$ is represented as the nested type $(\mu
\phi. \lambda \beta.\,\onet + \beta \times \phi \beta)\,\alpha$ then
we can choose $\alpha$ to be a functorial variable or not when forming
the type. This observation holds for other ADTs as well; for example,
if $\mathit{Tree}\,\alpha\,\gamma = \mu \beta. \alpha + \beta \times
\gamma \times \beta$, then $\alpha, \gamma; \emptyset \vdash
\mathit{Tree}\,\alpha\,\gamma$ is well-formed, but $\emptyset; \alpha,
\gamma \vdash \mathit{Tree}\,\alpha\,\gamma$ is not. And it also
applies to some non-ADT types, such as $\mathit{GRose}\,\phi\,\alpha =
\mu \beta. \onet + \alpha \times \phi\beta$, in which $\phi$ and
$\alpha$ must both be non-functorial variables.  It is in fact
possible to allow ``extra'' $0$-ary functorial variables in the body
of $\mu$-types (functorial variables of higher arity are the real
problem), which would allow the first-order representations of ADTs to
be functorial. However, doing this requires some changes to the
formation rule for $\mu$-types, as well as the delicate threading of
some additional conditions throughout our model construction.  But
since we can always use an ADT's (semantically equivalent)
second-order representation when functoriality is needed, disallowing
such ``extra'' variables does not negatively impact the expressivity
of our calculus. We therefore pursue the simpler syntax here.}
\begin{comment}
Definition~\ref{def:wftypes} supports the representation of all of the
(closed) nested types from the introduction. Indeed, $\mathit{List}\,
\alpha \; = \; \mu \beta. \,\onet + \alpha \times \beta\; = \; (\mu
\phi. \lambda \beta.\,\onet + \beta \times \phi \beta)\,\alpha$,\,
$\mathit{PTree}\,\alpha \; = \; (\mu \phi. \lambda \beta.\,\beta +
\phi\,(\beta \times \beta))\,\alpha$, \, $\mathit{PForest}\,\alpha \;
= \; (\mu \phi. \lambda \beta. \,\onet + \beta \times
\mathit{PTree}\,(\phi \beta))\,\alpha$, and $\mathit{Bush}\,\alpha \;
= \; (\mu \phi.\lambda \beta. \,\onet + \beta \times
\phi\,(\phi\beta))\,\alpha$.  Each of these types can be considered
either functorial in $\alpha$ or not, according to whether $\alpha$ is
in the functorial or non-functorial context in which it is formed. In
particular, if $\emptyset;\alpha \vdash \mathit{List} \,\alpha$, then
$\vdash \Nat^\alpha \onet\, (\mathit{List}\,\alpha)$ is well-formed;
if $\alpha;\emptyset \vdash \mathit{List} \,\alpha$, then it is not.
Similarly, if $\mathit{Tree}\,\alpha\,\gamma = \mu \,\beta.\, \alpha +
\beta \times \gamma \times \beta$, then $\gamma;\emptyset \vdash
\Nat^\alpha (\mathit{List}\, \alpha) \, (\mathit{Tree} \, \alpha\,
\gamma)$ is well-formed, but $\emptyset;\gamma \vdash \Nat^\alpha
(\mathit{List}\, \alpha) \, (\mathit{Tree} \, \alpha\, \gamma)$ is
not. Although types can be functorial in variables of arity greater
than $0$, the only such variable allowed in $F$ in $(\mu \phi.\lambda
\ol\alpha.F)\,\ol G$ is $\phi$.
%the body $F$ of a type $(\mu \phi.\lambda \ol\alpha.F)\,\ol
%G$ cannot.
For example, the type $\mathit{GRose}\, \phi \, \alpha =
\mu\beta . \onet + \alpha \times \phi \beta$ can be functorial or not in
$\alpha$, but not in $\phi$. In addition,
$\mathit{GRose}\,\phi\,\alpha$ cannot be the (co)domain of a $\Nat$
type representing a natural transformation functorial in $\phi$, and
the type $\mu \phi. \lambda \alpha. \mathit{GRose}\,\phi\,\alpha$ is
not well-formed in our system. These restrictions ensure that the set
and relational interpretations of types in
Section~\ref{sec:type-interp} are $\omega$-cocontinuous functors. For
example, the type $\emptyset; \alpha \vdash \Nat^\emptyset \, N \,
\alpha$, where $N = \mu \alpha. \,\onet + \alpha$, is functorial in
$\alpha$, but will not have an interpretation as an
$\omega$-cocontinuous functor~\cite{jp19}.
\end{comment}


Definition~\ref{def:wftypes} allows well-formed types to be functorial
in no variables. Functorial variables can also be demoted to
non-functorial status: if $F[\phi :== \psi]$ is the textual
replacement of $\phi$ in $F$, then $\Gamma, \psi^k; \Phi \vdash
F[\phi^k :== \psi^k]$ is derivable whenever $\Gamma; \Phi, \phi^k
\vdash F$ is.  In addition to textual replacement, we also have
substitution for types. If $\Gamma;\Phi\vdash F$ is a type, if $\Gamma$ and
$\Phi$ contain only type variables of arity $0$, and if $k=0$ for every
occurrence of $\phi^k$ bound by $\mu$ in $F$, then we say that $F$ is
{\em first-order}; otherwise we say that $F$ is {\em second-order}.
Substitution for first-order types is the usual capture-avoiding
textual substitution. We write $F[\alpha := \sigma]$ for the result of
substituting $\sigma$ for $\alpha$ in $F$, and $F[\alpha_1 :=
  F_1,...,\alpha_k := F_k]$, or $F[\ol{\alpha := F}]$ when convenient,
for $F[\alpha_1 := F_1][\alpha_2 := F_2,...,\alpha_k := F_k]$. The
operation $(\cdot)[\phi :=_{\ol \alpha} F]$ of {\em second-order type
  substitution along $\ol\alpha$} is defined by induction on types
exactly as expected.  {\color{red} The only interesting clause is that
  for type application, which defines $(\psi \ol G)[\phi
    :=_{\ol\alpha} F]$ to be $ F[\ol{\alpha := G[\phi :=_{\ol\alpha}
        F]}$ if $\psi = \phi$ and $\ol{G[\phi :=_{\ol\alpha} F]}$
    otherwise.}  Of course, $(\cdot)[\phi^0 :=_\emptyset F]$ coincides
  with first-order substitution. We omit $\ol\alpha$ when convenient,
  but note that it is not correct to substitute along non-functorial
  variables. It is not hard to see that if \,$\Gamma; \Phi,\phi^k
  \vdash H$ and\, $\Gamma;\Phi, \ol{\alpha} \vdash F$ with
  $|\ol\alpha| = k$, then $\Gamma;\Phi \vdash H[\phi :=_{\ol{\alpha}}
    F]$.  Similarly, if \,$\Gamma, \phi^k; \Phi \vdash H$, and if\,
  $\Gamma; \ol\psi,\ol{\alpha} \vdash F$ with $|\ol\alpha| = k$ and
  $\Phi \cap \ol\psi = \emptyset$, then $\Gamma,\ol\psi';\Phi \vdash
  H[\phi :=_{\ol{\alpha}} F[\ol{\psi :== \psi'}]]$.

\begin{figure*}

  \begin{adjustbox}{varwidth=5.4in, max width=5in, fbox, center}
       \[\begin{array}{ccc}
       \AXC{$\Gamma;\Phi \vdash F$}
       \UIC{$\Gamma;\Phi \,|\, \Delta,x :F \vdash x : F$}
       \hspace*{0.2in}\DisplayProof\hspace*{0.05in}
       &
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \zerot$}
       \AXC{$\Gamma;\Phi \vdash F$}
       \BIC{$\Gamma;\Phi \,|\, \Delta \vdash \bot_F t  : F$}
       \DisplayProof\hspace*{0.05in}
       &
       \AXC{$\phantom{\Gamma;\Phi}$}
       \UIC{$\Gamma;\Phi \,|\, \Delta \vdash \top : \onet$}
       \DisplayProof\\\\
       \end{array}\]
       
       \vspace*{-0.15in}
       
       \[\begin{array}{cc}
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F$}
       \UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: F + G$}
       \hspace*{0.8in}\DisplayProof\hspace*{0.05in}
       &
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : G$}
       \UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: F + G$}
       \DisplayProof\\\\
       \end{array}\]
       
       \vspace*{-0.15in}
       
       \[\begin{array}{c}
       \AXC{$\Gamma; \Phi \vdash F,G$}
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : F+G$}
       \AXC{$\Gamma;\Phi \,|\, \Delta, x : F \vdash l : K \hspace{0.2in} \Gamma;\Phi \,|\, \Delta, y : G \vdash r : K$}
       \TIC{$\Gamma;\Phi~|~\Delta \vdash \cse{t}{x \mapsto l}{y \mapsto r} : K$}
       \hspace*{-0.2in}\DisplayProof
       \end{array}\]

       \[\begin{array}{lll}
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F$}
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : G$}
       \BIC{$\Gamma;\Phi \,|\, \Delta \vdash (s,t) : F \times G$}
       \DisplayProof\hspace*{0.05in}
       &
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : F \times G$}
       \UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : F$}
       \DisplayProof\hspace*{0.05in}
       &
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : F \times G$}
       \UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : G$}
       \DisplayProof
       \end{array}\]

       \[\begin{array}{c}
       \AXC{$\Gamma; \ol{\alpha} \vdash F$}
       \AXC{$\Gamma; \ol{\alpha} \vdash G$}
       \AXC{$\Gamma; \ol{\alpha} \,|\, \Delta, x : F \vdash t: G$} 
       \TIC{$\Gamma; \emptyset
         \,|\, \Delta \vdash L_{\ol{\alpha}} x.t : \Nat^{\ol{\alpha}} \,F \,G$}
       \DisplayProof\vspace*{-0.05in}
       \\\\
       \AXC{$\ol{\Gamma;\Phi \vdash K}$}
       \AXC{$\Gamma; \emptyset
         \,|\, \Delta \vdash t : \Nat^{\ol{\alpha}} \,F \,G$}
       \AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F[\overline{\alpha := K}]$}
       \TIC{$\Gamma;\Phi\,|\, \Delta \vdash t_{\ol K} s:
         G[\overline{\alpha := K}]$}
       \DisplayProof\vspace*{-0.05in}
       \\\\
       \AXC{$\Gamma; \ol{\phi}, \ol{\gamma} \vdash H$}
       \AXC{$\ol{\Gamma; \ol{\beta},\ol{\gamma} \vdash F}$}
       \AXC{$\ol{\Gamma; \ol{\beta},\ol{\gamma} \vdash
           G}$}
       \TIC{$\Gamma; \emptyset
         ~|~\emptyset
         \vdash \map^{\ol{F},\ol{G}}_H :
         \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
         (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\;H[\ol{\phi
             :=_{\ol{\beta}} G}])$} 
       \DisplayProof\vspace*{-0.05in}
       \\\\
       \AXC{$\Gamma; \phi, \ol{\alpha} {\color{red},\ol{\gamma}} \vdash H$}
       \UIC{$\Gamma; \emptyset  \,|\, \emptyset \vdash \tin_H :
         \Nat^{\ol{\beta}{\color{red},\ol{\gamma}}} H[\phi :=_{\ol{\beta}} (\mu
           \phi.\lambda \ol{\alpha}.H)\ol{\beta}][\ol{\alpha := \beta}]\,(\mu
         \phi.\lambda \ol{\alpha}.H)\ol{\beta}$}
       \hspace*{0.2in}\DisplayProof\vspace*{-0.05in}
       \\\\
       \AXC{$\Gamma; \phi,\ol{\alpha} {\color{red}, \ol{\gamma}} \vdash H$}
       \AXC{$\Gamma; \ol{\beta} {\color{red}, \ol{\gamma}} \vdash F$}
       \BIC{$\Gamma; \emptyset  \,|\, \emptyset \vdash \fold^F_H :
         \Nat^\emptyset\; (\Nat^{\ol{\beta} {\color{red}, \ol{\gamma}}}\,H[\phi
           :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
         (\Nat^{\ol{\beta} {\color{red},
           \ol{\gamma}}}\,(\mu \phi.\lambda \ol{\alpha}.H)\ol{\beta}\,F)$}
       \hspace*{0.2in}\DisplayProof\vspace*{-0.1in}
       \end{array}\]

       \vspace*{0.05in}

       \caption{Well-formed terms}\label{fig:terms} \vspace*{-0.00in}
\end{adjustbox}
       \vspace*{-0.25in}
\end{figure*}


\vspace*{-0.10in}

\subsection{Terms}\label{sec:terms}
Assume an infinite set $\cal V$ of term variables disjoint from
$\tvars$ and $\fvars$. If $\Gamma$ is a type constructor context and
$\Phi$ is a functorial context, then a {\em term context for $\Gamma$
  and $\Phi$} is a finite set of bindings of the form $x : F$, where
$x \in {\cal V}$ and $\Gamma; \Phi \vdash F$. We adopt the above
conventions for disjoint unions and vectors in term contexts.  If
$\Delta$ is a term context for $\Gamma$ and $\Phi$ then the formation
rules for the set of\, {\em well-formed terms over $\Delta$} are given
in Figure~\ref{fig:terms}.  An expression $L_{\ol{\alpha}}x.t$ binds
all occurrences of the type variables in $\ol{\alpha}$ in the types of
$x$ and $t$, as well as all occurrences of $x$ in $t$. In the rule for
$t_{\ol K} s$ there is one functorial expression in $\ol K$ for every
variable in $\ol \alpha$. In the rule for $\map^{\ol{F},\ol{G}}_H$
there is one functorial expression in $\ol F$ and one functorial
expression in $\ol G$ for each variable in $\ol\phi$. Moreover, for
each $\phi^k$ in $\ol\phi$ the number of variables in $\ol\beta$ in
the judgments for functorial expresssions in $\ol F$ and $\ol G$ is
$k$. In the rules for $\tin_H$ and $\fold^F_H$, the variables in
$\ol{\beta}$ are fresh with respect to $H$, and there is one $\beta$
for every $\alpha$.  Substitution for terms is the obvious extension
of the usual capture-avoiding textual substitution, and weakening is
respected.

The ``extra'' functorial variables in $\ol{\gamma}$ in the rules for
$\map^{\ol{F},\ol{G}}_H$, $\tin_H$, and $\mathsf{fold}^F_H$ (i.e.,
those variables not affected by the substitution of $\phi$) allow us
to map or fold polymorphic functions over nested types.  Suppose, for
example, that we want to map the polymorphic function
$\mathit{flatten} : \Nat^\beta
(\mathit{PTree}\,\beta)\,(\mathit{List}\,\beta)$ over lists.  The
$\map$ term for this is typeable as follows:

\vspace*{0.1in}

\begin{adjustbox}{varwidth=6.4in, max width=\linewidth, center}
\[\begin{array}{l}
\AXC{$\Gamma;\alpha,\gamma \vdash \mathit{List} \, \alpha$}
\AXC{$\Gamma;\gamma \vdash \mathit{PTree}\,\gamma \hspace*{0.3in}
  \Gamma;\gamma \vdash \mathit{List}\,\gamma$}
\BIC{$\Gamma;\emptyset~|~\emptyset \vdash
  \map^{\mathit{PTree}\,\gamma,\mathit{List}\,\gamma}_{\mathit{List}\,\alpha}  : \Nat^\emptyset
  (\Nat^\gamma(\mathit{PTree}\, 
  \gamma)\,(\mathit{List}\, \gamma))\,
 (\Nat^\gamma\,(\mathit{List}\,
  (\mathit{PTree}\, \gamma))\,(\mathit{List}\, (\mathit{List}\,
  \gamma)))$}
\DisplayProof
  \end{array}\]
\end{adjustbox}

\vspace*{0.1in}

\noindent
However, this derivation would not possible without the variables in
$\ol\gamma$.  Similar remarks explain the appearance of $\ol \gamma$
in the typing rules for $\tin$ and $\mathsf{fold}$.

Our calculus is expressive enough to define, e.g., a function
$\mathit{reversePTree}: \Nat^\alpha \, (\mathit{PTree}\,\alpha)
(\mathit{PTree}\,\alpha)$ that reverses the order of the leaves in a
perfect tree. It maps the perfect tree $((1, 2), (3, 4))$ to $((4, 3),
(2, 1))$.  Unfortunately, we cannot define recursive functions ---
such as a zip function for perfect trees --- that take as inputs a
nested type and an argument of another type, both of which are
parameterized over the same variable. The fundamental issue is that
recursion is expressible only via $\mathsf{fold}$, which produces
natural transformations in some variables $\ol{\alpha}$ from
$\mu$-types to other functors $F$. The restrictions on $\Nat$-types
entail that $F$ cannot itself be a $\Nat$-type containing
$\ol{\alpha}$, so, e.g., $\Nat^\alpha \, (\mathit{PTree}\,\alpha)
(\Nat^\emptyset \, (\mathit{PTree}\,\alpha) (\mathit{PTree}\,(\alpha
\times \alpha)))$ is not well-typed.  Uncurrying gives $\Nat^\alpha \,
(\mathit{PTree}\,\alpha \times \mathit{PTree}\,\alpha)
(\mathit{PTree}\,(\alpha \times \alpha))$, which is well-typed, but
$\mathsf{fold}$ cannot produce a term of this type because
$\mathit{PTree}\,\alpha \times \mathit{PTree}\,\alpha$ is not a
$\mu$-type.  Our calculus can, however, express types of recursive
functions that take multiple nested types as arguments, provided they
are parameterized over disjoint sets of type variables and the return
type of the function is parameterized over only the variables
occurring in the type of its final argument.  Even for ADTs there is a
difference between which folds over them we can type when they are
viewed as ADTs (i.e., as fixpoints of first-order functors) versus as
proper nested types (i.e., as fixpoints of higher-order
functors). This is because, in the return type of $\mathsf{fold}$, the
arguments of the $\mu$-type must be variables bound by $\Nat$.  For
ADTs, the $\mu$-type takes no arguments, making it possible to write
recursive functions, such as a concatenation function for lists of
type $\alpha ; \emptyset \vdash \Nat^\emptyset \ (\mu \beta. \onet +
\alpha \times \beta)\, (\Nat^\emptyset (\mu \beta. \onet + \alpha
\times \beta) \, (\mu \beta. \onet + \alpha \times \beta))$.  This is
not possible for nested types --- even when they are semantically
equivalent to ADTs.

Interestingly, even some recursive functions of a single proper nested
type --- e.g., a reverse function for bushes that is a true involution
--- cannot be expressed as folds because the algebra arguments needed
to define them are again recursive functions with types of the same
problematic form as the type of, e.g., a zip function for perfect
trees.  Expressivity of folds for nested types has long been a vexing
issue, and this is naturally inherited by our calculus.  Adding more
expressive recursion combinators could help, but since this is
orthogonal to the issue of parametricity in the presence of primitive
nested types we do not consider it further here.

\vspace*{-0.15in}

\section{Interpreting Types}\label{sec:type-interp}

\vspace*{-0.1in}

We denote the category of sets and functions by $\set$. The category
$\rel$ has as objects triples $(A,B,R)$, where $R$ is a relation
between sets $A$ and $B$.  It has as morphisms from $(A,B,R)$ to
$(A',B',R')$ pairs $(f : A \to A',g : B \to B')$ of morphisms in
$\set$ such that $(f a,g\,b) \in R'$ if $(a,b) \in R$. We may write $R
: \rel(A,B)$ for $(A,B,R)$.  If $R : \rel(A,B)$ we write $\pi_1 R$ and
$\pi_2 R$ for the {\em domain} $A$ of $R$ and the {\em codomain} $B$
of $R$, respectively, and assume $\pi_1$ and $\pi_2$ are
surjective. We write $\Eq_A = (A,A,\{(x,x)~|~ x \in A\})$ for the {\em
  equality relation} on the set $A$.

The key idea underlying Reynolds' parametricity is to give each type
$F(\alpha)$ with one free variable $\alpha$ a {\em set interpretation}
$F_0$ taking sets to sets and a \emph{relational interpretation} $F_1$
taking relations $R : \rel(A,B)$ to relations $F_1 (R) : \rel(F_0 (A),
F_0 (B))$, and to interpret each term $t(\alpha,x) : F(\alpha)$ with
one free term variable $x : G(\alpha)$ as a map $t_0$ associating to
each set $A$ a function $t_0(A) : G_0(A) \to F_0(A)$. These
interpretations are given inductively on the structures of $F$ and $t$
in such a way that they imply two fundamental theorems. The first is
an \emph{Identity Extension Lemma}, which states that $F_1(\Eq_A) =
\Eq_{F_0(A)}$, and is the essential property that makes a model
relationally parametric rather than just induced by a logical
relation. The second is an \emph{Abstraction Theorem}, which states
that, for any $R :\rel(A, B)$, $(t_0(A),t_0(B))$ is a morphism in
$\rel$ from $(G_0(A),G_0(B),G_1(R))$ to $(F_0(A),F_0(B),F_1(R))$. The
Identity Extension Lemma is similar to the Abstraction Theorem except
that it holds for {\em all} elements of a type's interpretation, not
just those that interpret terms.  Similar theorems are required for
types and terms with any number of free variables.

The key to proving our Identity Extension Lemma is a familiar
``cutting down'' of the interpretations of universally quantified
types to include only the ``parametric'' elements; the relevant types
here are $\Nat$ types.  This requires that the set interpretations of
types (Section~\ref{sec:set-interp}) are defined simultaneously with
their relational interpretations (Section~\ref{sec:rel-interp}).
While set interpretations are relatively straightforward, relational
interpretations are less so because of the cocontinuity conditions
needed to know they are well-defined. We develop these conditions in
Sections~\ref{sec:set-interp} and~\ref{sec:rel-interp}. This 
separates our set and relational interpretations in space, but
has no other impact on the mutually inductive definitions.

\vspace*{-0.15in}

\subsection{Interpreting Types as Sets}\label{sec:set-interp}

\vspace*{-0.05in}

We interpret types in our calculus as $\omega$-cocontinuous functors
on locally finitely presentable categories~\cite{ar94}. Since functor
categories of locally finitely presentable categories are again
locally finitely presentable, this ensures that the fixpoints
interpreting $\mu$-types in $\set$ and $\rel$ exist, and thus that
both the set and relational interpretations of all of the types in
Definition~\ref{def:wftypes} are well-defined~\cite{jp19}. To
bootstrap this process, we interpret type variables as
$\omega$-cocontinuous functors.  If $\cal C$ and $\D$ are locally
finitely presentable categories, we write $[\cal C,\D]$ for the
category of $\omega$-cocontinuous functors from $\cal C$ to $\D$.

A {\em set environment} maps each type variable in $\tvars^k \cup
\fvars^k$ to an element of $[\set^k,\set]$.  A morphism $f : \rho \to
\rho'$ for set environments $\rho$ and $\rho'$ with $\rho|_\tvars =
\rho'|_\tvars$ maps each type constructor variable $\psi^k \in \tvars$
to the identity natural transformation on $\rho \psi^k = \rho'\psi^k$
and each functorial variable $\phi^k \in \fvars$ to a natural
transformation from the $k$-ary functor $\rho \phi^k$ on $\set$ to the
$k$-ary functor $\rho' \phi^k$ on $\set$.  Composition of morphisms on
set environments is componentwise, with the identity morphism mapping
each one to itself. This gives a category of set environments and
morphisms between them, denoted $\setenv$.  We identify a functor in
$[\set^0, \set]$ with its value on $\ast$, and consider a set
environment to map a type variable of arity $0$ to a set.  If
$\ol{\alpha} = \{\alpha_1,...,\alpha_k\}$ and $\ol{A} =
\{A_1,...,A_k\}$, then we write $\rho[\ol{\alpha := A}]$ for the set
environment $\rho'$ such that $\rho' \alpha_i = A_i$ for $i = 1,...,k$
and $\rho' \alpha = \rho \alpha$ if $\alpha \not \in
\{\alpha_1,...,\alpha_k\}$.  If $\rho \in \setenv$ we write $\Eq_\rho$
for the relation environment (see Section~\ref{sec:type-interp}) such
that $\Eq_\rho v = \Eq_{\rho v}$ for every type variable $v$.  The
{\em set interpretation} $\setsem{\cdot} : \F \to [\setenv, \set]$ is
defined in Figure~\ref{fig:set-sem}.  The relational interpretations
in the second clause of Figure~\ref{fig:set-sem} are given in full
in Figure~\ref{fig:rel-sem}.

\begin{figure}[t]
%\hspace*{0.1in}
%\resizebox{1.1\linewidth}{!}{
%\begin{minipage}[t]{0.5\textwidth}
  \begin{adjustbox}{varwidth=5in, max width=5in, fbox, center}
  \begin{align*}
  \setsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \setsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
  \setsem{\Gamma; \emptyset
    \vdash \Nat^{\ol{\alpha}}
    \,F\,G}\rho &= \{\eta : \lambda \ol{A}. \,\setsem{\Gamma;
    \ol{\alpha} \vdash
    F}\rho[\ol{\alpha := A}] 
      \Rightarrow \lambda \ol{A}.\,\setsem{\Gamma; 
        \ol{\alpha} \vdash G}\rho[\ol{\alpha := A}] \\ 
      &\hspace{0.2in}|~\forall \overline{A}, \overline{B} :
      \set. \forall \overline{R : \rel(A, B)}.\\ 
      &\hspace{0.2in}(\eta_{\overline{A}}, \eta_{\overline{B}})
      : \relsem{\Gamma; \ol{\alpha} \vdash F}\Eq_{\rho}[\ol{\alpha := R}]
      \rightarrow \relsem{\Gamma; \ol{\alpha} \vdash
        G}\Eq_{\rho}[\ol{\alpha := R}] \} \\
  \setsem{\Gamma;\Phi \vdash \phi\ol{F}}\rho &=
  (\rho\phi)\,\ol{\setsem{\Gamma;\Phi \vdash
    F}\rho}\\
  \setsem{\Gamma;\Phi \vdash F+G}\rho &=
  \setsem{\Gamma;\Phi \vdash F}\rho +
  \setsem{\Gamma;\Phi \vdash G}\rho\\
  \setsem{\Gamma;\Phi \vdash F\times G}\rho &=
  \setsem{\Gamma;\Phi \vdash F}\rho \times
  \setsem{\Gamma;\Phi \vdash G}\rho\\ 
  \setsem{\Gamma;\Phi {\color{red},\ol\gamma} \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{G}}\rho &= (\mu
    T^\set_{H,\rho})\ol{\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash G}\rho}\\
    \text{where } T^\set_{H,\rho}\,F & = \lambda
  \ol{A}. \setsem{\Gamma; {\color{red}\ol\gamma,}\phi, \ol{\alpha} \vdash
    H}\rho[\phi :=  F][\ol{\alpha := A}]\\
  \text{and } T^\set_{H,\rho}\,\eta &= \lambda
  \ol{A}. \setsem{\Gamma;{\color{red}\ol\gamma,}\phi, \ol{\alpha} \vdash
    H}\id_\rho[\phi := \eta][\ol{\alpha := \id_{A}}]
\end{align*}
\vspace*{-0.3in}\caption{Set interpretation}\label{fig:set-sem} 
\vspace*{-0.3in}
%\end{minipage}}
\end{adjustbox}\vspace*{-0.17in}
  \end{figure}

If $\rho \in \setenv$ and $\vdash F$ we write $\setsem{\vdash F}$ for
$\setsem{\vdash F}\rho$ since the environment is immaterial. The third
clause of Figure~\ref{fig:set-sem} does indeed define a set: local
finite presentability of $\set$ and $\omega$-cocontinuity of
$\setsem{\Gamma;\ol{\alpha} \vdash F}\rho$ ensure that the set of
natural transformations $\{\eta : \setsem{\Gamma;\ol{\alpha} \vdash
  F}\rho \Rightarrow \setsem{\Gamma;\ol{\alpha} \vdash G}\rho\}$
(which contains $\setsem{\Gamma;\emptyset \vdash
  \Nat^{\ol{\alpha}}\,F\,G}\rho$) is a subset of
$\big\{({\setsem{\Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha :=
      S}]})^{(\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha :=
      S}])}$ $\big|~ \ol{S} = (S_1,...,S_{|\ol{\alpha}|}), \mbox{ and
} S_i \mbox{ is a finite set for } i =
1,...,|\ol{\alpha}|\big\}$. There are countably many tuples $\ol{S}$,
each giving a morphism from ${\setsem{\Gamma;\ol{\alpha} \vdash
    F}\rho[ \ol{\alpha := S}]}$ to ${\setsem{\Gamma;\ol{\alpha} \vdash
    G}\rho[\ol{\alpha := S}]}$, and only $\set$-many such morphisms
since $\set$ is locally small.  In addition, $\setsem{\Gamma;
  \emptyset \vdash \Nat^{\ol\alpha} F\,G}$ is $\omega$-cocontinuous
since it is constant on $\omega$-directed sets. Interpretations of
$\Nat$ types ensure that $\setsem{\Gamma \vdash F \to G}$ and
$\setsem{\Gamma \vdash \forall \ol\alpha. F}$ are as expected in
parametric models.

To make sense of the last clause in Figure~\ref{fig:set-sem}, we need
to know that, for each $\rho \in \setenv$, $T^\set_{H,\rho}$ is an
$\omega$-cocontinuous endofunctor on $[\set^k, \set]$, and thus admits
a fixpoint.  Since $T_{H,\rho}^\set$ is defined in terms of
$\setsem{\Gamma;{\color{red}\ol\gamma,}\phi, \ol{\alpha} \vdash H}$,
interpretations of types must be such functors, which entails that the
actions of set interpretations of types on objects and on morphisms in
$\setenv$ are intertwined.  We know from~\cite{jp19} that, for every
$\Gamma; \ol{\alpha} \vdash G$, $\setsem{\Gamma; \ol{\alpha} \vdash
  G}$ is actually in $[\set^k,\set]$ where $k = |\ol \alpha|$, so
that, for each $\setsem{\Gamma; {\color{red}\ol\gamma,} \phi^k,
  \ol{\alpha} \vdash 
  H}$, the corresponding operator $T^\set_{H}$ can be extended to a
{\em functor} from $\setenv$ to $[[\set^k,\set],[\set^k,\set]]$. The
action of $T^\set_H$ on an object $\rho \in \setenv$ is given by the
higher-order functor $T_{H,\rho}^\set$, whose actions on objects
(functors in $[\set^k, \set]$) and morphisms between them are given in
Figure~\ref{fig:set-sem}. Its action on a morphism $f : \rho \to
\rho'$ is the higher-order natural transformation $T^\set_{H,f} :
T^\set_{H,\rho} \to T^\set_{H,\rho'}$ whose action on $F :
[\set^k,\set]$ is the natural transformation $T^\set_{H,f}\, F :
T^\set_{H,\rho}\,F \to T^\set_{H,\rho'}\,F$ whose component at
$\ol{A}$ is $(T^\set_{H,f}\, F)_{\ol{A}} = \setsem{\Gamma;
 {\color{red} \ol\gamma,}\phi,\ol{\alpha} \vdash H}f[\phi := \id_F][\ol{\alpha :=
    \id_A}]$. The next definition uses $T^\set_H$ to define the
functorial action of set interpretation.


\begin{definition}\label{def:set-sem-funcs}
The action
of\, $\setsem{\Gamma;\Phi \vdash F}$
on
$f : \rho \to \rho'$ in $\setenv$ is given by:
\begin{itemize}
\item
 $\setsem{\Gamma;\Phi \vdash \zerot}f = \id_0$
\item
  $\setsem{\Gamma;\Phi \vdash \onet}f = \id_1$
\item 
  $\setsem{\Gamma; \emptyset
    \vdash \Nat^{\ol{\alpha}}\,F\,G} f =
  \id_{\setsem{\Gamma; \emptyset
      \vdash \Nat^{\ol{\alpha}}\,F\,G}\rho}$
\item 
$\setsem{\Gamma;\Phi \vdash \phi \ol{F}} f : \setsem{\Gamma;\Phi
  \vdash \phi \ol{F}}\rho \to \setsem{\Gamma;\Phi \vdash
  \phi\ol{F}}\rho' = (\rho\phi) \ol{\setsem{\Gamma;\Phi \vdash F}\rho}
  \to (\rho'\phi) \ol{\setsem{\Gamma;\Phi \vdash F}\rho'}$ is defined
  by $\setsem{\Gamma;\Phi \vdash \phi \ol{F}} f =
  (f\phi)_{\ol{\setsem{\Gamma;\Phi \vdash F}\rho'}}\, \circ\,
  (\rho\phi) {\ol{\setsem{\Gamma;\Phi \vdash F}f}} = (\rho'\phi)
  {\ol{\setsem{\Gamma;\Phi \vdash F}f}}\, \circ\, (f
  \phi)_{\ol{\setsem{\Gamma;\Phi \vdash F}\rho}}$.  The latter
  equality holds because $\rho\phi$ and $\rho'\phi$ are functors and
  $f\phi : \rho\phi \to \rho'\phi$ is a natural transformation.
\item 
  $\setsem{\Gamma;\Phi
  \vdash F + G}f$ is defined by $\setsem{\Gamma;\Phi \vdash
  F + G}f(\inl\,x) = \inl\,(\setsem{\Gamma;\Phi \vdash
  F}f x)$ and $\setsem{\Gamma;\Phi \vdash F +
  G}f(\inr\,y) = \inr\,(\setsem{\Gamma;\Phi \vdash G}f y)$
\item 
  $\setsem{\Gamma;\Phi \vdash F \times G}f = 
  \setsem{\Gamma;\Phi \vdash F}f \times \setsem{\Gamma;\Phi \vdash
    G}f$
\item 
$\setsem{\Gamma;\Phi {\color{red},\ol\gamma} \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{G}} f \;: \;\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash
  (\mu \phi.\lambda \ol{\alpha}. H)\ol{G}} \rho \to
  \setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash (\mu
    \phi.\lambda\ol{\alpha}. H)\ol{G}} \rho' \;= \;(\mu
  T^\set_{H,\rho})\ol{\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash G}\rho} \to
  (\mu T^\set_{H,\rho'})\ol{\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash
      G}\rho'}$ is defined by $(\mu
  T^\set_{H,f})\ol{\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash G}\rho'} \circ
  (\mu T^\set_{H,\rho})\ol{\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash G}f}\;
  = \; (\mu T^\set_{H,\rho'})\ol{\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash
      G}f}\, \circ\, (\mu
  T^\set_{H,f})\ol{\setsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash G}\rho}$.  The
  latter equality holds because $\mu T^\set_{H,\rho}$ and $\mu
  T^\set_{H,\rho'}$ are functors and $\mu T_{H,f}^\set : \mu
  T_{H,\rho}^\set \to \mu T_{H,\rho'}^\set$ is a natural
  transformation.
\end{itemize}
\end{definition}

\subsection{Interpreting Types as Relations}\label{sec:rel-interp}

\vspace*{-0.01in}

A {\em $k$-ary relation transformer} $F$ is a triple $(F^1, F^2,F^*)$,
where $F^1,F^2 : [\set^k,\set]$ and $F^* : [\rel^k, \rel]$ are
functors, if $\ol{R_i:\rel(A_i,B_i)}$ for $i = 1,...,k$ then $F^*
\ol{R} : \rel(F^1 \ol{A}, F^2 \ol{B})$, and if $\ol{(\alpha_i,
  \beta_i) \in \Homrel(R_i,S_i)}$ for $i = 1,...,k$, then $F^*
\ol{(\alpha, \beta)} = (F^1 \ol{\alpha}, F^2 \ol{\beta})$.  We define
$F\ol{R}$ to be $F^*\overline{R}$ and $F\overline{(\alpha,\beta)}$ to
be $F^*\overline{(\alpha,\beta)}$.  The last clause above expands to:
if $\ol{(a,b) \in R}$ implies $\ol{(\alpha\,a,\beta\,b) \in S}$ then
$(c,d) \in F^*\ol{R}$ implies $(F^1 \ol{\alpha}\,c,F^2 \ol{\beta}\,d)
\in F^*\ol{S}$.  We identify a $0$-ary relation transformer $(A,B,R)$
with $R : \rel(A,B)$, and write $\pi_1 F$ for $F^1$ and $\pi_2 F$ for
$F^2$.  Below we extend these conventions to relation environments in
the obvious ways.

The category $RT_k$ of $k$-ary relation transformers is given by the
following data: an object of $RT_k$ is a $k$-ary relation transformer;
a morphism $\delta : (G^1,G^2,G^*) \to (H^1,H^2,H^*)$ in $RT_k$ is a
pair of natural transformations $(\delta^1, \delta^2)$ where $\delta^1
: G^1 \to H^1$, $\delta^2 : G^2 \to H^2$ such that, for all $\ol{R :
  \rel(A, B)}$, if $(x, y) \in G^*\ol{R}$ then $(\delta^1_{\ol{A}}x,
\delta^2_{\ol{B}}y) \in H^*\ol{R}$; and identity morphisms and
composition are inherited from the category of functors on $\set$.  An
endofunctor $H$ on $RT_k$ is a triple $H = (H^1,H^2,H^*)$, where $H^1$
and $H^2$ are functors from $[\set^k,\set]$ to $[\set^k,\set]$; $H^*$
is a functor from $RT_k$ to $[\rel^k,\rel]$; for all $\overline{R :
  \rel(A,B)}$, $\pi_1((H^*(\delta^1,\delta^2))_{\overline{R}}) = (H^1
\delta^1)_{\overline{A}}$ and
$\pi_2((H^*(\delta^1,\delta^2))_{\overline{R}}) = (H^2
\delta^2)_{\overline{B}}$; the action of $H$ on objects is given by
$H\,(F^1,F^2,F^*) = (H^1F^1,\,H^2F^2,\,H^*(F^1,F^2,F^*))$; and the
action of $H$ on morphisms is given by $H\,(\delta^1,\delta^2) =
(H^1\delta^1,H^2\delta^2)$ for $(\delta^1,\delta^2) : (F^1,F^2,F^*)\to
(G^1,G^2,G^*)$.  Since applying an endofunctor $H$ to $k$-ary relation
transformers and morphisms between them must give $k$-ary relation
transformers and morphisms between them, this definition implicitly
requires the following three conditions to hold: \,{\em i})
$H^*(F^1,F^2,F^*) \ol{R} : \rel(H^1F^1 \ol{A}, H^2F^2 \ol{B})$
whenever $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$; {\em ii})
$H^*(F^1,F^2,F^*)\, \ol{(\alpha, \beta)} = (H^1F^1\ol{\alpha}, H^2F^2
\ol{\beta})$ whenever $(\alpha_1, \beta_1) \in \Homrel(R_1,S_1),...,
(\alpha_k, \beta_k) \in \Homrel(R_k,S_k)$; and {\em iii}) $(\delta^1,\delta^2) : 
(F^1,F^2,F^*)\to (G^1,G^2,G^*)$ and
$R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then
$((H^1\delta^1)_{\ol{A}}x, (H^2\delta^2)_{\ol{B}}y) \in
H^*(G^1,G^2,G^*)\ol{R}$ whenever $(x, y) \in
H^*(F^1,F^2,F^*)\ol{R}$. Note, however, that this last condition is
automatically satisfied because it is implied by the third condition
on functors on relation transformers.

If $H$ and $K$ are endofunctors on $RT_k$, then a {\em natural
  transformation} $\sigma : H \to K$ is a pair $\sigma = (\sigma^1,
\sigma^2)$, where $\sigma^1 : H^1 \to K^1$ and $\sigma^2 : H^2 \to
K^2$ are natural transformations between endofunctors on
$[\set^k,\set]$ and the component of $\sigma$ at $F \in RT_k$ is given
by $\sigma_F = (\sigma^1_{F^1}, \sigma^2_{F^2})$.  This definition
entails that $\sigma^i_{F^i}$ is natural in $F^i : [\set^k,\set]$,
and, for every $F$, both $(\sigma^1_{F^1})_{\overline{A}}$ and
$(\sigma^2_{F^2})_{\overline{A}}$ are natural in $\overline{A}$.
Moreover, since the results of applying $\sigma$ to $k$-ary relation
transformers must be morphisms of $k$-ary relation transformers, it
implicitly requires that $(\sigma_F)_{\overline{R}} = (
(\sigma^1_{F^1})_{\overline{A}}, (\sigma^2_{F^2})_{\overline{B}})$ is
a morphism in $\rel$ for any $k$-tuple of relations $\overline{R :
  \rel(A, B)}$, i.e., that if $(x, y) \in H^*F\overline{R}$, then
$((\sigma^1_{F^1})_{\overline{A}} x, (\sigma^2_{F^2})_{\overline{B}}
y) \in K^*F\overline{R}$.

Critically, we can compute $\omega$-directed colimits in
$RT_k$. Indeed, if $\cal D$ is an $\omega$-directed set then $\colim{d
  \in {\cal D}}{(F^1_d, F^2_d,F^*_d)} = (\colim{d \in {\cal
    D}}{F^1_d}, \colim{d \in {\cal D}}{F^2_d}, \colim{d \in {\cal
    D}}{F^*_d})$.  We define an endofunctor $T = (T^1,T^2,T^*)$ on
$RT_k$ to be {\em $\omega$-cocontinuous} if $T^1$ and $T^2$ are
$\omega$-cocontinuous endofunctors on $[\set^k,\set]$ and $T^*$ is an
$\omega$-cocontinuous functor from $RT_k$ to $[\rel^k,\rel]$, i.e., is
in $[RT_k,[\rel^k,\rel]]$.  Now, for any $k$, any $A : \set$, and any
$R : \rel(A, B)$, let $K^\set_A$ be the constantly $A$-valued functor
from $\set^k$ to $\set$ and $K^\rel_R$ be the constantly $R$-valued
functor from $\rel^k$ to $\rel$.  Also let $0$ denote the initial
object of either $\set$ or $\rel$, as appropriate. Observing that, for
every $k$, $K^\set_0$ is initial in $[\set^k,\set]$, and $K^\rel_0$ is
initial in $[\rel^k,\rel]$, we have that, for each $k$, $K_0 =
(K^\set_0,K^\set_0,K^\rel_0)$ is initial in $RT_k$. Thus, if $T =
(T^1,T^2,T^*) : RT_k \to RT_k$ is an endofunctor on $RT_k$ we can
define the relation transformer $\mu T$ to be $\colim{n \in \nat}{T^n
  K_0}$ $= (\mu T^1,\mu T^2, \colim{n \in \nat}{(T^nK_0)^*})$.  If $T
: [RT_k,RT_k]$ then $\mu T$ is a fixpoint for $T$, i.e., $\mu T \cong
T(\mu T)$.  The isomorphism is given by $(\mathit{in}_1,
\mathit{in}_2) : T(\mu T) \to \mu T$ and $(in_1^{-1}, in_2^{-1}) : \mu
T \to T(\mu T)$ in $RT_k$. The latter is always a morphism in $RT_k$,
but the former need not be if $T$ is not $\omega$-cocontinuous.
Since $\mu T$'s third component is the colimit in
$[\rel^k,\rel]$ of third components of relation transformers, rather
than a fixpoint of an endofunctor on $[\rel^k,\rel]$,
there is an asymmetry between $\mu T$'s first two and third
components.

A {\em relation environment} maps each type variable in $\tvars^k \cup
\fvars^k$ to a $k$-ary relation transformer.  A morphism $f : \rho \to
\rho'$ between relation environments $\rho$ and $\rho'$ with
$\rho|_\tvars = \rho'|_\tvars$ maps each $\psi^k \in \tvars$ to the
identity morphism on $\rho \psi^k = \rho' \psi^k$ and each $\phi^k \in
\fvars$ to a morphism from the $k$-ary relation transformer $\rho
\phi$ to the $k$-ary relation transformer $\rho' \phi$. Composition of
morphisms on relation environments is componentwise, with the identity
morphism mapping each to itself; this gives a category $\relenv$ of
relation environments and their morphisms.  We identify a $0$-ary
relation transformer with its codomain, and consider a relation
environment to map a type variable of arity $0$ to a relation.  We
write $\rho[\ol{\alpha := R}]$ for the relation environment $\rho'$
such that $\rho' \alpha_i \, = R_i$ for $i = 1,...,k$ and $\rho'
\alpha = \rho\alpha$ if $\alpha \not \in \{\alpha_1,...,\alpha_k\}$.
If $\rho \in \relenv$ we write $\pi_1 \rho$ and $\pi_2 \rho$ for the
set environments mapping each type variable $\phi$ to the functors
$(\rho\phi)^1$ and $(\rho\phi)^2$, respectively.

For each $k$, an $\omega$-cocontinuous functor $H : [\relenv, RT_k]$
is a triple $H = (H^1,H^2,H^*)$, where $H^1, H^2 :
[\setenv,[\set^k,\set]]$; $H^* : [\relenv,[\rel^k,\rel]]$; for all
$\overline{R : \rel(A,B)}$ and morphisms $f$ in $\relenv$, $\pi_1(H^*f
\,{\overline{R}}) = H^1 (\pi_1 f)\,{\overline{A}}$ and $\pi_2(H^*f
\,{\overline{R}}) = H^2 (\pi_2 f)\,{\overline{B}}$; the action of $H$
on $\rho$ in $\relenv$ is given by $H \rho = (H^1 (\pi_1 \rho),\,H^2
(\pi_2 \rho),\,H^*\rho)$; and the action of $H$ on morphisms $f : \rho
\to \rho'$ in $\relenv$ is given by $Hf = (H^1 (\pi_1 f),H^2 (\pi_2
f))$.  The last two points above give: {\em i}) if $\ol{R_i :
  \rel(A_i,B_i)}$ for $i = 1,...,k$ then $H^*\rho\, \ol{R} :
\rel(H^1(\pi_1 \rho)\, \ol{A}, H^2(\pi_2 \rho)\, \ol{B})$; {\em ii})
if $\ol{(\alpha_i, \beta_i) \in \Homrel(R_i,S_i)}$ for $i = 1,...,k$
then $H^*\rho\, \ol{(\alpha, \beta)} = (H^1(\pi_1 \rho)\,\ol{\alpha},
H^2(\pi_2 \rho)\, \ol{\beta})$; and {\em iii}) if $f : \rho \to \rho'$
and $\ol{R_i:\rel(A_i,B_i)}$ for $i = 1,...,k$, then if $(x, y) \in
H^*\rho\,\ol{R}$ then $(H^1(\pi_1 f)\,{\ol{A}}\,x, H^2(\pi_2
f)\,{\ol{B}}\,y) \in H^*\rho'\,\ol{R}$.

Computation of $\omega$-directed colimits in $RT_k$ extends
componentwise to colimits in $\relenv$. Similarly,
$\omega$-cocontinuity for endofunctors on $RT_k$ extends to
functors from $\relenv$ to $RT_k$.
Our relational interpretation $\relsem{\cdot} : \F \to [\relenv,
\rel]$ is given in Figure~\ref{fig:rel-sem}.
\begin{figure}[t]
%\hspace*{0.1in}
%\resizebox{1.1\linewidth}{!}{
%\begin{minipage}[t]{0.5\textwidth}
\begin{adjustbox}{varwidth=5in, max width=5in, fbox, center}
  \begin{align*}
  \relsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \relsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
%  \end{align*}
%  \begin{align*}
  \relsem{\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}} \,F\,G}\rho &= \{\eta
  : \lambda \ol{R}.\,\relsem{\Gamma; \ol{\alpha} \vdash
    F}\rho[\ol{\alpha := R}] \Rightarrow \lambda \ol{R}. \,\relsem{
    \Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha := R}]\}\\
  &=
  \{(t,t') \in \setsem{\Gamma; \emptyset
    \vdash \Nat^{\ol{\alpha}}
    \,F\,G} (\pi_1 \rho) \times \setsem{ 
    \Gamma;\emptyset
    \vdash \Nat^{\ol{\alpha}} \,F\,G} (\pi_2
  \rho)~|~\\ 
  & \hspace{0.3in} \forall {R_1 : \rel(A_1,B_1)}\,...\,{R_k : \rel(A_k,B_k)}.\\
  & \hspace{0.4in} (t_{\ol{A}},t'_{\ol{B}}) \in
  (\relsem{\Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha :=
      R}])^{\relsem{\Gamma;\ol{\alpha}\vdash F}\rho[\ol{\alpha := R}]} \}\\  
  \relsem{\Gamma;\Phi \vdash \phi \ol{F}}\rho &=
  (\rho\phi)\ol{\relsem{\Gamma;\Phi \vdash 
    F}\rho}\\
  \relsem{\Gamma;\Phi \vdash F+G}\rho &=
  \relsem{\Gamma;\Phi \vdash F}\rho +
  \relsem{\Gamma;\Phi \vdash G}\rho\\
  \relsem{\Gamma;\Phi \vdash F\times G}\rho &=
  \relsem{\Gamma;\Phi \vdash F}\rho \times
  \relsem{\Gamma;\Phi \vdash G}\rho\\  
   \relsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{G}}\rho
  &= (\mu T_{H,\rho})\ol{\relsem{\Gamma;\Phi{\color{red},\ol\gamma} \vdash
     G}\rho}\\
  \text{where }	T_{H,\rho}
    &= (T^\set_{H,\pi_1\rho}, T^\set_{H,\pi_2\rho}, T^\rel_{H,\rho}) \\
  \text{and } T^\rel_{H,\rho}\,F
    &= \lambda \ol{R}. \relsem{
      \Gamma;{\color{red}\ol\gamma,}\phi,\ol{\alpha} \vdash H}\rho[\phi :=
    F][\ol{\alpha := R}]\\
  \text{and } T^\rel_{H,\rho}\,\delta
    &= \lambda \ol{R}. \relsem{
      \Gamma;{\color{red}\ol\gamma,}\phi,\ol{\alpha} \vdash H}\id_\rho[\phi :=
    \delta][\ol{\alpha := \id_R}]
\end{align*}
\vspace*{-0.3in}\caption{Relational
  interpretation}\label{fig:rel-sem} \vspace*{-0.3in} 
%\end{minipage}}\vspace*{-0.2in}
\end{adjustbox}\vspace*{-0.15in}
\end{figure}
It ensures that $\relsem{\Gamma \vdash F \to G}$ and $\relsem{\Gamma
  \vdash \forall \ol \alpha. F}$ are as expected.  As for set
interpretations, $\relsem{\Gamma; \emptyset \vdash \Nat^{\ol\alpha}
  F\,G}$ is $\omega$-cocontinuous because it is constant on
$\omega$-directed sets.  If $\rho \in \relenv$ we write
$\relsem{\vdash F}$ for $\relsem{\vdash F}\rho$.  For the last clause
in Figure~\ref{fig:rel-sem} to be well-defined we need $T_{H,\rho}$ to
be an $\omega$-cocontinuous endofunctor on $RT$, so that it admits a
fixpoint. Since $T_{H,\rho}$ is defined in terms of
$\relsem{\Gamma;{\color{red}\ol\gamma,}\phi^k, \ol{\alpha} \vdash H}$, this means
that relational interpretations of types must be $\omega$-cocontinuous
functors from $\relenv$ to $RT_0$, which in turn entails that the
actions of relational interpretations of types on objects and on
morphisms in $\relenv$ are intertwined.  We know from~\cite{jp19}
that, for every $\Gamma; \ol{\alpha} \vdash F$, $\relsem{\Gamma;
  \ol{\alpha} \vdash F}$ is actually in $[\rel^k,\rel]$ where $k =
|\ol \alpha|$.  We first define the actions of each of these functors
on morphisms between relation environments, and then argue that they
are well-defined and have the required properties. To do this, we
extend $T_H$ to a {\em functor} from $\relenv$ to
$[[\rel^k,\rel],[\rel^k,\rel]]$. Its action on an object $\rho \in
\relenv$ is given by the higher-order functor $T_{H,\rho}$ whose
actions on objects and morphisms are given in
Figure~\ref{fig:rel-sem}. Its action on a morphism $f : \rho \to
\rho'$ is the higher-order natural transformation $T_{H,f} :
T_{H,\rho} \to T_{H,\rho'}$ whose action on any $F : [\rel^k,\rel]$ is
the natural transformation $T_{H,f}\, F : T_{H,\rho}\, F \to
T_{H,\rho'}\, F$ whose component at $\ol{R}$ is $(T_{H,f}\,
F)_{\ol{R}} = \relsem{\Gamma; {\color{red}\ol\gamma,}\phi,\ol{\alpha} \vdash
  H}f[\phi := \id_F][\ol{\alpha := \id_R}]$.

Using $T_H$, we can define the functorial action of relational
interpretation.  The action $\relsem{\Gamma;\Phi \vdash F}f$ of
$\relsem{\Gamma;\Phi \vdash F}$ on $f : \rho \to \rho'$ in $\relenv$
is given as in Definition~\ref{def:set-sem-funcs}, except that all
interpretations are relational interpretations and all occurrences of
$T^\set_{H,f}$ are replaced by $T_{H,f}$.  For this definition and
Figure~\ref{fig:rel-sem} to be well-defined we need that, for every
$H$, $T_{H,\rho}\,F$ is a relation transformer, and $T_{H,f}\, F :
T_{H,\rho}\, F \to T_{H,\rho'}\, F$ is a morphism of relation
transformers, whenever $F$ is a relation transformer and $f : \rho \to
\rho'$ is in $\relenv$. This is immediate from

\vspace*{-0.2in}

\begin{equation}\label{lem:rel-transf-morph}
\sem{\Gamma;\Phi \vdash F} = (\setsem{\Gamma;\Phi \vdash F},
\setsem{\Gamma;\Phi \vdash F},\relsem{\Gamma;\Phi \vdash F}) \in
       [\relenv,RT_0]
\end{equation}

\vspace*{-0.05in}

\noindent
The proof is a straightforward induction on the structure of $F$,
using an appropriate result from~\cite{jp19} to deduce
$\omega$-cocontinuity of $\sem{\Gamma;\Phi \vdash F}$ in each case.


We can prove by simultaneous induction that set and relational
interpretations of types respect demotion of functorial variables to
non-functorial ones and, for $\mathsf D \in \{\set,\rel\}$,
$\sem{\Gamma;\Phi \vdash G[\ol{\alpha := K}]}^{\mathsf D}\rho =
\sem{\Gamma;\Phi,\ol{\alpha} \vdash G}^{\mathsf D}\rho[\ol{\alpha :=
    \sem{\Gamma;\Phi \vdash K}^{\mathsf D}\rho}]$, and
$\sem{\Gamma;\Phi \vdash G[\ol{\alpha := K}]}^{\mathsf D}f =
\sem{\Gamma;\Phi,\ol{\alpha} \vdash G}^{\mathsf D}f[\ol{\alpha :=
    \sem{\Gamma;\Phi \vdash K}^{\mathsf D}f}]$, and $\llbracket
\Gamma; \Phi$ $\vdash F[\phi := H] \rrbracket^{\mathsf D} \rho =
\sem{\Gamma; \Phi, \phi \vdash F}^{\mathsf D}\rho [\phi := \lambda
  \ol{A}.\, \sem{\Gamma;\Phi,\overline{\alpha}\vdash H}^{\mathsf
    D}\rho[\overline{\alpha := A}]]$, and, finally, $\sem{\Gamma; \Phi
  \vdash F[\phi := H]}^{\mathsf D}f = \sem{\Gamma; \Phi, \phi \vdash
  F}^{\mathsf D}f [\phi := \lambda
  \ol{A}.\,\sem{\Gamma;\Phi,\overline{\alpha}\vdash H}^{\mathsf
    D}f[\overline{\alpha := \id_{\ol{A}}}]]$.

\vspace*{-0.1in}

\section{The Identity Extension Lemma}\label{sec:iel}

\vspace*{-0.1in}

In most treatments of parametricity, equality relations are taken as
{\em given}, either directly as diagonal relations or perhaps via
reflexive graphs.  By contrast, we give a categorical definition of
graph relations for natural transformations and {\em construct}
equality relations as particular such relations. Our definitions
specialize to the usual ones for morphisms between sets and equality
relations on sets.

The standard definition $(x,y) \in \graph{f}$ iff $fx = y$ of the
graph $\graph{f}$ of a morphism $f : A \to B$ in $\set$ naturally
generalizes to associate to each natural transformation between
$k$-ary functors on $\set$ a $k$-ary relation transformer. Indeed, if
$F, G: \Set^k \to \Set$ and $\alpha : F \to G$ is a natural
transformation, then the functor $\graph{\alpha}^*: \rel^k \to \rel$
is defined as follows. Given $R_1 : \rel(A_1, B_1),...,R_k :
\rel(A_k,B_k)$, let $\iota_{R_i} : R_i \hookrightarrow A_i \times
B_i$, for $i = 1,...,k$, be the inclusion of $R_i$ as a subset of $A_i
\times B_i$, let $h_{\overline{A \times B}}$ be the unique morphism
making the left diagram below commute, and let $h_{\overline{R}} :
F\overline{R} \to F\overline{A} \times G\overline{B}$ be
$h_{\overline{A \times B}} \circ F\overline{\iota_R}$.  Further, let
$\alpha^\wedge\overline{R}$ be the subobject through which
$h_{\overline{R}}$ is factorized by the mono-epi factorization system
in $\set$, as in the right diagram below. Then
$\alpha^\wedge\overline{R} : \rel(F\overline{A}, G\overline{B})$ by
construction, so the action of $\langle \alpha \rangle^*$ on objects
can be given by $\langle \alpha \rangle^* \overline{(A,B,R)} =
(F\overline{A}, G\overline{B}, \iota_{\alpha^\wedge
  \overline{R}}\alpha^\wedge\overline{R})$. Its action on morphisms is
given by $\graph{\alpha}^*\overline{(\beta, \beta')} =
(F\overline\beta, G\overline\beta')$.

\begin{figure*}[ht]
\vspace*{-0.3in}
%  \hspace*{0.25in}
  \begin{minipage}[b]{0.25\linewidth}
{\footnotesize\[\begin{tikzcd}[row sep = large]
        F\overline{A}
        &F(\overline{A \times B})
        \ar[l, "{F\overline{\pi_1}}"']
        \ar[r, "{F\overline{\pi_2}}"]
        \ar[d, dashed, "{h_{\overline{A \times B}}}"]
        &F\overline{B}
        \ar[r, "{\alpha_{\ol{B}}}"]
        &G\overline{B} \\
        &F\overline{A} \times G\overline{B}
        \ar[ul, "{\pi_1}"] \ar[urr, "{\pi_2}"']
\end{tikzcd}\]}
  \end{minipage}
  \hspace*{1.4in}
  \begin{minipage}[b]{0.5\linewidth}
{\footnotesize\[\begin{tikzcd}
        F\overline{R}
        \ar[rr, "{h_{\overline{R}}}"]
        \ar[dr, twoheadrightarrow, "{q_{\alpha^\wedge\overline{R}}}"']
        &&F\overline{A} \times G\overline{B} \\
        &\alpha^\wedge\overline{R}
        \ar[ur, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"']
\end{tikzcd}\]}
\end{minipage}\vspace*{-0.4in}
\end{figure*}

\begin{lemma}\label{lem:graph-reln-functors}
If $F,G : [\set^k,\set]$, and if $\alpha : F \to G$ is a natural
transformation, then the {\em graph relation transformer for $\alpha$}
defined by $\graph{\alpha} = (F, G, \graph{\alpha}^*)$ is in $RT_k$.
\end{lemma}

\noindent
The action of a graph relation transformer on a graph relation can be
computed explicitly:
if $\alpha : F \to G$ is a morphism in $[\Set^k, \Set]$
and $f_1: A_1 \to B_1, ..., f_k : A_k \to B_k$,
then $\graph{\alpha}^* \graph{\overline{f}}
= \langle G \ol{f} \circ \alpha_{\ol{A}} \rangle
= \langle \alpha_{\ol{B}} \circ F \ol{f} \rangle$.

To prove the IEL we also need to know that equality relation
transformers preserve equality relations. The {\em equality relation
  transformer} on $F : [\set^k,\set]$ is $\Eq_F = \graph{\id_{F}} =
(F, F, \graph{\id_{F}}^*)$.
The above definition then gives that, for all $\ol{A : \set}$,
$\Eq^*_F \ol{\Eq_A}
= \graph{\id_F}^* \graph{\id_{\ol{A}}}
= \graph{F \id_{\ol{A}} \circ (\id_F)_{\ol{A}}}
= \graph{\id_{F\ol{A}} \circ \id_{F\ol{A}}}
= \graph{\id_{F\ol{A}}}
= \Eq_{F\ol{A}}$. In addition,
if $\rho, \rho' \in \setenv$ and $f : \rho \to \rho'$, then
the {\em graph relation environment} $\graph{f}$ is defined pointwise
by $\graph{f} \phi = \graph{f \phi}$ for every $\phi$. This entails
that $\pi_1 \graph{f} = \rho$ and $\pi_2 \graph{f} = \rho'$.  The {\em
  equality relation environment} $\Eq_\rho$ is defined to be
$\graph{\id_{\rho}}$. Our IEL is thus:
\begin{theorem}[IEL]\label{thm:iel}
    If $\rho \in \setenv$, then
  $\relsem{\Gamma; \Phi \vdash F} \Eq_\rho = \Eq_{\setsem{\Gamma;
      \Phi \vdash F}\rho}$.
\end{theorem}
The IEL's highly non-trivial proof is by induction on the structure of
$F$. Only the $\Nat$, application, and fixpoint cases are
non-routine. The latter two explicitly calculate actions of graph
relation transformers as above.  The fixpoint case also uses that, for
every $n \in \nat$, the following intermediate results can be proved
by simultaneous induction with Theorem~\ref{thm:iel}: for any $H$,
$\rho$, $\ol A$, and subformula $J$ of $H$, both $T^n_{H,\Eq_{\rho}}
K_0\, \ol{\Eq_A} = (\Eq_{(T^\set_{H,\rho})^n K_0})^* \ol{\Eq_A}$\; and
$ \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash J} \Eq_{\rho} [\phi
  := T^{n}_{H,\Eq_{\rho}} K_0] \overline{[\alpha := \Eq_A]}$ $=
\relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash J} \Eq_{\rho}[\phi :=
  \Eq_{(T^\set_{H,\rho})^n K_0}] \overline{[\alpha := \Eq_A]}$
hold. The case of the proof when $F$ and $J$ are both $\mu$-types
makes clear that if functorial variables of arity greater than $0$
were allowed to appear in the bodies of $\mu$-types, then the IEL
would fail.

With the IEL in hand we can prove a Graph Lemma for our setting:

\vspace*{-0.05in}

\begin{lemma}%[Graph Lemma]
  \label{lem:graph}
  If $\rho, \rho' \in \setenv$ and $f : \rho \to \rho'$
  then $\graph{\setsem{\Gamma; \Phi \vdash F} f} =
\relsem{\Gamma; \Phi \vdash F}\graph{f}$.
\end{lemma}



\vspace*{-0.25in}

\section{Interpreting Terms}\label{sec:term-interp}

\vspace*{-0.1in}

If $\Delta = x_1 : F_1,...,x_n : F_n$ is a term context for $\Gamma$
and $\Phi$, define $\sem{\Gamma;\Phi \vdash \Delta}^{\mathsf{D}} =
\sem{\Gamma;\Phi \vdash F_1}^{\mathsf{D}} \times ... \times
\sem{\Gamma;\Phi \vdash F_n}^{\mathsf{D}}$, where $\mathsf D$ is
$\set$ or $\rel$ as appropriate. Then every well-formed term has a set
(resp., relational) interpretation as a natural transformation from
the set (resp., relational) interpretation of its term context to that
of its type. These interpretations, given in
Figure~\ref{fig:term-sem}, respect weakening, so that
$\sem{\Gamma;\Phi \,|\, \Delta, x : F \vdash t : G}^{\mathsf D}\rho =
(\sem{\Gamma;\Phi \,|\, \Delta \vdash t : G}^{\mathsf D}\rho) \circ
\pi_{\Delta}$, where $\rho \in \setenv$ or $\rho \in\relenv$, and
$\pi_{\Delta}$ is the projection $\sem{\Gamma;\Phi \vdash \Delta, x :
  F}^{\mathsf D} \to \sem{\Gamma;\Phi \vdash \Delta}^{\mathsf D}$.


\begin{figure}[t]
%\hspace*{-0.3in}
%\resizebox{0.46\linewidth}{!}{
%\begin{minipage}[t]{0.5\textwidth}
\begin{adjustbox}{varwidth=6in, max width=5.3in, fbox, center}
\[\begin{array}{lll}
\dsem{\Gamma;\Phi \,|\, \Delta,x :F \vdash x : F} \rho& = &
\pi_{|\Delta|+1}\\
\dsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline
    \alpha} \,F \,G}\rho & = &  \curry (\dsem{\Gamma;\overline \alpha
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline K} s:
  G [\overline{\alpha := K}]}\rho & = & \eval \circ \langle
  \lambda d.\,(\dsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\; d)_{\overline{\dsem{\Gamma;\Phi
      \vdash K}\rho}},\\ 
 & & \hspace*{0.5in} \dsem{\Gamma;\Phi \,|\,
    \Delta \vdash s: F [\overline{\alpha := K}]}\rho \rangle\\ 
& & \\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_F t : F} \rho& = &
!^0_{\dsem{\Gamma;\Phi \vdash F}\rho} \circ
  \dsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho, \mbox{ where } \\
 & & \hspace*{0.1in} !^0_{\dsem{\Gamma;\Phi \vdash F}\rho}
\mbox{ is the unique morphism from } 0\\
 & & \hspace*{0.1in} \mbox{ to } \dsem{\Gamma;\Phi \vdash F}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \top : \onet}\rho & = &
!^{\dsem{\Gamma;\Phi\vdash \Delta}\rho}_1, \mbox{ where }
!^{\dsem{\Gamma;\Phi\vdash \Delta}\rho}_1\\ 
& & \hspace*{0.1in} \mbox{ is the unique morphism from }
\dsem{\Gamma;\Phi\vdash \Delta}\rho \mbox{ to } 1\\ 
\dsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : F \times G} \rho& = &
\dsem{\Gamma;\Phi \,|\, \Delta \vdash s: F} \rho\times
\dsem{\Gamma;\Phi \,|\, \Delta \vdash t : G} \rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : F} \rho& = &
\pi_1 \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : F \times G}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : G}\rho & = &
\pi_2 \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : F \times
  G} \rho\\
\dsem{\Gamma;\Phi~|~\Delta \vdash \cse{t}{x \mapsto l}{y \mapsto r} :
  K}\rho & = & \eval \circ \langle \curry \,[\dsem{\Gamma;\Phi
    \,|\, \Delta, x : F \vdash l : K}\rho,\\
   & & \hspace*{0.79in} \dsem{\Gamma;\Phi \,|\, \Delta, y
    : G \vdash r : K}\rho],\\
   & &  \hspace*{0.5in} \dsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  F + G} \rho\rangle\\   
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: F + G} \rho& = &
\inl \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash s: F}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: F + G}\rho & = & 
\inr \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : G}\rho\\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \map^{\ol{F},\ol{G}}_H
  : \Nat^\emptyset (\Nat^{\ol\beta,\ol\gamma} F\,G)
& = & \lambda d\, \ol\eta\,\ol{C}.\,
\dsem{\Gamma; \ol{\phi},\ol{\gamma}\vdash H}\id_{\rho[\ol{\gamma:=
      C}]}[\ol{\phi := \lambda \ol B. \eta_{\ol B\, \ol C}}]\\ 
\hspace*{0.5in}
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}]) \rrbracket^{\mathsf D} \rho & &\\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
Nat^{\ol{\beta} {\color{red},\ol{\gamma}}} \, H[\phi := (\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}][\ol{\alpha := \beta}] & = &
\lambda d.\,\mathit{in}_{{T}^X_{H,\rho}} \;\;\mbox{ where } X \mbox{
  is } \set \mbox{ when } \\  
\hspace*{0.79in}(\mu \phi.\lambda {\overline \alpha}.H){\overline
  \beta} \rrbracket^{\mathsf{D}} \rho & & \hspace*{0.2in}  
\mathsf{D} = \set \mbox{ and not present when }
\mathsf{D} = \rel\\  
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta} {\color{red}, \ol{\gamma}}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F) & = &  
\lambda d{\color{red}\,\eta}.\,
\mathit{fold}_{T^X_{H,\rho}} {\,\color{red} \eta}\\ 
\hspace*{0.79in}(\Nat^{{\ol{\beta}{\color{red},\ol{\gamma}}} }\,(\mu
  \phi.\lambda \overline \alpha.H)\overline \beta\;F)
\rrbracket^{\mathsf{D}} \rho & & \hspace*{0.2in} \mbox{ where } X \mbox{ is as above
}\vspace*{-0.1in} 
\end{array}\]
\caption{Term semantics}\label{fig:term-sem} 
%\end{minipage}}
\vspace*{-0.05in}
\end{adjustbox}\vspace*{-0.1in}
\end{figure}


The return type for the semantic fold is
$\dsem{\Gamma;\ol\beta,\ol\gamma \vdash F}\rho[\ol{\gamma :=
    C}][\ol{\beta := B}]$.  This interpretation gives
$\dsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : F \to G}\rho
= \curry (\dsem{\Gamma;\emptyset \,|\, \Delta, x : F \vdash t :
  G}\rho)$ and $\dsem{\Gamma;\emptyset \,|\, \Delta \vdash st: G} \rho
= \eval \circ \langle \dsem{\Gamma;\emptyset \,|\, \Delta \vdash s: F
  \to G}\rho, \dsem{\Gamma;\emptyset \,|\, \Delta \vdash t: F}\rho
\rangle$, so it specializes to the standard interpretations for System
F terms.  If $t$ is closed, i.e., if $\emptyset; \emptyset~|~\emptyset
\vdash t : F$, then we write $\dsem{\vdash t : F}$ instead of
$\dsem{\emptyset; \emptyset~|~\emptyset \vdash t : F}$.  In addition,
term interpretation respects substitution for both functorial and
non-functorial type variables, as well as term substitution.  Direct
calculation reveals that interpretations of terms also satisfy
$\sem{\Gamma; \Phi~|~\Delta \vdash
  (L_{\ol{\alpha}}x.t)_{\ol{K}}s}^{\mathsf D} = \sem{\Gamma;
  \Phi~|~\Delta \vdash t [\ol{\alpha := K}][x := s]}^{\mathsf D}$.
Term extensionality for both types and terms --- i.e.,
$\sem{\Gamma;\Phi\vdash (L_\alpha x.t)_\alpha \top : F}^{\mathsf D} =
\sem{\Gamma;\Phi \vdash t : F}^{\mathsf D}$ and
$\sem{\Gamma;\Phi\vdash (L_\alpha x.t)_\alpha x : F}^{\mathsf D} =
\sem{\Gamma;\Phi \vdash t : F}^{\mathsf D}$ --- follow (when both
sides of these equations are defined).

\vspace*{-0.15in}

\section{Free Theorems for Nested Types}\label{sec:ftnt}

\vspace*{-0.1in}

\subsection{Consequences of Naturality}\label{sec:Nat-type-terms}   

\vspace*{-0.1in}

Define, for $\Gamma; \ol{\alpha} \vdash F$, the term $\id_F$ to be
$\Gamma;\emptyset~|~\emptyset \vdash L_{\ol{\alpha}}x.x :
\Nat^{\ol{\alpha}} F\,F$ and, for terms $\Gamma; \emptyset \,|\,
\Delta \vdash t: \Nat^{\overline{\alpha}} F\,G$ and $\Gamma; \emptyset
\,|\, \Delta \vdash s: \Nat^{\overline{\alpha}} G\,H$, the {\em
  composition} $s \circ t$ of $t$ and $s$ to be $\Gamma;
\emptyset\,|\, \Delta \vdash L_{\overline{\alpha}}
x. s_{\overline{\alpha}}(t_{\overline{\alpha}}x):
\Nat^{\overline{\alpha}} F\,H$. Then $\setsem{\Gamma; \emptyset \,|\,
  \emptyset \vdash \id_{F} : \Nat^{\ol{\alpha}} F\,F} \rho\, \ast =
\id_{\lambda \ol{A}. \setsem{\Gamma; \ol{\alpha} \vdash F} \rho
  [\ol{\alpha := A}]}$ for any set environment $\rho$, and
$\setsem{\Gamma; \emptyset \,|\, \Delta \vdash s \circ t:
  \Nat^{\overline{\alpha}} F\,H}\\ = \setsem{\Gamma; \emptyset \,|\,
  \Delta \vdash s: \Nat^{\overline{\alpha}} G\,H} \circ 
\setsem{\Gamma; \emptyset \,|\, \Delta \vdash t:
  \Nat^{\overline{\alpha}} F\,G}$. Also, terms of $\Nat$ type behave
as natural transformations with respect to their source and target
types:

  \vspace*{-0.05in}

\begin{theorem}\label{eq:ft-from-nat} 
  If\, $\Gamma; \emptyset \,|\, \Delta \vdash s : \Nat^{\overline{\alpha},
  \overline{\gamma}} F\,G$ and $\overline{\Gamma; \emptyset \,|\,
  \Delta \vdash t : \Nat^{\overline{\gamma}} K\, H}$, then

    \vspace*{-0.25in}
  
  \[\begin{array}{l}
  \hspace*{0.135in}
\setsem{\Gamma; \emptyset\,|\, \Delta
  \vdash 
  ((\map_G^{\overline{K}, \overline{H}})_\emptyset \,\overline{t}) \circ
(L_{\overline{\gamma}} z. s_{\overline{K}, \overline{\gamma}}
  z)
  : \Nat^{\overline{\gamma}} F[\overline{\alpha := K}]\,
  G[\overline{\alpha := H}]}\\
= \setsem{ \Gamma; \emptyset \,|\, \Delta \vdash
(L_{\overline{\gamma}} z.
  s_{\overline{H}, \overline{\gamma}} z)\circ
  ((\map_F^{\overline{K}, \overline{H}})_\emptyset \,
  \overline{t})  : \Nat^{\overline{\gamma}} F[\overline{\alpha :=
      K}]\, G[\overline{\alpha := H}]}
\end{array}\]
\end{theorem}

\vspace*{-0.1in}
  
\noindent
Theorem~\ref{eq:ft-from-nat} gives rise to an entire family of free
theorems that are consequences of naturality, and thus do not require
the full power of parametricity. In particular, we can prove that the
interpretation of every $\map_H$ is a functor, and that $\map$ is
itself a higher-order functor. For example, the former property can be
stated as: if $\Gamma; \ol\alpha, \ol\gamma \vdash H$, $\ol{\Gamma;
  \emptyset \,|\, \Delta \vdash g : \Nat^{\ol\gamma} F \, G}$, and
$\ol{\Gamma; \emptyset \,|\, \Delta \vdash f : \Nat^{\ol\gamma} G \,
  K}$, then

  \vspace*{-0.2in}
  
  \begin{align*}
&\setsem{
\Gamma; \emptyset \,|\, \Delta \vdash 
  (\map^{\ol{F}, \ol{K}}_H \,)_{\emptyset} \, \ol{(f \circ g)}
  : \Nat^{\ol\gamma} H[\ol{\alpha := F}] \, H[\ol{\alpha := K}]} \\ 
= \hspace{0.03in} 
  &\setsem{
  \Gamma; \emptyset \,|\, \Delta \vdash 
  (\map^{\ol{G}, \ol{K}}_H \,)_{\emptyset} \, \ol{f} \circ 
  (\map^{\ol{F}, \ol{G}}_H \,)_{\emptyset} \, \ol{g}
  : \Nat^{\ol\gamma} H[\ol{\alpha := F}] \, H[\ol{\alpha := K}]}
\end{align*}

    \vspace*{-0.05in}
  
\noindent
We can also prove the expected properties of $\map$, $\tin$, and
$\fold$, and their interpretations, e.g., uniqueness and the universal
property of the interpretation of $\fold$, and the interpretation of
$\tin$ is an isomorphism.

\vspace*{-0.1in}

\subsection{The Abstraction Theorem}\label{sec:thms} 

\vspace*{-0.05in}

To get consequences of parametricity that are not merely consequences
of naturality, we prove an Abstraction Theorem
(Theorem~\ref{thm:abstraction}). As usual for such theorems, we prove
a more general result (Theorem~\ref{thm:at-gen}) for open terms, and
recover our Abstraction Theorem as its special case for closed terms
of closed type.

\vspace*{-0.05in}

\begin{theorem}\label{thm:at-gen}
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : F$ induces a
natural transformation from $\sem{\Gamma; \Phi \vdash \Delta}$ to
$\sem{\Gamma; \Phi \vdash F}$, i.e., a triple of natural
transformations $(\setsem{\Gamma;\Phi~|~\Delta \vdash t : F},\,
\setsem{\Gamma;\Phi~|~\Delta \vdash t : F},\,
\relsem{\Gamma;\Phi~|~\Delta \vdash t : F})$, where, for $\mathsf D
\in \{\set,\rel\}$, and for $\rho \in \setenv$ or $\rho \in \relenv$ as
appropriate, $\sem{\Gamma;\Phi~|~\Delta \vdash t : F}^{\mathsf D} :
\sem{\Gamma; \Phi \vdash \Delta}^{\mathsf D} \to \sem{\Gamma; \Phi
  \vdash F}^{\mathsf D}$ has component $\sem{\Gamma;\Phi~|~\Delta
  \vdash t : F}^{\mathsf D}\rho : \sem{\Gamma; \Phi \vdash
  \Delta}^{\mathsf D}\rho \to \sem{\Gamma; \Phi \vdash F}^{\mathsf
  D}\rho$ at $\rho$. Moreover, for all $\rho \in \relenv$, we have
$\relsem{\Gamma;\Phi~|~\Delta \vdash t : F}\rho =
(\setsem{\Gamma;\Phi~|~\Delta \vdash t : F}(\pi_1 \rho),\,
\setsem{\Gamma;\Phi~|~\Delta \vdash t : F}(\pi_2 \rho))$.

\vspace*{-0.05in}

\end{theorem}
The proof is by induction on $t$. It requires showing that set and
relational interpretations of term judgments are natural
transformations, and that all set interpretations of terms of $\Nat$
types satisfy the appropriate equality preservation conditions from
Figure~\ref{fig:set-sem}.  For the interesting cases of abstraction,
application, $\map$, $\tin$, and $\mathsf{fold}$ terms, propagating
the naturality conditions is quite involved; the latter two especially
require some rather delicate diagram chasing. That it is possible
provides strong evidence that our development is sensible, natural,
and at an appropriate level of abstraction.

Using Theorem~\ref{thm:at-gen} we can prove that our calculus admits
no terms with the type $\Nat^\alpha \onet \,\alpha$ of the polymorphic
bottom, and every closed term $g$ of type $\Nat^\alpha\alpha\,\alpha$
denotes the polymorphic identity function. Moreover, an immediate
consequence of Theorem~\ref{thm:at-gen} is that if $\rho \in \relenv$,
and \,$(a, b) \in \relsem{\Gamma; \Phi \vdash \Delta} \rho$, then
$(\setsem{\Gamma; \Phi \,|\, \Delta \vdash t : F} (\pi_1 \rho) \,a \,
, \setsem{\Gamma; \Phi \,|\, \Delta \vdash t : F } (\pi_2 \rho) \,b)
\in \relsem{\Gamma; \Phi \vdash F} \rho$.  Its instantiation to closed
terms of closed type gives

\begin{theorem}[Abstraction Theorem]\label{thm:abstraction}
  $(\setsem{\vdash t : F},\setsem{\vdash t
  : F}) \in \relsem{\vdash F}$
\end{theorem}

Using Theorem~\ref{thm:abstraction} we can recover free theorems, such
as that for the type of the standard $\mathit{filter}$ function for
lists, that go beyond mere naturality, and extend them to those nested
types for which analogous functions can be defined. In particular, we
can extend short cut fusion for lists~\cite{glp93} to nested types,
thereby formally proving correctness of the categorically inspired
theorem from~\cite{jg10}. As shown there, replacing $\onet$ with any
type $\emptyset;\alpha \vdash C$ generalizes
Theorem~\ref{thm:short-cut-nested} to a free theorem whose conclusion
is $\mathit{fold}_{H}\, B \; \circ \; G\; \mu H \; \mathit{in}_{H} = G
\,\setsem{\emptyset;\alpha \vdash K}\, B$.
\begin{theorem}\label{thm:short-cut-nested}
If $\emptyset;\phi,\alpha \vdash F$, $\emptyset; \alpha
\vdash K$, 
$H : [\set,\set] \to [\set,\set]$ is defined by $H\,f\,x =
\setsem{\emptyset; \phi, \alpha \vdash F}[\phi := f][\alpha := x]$,
and $G = \llbracket \phi;\emptyset\,|\,\emptyset \vdash g :
\Nat^\emptyset\,(\Nat^\alpha\,F\,(\phi\alpha))$ \\
\noindent $(\Nat^\alpha\,\onet \, (\phi\alpha)) \rrbracket^\set$ for
some $g$, then for every $B \in H \setsem{\emptyset;\alpha \vdash K}
\rightarrow \setsem{\emptyset; \alpha \vdash K}$ we have
$\mathit{fold}_{H}\, B \, (G\; \mu H \; \mathit{in}_{H}) = G
\,\setsem{\emptyset;\alpha \vdash K}\, B$.
\end{theorem}

\vspace*{-0.15in}

\section{Conclusion and Directions for Future Work}\label{sec:conclusion}

\vspace*{-0.1in}

We have constructed a parametric model for a calculus supporting
primitive nested types, and used its Abstraction Theorem to derive
free theorems for nested types.  This was not possible
before~\cite{jp19} because these types were not previously known to
have well-defined interpretations in locally finitely presentable
categories (here, $\set$ and $\rel$), and, to our knowledge, no term
calculus for them existed.  We naturally expect the construction
elaborated here to guide its generalization to more advanced data
types.  For example, GADTs can be represented using left Kan
extensions, and it was shown in~\cite{jp19} that adding a
$\mathsf{Lan}$ construct to a calculus such as ours preserves the
$\lambda$-cocontinuity needed for the data types it defines to have
well-defined interpretations in locally $\lambda$-presentable
categories. (Interestingly, $\lambda > \aleph_1$ is required to
interpret even common GADTs.) This suggests carrying out our model
construction in locally $\lambda$-presentable cartesian closed
categories (lpcccs) $\cal C$ whose categories of (abstract) relations,
obtained by pullback as in~\cite{jac99}, are also lpcccs and are
appropriately fibred over $\cal C$.  Adding term-level fixpoints
further requires our semantic categories not just to be locally
$\lambda$-presentable, but also to support some kind of domain
structure.

\pagebreak

\begin{thebibliography}{8}

%\bibitem{amu05} Abel, A., Matthes, R., Uustalu, T.: Iteration and
%  coiteration schemes for higher-order and nested datatypes
%  Theoretical Computer Science 333, 3--66 (2005)

\bibitem{ar94} Ad\'{a}mek, J., Rosick\'{y}, J.: Locally Presentable
  and Accessible Categories.  Cambridge University Press (1994)

\bibitem{atk12} Atkey, R.: Relational Parametricity for Higher Kinds.
  In: Computer Science Logic, pp. 46--61. Schloss
  Dagstuhl--Leibniz-Zentrum fuer Informatik (2012)

\bibitem{bfss90} Bainbridge, E. S., Freyd, P. J., Scedrov, A., Scott, P. J.: 
  Functorial Polymorphism. Theoretical Computer Science 70, 35--64 (1990)

\bibitem{bm98} Bird, R., Meertens, L.: Nested datatypes. 
    In: Mathematics of Program Construction, pp. 52--67. Springer (1998)

\bibitem{bp99} Bird, R., Paterson, R.: Generalised folds for nested datatypes. 
  Formal Aspects of Computing 11, 200--222 (1999)

\bibitem{bm05} Birkedal, L., M{\o}gelberg, R.~E.: 
  Categorical models for {A}badi and {P}lotkin's logic for parametricity.
    Mathematical Structures in Computer Science 15, 709--772 (2005)

\bibitem{car97} Cardelli, L: Type Systems. In: CRC Handbook of
  Computer Science and Engineering, pp. 2208--2236. CRC Press (1984)

\bibitem{dr04} Dunphy, B., Reddy, U.: Parametric Limits.
    In: Logic in Computer Science, pp. 242--252. IEEE (2004)

\bibitem{gjfor15} Ghani, N., Johann, P., Nordvall Forsberg, F.,
  Orsanigo, F., Revell, T.: Bifibrational Functorial Semantics for
  Parametric Polymorphism.  Electronic Notes in Theoretical Computer
  Science 319, 165--181. (2015)

\bibitem{glp93} Gill, A., Launchbury, J., Peyton Jones, S. L.: A short
  cut to deforestation.  In: Functional Programming Languages and
  Computer Architecture, Proceedings, pp. 223--232. Association for
  Computing Machinery (1993)

\bibitem{gir72} Girard, J.-Y.: Interpr\'etation fonctionnelle et
  \'elimination des coupures de l'arithmétique d'ordre sup\'erieur.
  PhD thesis, University of Paris (1972)
    
%\bibitem{gr98} Girard, J.-Y., Taylor, P., Lafont, Y.: Proofs and Types. 
% Cambridge University Press (1989)

\bibitem{has94} Hasegawa, R.: Categorical data types in parametric polymorphism. 
 Mathematical Structures in Computer Science  4,  71--109 (1994)

\bibitem{jac99} Jacobs, B.: Categorical Logic and Type Theory. 
  Elsevier (1999)

\bibitem{joh02} Johann, P.: A Generalization of Short-Cut Fusion and
  Its Correctness Proof.  Higher-Order and Symbolic Computation 15,
  273--300 (2002)

%\bibitem{joh03} Johann, P.: Short cut fusion is correct.
%  Journal of Functional Programming 13,  797--814 (2003)

\bibitem{jg08} Johann, P., Ghani, N.: Foundations for Structured
  Programming with GADTs.  In: Principles of Programming Languages,
  pp. 297--308. Association for Computing Machinery (2008)

\bibitem{jg10} Johann, P., Ghani, N.: Haskell Programming with Nested
  Types: A Principled Approach Higher-Order and Symbolic Computation
  22(2), 155--189 (2010)

\bibitem{jp19} Johann, P., Polonsky, A.: Higher-kinded data types:
  Syntax and Semantics. In: Logic in Computer Science, pp. 1--13. IEEE 
  (2019)

\bibitem{jp20} Johann, P., Polonsky, A.: Deep Induction: Induction
  Rules for (Truly) Nested Types.  In: Foundations of Software Science
  and Computation Structures, pp. 339--358. Springer (2020)

\bibitem{mat11} Matthes, R.: Map Fusion for Nested Datatypes in
  Intensional Type Theory. Science of Computer Programming 76(3),
  204--224 (2011)
    
\bibitem{mr92} Ma, Q., Reynolds, J. C.: Types, abstraction, and
  parametric polymorphism, part 2.  In: Mathematical Foundations of
  Program Semantics, pp. 1--40. Springer-Verlag (1992)

\bibitem{mg01} Martin, C., Gibbons, J.: On the semantics of nested
  datatypes.  Information Processing Letters 80(5), 233--238 (2001)

%\bibitem{oka99} Okasaki, C.: Purely Functional Data
%  Structures. Cambridge University Press (1999)

\bibitem{pit98} Pitts, A.: Parametric polymorphism, recursive types,
  and operational equivalence.  (1998)

\bibitem{pit00} Pitts, A.: Parametric polymorphism and operational equivalence.
  Mathematical Structures in Computer Science 10, 321--359 (2000)

\bibitem{rey83} Reynolds, J. C.: Types, abstraction, and parametric
  polymorphism.  Information Processing 83(1), 513--523 (1983)

\bibitem{rey84} Reynolds, J. C.: Polymorphism is not set-theoretic.
  Semantics of Data Types, 145--156 (1984)

\bibitem{rr94} Robinson, E., Rosolini, G.: Reflexive graphs and
  parametric polymorphism.  In: Logic in Computer Science,
  pp. 364--371. IEEE (1994)

\bibitem{wad89} Wadler, P.: Theorems for free!.  In: Functional
  Programming Languages and Computer Architecture, Proceedings,
  pp. 347--359. Association for Computing Machinery (1989)

\end{thebibliography}

\end{document}


\appendix

\section{Proofs from Section~\ref{sec:iel}}

{\bf Lemma~1.}
If $F,G : [\set^k,\set]$, and if $\alpha : F \to G$ is a natural
transformation, then the {\em graph relation transformer for $\alpha$}
defined by $\graph{\alpha} = (F, G, \graph{\alpha}^*)$ is in $RT_k$.

\begin{proof}
Clearly, $\graph{\alpha}^*$ is $\omega$-cocontinuous, so
$\graph{\alpha}^* : [\rel^k,\rel]$. Now, let $\overline{R :
  \rel(A, B)}$, $\overline{S : \rel(C, D)}$, and $\overline{(\beta,
  \beta') : R \to S}$. We want to show that there exists a morphism
$\epsilon : \alpha^\wedge\overline{R} \to \alpha^\wedge\overline{S}$
such that the following  diagram commutes:
\begin{figure*}[ht]
\vspace*{-0.3in}
  \hspace*{1.5in}
  \begin{minipage}[b]{0.25\linewidth}
 {\small    \[
    \begin{tikzcd}
        \alpha^\wedge\overline{R}
        \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"]
        \ar[d, "{\epsilon}"']
        & F\overline{A} \times G\overline{B}
        \ar[d, "{F\overline{\beta} \times G\overline{\beta'}}"] \\
        \alpha^\wedge\overline{S}
        \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{S}}}"']
        & F\overline{C} \times G\overline{D}
    \end{tikzcd}
    \]}
\end{minipage}\vspace*{-0.3in}
\end{figure*}
\noindent
Since $\ol{(\beta,\beta') : R \to S}$, there exist $\overline{\gamma :
  R \to S}$ such that each diagram on the left below commutes.  Moreover,
since both $h_{\overline{C \times D}} \circ F(\overline{\beta \times
  \beta'})$ and $(F\overline{\beta} \times G\overline{\beta'}) \circ
h_{\overline{A \times B}}$ make the diagram on the right commute, they
must be equal.
\begin{figure*}[ht]
\vspace*{-0.3in}
  \hspace*{0.3in}
\begin{minipage}[b]{0.25\linewidth}
{\small    \[
    \begin{tikzcd}
        R_i
        \ar[d, "{\gamma_i}"']
        \ar[r, hookrightarrow, "{\iota_{R_i}}"]
        &A_i \times B_i
        \ar[d, "{\beta_i \times \beta'_i}"] \\
        S_i
        \ar[r, hookrightarrow, "{\iota_{S_i}}"]
        &C_i \times D_i
    \end{tikzcd}
    \]}
\end{minipage}\hspace*{0.3in}
\begin{minipage}[b]{0.25\linewidth}
{\footnotesize \[
      \begin{tikzcd}[row sep = large]
          F\overline{C}
          &F\overline{C} \times F\overline{D}
          \ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
          &F\overline{D}
          \ar[r, "{\alpha_{\ol{D}}}"]
          &G\overline{D}\\
          &F(\overline{A \times B})
          \ar[u, dashed, "{\exists !}"]
          \ar[ul, "{F\ol{\pi_1} \circ F(\overline{\beta \times \beta'})}"]
          \ar[urr, "{\alpha_{\ol{D}} \circ F\ol{\pi_2} \circ F(\overline{\beta \times \beta'})}"']
      \end{tikzcd}
      \]}
\end{minipage}
\end{figure*}

\vspace*{-0.3in}

\noindent
We therefore get that the right-hand square in the diagram on the left
below commutes, and thus that the entire diagram does as well.
Finally, by the left-lifting property of
$q_{\alpha^\wedge\overline{R}}$ with respect to
$\iota_{\alpha^\wedge\overline{S}}$ given by the mono-epi
factorization system, there exists an $\epsilon$ such that the diagram
on the right below commutes.

\begin{figure*}[h]
  \vspace*{-0.1in}
  \hspace*{-0.2in}
  \begin{minipage}[b]{0.45\linewidth}
{\footnotesize \[
      \begin{tikzcd}
          F\overline{R}
          \ar[d, "{F\overline{\gamma}}"']
          \ar[r, hookrightarrow, "{F\overline{\iota_R}}"]
          \ar[rr, bend left, "{h_{\overline{R}}}"]
          &F(\overline{A \times B})
          \ar[d, "{F(\overline{\beta \times \beta'})}"]
          \ar[r, "{h_{\overline{A \times B}}}"]
          &F\overline{A} \times G\overline{B}
          \ar[d, "{F\overline{\beta} \times F\overline{\beta'}}"] \\
          F\overline{S}
          \ar[r, hookrightarrow, "{F\overline{\iota_S}}"']
          \ar[rr, bend right, "{h_{\overline{S}}}"']
          &F(\overline{C \times D})
          \ar[r, "{h_{\overline{C \times D}}}"']
          &F\overline{C} \times G\overline{D}
      \end{tikzcd}
      \]}
\end{minipage}\hspace*{0.3in}
  \vspace*{-0.5in}
  \begin{minipage}[b]{0.45\linewidth}
      {\footnotesize
        \[  \vspace*{0.4in}
      \begin{tikzcd}
          F\overline{R}
          \ar[d, "{F\overline{\gamma}}"']
          \ar[r, twoheadrightarrow, "{q_{\alpha^\wedge\overline{R}}}"]
          &\alpha^\wedge\overline{R}
          \ar[d, dashed, "{\epsilon}"]
          \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"]
          &F\overline{A} \times G\overline{B}
          \ar[d, "{F\overline{\beta} \times G\overline{\beta'}}"] \\
          F\overline{S}
          \ar[r, twoheadrightarrow, "{q_{\alpha^\wedge\overline{S}}}"']
          &\alpha^\wedge\overline{S}
          \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{S}}}"']
          &F\overline{C} \times G\overline{D}
      \end{tikzcd}
      \]}
\end{minipage}
\end{figure*}
\end{proof}

\pagebreak

\vspace*{0.2in}

\noindent
{\bf Lemma}
If $\alpha : F \to G$ is a morphism in $[\Set^k, \Set]$
and $f_1: A_1 \to B_1, ..., f_k : A_k \to B_k$,
then $\graph{\alpha}^* \graph{\overline{f}}
= \langle G \ol{f} \circ \alpha_{\ol{A}} \rangle
= \langle \alpha_{\ol{B}} \circ F \ol{f} \rangle$.


\begin{proof}
Since $h_{\overline{A \times B}}$ is the unique morphism making the
bottom triangle of the diagram on the left below commute, and since
$h_{\graph{\overline{f}}} = h_{\overline{A \times B}} \circ F
\,\ol{\iota_{\graph{f}}} = h_{\overline{A \times B}} \circ F
\overline{\langle \id_A, f \rangle}$, the universal property of the
product depicted in the diagram on the right gives
$h_{\graph{\overline{f}}} = \langle \id_{F \ol{A}}, \alpha_{\ol{B}}
\circ F\ol{f} \rangle : F \ol{A} \to F \ol{A} \times G \ol{B}$.

\begin{figure*}[h]
  \vspace*{-0.15in}
%  \hspace*{-0.5in}
  \begin{minipage}[b]{0.45\linewidth}
{\footnotesize
\[\begin{tikzcd}[row sep = large]
        &F\overline{A}
        \ar[d, "{F \overline{\langle \id_A, f \rangle}}" description]
        \ar[dl, equal]
        \ar[dr, "{F\ol{f}}"]\\
        F\overline{A}
        &F(\overline{A \times B})
        \ar[l, "{F\overline{\pi_1}}"']
        \ar[r, "{F\overline{\pi_2}}"]
        \ar[d, "{h_{\overline{A \times B}}}"]
        &F\overline{B}
        \ar[r, "{\alpha_{\ol{B}}}"]
        &G\overline{B}\\
        &F\overline{A} \times G\overline{B}
        \ar[ul, "{\pi_1}"] \ar[urr, "{\pi_2}"']
\end{tikzcd}\]}
\end{minipage}
  \hspace*{0.5in}
  \begin{minipage}[b]{0.45\linewidth}
{\footnotesize
\[
      \begin{tikzcd}[row sep = large]
          F\overline{A}
          &F\overline{A} \times G\overline{B}
          \ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
          &G\overline{B}\\
          &F\overline{A}
          \ar[u, dashed, "{\exists !}"]
          \ar[ul, equal]
          \ar[r, "{F\ol{f}}"']
          &F{\ol{B}}
          \ar[u, "{\alpha_{\ol{B}}}"']
      \end{tikzcd}
      \]}
\end{minipage}
\end{figure*}

\vspace*{-0.1in}

\noindent
Moreover, $\langle \id_{F \ol{A}}, \alpha_{\ol{B}} \circ
F\ol{f} \rangle$ is a monomorphism in $\set$ because $\id_{F \ol{A}}$
is, so its mono-epi factorization gives $\iota_{\alpha^\wedge
  \graph{\overline{f}}} = \langle \id_{F \ol{A}}, \alpha_{\ol{B}}
\circ F\ol{f} \rangle$, and thus $\alpha^\wedge \graph{\overline{f}} =
F\overline{A}$.  Then $\iota_{\alpha^\wedge
  \graph{\overline{f}}} \alpha^\wedge \graph{\overline{f}} = \langle
\id_{F \ol{A}}, \alpha_{\ol{B}} \circ F\ol{f} \rangle (F \ol{A}) =
\graph{ \alpha_{\ol{B}} \circ F\ol{f} }^*$,
so that $\graph{ \alpha }^* \graph{ \overline{f} } = (F\overline{A},
G\overline{B}, \iota_{\alpha^\wedge \graph{\overline{f}}}\,
\alpha^\wedge \graph{\overline{f}}) = (F\overline{A}, G\overline{B},
\graph{ \alpha_{\ol{B}} \circ F\ol{f} }^*) = \graph{ \alpha_{\ol{B}}
  \circ F\ol{f} }$.  Finally, $\alpha_{\ol{B}} \circ F\ol{f} = G\ol{f}
\circ \alpha_{\ol{A}}$ by naturality of $\alpha$.
\end{proof}
    

\vspace{0.1in}

\noindent
{\bf Theorem 1.}  If $\rho \in \setenv$, then $\relsem{\Gamma; \Phi
  \vdash F} \Eq_\rho = \Eq_{\setsem{\Gamma; \Phi \vdash F}\rho}$.

\begin{proof}
By induction on $F$.
\begin{itemize}
\item $\relsem{\Gamma; \Phi \vdash \zerot} \Eq_{\rho} = 0_\rel =
  \Eq_{0_\set} = \Eq_{\setsem{\Gamma; \Phi \vdash \zerot}\rho}$
\item $\relsem{\Gamma; \Phi \vdash \onet} \Eq_{\rho} = 1_\rel =
  \Eq_{1_\set} = \Eq_{\setsem{\Gamma; \Phi \vdash \onet}\rho}$

\item
By definition, $\relsem{\Gamma; \emptyset \vdash
  \Nat^{\overline\alpha} \,F\,G} \Eq_{\rho}$ is the relation on
  $\setsem{\Gamma; \emptyset \vdash \Nat^{\overline\alpha} \,F\,G}
  \rho$ relating $t$ and $t'$ if, for all ${R_1 :
    \rel(A_1,B_1)},...,{R_k : \rel(A_k,B_k)}$, $(t_{\overline{A}},
  t'_{\overline{B}})$ is a morphism from $\relsem{\Gamma;
    \overline\alpha \vdash F} \Eq_{\rho}\overline{[\alpha := R]}$ to
  $\relsem{\Gamma ; \overline\alpha \vdash G}
  \Eq_{\rho}\overline{[\alpha := R]}$ in $\rel$.  To prove that this
  is equal to $\Eq_{\setsem{\Gamma; \emptyset \vdash
      \Nat^{\overline\alpha} \,F\,G} \rho}$ we need to show that
  $(t_{\overline{A}}, t'_{\overline{B}})$ is a morphism from
  $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ;
  \overline\alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in
  $\rel$ for all ${R_1 : \rel(A_1,B_1)},...,{R_k : \rel(A_k,B_k)}$ if
  and only if $t = t'$ and $(t_{\overline{A}}, t_{\overline{B}})$ is a
  morphism from $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ; \overline
    \alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in $\rel$ for
  all ${R_1 : \rel(A_1,B_1)}, ...,$ ${R_k : \rel(A_k,B_k)}$. The only
  interesting part of this equivalence is to show if
  $(t_{\overline{A}}, t'_{\overline{B}})$ is a morphism from
  $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ;
    \overline\alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in
  $\rel$ for all ${R_1 : \rel(A_1,B_1),}$ $...,{R_k : \rel(A_k,B_k)}$,
  then $t = t'$.  By hypothesis, $(t_{\overline{A}},
  t'_{\overline{A}})$ is a morphism from $\relsem{\Gamma;
    \overline\alpha \vdash F} \Eq_{\rho}\overline{[\alpha :=
      \Eq_{A}]}$ to $\relsem{\Gamma ; \overline\alpha \vdash G}
  \Eq_{\rho}\overline{[\alpha := \Eq_{A}]}$ in $\rel$ for all
  $A_1\,...\,A_k : \set$. By the induction hypothesis, it is therefore
  a morphism in $\rel$ from $\Eq_{\setsem{\Gamma; \overline\alpha \vdash F}
    \rho\overline{[\alpha := A]}}$ to $\Eq_{\setsem{\Gamma;
      \overline\alpha \vdash G} \rho\overline{[\alpha := A]}}$.
   This means that, for every $x : \Eq_{\setsem{\Gamma;
      \overline\alpha \vdash F} \rho\overline{[\alpha := A]}}$,
  $t_{\overline{A}}x = t'_{\overline{A}}x$.  Then, by extensionality,
  $t = t'$.

\item The application case is proved by the following sequence of
  equalities, where the second equality is by the induction hypothesis
  and the definition of the relation environment $\Eq_\rho$, the third
  is by the definition of application of relation transformers 
  and the fourth is by the action of equality relation transformers:
\[
\begin{split}
\relsem{\Gamma; \Phi \vdash \phi\ol{F}}\Eq_{\rho} &=
(\Eq_{\rho}\phi)\ol{\relsem{\Gamma; \Phi \vdash F}
\Eq_{\rho}}\\
&= \Eq_{\rho \phi}\, \ol{\Eq_{\setsem{\Gamma; \Phi \vdash F}
  \rho}}\\
&= (\Eq_{\rho \phi})^* \,\ol{\Eq_{\setsem{\Gamma; \Phi \vdash F}
  \rho}}\\
&= \Eq_{(\rho \phi) \,\ol{\setsem{\Gamma; \Phi \vdash F} \rho}}\\
&= \Eq_{\setsem{\Gamma; \Phi \vdash \phi\ol{F}}\rho}
\end{split}
\]
\item 
  The fixpoint case is proven by the sequence of equalities
\[
\begin{split}
\relsem{\Gamma; \Phi, \ol\gamma \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{F}}\Eq_{\rho} 
&=(\mu {T_{H, \Eq_{\rho}}}) \,\ol{\relsem{\Gamma; \Phi, \ol\gamma  \vdash F}\Eq_{\rho}}\\ 
&= \colim{n \in \nat}{T^n_{H, \Eq_{\rho}} K_0}\, \ol{\relsem{\Gamma; \Phi, \ol\gamma 
  \vdash F}\Eq_{\rho}}\\
&= \colim{n \in \nat}{ T^n_{H, \Eq_{\rho}} K_0 \,\ol{\Eq_{\setsem{\Gamma;
    \Phi, \ol\gamma  \vdash F}\rho}}}\\
&= \colim{n \in \nat}{(\Eq_{(T^\set_{H,\rho})^n K_0})^*
  \ol{\Eq_{\setsem{\Gamma; \Phi, \ol\gamma  \vdash F}\rho}}}\\
&= \colim{n \in \nat}{\Eq_{(T^\set_{H,\rho})^n K_0 \,\ol{\setsem{\Gamma;
        \Phi, \ol\gamma  \vdash F}\rho}}}\\ 
&= \Eq_{\colim{n \in \nat}{ (T^\set_{H,\rho})^n K_0\,
    \ol{\setsem{\Gamma; \Phi, \ol\gamma  \vdash F}\rho}}}\\
&= \Eq_{\setsem{\Gamma; \Phi, \ol\gamma  \vdash (\mu \phi.\lambda
      \ol{\alpha}. H)\ol{F}}\rho}
\end{split}
\]
Here, the third equality is by induction hypothesis, the fifth is by
the action of equality relation transformers and the fourth equality is
because, for every $n \in \nat$, the following two statements can be
proved by simultaneous induction: and for any $H$, $\rho$, $\ol{A}$, and
subformula $J$ of $H$,
\begin{equation}\label{eq:iel-fix-point-intermediate1}
T^n_{H, \Eq_{\rho}} K_0\, \ol{\Eq_A} = (\Eq_{(T^\set_{H, \rho})^n K_0})^*
\ol{\Eq_A}
\end{equation}
and 
\begin{equation}\label{eq:iel-fix-point-intermediate2}
\begin{split}
  \relsem{\Gamma; \Phi', \phi, \ol{\alpha} \vdash J}
\Eq_{\rho} [\phi := 
 & T^{n}_{H,\Eq_{\rho}} K_0] \overline{[\alpha :=
    \Eq_A]} \\
=\;\; & \relsem{\Gamma; \Phi', \phi, \ol{\alpha} \vdash J} \Eq_{\rho} [\phi
  := \Eq_{(T^\set_{H,\rho})^n K_0}] \overline{[\alpha :=
    \Eq_A]}
\end{split}
\end{equation}
(Notice that we don't know what's in the context $\Phi'$.)
We prove~\eqref{eq:iel-fix-point-intermediate1} by induction on $n$.
The case $n=0$ is trivial, because $T^0_{H,\Eq_{\rho}} K_0 = K_0$ and
$(T^\set_{H,\rho})^0 K_0 = K_0$; the inductive step is proved by the
following sequence of equalities:
\[
\begin{split}
T^{n+1}_{H,\Eq_{\rho}} K_0\, \overline{\Eq_A}
&= T^\rel_{H,\Eq_{\rho}} (T^{n}_{H,\Eq_{\rho}} K_0)
\overline{\Eq_A} \\ 
&= \relsem{\Gamma; \phi, \ol{\alpha}, \ol\gamma \vdash H} \Eq_{\rho} [\phi
  := T^{n}_{H, \Eq_{\rho}} K_0] \overline{[\alpha :=
    \Eq_A]} \\ 
&= \relsem{\Gamma; \phi, \ol{\alpha}, \ol\gamma \vdash H} \Eq_{\rho} [\phi
  := \Eq_{(T^\set_{H,\rho})^n K_0}] \overline{[\alpha :=
    \Eq_A]} \\ 
&= \relsem{\Gamma; \phi, \ol{\alpha}, \ol\gamma \vdash H} \Eq_{\rho [\phi
    := (T^\set_{H,\rho})^n K_0] \overline{[\alpha :=
      A]}} \\ 
&= \Eq_{\setsem{\Gamma; \phi, \ol{\alpha}, \ol\gamma \vdash H} \rho [\phi
    := (T^\set_{H,\rho})^n K_0] \overline{[\alpha :=
      A]}} \\ 
&= \Eq_{(T^\set_{H,\rho})^{n+1} K_0 \overline{A}} \\ 
&= (\Eq_{(T^\set_{H,\rho})^{n+1} K_0})^*\, \overline{\Eq_A} 
\end{split}
\]
Here, the third equality is by~\eqref{eq:iel-fix-point-intermediate2}
for $J = H$, the fifth by the induction hypothesis of the IEL on $H$,
and the last is by the action of equality relation transformers.

\vspace*{0.1in}

We prove~\eqref{eq:iel-fix-point-intermediate2} by structural
induction on $J$. The only interesting cases, though, are when
$J = \phi \ol{G}$ and when $J = (\mu \psi.\lambda \ol\beta. G)\ol K$.
\begin{itemize}
\item The case $J = \phi \ol G$ is proved by the sequence of equalities:
\[
\begin{split}
& \relsem{\Gamma; \Phi', \phi, \ol{\alpha} \vdash \phi
    \ol{G}} \Eq_{\rho} [\phi := T^{n}_{H,\Eq_{\rho}} K_0]
  \overline{[\alpha := \Eq_A]}
  \\
&= T^{n}_{H,\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi',
      \phi, \ol{\alpha} \vdash G} \Eq_{\rho} [\phi :=
      T^{n}_{H,\Eq_{\rho}} K_0] \overline{[\alpha :=
        \Eq_A]}} \\ 
&= T^{n}_{H,\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi',
      \phi, \ol{\alpha} \vdash G} \Eq_{\rho} [\phi :=
      \Eq_{(T^\set_{H,\rho})^{n} K_0}] \overline{[\alpha :=
        \Eq_A]}} \\ 
&= T^{n}_{H,\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi',
      \phi, \ol{\alpha} \vdash G} \Eq_{\rho [\phi := (T^\set_{H,\rho})^{n}
        K_0] \overline{[\alpha := A]}}} \\ 
&= T^{n}_{H,\Eq_{\rho}} K_0\, \overline{\Eq_{\setsem{\Gamma;
        \Phi', \phi, \ol{\alpha} \vdash G} \rho [\phi :=
        (T^\set_{H,\rho})^{n} K_0] \overline{[\alpha :=
          A]}}} \\ 
&= (\Eq_{(T^\set_{H,\rho})^{n} K_0})^* \,\overline{\Eq_{\setsem{\Gamma;
        \Phi', \phi, \ol{\alpha} \vdash G} \rho [\phi :=
        (T^\set_{H,\rho})^{n} K_0] \overline{[\alpha :=
          A]}}} \\ 
&= (\Eq_{(T^\set_{H,\rho})^{n} K_0})^* \overline{\relsem{\Gamma;
      \Phi', \phi, \ol{\alpha} \vdash G} \Eq_{\rho} [\phi :=
      \Eq_{(T^\set_{H,\rho})^{n} K_0}] \overline{[\alpha :=
        \Eq_A]}} \\ 
&= \relsem{\Gamma; \Phi', \phi, \ol{\alpha} \vdash \phi \ol{G}}
  \Eq_{\rho} [\phi := \Eq_{(T^\set_{H,\rho})^{n} K_0}]
  \overline{[\alpha := \Eq_A]} 
\end{split}
\]
Here, the second equality is by the induction hypothesis
for~\eqref{eq:iel-fix-point-intermediate2} on the $G$s, the fourth is
by the induction hypothesis for the IEL on the $G$s, and the fifth is
by the induction hypothesis on $n$
for~\eqref{eq:iel-fix-point-intermediate1}.

\item 
  The case $J = (\mu \psi.\, \lambda \ol{\beta}.\, G) \ol{K}$
is proved by the sequence of equalities (where $\Phi' = \Phi'', \ol\gamma$):
\[
\begin{split}
& \relsem{\Gamma; \Phi'', \ol\gamma, \phi, \ol{\alpha} \vdash (\mu \psi.\, \lambda \ol{\beta}.\, G) \ol{K}}
  \Eq_{\rho} [\phi := T^{n}_{H,\Eq_{\rho}} K_0]
  [\overline{\alpha := \Eq_A}] \\
&= (\mu {T_{G, \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha := \Eq_A}]}}) \\
  &\hspace*{1in} 
  \,\ol{\relsem{\Gamma; \Phi'', \ol\gamma, \phi, \ol{\alpha} \vdash K}\Eq_{\rho}
  [\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha := \Eq_A}]} \\ 
&= \colim{m \in \nat} {T^m_{G, \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha := \Eq_A}]}}\,K_0 \\
  \, 
  &\hspace*{1in} 
  (\ol{\relsem{\Gamma; \Phi'', \ol\gamma, \phi, \ol{\alpha} \vdash K}\Eq_{\rho}
  [\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha := \Eq_A}]}) \\ 
&= \colim{m \in \nat} {T^m_{G, \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha := \Eq_A}]}}\,K_0 \\
  \,
  &\hspace*{1in} 
  (\ol{\relsem{\Gamma; \Phi'', \ol\gamma, \phi, \ol{\alpha} \vdash K}\Eq_{\rho}
  [\phi := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha := \Eq_A}]}) \\  %%
&= \colim{m \in \nat} {T^m_{G, \Eq_{\rho}[\phi := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha := \Eq_A}]}}\,K_0 \\
  \, 
  &\hspace*{1in} 
  (\ol{\relsem{\Gamma; \Phi'', \ol\gamma, \phi, \ol{\alpha} \vdash K}\Eq_{\rho}
  [\phi := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha := \Eq_A}]}) \\ 
&= (\mu {T_{G, \Eq_{\rho}[\phi := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha := \Eq_A}]}}) \\
  \, 
  &\hspace*{1in} 
  \ol{\relsem{\Gamma; \Phi'', \ol\gamma, \phi, \ol{\alpha} \vdash K}\Eq_{\rho}
  [\phi := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha := \Eq_A}]} \\ 
&= \relsem{\Gamma; \Phi'', \ol\gamma, \phi, \ol{\alpha} \vdash (\mu \psi.\, \lambda \beta.\, G) \ol{K}} 
  \Eq_{\rho}[\phi := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha := \Eq_{A}}]
\end{split}
\]
Here, the third equality is by the induction hypothesis
for~\eqref{eq:iel-fix-point-intermediate2} on the $K$s, and the fourth
equality holds because we can prove that, for all $m \in \nat$,
\begin{equation}\label{eq:helper}
T^m_{G,
\Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha :=
    \Eq_A}]}\,K_0 \ = T^m_{G, \Eq_{\rho}[\phi :=
    \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha :=
      \Eq_A}]}\,K_0
\end{equation}
Indeed, the base case of~\eqref{eq:helper} is trivial because
\[T^0_{G,
  \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha :=
      \Eq_A}]}\,K_0 \ = K_0 = T^0_{G, \Eq_{\rho}[\phi :=
    \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha :=
      \Eq_A}]}\,K_0\]
and the inductive case is proved by: \\
\begin{align*}
& T^{m+1}_{G, \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha := \Eq_A}]}\,K_0 \\
&= T_{G, \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha
        := \Eq_A}]} (T^{m}_{G, \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}}
      K_0][\overline{\alpha := \Eq_A}]}\,K_0) \\
&= T_{G, \Eq_{\rho}[\phi := T^{n}_{H,\Eq_{\rho}} K_0][\overline{\alpha
        := \Eq_A}]} (T^{m}_{G, \Eq_{\rho}[\phi :=
      \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha :=
        \Eq_A}]}\,K_0) \\
&= \lambda \ol{R}. \relsem{\Gamma; \ol\gamma, \phi, \ol\alpha, \psi,
    \ol\beta \vdash G} \Eq_{\rho} [\phi := T^{n}_{H,\Eq_{\rho}}
    K_0][\overline{\alpha := \Eq_A}] \\
    &\hspace{1in} [\psi := T^{m}_{G, \Eq_{\rho}[\phi
        := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha :=
          \Eq_A}]}\,K_0][\overline{\beta := R}] \\
&= \lambda \ol{R}. \relsem{\Gamma; \ol\gamma, \phi, \ol\alpha, \psi,
    \ol\beta \vdash G} \Eq_{\rho} [\phi := \Eq_{(T^{\set}_{H,\rho})^n
      K_0}][\overline{\alpha := \Eq_A}] \\
      &\hspace{1in} [\psi := T^{m}_{G,
      \Eq_{\rho}[\phi := \Eq_{(T^{\set}_{H,\rho})^n
          K_0}][\overline{\alpha := \Eq_A}]}\,K_0][\overline{\beta :=
      R}] \\
&= T_{G, \Eq_{\rho}[\phi := \Eq_{(T^{\set}_{H,\rho})^n
        K_0}][\overline{\alpha := \Eq_A}]} (T^{m}_{G, \Eq_{\rho}[\phi
      := \Eq_{(T^{\set}_{H,\rho})^n K_0}][\overline{\alpha :=
        \Eq_A}]}\,K_0) \\
&= T^{m+1}_{G, \Eq_{\rho}[\phi := \Eq_{(T^{\set}_{H,\rho})^n
        K_0}][\overline{\alpha := \Eq_A}]}\,K_0
\end{align*}

Here, the second equality holds by the induction hypothesis
for~\eqref{eq:helper} on $m$. The fourth equality holds because, due
to typing rule restrictions for the $\mu$ types, $\phi$ either does
not appear in $G$, or must have arity $0$ if it does. If $\phi$ does
not appear in $G$, then the equality clearly holds. If $\phi$ has
arity 0, then $\ol\alpha$ must be empty, so the equality holds
by~\eqref{eq:iel-fix-point-intermediate1}.
\end{itemize}
\item $\relsem{\Gamma; \Phi \vdash F + G} \Eq_{\rho} =
  \relsem{\Gamma; \Phi \vdash F} \Eq_{\rho} + \relsem{\Gamma;
    \Phi \vdash G} \Eq_{\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash
      F}\rho} + \Eq_{\setsem{\Gamma; \Phi \vdash G}\rho} =
  \Eq_{\setsem{\Gamma; \Phi \vdash F}\rho + \setsem{\Gamma; \Phi
      \vdash G}\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash F +
      G}\rho}$
\item $\relsem{\Gamma; \Phi \vdash F \times G} \Eq_{\rho} =
  \relsem{\Gamma; \Phi \vdash F}\Eq_{\rho} \times \relsem{\Gamma;
    \Phi \vdash G}\Eq_{\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash
      F}\rho} \times \Eq_{\setsem{\Gamma; \Phi \vdash G}\rho}
  = \Eq_{\setsem{\Gamma; \Phi \vdash F}\rho \times
    \setsem{\Gamma; \Phi \vdash G}\rho} = \Eq_{\setsem{\Gamma;
      \Phi \vdash F \times G}\rho}$
\end{itemize}
\end{proof}

\section{Proofs from Section~\ref{sec:term-interp}}

\noindent
{\bf Theorem 3.}
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : F$ induces a
natural transformation from $\sem{\Gamma; \Phi \vdash \Delta}$ to
$\sem{\Gamma; \Phi \vdash F}$, i.e., a triple of natural
transformations $(\setsem{\Gamma;\Phi~|~\Delta \vdash t : F},\,
\setsem{\Gamma;\Phi~|~\Delta \vdash t : F},\,
\relsem{\Gamma;\Phi~|~\Delta \vdash t : F})$, where, for $\mathsf D
\in \{\set,\rel\}$, and for $\rho \in \setenv$ or $\rho \in \relenv$ as
appropriate, $\sem{\Gamma;\Phi~|~\Delta \vdash t : F}^{\mathsf D} :
\sem{\Gamma; \Phi \vdash \Delta}^{\mathsf D} \to \sem{\Gamma; \Phi
  \vdash F}^{\mathsf D}$ has component $\sem{\Gamma;\Phi~|~\Delta
  \vdash t : F}^{\mathsf D}\rho : \sem{\Gamma; \Phi \vdash
  \Delta}^{\mathsf D}\rho \to \sem{\Gamma; \Phi \vdash F}^{\mathsf
  D}\rho$ at $\rho$. Moreover, for all $\rho \in \relenv$, we have
%\begin{equation}\label{eq:projs}
$\relsem{\Gamma;\Phi~|~\Delta \vdash t : F}\rho =
(\setsem{\Gamma;\Phi~|~\Delta \vdash t : F}(\pi_1 \rho),\,
\setsem{\Gamma;\Phi~|~\Delta \vdash t : F}(\pi_2 \rho))$.
%\end{equation}

\begin{proof}


By induction on $t$. The only interesting cases are the cases for
abstraction, application, $\map$, $\tin$, and $\fold$ so we omit the
others.   
\begin{itemize}


\item 
$\underline{\Gamma; \emptyset \,|\, \Delta \vdash
  L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G}$ \; To
  see that $\setsem{\Gamma; \emptyset \,|\, \Delta \vdash
    L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G}$ is
  a natural transformation from $\setsem{\Gamma; \emptyset \vdash
    \Delta}$ to $\setsem{\Gamma; \emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}$ we need to show that, for every
  $\rho : \setenv$, $\setsem{\Gamma; \emptyset \,|\, \Delta \vdash
    L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho$
  is a morphism in $\set$ from $\setsem{\Gamma; \emptyset \vdash
    \Delta}\rho$ to $\setsem{\Gamma; \emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}\rho$, and that such a family of
  morphisms is natural.  First, we need to show that, for all $\ol{A :
    \set}$ and all $d : \setsem{\Gamma; \emptyset \vdash \Delta}\rho =
  \setsem{\Gamma; \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha :=
      A}]$, we have that
  \begin{align*}
      &(\setsem{\Gamma; \emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
      x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho\,d)_{\ol{A}} :  \\
      &\hspace{1in} \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\overline{\alpha := A}]
    \to \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\overline{\alpha :=
        A}]
  \end{align*}
      but this follows easily from the induction hypothesis.
That these maps comprise a natural transformation $\eta :
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\overline{\alpha := \_}] \to
\setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\overline{\alpha := \_}]$ is
clear since $\eta_{\ol{A}} \, = \, \curry\,
(\setsem{\Gamma; \overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := A}])\,d$ is the component at $\ol{A}$ of
the partial specialization to $d$ of the natural transformation
$$\setsem{\Gamma; \overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := \_}]$$  To see that the components of
$\eta$ also satisfy the additional condition needed for $\eta$ to
be in $\setsem{\Gamma; \emptyset \vdash \Nat^{\overline{\alpha}} \,F
  \,G}\rho$, let $\overline{R : \rel(A, B)}$ and suppose
\[\begin{array}{lll}
(u, v) &  \in & \relsem{\Gamma;\overline{\alpha} \vdash F}
\Eq_{\rho}[\overline{\alpha := R}]\\
&  = & (\setsem{\Gamma;\overline{\alpha} \vdash F}
\rho[\overline{\alpha := A}], \\ 
  & &\,\,\setsem{\Gamma;\overline{\alpha} \vdash
  F} \rho[\overline{\alpha := B}],
(\relsem{\Gamma;\overline{\alpha} \vdash F}
\Eq_{\rho}[\overline{\alpha := R}])^*)
\end{array}\]
Then the induction hypothesis and the fact that 
$(d,d) \in \relsem{\Gamma; \emptyset \vdash \Delta} \Eq_\rho =
\relsem{\Gamma; \emptyset \vdash \Delta} \Eq_\rho[\ol{\alpha := R}]$
ensure that
\[\begin{array}{ll}
& (\eta_{\ol{A}}u,\eta_{\ol{B}}v)\\
= & (\curry\, (\setsem{\Gamma; \overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\rho[\overline{\alpha := A}])\,d\,u, \\
  &\hspace{0.5in} \curry\,
(\setsem{\Gamma; \overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := B}])\,d\,v)\\
= & \curry\, (\relsem{\Gamma; \overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\Eq_\rho[\overline{\alpha := R}])\,(d,d)\,(u,v)\\
: & \relsem{\Gamma; \overline{\alpha} \vdash G}
\Eq_{\rho}[\overline{\alpha := R}]  
\end{array}\]
Moreover,
$\setsem{\Gamma; \emptyset \,|\, \Delta \vdash L_{\overline{\alpha}} x.t
: \Nat^{\overline{\alpha}} \,F \,G} \rho$
is trivially natural in $\rho$,
as the functorial action of
$\setsem{\Gamma; \emptyset \vdash \Delta}$
and $\setsem{\Gamma; \emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}$
on morphisms is the identity.
  
\item 
$\underline{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline K} s: G
  [\overline{\alpha := K}]}$\; 
  To see that $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash t_{\overline K} s: G [\overline{\alpha := K}]}$ is a
  natural transformation from $\setsem{\Gamma; \Phi \vdash \Delta}$ to
  $\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := K}]}$ we must
  show that, for every $\rho : \setenv$, $\setsem{\Gamma;\Phi \,|\,
    \Delta \vdash t_{\overline K} s: G [\overline{\alpha := K}]}\rho$
  is a morphism from $\setsem{\Gamma; \Phi \vdash \Delta}\rho$ to
  $\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := K}]}\rho$, and
  that this family of morphisms is natural in $\rho$. Let $d :
  \setsem{\Gamma; \Phi \vdash \Delta}\rho$. Then
  \[\begin{array}{ll}
  & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline K} s: G
  [\overline{\alpha := K}]}\,\rho\,d\\
= & (\eval \circ \langle (\setsem{\Gamma; \emptyset \,|\, \Delta \vdash
  t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\setsem{\Gamma;\Phi \vdash K}\rho}},\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      K}]}\rho \rangle)\,d\\
= & \eval ((\setsem{\Gamma; \emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\setsem{\Gamma;\Phi \vdash K}\rho}} \,d,\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      K}]}\rho\, d)\\
= & \eval ((\setsem{\Gamma; \emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\;
d)_{\overline{\setsem{\Gamma;\Phi \vdash K}\rho}},\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      K}]}\rho\, d)\\
\end{array}\]
The induction hypothesis ensures that $(\setsem{\Gamma; \emptyset \,|\,
  \Delta \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\,
d)_{\overline{\setsem{\Gamma;\Phi \vdash K}\rho}}$ has type
$\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash K}\rho}] \to \setsem{\Gamma;
  \ol{\alpha} \vdash G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      K}\rho}]$.  Since, in addition, 
\[\begin{array}{ll}
  &\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash s: F [\overline{\alpha := K}]}\rho\, d :
\setsem{\Gamma; \Phi \vdash F[\ol{\alpha := K}]}\rho \\ 
  =&\setsem{\Gamma; \Phi, \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash K}\rho}] \\
    =& \setsem{\Gamma;
  \ol{\alpha} \vdash F}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      K}\rho}] 
\end{array}\]
      we have that 
\[\begin{array}{ll}
  &\setsem{\Gamma;\Phi \,|\, \Delta
  \vdash t_{\overline K} s: G [\overline{\alpha :=
      K}]}\,\rho\,d : \setsem{\Gamma; \Phi ,\ol{\alpha} \vdash
  G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash K}\rho}]  \\
  =&\setsem{\Gamma; \Phi \vdash G[\ol{\alpha := K}]}\rho
\end{array}\]
as desired.

\vspace*{0.1in}

To see that the family of maps comprising $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash t_{\overline K} s: G [\overline{\alpha := K}]}$
is natural in $\rho$
we need to show that, if $f : \rho \to \rho'$ in $\setenv$, then the
following diagram commutes, where $g = \setsem{\Gamma; \emptyset \,|\,
  \Delta \vdash t : \Nat^{\overline{\alpha}} \,F \,G}$ and $h =
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      K}]}$:
{\footnotesize
\[\hspace*{-0.6in}
\begin{tikzcd}
\setsem{\Gamma;\Phi \vdash \Delta}\rho \ar[r, "{\setsem{\Gamma;\Phi
  \vdash \Delta}f}"] \ar[d, "{\langle g \rho, h \rho\rangle}"']
& \setsem{\Gamma;\Phi \vdash 
  \Delta}\rho' \ar[d, "{\langle g \rho', h \rho' \rangle}"]\\
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := K}]}\rho
\ar[d, "{\eval \circ ((-)_{\overline{\sem{\Gamma;\Phi \vdash K}\rho}} \times
    \id)}"']
\ar[r, bend left = 5, "{\setsem{\Gamma;\emptyset\vdash
      \Nat^{\overline{\alpha}} \,F \,G}f\, \times\, \setsem{\Gamma;\Phi
      \vdash F [\overline{\alpha := K}]}f}"] &
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho'
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := K}]}\rho'
\ar[d, "{\eval \circ ((-)_{\overline{\sem{\Gamma;\Phi \vdash
          K}\rho'}} \times \id)}"] \\
\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := K}]}\rho
\ar[r, "{\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := K}]}f}"']
&
\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := K}]}\rho'
\end{tikzcd}\]}

\noindent
The top diagram commutes because $g$ and $h$ are natural in $\rho$ by
the induction hypothesis.
To see that the bottom diagram commutes,
we need to show that
\[\begin{array}{ll}
& \setsem{\Gamma;\Phi \vdash G [\overline{\alpha := K}]}f
(\eta_{\overline{\sem{\Gamma;\Phi \vdash K}\rho}} x)\\
= &
(\setsem{\Gamma; \emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G} f\, \eta
)_{\overline{\sem{\Gamma;\Phi \vdash K}\rho'}}
(\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := K}]}f x)
\end{array}\]
holds for all $\eta \in \setsem{\Gamma; \emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\rho$ and $x \in
\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := K}]}\rho$,
i.e.,
by remembering the following facts,
\begin{align*}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := K}]}\rho
&= \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash K}\rho}] \\
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := K}]}f
&= \setsem{\Gamma; \ol{\alpha} \vdash F}
  f [\ol{\alpha := \setsem{\Gamma;\Phi \vdash K}f}] \\
\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := K}]}\rho
&= \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash K}\rho}] \\
\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := K}]}f
&= \setsem{\Gamma; \ol{\alpha} \vdash
  G} f [\ol{\alpha := \setsem{\Gamma;\Phi \vdash K}f}]
\end{align*}
we need to show that
\begin{multline*}
\setsem{\Gamma; \ol{\alpha} \vdash G} f[\overline{\alpha := \setsem{\Gamma;\Phi \vdash K} f }]
  \circ
\eta_{\overline{\setsem{\Gamma;\Phi \vdash K}\rho}} \\
=
\eta_{\overline{\setsem{\Gamma;\Phi \vdash K}\rho'}}
\circ
\setsem{\Gamma; \ol{\alpha} \vdash F} f [\ol{\alpha := \setsem{\Gamma;\Phi \vdash K}f}]
\end{multline*}
for all $\eta \in \setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\rho$.
But this follows from the naturality of $\eta$, which ensures the
commutativity of 
{\footnotesize
\[\hspace*{-0.3in}\begin{tikzcd}[column sep = large]
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash K}\rho}] \ar[r,
  "{\;\;\;\eta_{\ol{\setsem{\Gamma;\Phi \vdash K}\rho}}\;\;\; }"]
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash F} f [\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash K}f}]}"']
& \setsem{\Gamma;
  \ol{\alpha} \vdash G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      K}\rho}]
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash G} f [\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash K}f}]}"]\\
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho'[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash K}\rho'}] \ar[r,
  "{\eta_{\ol{\setsem{\Gamma;\Phi \vdash K}\rho'}} }"]
& \setsem{\Gamma; \ol{\alpha} \vdash G}\rho'[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash K}\rho'}]
\end{tikzcd}\]}

\item 
  $\underline{\Gamma;\emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}])}$\;
To see that
\[
\setsem{\Gamma; \emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H
    : \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
    (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
        :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}
\]
is in $\setsem{\Gamma; \emptyset \vdash
    \Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
        :=_{\ol{\beta}} G}]} \rho$
for all $\rho : \setenv$, $d : \setsem{\Gamma;\emptyset \vdash \emptyset} \rho$,
and $\ol{\eta : \setsem{\Gamma; \emptyset
  \vdash\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G} \rho}$,
  we first note that
$\setsem{\Gamma ;\ol{\phi}, \ol{\gamma} \vdash H}$ is a functor from
  $\setenv$ to $\set$ and, for any $\ol C$, $\id_{\rho[\ol{\gamma :=
        C}]}[\ol{\phi := \lambda \ol{B}. \eta_{\ol{B}\,\ol{C}}}]$ is a
  morphism in $\setenv$ from \[\rho[\ol{\gamma := C}][\ol{\phi :=
      \lambda \ol{B}.\setsem{\Gamma; \ol{\gamma},\ol{\beta} \vdash
        F}\rho[\ol{\gamma := C}][\ol{\beta := B}]}]\] to
\[\rho[\ol{\gamma := C}][\ol{\phi := \lambda \ol{B}.\setsem{\Gamma;
\ol{\gamma},\ol{\beta} \vdash G}\rho[\ol{\gamma := C}][\ol{\beta := B}]}]\]
so that
\begin{align*}
&(\setsem{\Gamma; \emptyset~|~\emptyset \vdash
  \map^{\ol{F},\ol{G}}_H :
\Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
(\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
    :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta})_{\ol{C}} \\
  &=  \setsem{\Gamma; \ol{\phi},\ol{\gamma} \vdash H}\id_{\rho[\ol{\gamma
      := C}]}[\ol{\phi := \lambda \ol{B}. \eta_{\ol{B}\,\ol{C}}}]
\end{align*}
is indeed a morphism of type
$$\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := C}]% $
\to 
% $ 
\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := C}]$$
This family of morphisms is natural in $\ol C$: if $\ol{f : C \to C'}$
then, writing $\xi$ for
\[
\setsem{\Gamma; \emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H
    : \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
    (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
        :=_{\ol{\beta}} G}])}\,\rho\,d\, \ol{\eta}
\]
the naturality of $\eta$,
together with the fact that composition of environments is
computed componentwise, ensure that the following naturality diagram
for $\xi$ commutes:
{\footnotesize
\[\begin{tikzcd}
\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := C}] \ar[r, "{\xi_{\ol{C}}}"]
\ar[d, "{\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi :=
          F}]}\id_{\rho}[\ol{\gamma := f}]}"']
& \setsem{\Gamma ; \ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := C}]
\ar[d, "{\setsem{\Gamma ; \ol{\gamma} \vdash H[\ol{\phi :=
          G}]}\id_{\rho}[\ol{\gamma := f}]}"]\\
\setsem{\Gamma ;\ol{\gamma} \vdash H[\ol{\phi := F}]}\rho[\ol{\gamma
      := C'}] \ar[r, "{\xi_{\ol{C'}}}"]
& \setsem{\Gamma ; \ol{\gamma} \vdash H[\ol{\phi := G}]}\rho[\ol{\gamma
      := C'}] 
\end{tikzcd}\]}
That, for all $\rho : \setenv$ and $d : \setsem{\Gamma; \emptyset \vdash
  \emptyset}\rho$, $\xi$ satisfies the additional condition needed for
it to be in $\setsem{\Gamma; \emptyset \vdash
  \Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}]}\rho$ follows from the fact
that $\eta$ satisfies the extra
condition needed for it to be in its corresponding
$\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},\ol{\gamma}}\,F\,G} \rho$.
Finally, since $\Phi = \emptyset$, the naturality of
\[
\setsem{\Gamma; \emptyset~|~\emptyset \vdash \map^{\ol{F},\ol{G}}_H
    : \Nat^\emptyset\;(\ol{\Nat^{\ol{\beta},\ol{\gamma}}\,F\,G})\;
    (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
        :=_{\ol{\beta}} G}])}\rho
\]
in $\rho$ is trivial.


\item
$\underline{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
  \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}$\; To
  see that if $d : \setsem{\Gamma;\emptyset \vdash \emptyset} \rho$
  then $$\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho\,d$$ 
  is in $\setsem{\Gamma;\emptyset \vdash
    \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho$, we first note that, for all $\ol{B}$ and $\ol{C}$,
  \begin{align*}
    &(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,
  \rho\,d)_{\ol{B}\,\ol{C}}\, \\
    =\,
    &(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C}]}})_{\ol{B}}
  \end{align*}
  maps
  \begin{align*}
    &\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
      \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha
        := \beta}]}\rho[\ol{\beta := B}][\ol{\gamma := C}] 
        \\ = \,
    &T^\set_{H,\rho[\ol{\gamma := C}]}\, (\mu T^\set_{H,\rho[\ol{\gamma
        := C}]}) \, \ol{B}
  \end{align*}
        to $\setsem{\Gamma;\ol{\beta},\ol{\gamma}
    \vdash (\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}
  \rho[\ol{\beta := B}][\ol{\gamma := C}] = (\mu
  T^\set_{H,\rho[\ol{\gamma := C}]}) \, \ol{B}$.  \\
  Secondly, we observe
  that
  \begin{align*}
    &\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
    \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
      {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
    \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
      \beta}}\,\rho\,d \\ 
      = \, &\lambda
  \ol{B}\,\ol{C}.\,(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma :=
          C}]}})_{\ol{B}}
  \end{align*}
  is natural in $\ol{B}$ and $\ol{C}$, since
  naturality of $\mathit{in}$ with respect to its functor argument and
  naturality of $\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C'}]}}$ ensure
  that the following diagram commutes for all $\ol{f : B \to B'}$ and
  $\ol{g : C \to C'}$:
{\tiny
  \[\hspace*{-0.15in}\begin{tikzcd}[column sep=2.5in, row sep=0.75in]
T^\set_{H,\rho[\ol{\gamma := C}]}\, (\mu T^\set_{H,\rho[\ol{\gamma := C}]})\, \ol{B}
\ar[d, "{T^\set_{H,\id_\rho[\ol{\gamma := g}]}\,(\mu
    T^\set_{H,\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"] \ar[r,
  "{(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C}]}})_{\ol{B}}}" ]
& (\mu T^\set_{H,\rho[\ol{\gamma := C}]})\, \ol{B} \ar[d, "{(\mu
    T^\set_{H,\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"]\\
T^\set_{H,\rho[\ol{\gamma := C'}]}\, (\mu
T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B} \ar[d, "{T^\set_{H,\rho[\ol{\gamma :=
          C'}]}\, (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{f}}"]
\ar[r,"{(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C'}]}})_{\ol{B}}}" ] & 
  (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B}
\ar[d,"{\mu {T^\set_{H,\rho[\ol{\gamma := C'}]}}\, {\ol{f}}}" ] 
\\
T^\set_{H,\rho[\ol{\gamma := C'}]}\, (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\,
\ol{B'} \ar[r, "{(\mathit{in}_{T^\set_{H,\rho[\ol{\gamma :=
            C'}]}})_{\ol{B'}}}"] & (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\,
\ol{B'}
\end{tikzcd}\]
}
  That, for all $\rho : \setenv$ and $d :
\setsem{\Gamma;\emptyset \vdash \emptyset}\rho$,
\[\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash
  \tin_H : \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
    \beta}}\,\rho\,d\] satisfies the additional property needed for
it to be in 
\[\setsem{\Gamma;\emptyset \vdash
  \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}\,\rho\]
follows from the fact that, for every $\ol{R : \rel(B,B')}$ and $\ol{S
  : \rel(C,C')}$,
\[\hspace*{-0.2in}
  \begin{array}{ll}
 & (\,(\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
      \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
        {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
      \;(\mu \phi.\lambda {\overline \alpha}.H){\overline
        \beta}}\,\rho\,d)_{\ol{B},\ol{C}},\,\\ & \hspace*{0.5in}(\setsem{\Gamma;\emptyset
      \,|\, \emptyset \vdash \tin_H : \Nat^{\ol{\beta},\ol{\gamma}} \,
      H[\phi := (\mu \phi.\lambda {\overline \alpha}.H){\overline
          \beta}][\ol{\alpha := \beta}] \;(\mu \phi.\lambda {\overline
        \alpha}.H){\overline
        \beta}}\,\rho\,d)_{\ol{B'},\ol{C'}}\,)\\ &= (\,
    (\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C}]}})_{\ol{B}},
    (\mathit{in}_{T^\set_{H,\rho[\ol{\gamma := C'}]}})_{\ol{B'}}\,)
\end{array}\]
has type
\[\begin{array}{ll}
& (\, T^\set_{H,\rho[\ol{\gamma := C}]}\, (\mu
T^\set_{H,\rho[\ol{\gamma := C}]}) \, 
\ol{B} \to (\mu T^\set_{H,\rho[\ol{\gamma := C}]}) \, \ol{B}, \, \\
& \hspace*{0.5in}T^\set_{H,\rho[\ol{\gamma := C'}]}\, (\mu
T^\set_{H,\rho[\ol{\gamma := C'}]}) \, 
\ol{B'} \to (\mu T^\set_{H,\rho[\ol{\gamma := C'}]}) \,\ol{B'} \, )\\
= &
 \relsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash H[\phi := (\mu
    \phi.\lambda {\overline \alpha}.H){\overline \beta}][\ol{\alpha :=
      \beta}]}\Eq_\rho[\ol{\beta := R}][\ol{\gamma := S}] \to\\
 & \hspace*{0.5in} \relsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash (\mu
  \phi.\lambda \ol{\alpha}.H)\ol{\beta}} \Eq_\rho[\ol{\beta:=
    R}][\ol{\gamma :=S}]
\end{array}\]

Finally, since $\Phi = \emptyset$, the naturality of
\[
\setsem{\Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
  \Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda
    {\overline \alpha}.H){\overline \beta}][\ol{\alpha := \beta}]
  \;(\mu \phi.\lambda {\overline \alpha}.H){\overline \beta}}
\]
in $\rho$ is trivial.



\item
$\underline{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta \;F)}$ \; Since $\Phi$ is empty, to see
  that 
  $$\setsem{ \Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
    \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
      :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
    (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
    \alpha.H)\overline \beta \;F)}$$
    is a natural transformation from
  $\setsem{\Gamma;\emptyset \vdash \emptyset}$ to \[\setsem{\Gamma;
    \emptyset \vdash \Nat^\emptyset\;(\Nat^{\ol{\beta},
      \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
        \beta}]\,F)\; (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
    \phi.\lambda \overline \alpha.H)\overline \beta\,F)}\] we need only
  show that, for all $\rho : \setenv$, the unique $d :
  \setsem{\Gamma;\emptyset \vdash \emptyset} \rho$, and all $\eta :
  \setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
      \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
        \beta}]\,F} \rho$,
\[ \setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)}\,\rho\,d\,\eta\] has type
$\setsem{\Gamma; \emptyset \vdash \Nat^{{\ol{\beta},\ol{\gamma}}
  }\,(\mu \phi.\lambda \overline \alpha.H)\overline \beta\,F}\,\rho$,
i.e., for any $\ol{B}$ and $\ol{C}$,
\[(\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\] is a
morphism from $\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash (\mu
  \phi.\lambda \overline \alpha.H)\overline \beta}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}] \,=\,(\mu T^\set_{H,\rho[\ol{\gamma := C}]})
\ol{B}$\\ to $\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := B}][\ol{\gamma := C}]$.  To see this, note
that $\eta$ is a natural transformation from
\[\begin{array}{ll}
 & \lambda \ol{B}\,\ol{C}.\,\setsem{\Gamma; \ol{\beta},\ol{\gamma}
  \vdash H[\phi := F][\ol{\alpha := \beta}]}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}]\\
= & \lambda \ol{B}\,\ol{C}.\,T^\set_{H,\rho[\ol{\gamma:=
     C}]}\,(\lambda \ol{A}. \, \setsem{\Gamma;\ol{\beta},\ol{\gamma} 
  \vdash F}\rho[\ol{\beta := A}][\ol{\gamma := C}]) \, \ol{B}
\end{array}\]
to
\[\begin{array}{ll}
 & \lambda \ol{B}\,\ol{C}.\,(\lambda
\ol{A}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\beta
    := A}][\ol{\gamma := C}]) \ol{B}\\
= & \lambda
\ol{B}\,\ol{C}.\,\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := B}][\ol{\gamma := C}]
\end{array}\]
and thus for each $\ol{B}$ and $\ol{C}$,
\[(\setsem{\Gamma; \emptyset~|~\emptyset \vdash \fold^F_H :
  \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\;
  (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu \phi.\lambda \overline
  \alpha.H)\overline \beta\,F)}\,\rho\,d\,\eta)_{\ol{B}\,\ol{C}}\] is a
morphism from
$\setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash (\mu
  \phi.\lambda \overline \alpha.H)\overline \beta}\rho[\ol{\beta :=
    B}][\ol{\gamma := C}]\,=\, (\mu T^\set_{H,\rho[\ol{\gamma := C}]})
\ol{B}$ to $\setsem{\Gamma;\ol{\beta},\ol{\gamma} \vdash
  F}\rho[\ol{\beta := B}][\ol{\gamma := C}]$.
To see that this family of morphisms is natural in $\ol{B}$ and
$\ol{C}$, we observe that the following diagram commutes for all
$\ol{f : B \to B'}$ and $\ol{g : C \to C'}$:
{\tiny
\[\hspace*{-0.3in}\begin{tikzcd}[column sep=2.5in, row sep=0.75in]
(\mu T^\set_{H,\rho[\ol{\gamma := C}]})\, \ol{B}
\ar[d, "{(\mu T^\set_{H,\id_\rho[\ol{\gamma := g}]}) \, \ol{B}}"'] \ar[r, 
  "{(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma := C}]}}\,(\lambda
    \ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}}}"] 
& \setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\gamma :=
    C}][\ol{\beta := B}]\ar[d, "{\setsem{\Gamma;
      \ol{\beta},\ol{\gamma} \vdash F}\id_\rho[\ol{\gamma := 
    g}][\ol{\beta := \id_B}]}"]\\
(\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B} 
\ar[r,"{(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
            C'}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C'}}))_{\ol{B}}\,}" ] 
\ar[d, "{(\mu T^\set_{H,\rho[\ol{\gamma := C'}]}) \, \ol{f}}"'] & 
 \setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\gamma :=
    C'}][\ol{\beta := B}]\ar[d, "{\setsem{\Gamma;
      \ol{\beta},\ol{\gamma} \vdash F}\id_\rho[\ol{\gamma := 
    \id_{C'}}][\ol{\beta := f}]}"]\\
 (\mu T^\set_{H,\rho[\ol{\gamma := C'}]})\, \ol{B'} 
\ar[r,"{(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
            C'}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C'}}))_{\ol{B'}}\,}"
] &  
 \setsem{\Gamma; \ol{\beta},\ol{\gamma} \vdash F}\rho[\ol{\gamma :=
    C'}][\ol{\beta := B'}]
\end{tikzcd}\]}
Indeed, naturality of $\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
        C'}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C'}})$ ensures that
the bottom diagram commutes. To see that the top one commutes
we first observe that, given a natural transformation $\Theta : H \to
K : [\set^k, \set] \to [\set^k, \set]$, the fixpoint natural
transformation $\mu \Theta : \mu H \to \mu K : \set^k \to \set$ is
defined to be $\mathit{fold}_{H}(\Theta\,(\mu K) \circ
\mathit{in}_{K})$, i.e., the unique morphism making the following
diagram commute:\label{page:dia1}
{\footnotesize
\[\begin{tikzcd}[column sep = large]
H(\mu H)
	\ar[dd, "{\mathit{in}_H}"']
	\ar[r, "{H(\mu \Theta)}"]
& H(\mu K)
	\ar[d, "{\Theta (\mu K)}"] \\
& K(\mu K)
	\ar[d, "{\mathit{in}_K}"] \\
\mu H
	\ar[r, "{\mu \Theta}"']
& \mu K
\end{tikzcd}\]}
Taking $\Theta = T^{\set}_{H,f}: T^{\set}_{H,\rho} \to
T^{\set}_{H,\rho'}$ thus gives that, for any $f : \rho \to \rho'$ in
$\setenv$,
\begin{equation}\label{eq:mu-sigma-def}
\mathit{in}_{T^{\set}_{H,\rho'}} \circ 
T^{\set}_{H,f} (\mu T^{\set}_{H,\rho'}) \circ 
T^{\set}_{H,\rho}(\mu T^{\set}_{H,f}) \,=\, 
\mu T^{\set}_{H,f} \circ \mathit{in}_{T^{\set}_{H,\rho}}
\end{equation}
Next, note that the action of the functor
\[\lambda \ol{B}. \lambda \ol{C}. \setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash H[\phi := F][\ol{\alpha := \beta}]}\rho
        [\ol{\beta := B}] [\ol{\gamma := C}]\]
on the morphisms $\ol{f : B \to B'}, \ol{g : C \to C'}$ is given by
\[\begin{array}{ll}
 & \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash H[\phi :=
      F][\ol{\alpha := \beta}]} \id_{\rho} [\ol{\beta := f}]
           [\ol{\gamma := g}]\\
= & \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma} \vdash H}
\id_{\rho}[\ol{\alpha := f}] [\ol{\gamma := g}][\phi := \lambda
  \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
    [\ol{\beta := A}]} [\ol{\gamma := g}]] \\ 
=& \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma} \vdash H} \id_{\rho
  [\ol{\gamma := C'}][\phi := \lambda \ol{A}. \setsem{\Gamma;
      \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta := A}]
    [\ol{\gamma := C'}]]} [\ol{\alpha := f}] \\
&\hspace{3em} \circ \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma}
  \vdash H} \id_{\rho [\ol{\alpha := B}][\phi := \lambda
    \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
       [\ol{\beta := A}] [\ol{\gamma := C'}]]} [\ol{\gamma := g}] \\
&\hspace{3em} \circ \setsem{\Gamma; \phi, \ol{\alpha}, \ol{\gamma}
  \vdash H} \id_{\rho [\ol{\alpha := B}] [\ol{\gamma := C}]} [\phi :=
  \lambda \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
  \id_{\rho [\ol{\beta := A}]} [\ol{\gamma := g}]] \\
= & T^{\set}_{H,\rho [\ol{\gamma := C'}]} (\lambda
\ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := A}] [\ol{\gamma := C'}]) \ol{f} \\
&\hspace{3em} \circ \big( T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}
   (\lambda \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
   \rho [\ol{\beta := A}] [\ol{\gamma := C'}]) \big)_{\ol{B}} \\
&\hspace{3em} \circ \big( T^{\set}_{H,\rho [\ol{\gamma := C}]} (\lambda
   \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
     [\ol{\beta := A}]} [\ol{\gamma := g}]) \big)_{\ol{B}}
\end{array}\]
So if $\eta$ is a natural transformation such that $\eta_{\ol B, \ol
  C}$ has type
\[
\setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash H[\phi := F][\ol{\alpha := \beta}]}\rho
[\ol{\beta := B}] [\ol{\gamma := C}]
\to
\setsem{\Gamma; \ol{\beta},
   \ol{\gamma} \vdash F}\rho [\ol{\beta := B}] [\ol{\gamma := C}]\]
then, by naturality,
\[\begin{array}{ll}
 & \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho}
       [\ol{\beta := f}] [\ol{\gamma := g}] \circ \eta_{\ol{B},
         \ol{C}} \\ 
= & \eta_{\ol{B'}, \ol{C'}} \circ T^{\set}_{H,\rho [\ol{\gamma := C'}]}
(\lambda \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
\rho [\ol{\beta := A}] [\ol{\gamma := C'}]) \ol{f} \\
& \circ \big( T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]} (\lambda
\ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := A}] [\ol{\gamma := C'}]) \big)_{\ol{B}} \\
& \circ \big( T^{\set}_{H,\rho [\ol{\gamma := C}]} (\lambda
   \ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
     [\ol{\beta := A}]} [\ol{\gamma := g}]) \big)_{\ol{B}}
\end{array}\]
As a special case when $\ol{f = \id_B}$ we have
\begin{equation}\label{eq:T-sigma-functor}
\begin{split}
  & \lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
\id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}] \circ \lambda
\ol{B}.\eta_{\ol{B}, \ol{C}} \\  
=\;\;\; & \lambda \ol{B}.\eta_{\ol{B}, \ol{C'}} \circ
T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]} (\lambda
\ol{A}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := A}] [\ol{\gamma := C'}]) \\
 & \hspace*{0.5in} \circ
   T^{\set}_{H,\rho [\ol{\gamma := C}]} (\lambda \ol{A}. \setsem{\Gamma;
     \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho [\ol{\beta := A}]}
   [\ol{\gamma := g}]) 
\end{split}
\end{equation}
Finally, to see that the top diagram in the diagram on
page~\pageref{page:dia1} commutes we first note that functoriality of
$T^{\set}_{H,\rho [\ol{\gamma := C}]}$, naturality of
$T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}$, the universal property of
$\mathit{fold}_{T^{\set}_{H,\rho [\ol{\gamma := C'}]}} (\lambda
\ol{A}. \eta_{\ol{A}, \ol{C'}})$ and Equation~\ref{eq:mu-sigma-def}
ensure that the following diagram commutes: {\footnotesize
\begin{equation}\label{eq:one-side}
\hspace*{-0.7in}  \begin{tikzcd}[column sep = huge, row sep = huge]
T^{\set}_{H,\rho [\ol{\gamma := C}]} (\mu T^{\set}_{H,\rho [\ol{\gamma :=
      C}]}) \ar[rr, "{T^{\set}_{H,\rho [\ol{\gamma := C}]} (
    \mathit{fold}_{T^{\set}_{H,\rho [\ol{\gamma := C'}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C'}}) \circ \mu
    T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]} )}"] \ar[dd,
    "{\mathit{in}_{T^{\set}_{H,\rho [\ol{\gamma := C}]}}}"']
&& T^{\set}_{H,\rho [\ol{\gamma := C}]} (\lambda \ol{B}. \setsem{\Gamma;
  \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta := B}] [\ol{\gamma
    := C'}]) \ar[d, "{ T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}
    (\lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
    \rho [\ol{\beta := B}] [\ol{\gamma := C'}]) }" description] \\
&& T^{\set}_{H,\rho [\ol{\gamma := C'}]} (\lambda
\ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho
   [\ol{\beta := B}][\ol{\gamma := C'}]) \ar[d, "{ \lambda \ol{A}. \eta_{\ol{A}, \ol{C'}}
     }" description] \\
\mu T^{\set}_{H,\rho [\ol{\gamma := C}]}\ar[r, "{\mu
    T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}}"'] 
&\mu T^{\set}_{H,\rho [\ol{\gamma := C'}]} \ar[r, bend right = 10,
  "{\mathit{fold}_{T^{\set}_{H,\rho [\ol{\gamma := C'}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C'}})}"']
& \lambda \ol{B}. \setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F}
\rho [\ol{\beta := B}] [\ol{\gamma := C'}]
  \end{tikzcd}
  \end{equation}}
Next, we note that functoriality of $T^{\set}_{H,\rho [\ol{\gamma :=
      C}]}$, Equation~\ref{eq:T-sigma-functor}, and the universal
property of $\mathit{fold}_{T^{\set}_{H,\rho [\ol{\gamma := C}]}} (\lambda
\ol{A}. \eta_{\ol{A}, \ol{C}})$ ensure that the following diagram
commutes: {\footnotesize
\begin{equation}\label{eq:other-side}
\hspace*{-1in}\begin{tikzcd}[row sep = huge]
T^{\set}_{H,\rho [\ol{\gamma := C}]} (\mu T^{\set}_{H,\rho [\ol{\gamma :=
      C}]}) \ar[rr, "{T^{\set}_{H,\rho [\ol{\gamma := C}]} (
    \lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \id_{\rho
      [\ol{\beta := B}]} [\ol{\gamma := g}] \circ
    \mathit{fold}_{T^{\set}_{H,\rho [\ol{\gamma := C}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C}}) )}"] \ar[dd, "{\mathit{in}_{T^{\set}_{H,\rho
        [\ol{\gamma := C}]}}}"']
&& T^{\set}_{H,\rho [\ol{\gamma := C}]} (\lambda \ol{B}.\setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash F} \rho [\ol{\beta := B}] [\ol{\gamma := C'}])
\ar[d, "{ T^{\set}_{H,\id_{\rho}[\ol{\gamma := g}]}
    (\lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta
        := B}] [\ol{\gamma := C'}]) }" description]\\
&& T^{\set}_{H,\rho [\ol{\gamma := C'}]} (\lambda \ol{B}.\setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash F} \rho [\ol{\beta := B}][\ol{\gamma := C'}]) \ar[d, "{ \lambda
    \ol{A}. \eta_{\ol{A}, \ol{C'}} }" description] \\
\mu T^{\set}_{H,\rho [\ol{\gamma := C}]} \ar[r, bend right = 10,
  "{\mathit{fold}_{T^{\set}_{H,\rho [\ol{\gamma := C}]}} (\lambda
    \ol{A}. \eta_{\ol{A}, \ol{C}})}"'] & \lambda \ol{B}.\setsem{\Gamma; \ol{\beta},
  \ol{\gamma} \vdash F} \rho [\ol{\beta := B}] [\ol{\gamma := C}]
\ar[r, bend right = 10, "{\lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma}
      \vdash F} \id_{\rho [\ol{\beta := B}]} [\ol{\gamma := g}]}"'] &
\lambda \ol{B}.\setsem{\Gamma; \ol{\beta}, \ol{\gamma} \vdash F} \rho [\ol{\beta :=
    B}] [\ol{\gamma := C'}]
\end{tikzcd}
\end{equation}}
Combining the equations entailed by~\ref{eq:one-side}
and~\ref{eq:other-side}, we get that
the top diagram in the diagram on
  page~\pageref{page:dia1} commutes, as desired.
To see that, for all $\rho : \setenv$, $d \in
\setsem{\Gamma; \emptyset \vdash \emptyset}\rho$, and $\eta :
\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F}
\rho$,
\[\setsem{\Gamma; \emptyset~|~\emptyset
  \vdash \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta},
    \ol{\gamma}}\,H[\phi :=_{\ol{\beta}} F][\ol{\alpha :=
      \beta}]\,F)\; (\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
  \phi.\lambda \overline \alpha.H)\overline \beta\,F)}\,\rho\,d\,\eta\]
satisfies the additional condition needed for it to be in
$\setsem{\Gamma;\emptyset \vdash \Nat^{{\ol{\beta},\ol{\gamma}}
  }\,(\mu \phi.\lambda \overline \alpha.H)\overline \beta\;F}\,\rho$,
let $\ol{R : \rel(B,B')}$ and $\ol{S : \rel(C,C')}$.  Since $\eta$
satisfies the additional condition needed for it to be in
$\setsem{\Gamma; \emptyset \vdash \Nat^{\ol{\beta},
    \ol{\gamma}}\,(H[\phi := F][\ol{\alpha := \beta}])\,F} \rho$,
\[\begin{array}{ll}
 & (\,(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
        C}]}}\,(\lambda \ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}},\,
(\mathit{fold}_{T^\set_{H,\rho[\ol{\gamma :=
        C'}]}}\,(\lambda \ol{A}.\eta_{\ol{A}\,\ol{C'}}))_{\ol{B'}}\,) 
\end{array}\]
has type
\[\begin{array}{ll}
  & (\mu T_{H,\Eq_\rho[\ol{\gamma := S}]}) \,\ol{R} \to
\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma := 
    S}][\ol{\beta:= R}]\\ 
= & (\mu T_{H,\Eq_\rho[\ol{\gamma :=
      S}]})\,\ol{\relsem{\Gamma;\ol{\gamma},\ol{\beta} 
  \vdash \beta}\Eq_\rho[\ol{\gamma := S}][\ol{\beta := R}]} \\ 
  &\hspace{1.5in} \to
\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma := 
    S}][\ol{\beta:= R}]\\ 
= & \relsem{\Gamma; \ol{\gamma},\ol{\beta} \vdash (\mu \phi. \lambda
  \ol{\alpha}. H)\ol{\beta}}\Eq_\rho[\ol{\gamma := S}][\ol{\beta := R}] \\ 
  &\hspace{1.5in}\to
\relsem{\Gamma;\ol{\gamma},\ol{\beta} \vdash F}\Eq_\rho[\ol{\gamma := 
    S}][\ol{\beta:= R}]
\end{array}\]
\end{itemize}
\end{proof}


\section{Free Theorems for Nested Types}

\subsection{Free Theorem for Type of Polymorphic
  Bottom}\label{sec:bottom} 

Let $ \vdash g : \Nat^\alpha \,\onet\,\alpha$, let $G^\set =
\setsem{\vdash g : \Nat^\alpha \,\onet\,\alpha}$ and $G^\rel =
\relsem{\vdash g : \Nat^\alpha \,\onet\,\alpha}$.  By
Theorem~\ref{thm:at-gen}, $(G^\set(\pi_1\rho),G^\set(\pi_2\rho)) =
G^\rel\rho$. Thus, for all $\rho \in \relenv$ and any $(a, b) \in
\relsem{\vdash \emptyset}\rho = 1$, eliding the only possible
instantiations of $a$ and $b$ gives that $(G^\set,G^\set) \;= \;
(G^\set(\pi_1 \rho), G^\set (\pi_2 \rho))$ $ \in \relsem{\vdash
  \Nat^\alpha \,\onet\,\alpha}\rho$ $ = \{\eta : K_1 \Rightarrow
\id\}$ $ = \{(\eta_1 : K_1 \Rightarrow \id, \eta_2 : K_1 \Rightarrow
\id)\}$ That is, $G^\set$ is a natural transformation from the
constantly $1$-valued functor to the identity functor in $\set$. In
particular, for every $S : \set$, $G^\set_S : 1 \to S$. Note, however,
that if $S = \emptyset$, then there can be no such morphism, so no
such natural transformation, and thus no term $\vdash g : \Nat^\alpha
\onet \,\alpha$, can exist.  That is, our calculus admits no
non-terminating terms, i.e., terms with the closed type $\Nat^\alpha
\onet \,\alpha$ of the polymorphic bottom.

\subsection{Free Theorem for Type of Polymorphic
  Identity}\label{sec:identity} 

Let $ \vdash g : \Nat^\alpha \,\alpha\,\alpha$, \/$G^\set =
\setsem{\vdash g : \Nat^\alpha \,\alpha\,\alpha}$, and $G^\rel =
\relsem{\vdash g : \Nat^\alpha \,\alpha\,\alpha}$.  By
Theorem~\ref{thm:at-gen}, $(G^\set(\pi_1\rho),G^\set(\pi_2\rho)) =
G^\rel\rho$. Thus, for all $\rho \in \relenv$ and any $(a, b) \in
\relsem{\vdash \emptyset}\rho = 1$, eliding the only possible
instantiations of $a$ and $b$ gives that $(G^\set, G^\set) \; = \;
(G^\set(\pi_1 \rho), G^\set (\pi_2 \rho))$ $ \in \relsem{\vdash
  \Nat^\alpha \,\alpha\,\alpha}\rho$ $ = \{\eta : \id \Rightarrow
\id\}$ $ = \{(\eta_1 : \id \Rightarrow \id, \eta_2 : \id \Rightarrow
\id)\}$ That is, $G^\set$ is a natural transformation from the
identity functor on $\set$ to itself. Now let $S$ be any set.  If $S =
\emptyset$, then there is exactly one morphism $\id_S: S \to S$, so
$G^\set_S : S \to S$ must be $\id_S$. If $S \not = \emptyset$, if $a$
is any element of $S$, and if $K_a :S \to S$ is the constantly
$a$-valued morphism on $S$, then instantiating the naturality square
implied by the above equality gives that $G^\set_S \circ K_a = K_a
\circ G^\set_S$, i.e., $G^\set_S \, a = a$, i.e., $G^\set_S = \id_S$.
Putting these two cases together we have that for every $S : \set$,
$G^\set_S = \id_S$, i.e., $G^\set$ is the identity natural
transformation for the identity functor on $\set$. So every closed
term $g$ of closed type $\Nat^\alpha\alpha\,\alpha$ always denotes the
identity natural transformation for the identity functor on $\set$,
i.e., every closed term $g$ of type $\Nat^\alpha\alpha\,\alpha$
denotes the polymorphic identity function.

\subsection{Standard Free Theorems for ADTs and Nested
  types}\label{sec:ft-adt} 

We can derive in our calculus even those free theorems for polymorphic
functions over ADTs that are not consequences of naturality.  We can,
e.g., prove the free theorem for $\mathit{filter}$'s type as follows:

\begin{theorem} 
If $g : A \to B$, $\rho \in \relenv$, $\rho \alpha = (A, B, \graph{g})$,
$(a, b) \in \relsem{\alpha ;\emptyset \vdash \Delta} \rho$, $(s \circ
g, s) \in \relsem{\alpha; \emptyset \vdash \Nat^\emptyset \alpha \,
  \mathit{Bool}} \rho$, and
\[\mathit{filter} = \setsem{\alpha; \emptyset \,|\, \Delta \vdash t :
  \filtype}\]
\noindent
for some $t$, then
\[  \mathit{map}_{\mathit{List}} \,g \circ \mathit{filter} \, (\pi_1
\rho) \, a \, (s \circ g) = \mathit{filter}\, (\pi_2\rho) \, b \, s
\circ \mathit{map}_{\mathit{List}} \,g\]
\end{theorem}
\begin{proof}
By Theorem~\ref{thm:abstraction}, \[(\mathit{filter}\, (\pi_1 \rho)\,
a, \mathit{filter}\, (\pi_2 \rho)\, b) \in \relsem{\alpha; \emptyset
  \vdash \filtype} \rho\] so if $(s', s) \in \relsem{\alpha; \emptyset
  \vdash \Nat^\emptyset \alpha \, \mathit{Bool}} \rho = \rho\alpha \to
\Eq_{\mathit{Bool}}$ and $(xs', xs) \in \relsem{\alpha; \emptyset
  \vdash List \, \alpha} \rho$ then
\begin{equation}\label{eq:filter-thm-list}
  (\mathit{filter}\, (\pi_1\rho) \,a \,s' \,xs', \mathit{filter} \,
  (\pi_2\rho) \,b \,s \,xs) \in \relsem{\alpha; \emptyset \vdash
    \mathit{List} \, \alpha} \rho
\end{equation}
If $\rho\alpha = (A, B, \graph{g})$, then $\relsem{\alpha; \emptyset
  \vdash \mathit{List} \, \alpha} \rho =
\graph{\mathit{map}_{\mathit{List}} \, g}$ by Lemma~\ref{lem:graph}
and demotion.  Moreover, $xs =
\mathit{map}_{\mathit{List}} \,g \,xs'$ and $(s', s) \in \graph{g} \to
\Eq_{\mathit{Bool}}$, so $s' = s \circ g$. The result
follows from 
Equation~\ref{eq:filter-thm-list}.\end{proof}

A similar proof establishes the analogous result for, say, generalized
rose trees. 
\begin{theorem} 
  If $g : A \to B$,
$F, G : \set \to \set$,
  $\eta : F \to G$ in $\set$, $\rho \in \relenv$, $\rho \alpha =
 (A, B, \graph{g})$, $\rho \psi = (F, G, \graph{\eta})$, $(a, b) \in
 \relsem{\alpha, \psi ;\emptyset \vdash \Delta} \rho$, $(s \circ
 g, s) \in \relsem{\alpha; \emptyset \vdash \Nat^\emptyset \alpha \,
   \mathit{Bool}} \rho$, and
 \[ \mathit{filter} = \setsem{\alpha, \psi; \emptyset \,|\, \Delta
      \vdash t : \filtypeGRose}  \]
for some $t$, then
\[ \semmap_{\mathit{GRose}}\, \eta\, (g + 1) \circ \mathit{filter} \,
(\pi_1 \rho) \, a \, (s \circ g) = \mathit{filter} \, (\pi_2\rho) \, b
\, s \circ 
\semmap_{\mathit{GRose}}\, \eta\, g\]
\end{theorem}

\noindent
This is not surprising since rose trees are essentially
ADT-like. However, as noted in Section~\ref{sec:terms}, our calculus
cannot express the type of a polymorphic filter function for a proper
nested type.

\subsection{Short Cut Fusion for Lists}\label{sec:short-cut}

We can recover standard short cut fusion for lists~\cite{glp93} in our
calculus: 
\begin{theorem}
If \,$\vdash F$, $\vdash H$, and 
$G \, = \, \setsem{\beta; \emptyset \,|\, \emptyset \vdash g :
  \Nat^{\emptyset} (\Nat^{\emptyset} (\onet + F \times \beta)\,
  \beta)\, \beta}$ for some $g$, and if $c \in \setsem{\vdash F}
\,\times\, \setsem{\vdash H} \to \setsem{\vdash H}$ and $n \in
\setsem{\vdash H}$, then
\[\mathit{fold}_{1 + \setsem{\vdash F} \times \_}\, n\, c\; (G\; (\mathit{List}\,
\setsem{\vdash F})\,\mathit{nil} \,\mathit{cons}) = G \,\setsem{\vdash
  H}\, n\, c \]
\end{theorem}
\begin{proof}
Theorem~\ref{thm:abstraction} gives
that, for any $\rho \in \relenv$,
  \begin{align*}
    (G \,(\pi_1 \rho),  \,
    &G\, (\pi_2 \rho))
 \in  \\ 
    &
    \relsem{\beta; \emptyset \vdash \Nat^{\emptyset} (\Nat^{\emptyset}
  (\onet + F \times \beta)\, \beta)\, \beta} \rho \\
    &
    \cong (((\relsem{\vdash F} \rho \times
\rho\beta) \to \rho\beta) \times \rho\beta) \to \rho\beta
  \end{align*} 
so if $(c', c) \in \relsem{\vdash F} \rho \times
\rho\beta \to \rho\beta$ and $(n', n) \in \rho\beta$ then
$(G \,(\pi_1 \rho)\, n'\, c', G\, (\pi_2 \rho)\, n\, c)
\in \rho \beta$.
In addition,
\begin{align*}
  &\setsem{\vdash \fold_{\onet + F
    \times \beta}^{H} : \Nat^{\emptyset} (\Nat^{\emptyset} (\onet
  + F \times H)\, H)\, (\Nat^{\emptyset} (\mu \alpha. \onet
  + F \times \alpha)\, H)} \\ &=
\mathit{fold}_{1 + \setsem{\vdash F} \times \_}
\end{align*}
so that if $c \in
\setsem{\vdash F} \,\times\, \setsem{\vdash H} \to
\setsem{\vdash H}$ and $n \in \setsem{\vdash H}$,
 then
$(n, c) \in \setsem{\vdash \Nat^{\emptyset} (\onet + F \times H)\,
  H}$. The instantiation
$\pi_1 \rho \beta = \setsem{\vdash \mu \alpha. \onet + F \times
  \alpha}=\mathit{List}\,\setsem{\vdash F}$,\, 
$\pi_2 \rho \beta = \setsem{\vdash H}$,\,
$\rho \beta = \graph{\mathit{fold}_{1 + \setsem{\vdash F} \times \_}\, n\, c} :
\rel(\pi_1 \rho \beta, \pi_2 \rho \beta)$,\,
$c' = \mathit{cons}$,\, and 
$n' = \mathit{nil}$
thus gives that $(G \;(\mathit{List}\,\setsem{\vdash
  F})\,\mathit{nil} \,\mathit{cons}, G \,\setsem{\vdash H} \,
n\, c) \in \graph{\mathit{fold}_{1 + \setsem{\vdash F} \times \_}\, n\, c}$, i.e.,
that $\mathit{fold}_{1 + \setsem{\vdash F} \times \_}\, n\, c\; (G\;
(\mathit{List}\,\setsem{\vdash F})\, \mathit{nil}\, \mathit{cons})
= G \,\setsem{\vdash H}\, n\, c$.
\end{proof}

We can extend short cut fusion results to arbitrary ADTs, as
in~\cite{joh02,pit98}.



\subsection{Short Cut Fusion for Arbitrary Nested
  Types}\label{sec:short-cut-nested} 

We can extend short cut fusion for lists~\cite{glp93} to nested types,
thereby formally prove correctness of the categorically inspired
theorem from~\cite{jg10}.  We have:
\begin{theorem}\label{thm:short-cut-nested}
If $\emptyset;\phi,\alpha \vdash F$, \,$\emptyset; \alpha
\vdash K$, \,
$H : [\set,\set] \to [\set,\set]$ is defined by
\[\begin{array}{lll}
H\,f\,x & = & \setsem{\emptyset; \phi, \alpha \vdash F}[\phi :=
  f][\alpha := x]\\
\end{array}\]
and 
\[G = \setsem{\phi;\emptyset\,|\,\emptyset \vdash g :
\Nat^\emptyset\,(\Nat^\alpha\,F\,(\phi\alpha))\,(\Nat^\alpha\,\onet \,
(\phi\alpha))}\] for some $g$, then, for every $B \in H
\setsem{\emptyset;\alpha \vdash K} \rightarrow \setsem{\emptyset;
  \alpha \vdash K}$,
$$\mathit{fold}_{H}\, B \, (G\; \mu H \; \mathit{in}_{H}) = G
\,\setsem{\emptyset;\alpha \vdash K}\, B$$
\end{theorem}

\begin{proof}
Theorem~\ref{thm:abstraction} gives that, for any 
$\rho \in \relenv$,
\[\begin{array}{lll}
(G \,(\pi_1 \rho), G\, (\pi_2 \rho))
& \in & \relsem{\phi;\emptyset\vdash \Nat^{\emptyset} (\Nat^\alpha
  F\, (\phi\alpha))\, (\Nat^\alpha\,\onet \, (\phi\alpha))}
\rho\\ 
& = & \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
  (\phi\alpha)}\rho \to \relsem{\phi;\emptyset\vdash
  \Nat^\alpha\,\onet \, (\phi\alpha)}\rho\\ 
& = & \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
  (\phi\alpha)}\rho \to \rho \phi
\end{array}\]
\noindent
so if $(A, B) \in \relsem{\phi;\emptyset\vdash \Nat^\alpha F\,
  (\phi\alpha)}\rho$ then $(G \,(\pi_1 \rho)\, A, G\, (\pi_2 \rho)\,
B) \in \rho \phi$.
Also,
\[\setsem{\vdash \fold_F^K :
  \Nat^{\emptyset}\, (\Nat^\alpha F[\phi := K]\,K)\, (\Nat^\alpha
  ((\mu \phi.\lambda\alpha.F)\alpha)\,K)} = \mathit{fold}_H\]
Now let $A = \mathit{in}_H : H (\mu H) \Rightarrow
\mu H$,\, $B : H\setsem{\emptyset;\alpha\vdash K} \Rightarrow
\setsem{\emptyset;\alpha \vdash K}$,\, $\rho \phi =
\graph{\mathit{fold}_H\, B}$,\, $\pi_1 \rho \phi = \mu H$,\, $\pi_2
\rho \phi = \setsem{\emptyset;\alpha\vdash K}$,\, $\rho \phi :
\rel(\pi_1 \rho \phi, \pi_2 \rho \phi)$,\, $A : \setsem{\phi;
  \emptyset \vdash \Nat^\alpha F \, (\phi \alpha)} (\pi_1 \rho)$,\,
and $B : \setsem{\phi; \emptyset \vdash \Nat^\alpha F \, (\phi
  \alpha)} (\pi_2 \rho)$.
Demotion ensures that $A = \mathit{in}_H : H(\mu H) \Rightarrow \mu H
= \setsem{\phi;\emptyset \vdash \Nat^\alpha F
  \,(\phi\alpha)}(\pi_1\rho)$,
and demotion and Lemma~\ref{lem:graph} together give that
\[\begin{array}{lll}
(A,B) \,=\, (\mathit{in}_H,B) & \in & \relsem{\phi;\emptyset\vdash
  \Nat^\alpha F\, (\phi\alpha)}\rho\\
& = & \lambda A. \relsem{\phi;\alpha\vdash F}[\phi :=
  \graph{\mathit{fold}_H\, B}][\alpha := A] \Rightarrow 
 \graph{\mathit{fold}_H\, B} \\ 
& = & \relsem{\emptyset;\phi,\alpha\vdash F}
  \graph{\mathit{fold}_H\, B} \Rightarrow \graph{\mathit{fold}_H\,
    B}\\
  & = & \graph{\setsem{\emptyset;\phi,\alpha\vdash F}
    \,(\mathit{fold}_H\,B)} \Rightarrow \graph{\mathit{fold}_H\, B}\\
  & = & \graph{\mathit{map}_H \,(\mathit{fold}_H\,B)} \Rightarrow
\graph{\mathit{fold}_H\, B}\\
\end{array}\]
since if $(x,y) \in \graph{\mathit{map}_H \,(\mathit{fold}_H\,B)}$,
then $$\mathit{fold}_H\, B\, (\mathit{in}_H\,x) = B\,y = B\,
(\mathit{map}_H \,(\mathit{fold}_H\,B) \, x)$$ by the definition of
$\mathit{fold}_H$ as a (indeed, the unique) morphism from
$\mathit{in}_H$ to $B$.  Thus, $(G \,(\pi_1 \rho)\, A, G\, (\pi_2
\rho)\, B) \in \graph{\mathit{fold}_H\, B}$, i.e., $\mathit{fold}_H \,
B \, (G\, (\pi_1 \rho) \, \mathit{in}_H) = G\,(\pi_2 \rho)\,B$.  But
since $\phi$ is the only free variable in $G$, this simplifies to
$\mathit{fold}_H\, B \, (G\, \mu H\, \mathit{in}_H) =
G\,\setsem{\emptyset;\alpha\vdash K}\,B$. 
\end{proof}







\end{document}


