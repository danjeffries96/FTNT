<<<<<<< HEAD
% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
=======
%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
\documentclass[acmsmall,review,anonymous]{acmart}
\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{POPL} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2020}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations
%\citestyle{acmnumeric}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\usepackage[utf8]{inputenc}
\usepackage{ccicons}

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amscd}
%\usepackage{MnSymbol}
\usepackage{xcolor}

\usepackage{bbold}
\usepackage{url}
\usepackage{upgreek}
%\usepackage{stmaryrd}

\usepackage{lipsum}
\usepackage{tikz-cd}
\usetikzlibrary{cd}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}

\usepackage{bussproofs}
\EnableBpAbbreviations

\input{macros}
\input{mytheorem}

\theoremstyle{definition}
\newtheorem{exmpl}{Example}

\renewcommand{\greyout}[1]{} %{{\color{gray} {#1}}} -- toggle to remove greyed text

\newcommand{\emptyfun}{{[]}}
\newcommand{\cal}{\mathcal}
%\newcommand{\fold}{\mathit{fold}}
\newcommand{\F}{\mathcal{F}}
\renewcommand{\G}{\mathcal{G}}
\newcommand{\N}{\mathcal{N}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\B}{\mathcal{B}}
\renewcommand{\P}{\mathcal{A}}
\newcommand{\pred}{\mathsf{Fam}}
\newcommand{\env}{\mathsf{Env}}
\newcommand{\set}{\mathsf{Set}}
\renewcommand{\S}{\mathcal S}
\renewcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\A}{\mathcal{A}}
\renewcommand{\id}{\mathit{id}}
\newcommand{\map}{\mathsf{map}}
\newcommand{\pid}{\underline{\mathit{id}}}
\newcommand{\pcirc}{\,\underline{\circ}\,}
\newcommand{\pzero}{\underline{0}}
\newcommand{\pone}{\underline{1}}
\newcommand{\psum}{\,\underline{+}\,}
%\newcommand{\inl}{\mathit{inL}\,}
%\newcommand{\inr}{\mathit{inR}\,}
\newcommand{\pinl}{\underline{\mathit{inL}}\,}
\newcommand{\pinr}{\underline{\mathit{inR}}\,}
\newcommand{\ptimes}{\,\underline{\times}\,}
\newcommand{\ppi}{\underline{\pi_1}}
\newcommand{\pppi}{\underline{\pi_2}}
\newcommand{\pmu}{\underline{\mu}}

\title[Free Theorems for Nested Types]{Free Theorems for 
Nested Types} %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{Patricia Johann and Andrew Polonsky}
%\authornote{with author1 note}          %% \authornote is optional;
%                                        %% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
%  \position{Position1}
%  \department{Department1}              %% \department is recommended
  \institution{Appalachian State University}            %% \institution is required
%  \streetaddress{Street1 Address1}
%  \city{City1}
%  \state{State1}
%  \postcode{Post-Code1}
%  \country{Country1}                    %% \country is recommended
}
\email{johannp@appstate.edu, andrew.polonsky@gmail.com}          %% \email is recommended


\begin{document}

\begin{abstract}
\end{abstract}

%\begin{CCSXML}
%<ccs2012>
%<concept>
%<concept_id>10011007.10011006.10011008</concept_id>
%<concept_desc>Software and its engineering~General programming languages</concept_desc>
%<concept_significance>500</concept_significance>
%</concept>
%<concept>
%<concept_id>10003456.10003457.10003521.10003525</concept_id>
%<concept_desc>Social and professional topics~History of programming languages</concept_desc>
%<concept_significance>300</concept_significance>
%</concept>
%</ccs2012>
%\end{CCSXML}
%
%\ccsdesc[500]{Software and its engineering~General programming languages}
%\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
%\keywords{keyword1, keyword2, keyword3}  %% \keywords is optional


\maketitle

\section{Introduction}\label{sec:intro}

{\color{red}
\begin{itemize}
\item Bob has forall types. But we have data types. So we each add
  somethign different to the simply typed lambda calculus. We'll treat
  simply typed lambda calculus with data types first, and may add poly
  types later. This will require additional hypotheses on the semantic
  categories.
\item We're not (obviously) using the exponential between functor
  categories anywhere. 
\item Couldn't do this before LICS paper? Or could Bob have done it?
  What's new?
\end{itemize}}

\subsection{Preliminaries}\label{sec:prelims}

We write $\set$ for the category of sets and functions.

\begin{dfn}\label{def:rel}
The category $\rel$ is defined as follows.
\begin{itemize}
\item An object of $\rel$ is a triple $(A,B,R)$ where $R$ is a
  relation between the objects $A$ and $B$ in $\set$, i.e., a subset
  of $A \times B$. We write $R : \rel(A,B)$ when convenient.
\item A morphism between objects $R : \rel(A,B)$ and $R' :
  \rel(A',B')$ of $\rel$ is a pair $(f : A \to A',g : B \to B')$ of
  morphisms in $\set$ such that $(fa,g\,b) \in R'$ whenever $(a,b) \in
  R$.
  \end{itemize}
\end{dfn}

If $R : \rel(A,B)$ we write $\pi_1 R$ and $\pi_2 R$ for the {\em
  domain} $A$ of $R$ and the {\em codomain} $B$ of $R$, respectively.
If $A : \set$, then we write $\Eq_A = (A,A,\{(x,x)~|~ x \in A\})$ for
the {\em equality relation} on $A$.

\vspace*{0.1in}

If $\C$ and $\D$ are categories, we write $[\C,\D]$ for the set of
$\omega$-cocontinuous functors from  $\C$ to $\D$.

\section{The Calculus}

\subsection{Types}

For each $k \ge 0$, we assume a countable set $\tvars^k$ of \emph{type
  constructor variables of arity $k$}, disjoint for distinct $k$.  We
use lower case Greek letters for type constructor variables, and write
$\phi^k$ to indicate that $\phi \in \tvars^k$.
%We call $\tvars^0$ the set of {\em type variables}.
When convenient we may write $\alpha, \beta$, etc., rather than
$\alpha^0, \beta^0$, etc., for elements of $\tvars^0$. The set of all
type constructor variables is $\tvars = \bigcup_{k \ge 0} \tvars^k$.
We further assume an infinite set $\V$ of {\em type variables}
disjoint from $\tvars$.  We write $\overline{\zeta}$ for either a set
$\{\zeta_1,...,\zeta_n\}$ of type variables or a set of type
constructor variables when the cardinality $n$ of the set is
unimportant. If $\Pos$ is a set of type constructor variables then we
write $\Pos, \overline{\phi}$ for $\Pos \cup \overline{\phi}$ when
$\Pos \cap \overline{\phi} = \emptyset$.  We omit the boldface for a
singleton set, thus writing $\phi$, rather than $\overline{\phi}$, for
$\{\phi\}$.

\begin{dfn}
Let $V$ be a finite subset of\, $\V$, and let $\Pos$ and
$\overline{\alpha}$ be finite subsets of\, $\tvars$. The sets $\T(V)$ of
{\em type expressions} over $V$ and $\mcF^\Pos(V)$ of {\em type
  constructor expressions} over $V$ are given by:
\[\T(V) \; ::= \; V \mid \T(V) \to \T(V) \mid
   {\color{red} \forall v.\, \T(V,v)} \mid
   \Nat^{\ol{\alpha}}(\mcF^{\overline{\alpha}}(V),\mcF^{\ol{\alpha}}(V))\]
\noindent
and 
\begin{align*}
\mcF^\Pos(V) \; ::= \; \T(V) &\mid
\zerot \mid \onet \mid \Pos\, \ol{\mcF^{\Pos}(V)} 
\mid \mcF^{\Pos}(V)\! +\, \mcF^{\Pos}(V)
\mid \mcF^{\Pos}(V)\! \times\, \mcF^{\Pos}(V)\\
&\mid \left(\mu \phi^{k}. \lambda \alpha_1...\alpha_k.
\mcF^{\Pos,\alpha_1,...,\alpha_k,\phi}(V)\right)
\ol{\mcF^{\Pos}(V)}
\end{align*}
\end{dfn}

The above notation entails that an application $\tau\tau_1...\tau_k$ is
allowed only when $\tau$ is a type constructor variable of arity $k$, or
$\tau$ is a subexpression of the form $\mu \phi^{k}. \lambda
\alpha_1...\alpha_k.\tau$. Moreover, if $\tau$ has arity $k$ then $\tau$
must be applied to exactly $k$ arguments.  Accordingly, an overbar
indicates a sequence of subexpressions whose length matches the arity
of the functorial expression applied to it.  The fact that functorial
expressions are always in \emph{$\eta$-long normal form} avoids having
to consider $\beta$-conversion at the level of type constructors, and
the fact that the standard type formers are all defined pointwise
avoids having to relate functorial expressions at different kinds.

If $\tau \in \mcF^\Pos(V)$, if $\Pos$ contains only type constructor
variables of arity $0$, and if $k=0$ for every occurrence of $\phi^k$
bound by $\mu$ in $\tau$, then we say that $\tau$ is {\em
  first-order}. Otherwise we say that $\tau$ is {\em second-order}.
The intuition here is that variables in $V$ can be substituted by any
types, but those in $\Pos$ can only be substituted by type
constructors, even if of arity $0$. In this case, they'd be
substituted by type constructors of arity $0$ --- i.e., type constants
--- such as Nat or Bool.

\begin{dfn}
Let $\Gamma$ be a {\em type context}, i.e., a finite set of type
variables, and let $\Phi$ be a {\em type constructor context}, i.e., a
finite set of type constructor variables. The formation rules for the
set $\T \subseteq \bigcup_{V \subseteq \V}\T(V)$ of\, {\em well-formed
  type expressions} are 
\[\begin{array}{cc}
\AXC{$\phantom{\Gamma;\Phi}$}
\UIC{$\Gamma,v;\emptyset \vdash v : \T$}
\DisplayProof
&
\AXC{$\Gamma;\emptyset \vdash \sigma : \T$}
\AXC{$\Gamma;\emptyset \vdash \tau : \T$}
\BIC{$\Gamma;\emptyset \vdash \sigma \to \tau : \T$}
\DisplayProof  
\\
\\
{\color{red}
\AXC{$\Gamma,v;\emptyset  \vdash \tau : \T$} 
\UIC{$\Gamma;\emptyset  \vdash \forall v.\, \tau : \T$}
\DisplayProof
}
&
\AXC{$\Gamma;\ol{\alpha} \vdash \sigma :
  \mcF$}
\AXC{$\Gamma;\ol{\alpha}  \vdash \tau : \mcF$}
\BIC{$\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\sigma \,\tau : \T$}
\DisplayProof
\end{array}\]
The formation rules for the set $\F \subseteq \bigcup_{V \subseteq
   \V, \Pos \subseteq \tvars}\F^\Pos(V)$ of\, {\em well-formed type
   constructor expressions} are
\[\begin{array}{cccc}
\AXC{$\Gamma;\emptyset \vdash \tau : \T$}
\UIC{$\Gamma; \emptyset \vdash \tau : \F$}
\DisplayProof
&
\AXC{$\phantom{\Gamma;\Phi}$}
\UIC{$\Gamma;\Phi, v \vdash v : \F$}
\DisplayProof
&
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \zerot : \mcF$}
\DisplayProof
&
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \onet : \mcF$}
\DisplayProof
%&
%\AXC{$\phantom{\Gamma;\Phi \vdash \phi : \mcF}$} 
%\UIC{$\Gamma;\Phi,\alpha^0 \vdash \alpha^0 : \mcF$}
%\DisplayProof
%<- subsumed\;by\;next\;rule\;
\end{array}\]
\[\begin{array}{c}
\AXC{$\Gamma;\Phi \vdash \phi^k : \mcF$}
\AXC{$\quad\quad\ol{\Gamma;\Phi \vdash \tau : \mcF}$}% \mbox{\,for\,} i = 1,...,k$}
\BIC{$\Gamma;\Phi \vdash \phi^k \ol{\tau}$}%_1...\tau_k : \mcF$}
\DisplayProof
\\
\AXC{$\Gamma;\Phi,\ol{\alpha},\phi^k \vdash \tau : \mcF$}
\AXC{$\quad\quad\ol{\Gamma;\Phi \vdash \tau : \mcF}$}% \mbox{\,for\,} i = 1,...,k$}
\BIC{$\Gamma;\Phi \vdash (\mu \phi^k.\lambda
  \ol{\alpha}.%^0_1...\alpha^0_k.
  \,\tau)\ol{\tau}$}%_1...\tau_k : \mcF$}
\DisplayProof
\end{array}\]
\[\begin{array}{cc}
\AXC{$\Gamma;\Phi \vdash \sigma : \mcF$}
\AXC{$\Gamma;\Phi \vdash \tau : \mcF$}
\BIC{$\Gamma; \Phi \vdash \sigma + \tau : \F$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \vdash \sigma : \mcF$}
\AXC{$\Gamma;\Phi \vdash \tau : \mcF$}
\BIC{$\Gamma; \Phi \vdash \sigma \times \tau : \F$}
\DisplayProof
\end{array}\]
\end{dfn}
%Note that if $\Gamma;\Phi \vdash \tau : \T$ then $\Gamma;\emptyset
%\vdash \tau : \T$. 

Our formation rules allow type constructor expressions like
$\List\gamma = (\mu \beta. \lambda \alpha. \onet + \alpha \times
\beta)\gamma$ either to be natural in $\gamma$ or not, according to
whether it is well-formed in the context $\emptyset; \gamma$ or
$\gamma;\emptyset$. If the former, then we can derive $\vdash
\Nat^\gamma \onet (\List\gamma) : \T$. If the latter, then we
cannot. Our formation rules also allow the derivation of, e.g.,
$\delta; \emptyset \vdash \Nat^\gamma (\List \gamma) \, (\Tree \gamma
\delta)$, which represents a natural transformation between lists and
trees that is natural in $\gamma$ but not in $\delta$.

Substitution for first-order type constructor expressions is the usual
capture-avoiding textual substitution. We write $\tau[\alpha :=
  \sigma]$ for the result of substituting $\sigma$ for $\alpha$ in
$\tau$, and $\tau[\alpha_1 := \tau_1,...,\alpha_k := \tau_k]$, or
$\tau[\ol{\alpha := \tau}]$ when convenient, for $\tau[\alpha_1 :=
  \tau_1][\alpha_2 := \tau_2,...,\alpha_k := \tau_k]$.  Substitution
for second-order type constructor expressions is given in the next
definition.
%We write $F[\bm \alpha]$ to indicate that $\Gamma; \Phi, \bm \alpha
%\vdash F : \F$, i.e., that $F$ is a second-order type constructor
%expression depending on (at least) the type constructor variables in
%$\bm \alpha$.

\begin{dfn}\label{def:second-order-subst}
If \,$\Gamma; \Phi, \phi^k \vdash h[\phi] : \F$ and $\Gamma;\Phi,
\ol{\alpha} \vdash F : \F$ with $\ol{\alpha} = \{\alpha_1,...,\alpha_k\}$
and $k \geq 1$, then $\Gamma;\Phi \vdash h[\phi := F] : \F$, where the
operation $(\cdot)[\phi := F]$ of {\em second-order type constructor
  substitution} is defined by:
\[\begin{array}{lll}
\tau[\phi := F] & = & \tau \mbox{ if } \tau \in \T\\[0.5ex] 
\onet[\phi := F] & = & \onet\\[0.5ex]
\zerot[\phi := F] & = & \zerot\\[0.25ex]
(\psi \ol{\tau})[\phi := F] & = &
\left\{\begin{array}{ll}
\psi \,\ol{\tau[\phi := F]} & \mbox{if } \psi \not = \phi\\
F[\ol{\alpha := \tau[\phi := F]}] & \mbox{if } \psi = \phi
\end{array}\right.\\
\\[-0.25ex]
(\sigma + \tau)[\phi := F] & = & \sigma[\phi := F]
+ \tau[\phi := F]\\[0.5ex] 
(\sigma \times \tau)[\phi := F] & = & \sigma[\phi := F] \times \tau[\phi
  := F]\\[0.5ex]  
((\mu \psi. \lambda \ol{\beta}.\, G)\ol{\tau}[\phi :=
  F] & = & (\mu \psi. \lambda \ol{\beta}. \,G[\phi :=
  F])\, \ol{\tau[\phi := F]}
\end{array}\]
\end{dfn}

Note that, since an arity $0$ type constructor is first-order,
substitution into it is just the usual textual replacement, i.e., the
usual notion of substitution, as expected.

\subsection{Terms}

We assume an infinite set $\cal V$ of term variables disjoint from
$\tvars$ and $\V$.

\begin{dfn}
Let $\Gamma$ be a type context and $\Phi$ be a type constructor
context. A {\em term context for $\Gamma$ and $\Phi$} is a finite set of
bindings of the form $x : \tau$, where $x \in {\cal V}$ and $\Gamma;
\Phi \vdash \tau : \F$.
\end{dfn}
We adopt the same conventions for denoting disjoint unions in term
contexts as in type contexts and type constructor contexts.

\begin{dfn}
Let $\Delta$ be a term context for $\Gamma$ and $\Phi$.  The formation
rules for the set of\, {\em well-formed terms over $\Delta$} are
\[\begin{array}{cc}
\AXC{$\Gamma;\emptyset \vdash \tau : \T$}
\UIC{$\Gamma;\emptyset\,|\, \Delta,x :\tau \vdash x : \tau$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \vdash \tau : \mcF$}
\UIC{$\Gamma;\Phi \,|\, \Delta,x :\tau \vdash x : \tau$}
\DisplayProof
\\\\
\AXC{$\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t : \tau$}
\UIC{$\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau$}
\DisplayProof
&
\AXC{$\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to \tau$}
\AXC{$\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma$}
\BIC{$\Gamma;\emptyset \,|\, \Delta \vdash st: \tau$}
\DisplayProof
\\\\
{\color{red}
\AXC{$\Gamma,\alpha;\Phi \vdash \tau : \T$}
\AXC{$\Gamma,\alpha;\Phi \,|\, \Delta \vdash t: \tau$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash \Lambda \alpha.t : \forall \alpha. \tau$}
\DisplayProof}
&
{\color{red}
\AXC{$\Gamma,\alpha;\Phi \vdash \sigma : \T$}
\AXC{$\Gamma;\Phi \vdash \tau : \T$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t: \forall \alpha.\sigma$}
\TIC{$\Gamma;\Phi \,|\, \Delta \vdash t\tau: \sigma[\alpha := \tau]$}
\DisplayProof}
\\\\
{\color{red} No\;intro\; \zerot}
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \zerot$}
\AXC{$\Gamma;\Phi \vdash \tau: \F$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t  : \tau$}
\DisplayProof
\\\\
\AXC{$\phantom{\Gamma;\Phi}$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \top : \onet$}
\DisplayProof
&
    {\color{red}
      No\;elim\; \onet
%\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s : \onet$}
%\AXC{$\Gamma;\Phi \vdash G : \F$}
%%\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : G$}
%\BIC{$\Gamma;\Phi \,|\, \Delta \vdash t s : \Nat^\emptyset \onet G$}
%\DisplayProof
}
\\\\
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: \sigma$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \tau$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: \sigma + \tau$}
\DisplayProof
\end{array}\]
\[\begin{array}{c}
\AXC{$\Gamma; \Phi \vdash \tau,\sigma : \F$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \sigma + \tau$}
\AXC{$\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash l : \gamma \hspace{0.3in} \Gamma;\Phi \,|\, \Delta, y : \tau \vdash r : \gamma$}
\TIC{$\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r} : \gamma$}
\DisplayProof
\end{array}\]

\vspace*{0.05in}

\[\begin{array}{lll}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: \sigma$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \tau$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : \tau$}
\DisplayProof
\end{array}\]

\vspace*{0.05in}

\[\begin{array}{c}
%{\color{red} Do\;we\;want\;this?
%\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \onet$}
%\AXC{$\Gamma;\Phi \vdash G : \F$}
%\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s : G$}
%\TIC{$\Gamma;\Phi \,|\, \Delta \vdash s t : \Nat^\emptyset \onet G$}
%\DisplayProof}
%\\\\
\AXC{$\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}} \,F\,G : \T$}
\AXC{$\Gamma; \ol{\alpha} \,|\, \Delta, x : F
  \vdash t: G  $} 
\BIC{$\Gamma;\emptyset \,|\, \Delta \vdash L_{\ol{\alpha}} x.t : \Nat^{\ol{\alpha}} \,F \,G$}
\DisplayProof
\\\\
\AXC{$\Gamma;\emptyset \,|\, \Delta \vdash t : \Nat^{\ol{\alpha}} \,F \,G$}
\AXC{$\ol{\Gamma;\Phi \vdash \tau : \F}$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F[\overline{\alpha := \tau}]$}
\TIC{$\Gamma;\Phi \,|\, \Delta \vdash t_{\ol{\tau}} s:
  G[\overline{\alpha := \tau}]$}
\DisplayProof
\\\\
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : H[\phi := \mu \phi.\lambda 
  \ol{\alpha}.H][\ol{\alpha := \tau}]$}
\AXC{$\ol{\Gamma;\Phi \vdash \tau}$}%_i \mbox{\,for\,}i = 1,...,k$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash \tin_H \,t : (\mu \phi.\lambda 
  \ol{\alpha}.H)\ol{\tau}$}
\DisplayProof
\\\\
\AXC{$\Gamma; \ol{\alpha} \vdash F : \F$}
\AXC{$\Gamma; \phi,\ol{\beta} \vdash H : \mcF$}
\AXC{$\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\ol{\alpha}}\,H[\phi := F][\ol{\beta := \alpha}]\,F$}
\TIC{$\Gamma;\emptyset \,|\, \Delta \vdash
  \fold_H\, t : \Nat^{\ol{\alpha}}\,((\mu
  \phi.\lambda \ol{\beta}.H)\ol{\alpha})\,F$} 
\DisplayProof
\end{array}\]
\end{dfn}

\section{Interpreting Types}\label{sec:type-interp}

Parametricity requires that set interpretations of types are defined
concurrently with their relational interpretations. In this section we
give the set interpretations for types; in the next section we give
their relational interpretations. While the set interpretations are
relatively straightforward, their relation interpretations are less
so, mainly because of the cocontinuity conditions we must impose to
ensure that they are well-behaved. We take some effort to develop
these in Section~\ref{sec:rel-interp}, which separates
Definitions~\ref{def:set-sem} and~\ref{def:rel-sem} in space but
otherwise has no impact on the fact that they are given by mutual
induction.

\subsection{Interpreting Types as Sets}\label{sec:set-interp}

\begin{dfn}
A {\em set environment} maps each type variable to a set, and each
type constructor variable of arity $k$ to an element of
$[\set^k,\set]$. 
%to an $\omega$-cocontinuous functor from $\set^k$ to $\set$. 
A morphism $f : \rho \to \rho'$ from a set environment $\rho$ to a set
environment $\rho'$ with $\rho|_\V = \rho'|_\V$ maps each type
variable $v$ to $\id_{ \rho v}$, and each type constructor variable
$\phi$ of arity $k$ to a natural transformation from the $k$-ary
functor $\rho \phi$ on $\set$ to the $k$-ary functor $\rho' \phi$ on
$\set$. Composition of morphisms on set environments is given
componentwise, with the identity morphism mapping each set environment
to itself. This gives a category of set environments and morphisms
between them, which we denote $\setenv$.
\end{dfn}
When convenient we identify a functor $F : [\set^0, \set]$ with the
set that is its codomain.  With this convention, a set environment
maps a type constructor variable of arity $0$ to an
$\omega$-cocontinuous functor from $\set^0$ to $\set$ --- i.e., to a
set --- just as it does a type variable. If $\ol{\alpha} =
\{\alpha_1,...,\alpha_k\}$ and $\ol{A} = \{A_1,...,A_k\}$, then we
write $\rho[\ol{\alpha := A}]$ for the set environment $\rho'$ such
that $\rho' \alpha_i = A_i$ for $i = 1,...,k$ and $\rho' \alpha = \rho
\alpha$ if $\alpha \not \in \{\alpha_1,...,\alpha_k\}$.

If $\rho$ is a set environment we write $\Eq_\rho$ for the relation
environment such that $\Eq_\rho v = \Eq_{\rho v}$ for every type
variable or type constructor variable $v$; see
Definition~\ref{def:reln-env} below for the complete definition of a
relation environment. The relational interpretations referred to in
the condition on the natural transformations in the clause of
Definition~\ref{def:set-sem} for types of the form
$\Nat^{\ol{\alpha}}\,F\,G$ are given in full in
Definition~\ref{def:rel-sem}. Intuitively, this condition can be
thought of as ensuring that set interpretations of such terms are
sufficiently uniform.

%If $\rho$ is a set environment and $\tau : \F$ then we write $\tau
%\rho$ for the result of applying $\rho$ to $\tau$. When $\vdash \tau
%: \mcF$ we write $\tau$ instead of $\tau\rho$ since the environment
%is immaterial.  We will adopt similar conventions for terms in
%Section~\ref{sec:term-interp} below.

\begin{dfn}\label{def:set-sem}
Let $\rho$ be a set environment. The {\em set interpretation}
$\setsem{\cdot} : \F \to [\setenv, \set]$ is defined by
\begin{align*}
  \setsem{\Gamma;\emptyset \vdash v} \rho &= \rho v \mbox{
    if } v \in \V\\ 
  \setsem{\Gamma;\emptyset \vdash \sigma \to \tau}\rho &=
  \setsem{\Gamma;\emptyset \vdash \sigma} \rho \to
  \setsem{\Gamma;\emptyset \vdash \tau} \rho\\ 
 & {\color{red} \mbox{need to interpret forall types if we include them}}\\
  \setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}
    \,F\,G}\rho &= \{\eta : \setsem{\Gamma; \ol{\alpha} \vdash
    F}\rho[\ol{\alpha := \text{--}}] 
      \Rightarrow \setsem{\Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha
          := \text{--}}] \\ 
      &\hspace{0.3in}|~\forall \overline{A}, \overline{B} :
      \set. \forall \overline{R : \rel(A, B)}.\\ 
      &\hspace{0.4in}(\eta_{\overline{A}}, \eta_{\overline{B}})
      : \relsem{\Gamma; \ol{\alpha} \vdash F}\Eq_{\rho}[\ol{\alpha := R}]
      \rightarrow \relsem{\Gamma;\ol{\alpha} \vdash
        G}\Eq_{\rho}[\ol{\alpha := R}] \} \\
  %  &\\
%  = {\color{red}
%    \{({\setsem{G}\rho[\bm \alpha := \bm S]})^{(\setsem{F}\rho[\bm
%        \alpha := \bm S])}~|~ \bm S \in \set^{|{\bm \alpha}|}\}}\\ 
%
% In a general ccc this would be
%  &=\int_{\bm A \in \C_0^{|\bm \alpha|}}
%  (\setsem{G}\rho[\bm \alpha := \bm A])^{(\setsem{F}\rho[\bm \alpha := \bm A])}\\
  \setsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \setsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
  \setsem{\Gamma;\Phi \vdash \phi\ol{\tau}}\rho &=
  (\rho\phi)\,\ol{\setsem{\Gamma;\Phi \vdash
    \tau}\rho}\\%)...(\setsem{\Gamma;\Phi \vdash \tau_k}\rho)\\   
  \setsem{\Gamma;\Phi \vdash \sigma+\tau}\rho &=
  \setsem{\Gamma;\Phi \vdash \sigma}\rho +
  \setsem{\Gamma;\Phi \vdash \tau}\rho\\
  \setsem{\Gamma;\Phi \vdash \sigma\times \tau}\rho &=
  \setsem{\Gamma;\Phi \vdash \sigma}\rho \times
  \setsem{\Gamma;\Phi \vdash \tau}\rho\\ 
  \setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{\tau}}\rho &= (\mu
    T^\set_{\rho})\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}\\
    %)...(\setsem{\Gamma;\Phi \vdash \tau_k}\rho) \\
    \text{where } T^\set_{\rho} F & = \lambda
  \ol{A}. \setsem{\Gamma;\Phi,\phi, \ol{\alpha} \vdash
    H}\rho[\phi :=  F][\ol{\alpha := A}]\\
  \text{and } T^\set_{\rho} \eta &= \lambda
  \ol{A}. \setsem{\Gamma;\Phi,\phi, \ol{\alpha} \vdash
    H}\id_\rho[\phi := \eta][\ol{\alpha := \id_{A}}]
\end{align*}
\end{dfn}
If $\rho$ is a set environment and $\vdash \tau : \F$ then we may
write $\setsem{\vdash \tau}$ instead of $\setsem{\emptyset; \emptyset
  \vdash \tau}\rho$ since the environment is
immaterial. Definition~\ref{def:set-sem} ensures that
\[\setsem{\Gamma;\Phi \vdash F \ol{\tau}}\rho =
  \setsem{\Gamma;\Phi,\ol{\alpha} \vdash F\ol{\alpha}}
  (\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash \tau}}])\] Moreover,
  the third {\color{red} fourth} clause does indeed define a
  set. Indeed, local finite presentability of $\set$ and
  $\omega$-cocontinuity of $\setsem{\Gamma;\ol{\alpha} \vdash F}\rho$
  ensure that $\{\eta : \setsem{\Gamma;\ol{\alpha} \vdash F}\rho
  \Rightarrow \setsem{\Gamma;\ol{\alpha} \vdash G}\rho\}$ (which
  contains $\setsem{\Gamma;\emptyset \vdash
    \Nat^{\ol{\alpha}}\,F\,G}\rho$) is a subset of
\[\big\{({\setsem{\Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha :=
    S}]})^{(\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha :=
      S}])}~\big|~ \ol{S} = (S_1,...,S_{|\ol{\alpha}|}), \mbox{ and }
S_i \mbox{ is a finite set for } i = 1,...,|\ol{\alpha}|\big\}\] There
are countably many choices for tuples $\ol{S}$, and each of these
gives rise to a morphism from ${\setsem{\Gamma;\ol{\alpha} \vdash
    F}\rho[ \ol{\alpha := S}]}$ to ${\setsem{\Gamma;\ol{\alpha} \vdash
    G}\rho[\ol{\alpha := S}]}$. But there are only $\set$-many choices
of morphisms between these (or any) two objects because $\set$ is
locally small.
%$\{\eta_X : \setsem{F}\rho\,X
%\Rightarrow \setsem{G}\rho\,X~|~X \mbox{ is finite } \}$.
%
%$\{\,\{\eta_X~|~ X \mbox{ is finite }\}
%~|~ \eta : \setsem{F}\rho \Rightarrow \setsem{G}\rho\}$.

In order to make sense of the last clause in
Definition~\ref{def:set-sem}, we need to know that $T^\set_{\rho}$ is
an $\omega$-cocontinuous endofunctor on $[\set^k, \set]$, so that it
admits a fixed point.  Since $T_\rho^\set$ is defined in terms of
$\setsem{\Gamma;\Phi,\phi, \ol{\alpha} \vdash H}$, this means that set
interpretations of types must be functors.  This in turn means that
the actions of set interpretations of types on objects and on
morphisms in $\setenv$ are intertwined.  In fact, we know
from~\cite{jp19} that, for every $\Gamma; \ol{\alpha} \vdash \tau :
\F$, $\setsem{\Gamma; \ol{\alpha} \vdash \tau}$ is actually functorial
in $\ol{\alpha}$ and $\omega$-cocontinuous.  What remains is to define
the actions of each of these functors on morphisms between
environments.

\begin{dfn}
Let $f: \rho \to \rho'$ for set environments $\rho$ and $\rho'$ such
that $\rho|_\V = \rho'|_\V$. The action $\setsem{\Gamma;\Phi \vdash
  \tau}f$ of\, $\setsem{\Gamma;\Phi \vdash \tau}$ on the morphism $f$
is given as follows:
\begin{itemize}
\item If $\Gamma,v;\emptyset \vdash v$ then
  $\setsem{\Gamma,v;\emptyset \vdash v}f = \id_{\rho v}$.
\item If $\Gamma;\emptyset \vdash \sigma \to \tau$ then
  $\setsem{\Gamma;\emptyset \vdash \sigma \to \tau}f =
  \id_{\setsem{\Gamma;\emptyset \vdash \sigma \to \tau}\rho}$.
\item If $\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G$, then we
  define $\setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G} f =
  \id_{\setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G}\rho}$.
\item If $\Gamma;\Phi \vdash \zerot$ then $\setsem{\Gamma;\Phi \vdash
  \zerot}f = \id_0$.
\item If $\Gamma;\Phi \vdash \onet$ then $\setsem{\Gamma;\Phi \vdash
  \onet}f = \id_1$.
\item If $\Gamma;\Phi \vdash \phi \ol{\tau}$, then we have that
  $\setsem{\Gamma;\Phi \vdash \phi \ol{\tau}} f : \setsem{\Gamma;\Phi
  \vdash \phi \ol{\tau}}\rho \to \setsem{\Gamma;\Phi \vdash
  \phi\ol{\tau}}\rho' = (\rho\phi) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}
  \to (\rho'\phi) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}$ is defined
  by $\setsem{\Gamma;\Phi \vdash \phi \ol{\tau}} f =
  (f\phi)_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}}\, \circ\,
  (\rho\phi) {\ol{\setsem{\Gamma;\Phi \vdash \tau}f}} = (\rho'\phi)
  {\ol{\setsem{\Gamma;\Phi \vdash \tau}f}}\, \circ\, (f
  \phi)_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}}$.  This equality
  holds because $\rho\phi$ and $\rho'\phi$ are functors and $f\phi :
  \rho\phi \to \rho'\phi$ is a natural transformation, so that the
  following naturality square commutes:
\begin{equation}\label{eq:cd2}
\begin{CD}
  (\rho\phi) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} @> (f\phi)_{
    \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}} >> (\rho'\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} \\ @V(\rho\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}f}VV @V (\rho'\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}f} VV \\ (\rho\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'} @>(f\phi)_{
    \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}}>> (\rho'\phi)
  \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}
\end{CD}
\end{equation}
\item If $\Gamma;\Phi \vdash \sigma + \tau$ then $\setsem{\Gamma;\Phi
  \vdash \sigma + \tau}f$ is defined by $\setsem{\Gamma;\Phi \vdash
  \sigma + \tau}f(\inl\,x) = \inl\,(\setsem{\Gamma;\Phi \vdash
  \sigma}f x)$ and $\setsem{\Gamma;\Phi \vdash \sigma +
  \tau}f(\inr\,y) = \inr\,(\setsem{\Gamma;\Phi \vdash \tau}f y)$.
\item If $\Gamma;\Phi\vdash \sigma \times \tau$ then
  $\setsem{\Gamma;\Phi \vdash \sigma \times \tau}f = 
  \setsem{\Gamma;\Phi \vdash \sigma}f \times \setsem{\Gamma;\Phi \vdash
    \tau}f$.
\item If $\Gamma;\Phi \vdash (\mu \phi.\lambda \ol{\alpha}. H)\ol{\tau}$ then
%writing
%\[\begin{array}{ccc}
%T^\set_\rho & = & F \mapsto \lambda R_1...R_k. \setsem{\Gamma;\Phi,\phi,\bm
%  \alpha \vdash H}\rho[\phi :=
%  F][\alpha_1 := R_1]...[\alpha_k := R_k]\\
%T^\set_{\rho'} & = & F \mapsto \lambda
%R_1...R_k. \setsem{\Gamma;\Phi,\phi,\bm \alpha \vdash H}\rho'[\phi
%  := F][\alpha_1 := R_1]...[\alpha_k := R_k]\\
%\end{array}\]
%\noindent
%and
letting $\sigma^\set_f : T^\set_\rho \to T^\set_{\rho'}$ be the map
\[ F \mapsto \lambda \ol{A}. \setsem{\Gamma;\Phi,\phi,\ol{\alpha} \vdash
  H}f[\phi := \id_F][\ol{\alpha := \id_A}] \] 
we define
\[\begin{array}{cl}
 & \setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{\tau}} f\\
 : & \setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{\tau}} \rho \,\to \,\setsem{\Gamma;\Phi \vdash (\mu
  \phi.\lambda\ol{\alpha}. H)\ol{\tau}} \rho'\\
 = & (\mu T^\set_\rho)\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}\, \to \, (\mu
T^\set_{\rho'})\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}
\end{array}\]
\noindent
by
\[\begin{array}{ll}
& (\mu \sigma^\set_f)\ol{\setsem{\Gamma;\Phi \vdash
  \tau}\rho'} \circ (\mu T^\set_\rho)\ol{\setsem{\Gamma;\Phi \vdash \tau}f}\\
= & (\mu T^\set_{\rho'})\ol{\setsem{\Gamma;\Phi \vdash \tau}f} \circ (\mu
\sigma^\set_f)\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} 
\end{array}\]
Again, this equality holds because $\mu T^\set_\rho$ and $\mu
T^\set_{\rho'}$ are functors and $\mu \sigma_f^\set : \mu T_\rho^\set
\to \mu T_{\rho'}^\set$ is a
natural transformation, so that the following naturality square
commutes:

\begin{equation}\label{eq:cd3}
\begin{CD}
 (\mu T^\set_\rho) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} @> (\mu
  \sigma^\set_f)_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}} >> (\mu
  T^\set_{\rho'}) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho} \\ 
 @V(\mu T^\set_\rho) \ol{\setsem{\Gamma;\Phi \vdash \tau}f})VV @V  (\mu
 T^\set_{\rho'}) \ol{\setsem{\Gamma;\Phi \vdash \tau}f} VV \\ 
(\mu T^\set_\rho) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'} @>(\mu
 \sigma^\set_f)_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}}>> (\mu
 T^\set_{\rho'}) \ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}
\end{CD}
\end{equation}
\end{itemize}
\end{dfn}

\subsection{Interpreting Types as Relations}\label{sec:rel-interp}

%To generalize to relations over an arbitrary category $\C$:
%\begin{dfn}
%Let $\C$ be a category. The category $\rel(\C)$ is defined as follows.
%\begin{itemize}
%\item An object of $\rel(\C)$ is a subobject of $A \times B$ provided
%  $\C$ has subobject classifiers? given by the fibrational definition
%  (if we want relations to be derived from predicates)? a reflexive
%  graph (if we want them to be more abstract)? We write $R :
%  \rel(A,B)$ to indicate that an object $R$ of $\rel$ is a relation
%  between objects $A$ and $B$ of $\C$, and $(a,b) \in R$ to indicate
%  that $a$ and $b$ are related by $R$.
%\item A morphism between objects $R : \rel(A,B)$ and $R' :
%  \rel(A',B')$ is a pair $(f : A \to A',g : B \to B')$ of morphisms in
%  $\C$ such that $(fa,g\,b) \in R'$ whenever $(a,b) \in R$.
%  \end{itemize}
%\end{dfn}

\begin{dfn}\label{def:rel-transf}
A {\em $k$-ary relation transformer} $F$ is a triple $(F^0, F^1,F^*)$,
where $F^0,F^1 : [\set^k,\set]$ are functors, $F^* : [\rel^k, \rel]$
is a functor, if $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then $F^*
\ol{R} : \rel(F^0 \ol{A}, F^1 \ol{B})$, and if $(\alpha_1, \beta_1)
\in \Homrel(R_1,S_1),..., (\alpha_k, \beta_k) \in \Homrel(R_k,S_k)$
then $F^* \ol{(\alpha, \beta)} = (F^0 \ol{\alpha}, F^1 \ol{\beta})$.
We define $F\overline{R}$ to be $F^*\overline{R}$ and
$F\overline{(\alpha,\beta)}$ to be $F^*\overline{(\alpha,\beta)}$.
\end{dfn}
Expanding the last clause of Definition~\ref{def:rel-transf} is
equivalent to: if $\ol{(a,b) \in R}$ implies $\ol{(\alpha\,a,\beta\,b)
  \in S}$ then $(c,d) \in F^*\ol{R}$ implies $(F^0 \ol{\alpha}\,c,F^1
\ol{\beta}\,d) \in F^*\ol{S}$.

When convenient we identify a $0$-ary relation transformer $(A,B,R)$
with $R : \rel(A,B)$. We may also write $F^0$ and $F^1$ for $\pi_1 F$
and $\pi_2 F$. We extend these conventions to relation environments,
introduced in Definition~\ref{def:reln-env} below, as well.

\begin{dfn}
The category $RT_k$ of $k$-ary relation transformers is given by the
following data:
\begin{itemize}
\item An object of $RT_k$ is a relation transformer.
\item A morphism $\delta : (G^0,G^1,G^*) \to (H^0,H^1,H^*)$ in $RT_k$ is
  a pair of natural transformations $(\delta^0, \delta^1)$ where
  $\delta^0 : G^0 \to H^0$, $\delta^1 : G^1 \to H^1$ such that, for
  all $\ol{R : \rel(A, B)}$, if $(x, y) \in G^*\ol{R}$ then
  $(\delta^0_{\ol{A}}x, \delta^1_{\ol{B}}y) \in H^*\ol{R}$.  {\color{red}
    This is basically a fibred natural transformation, but for
    heterogeneous relations.}
  %$H^* \bm R \circ \delta^0_{\bm A} = \delta^1_{\bm B}
  %\circ G^*\bm R$.
\item Identity morphisms and composition are inherited from the
  category of functors on $\set$.
\end{itemize}
\end{dfn}

\begin{dfn}\label{def:RT-functor}
An endofunctor $H$ on $RT_k$ is a triple $H = (H^0,H^1,H^*)$, where
\begin{itemize}
\item $H^0$ and $H^1$ are functors from $[\set^k,\set]$ to $[\set^k,\set]$
\item $H^*$ is a functor from $RT_k$ to $[\rel^k,\rel]$
\item for all $\overline{R : \rel(A,B)}$,
  $\pi_1((H^*(\delta^0,\delta^1))_{\overline{R}}) = (H^0 \delta^0)_{\overline{A}}$ and
    $\pi_2((H^*(\delta^0,\delta^1))_{\overline{R}}) = (H^1 \delta^1)_{\overline{B}}$
\item The action of $H$ on objects is given by $H\,(F^0,F^1,F^*) =
  (H^0F^0,\,H^1F^1,\,H^*(F^0,F^1,F^*))$  
\item The action of $H$ on morphisms is given by
  $H\,(\delta^0,\delta^1) = (H^0\delta^0,H^1\delta^1)$ for
  $(\delta^0,\delta^1) : (F^0,F^1,F^*)\to (G^0,G^1,G^*)$
\end{itemize}
\end{dfn}
Since the results of applying $H$ to $k$-ary relation transformers and
morphisms between them must again be $k$-ary relation transformers and
morphisms between them, respectively, Definition~\ref{def:RT-functor}
implicitly requires that the following three conditions hold:
\begin{enumerate}
\item if $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then
  \[H^*(F^0,F^1,F^*) \ol{R} : \rel(H^0F^0 \ol{A}, H^1F^1 
  \ol{B})\] In other words, $\pi_1 (H^*(F^0,F^1,F^*) \ol{R}) = H^0F^0
  \ol{A}$ and $\pi_2 (H^*(F^0,F^1,F^*) \ol{R}) = H^1F^1 \ol{B}$.
\item if $(\alpha_1, \beta_1) \in \Homrel(R_1,S_1),..., (\alpha_k,
  \beta_k) \in \Homrel(R_k,S_k)$, then
  \[H^*(F^0,F^1,F^*) \ol{(\alpha, \beta)} = (H^0F^0\ol{\alpha}, H^1F^1
  \ol{\beta})\] In other words, $\pi_1 (H^*(F^0,F^1,F^*) \ol{(\alpha,
    \beta)}) = H^0F^0 \ol{\alpha}$ and $\pi_2 (H^*(F^0,F^1,F^*) 
      \ol{(\alpha, \beta)}) = H^1F^1 \ol{\beta}$.
\item if $(\delta^0,\delta^1) : (F^0,F^1,F^*)\to (G^0,G^1,G^*)$ and
  $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then
  \[\mbox{ if }(x, y) \in H^*(F^0,F^1,F^*)\ol{R} \mbox{ then }
  ((H^0\delta^0)_{\ol{A}}x, (H^1\delta^1)_{\ol{B}}y) \in
  H^*(G^0,G^1,G^*)\ol{R}\]
  Note, however, that this condition is automatically satisfied
  because it is implied by the third bullet point of
  Definition~\ref{def:RT-functor}. 
\end{enumerate}

\begin{dfn}\label{def:RT-nat-trans}
If $H$ and $K$ are endofunctors on $RT_k$, then a {\em natural
  transformation} $\sigma : H \to K$ is a pair $\sigma = (\sigma^0,
\sigma^1)$, where $\sigma^0 : H^0 \to K^0$ and $\sigma^1 : H^1 \to
K^1$ are natural transformations between endofunctors on
$[\set^k,\set]$ and the component of $\sigma$ at the $k$-ary relation
transformer $F$ is given by $\sigma_F = (\sigma^0_{F^0},
\sigma^1_{F^1})$.
% $F$ in $RT_k$ and $i = 0, 1$, $\sigma^i F$ is a natural
% transformation $H^i F^i \to K^i F^i$
\end{dfn}
Definition~\ref{def:RT-nat-trans} entails that $\sigma^i_{F^i}$ must
be natural in $F^i : [\set^k,\set]$, and, for every $F$, both
$(\sigma^0_{F^0})_{\overline{A}}$ and
$(\sigma^1_{F^1})_{\overline{A}}$ must be natural in $\overline{A}$.
Moreover, since the results of applying $\sigma$ to $k$-ary relation
transformers must be morphisms of $k$-ary relation transformers,
Definition~\ref{def:RT-nat-trans} implicitly requires that
$(\sigma_F)_{\overline{R}} = ( (\sigma^0_{F^0})_{\overline{A}},
(\sigma^1_{F^1})_{\overline{B}})$ is a morphism in $\rel$ for any
$k$-tuple of relations $\overline{R : \rel(A, B)}$, i.e., if $(x, y)
\in H^*F\overline{R}$, then $((\sigma^0_{F^0})_{\overline{A}} x,
(\sigma^1_{F^1})_{\overline{B}} y) \in K^*F\overline{R}$.

\vspace*{0.1in}

Next, we see that we can compute colimits in $RT_k$.

%\begin{lemma}
%For any functor $T$ on $RT$, $\mu T = \colim{n}{T^nK_0}$.
%\end{lemma}
%\begin{proof}
%Let $\{\iota^0_n : (T^0)^nK_0 \to \mu T^0\}$ be the cocone for the
%colimit $\mu T^0$ and $\{\iota^1_n : (T^1)^nK_0 \to \mu T^1\}$ be the
%cocone for the colimit $\mu T^1$. We first show that
%$(\iota^0_n,\iota^1_n) : T^nK_0 \to \mu T$ is a morphism in $RT$. To
%see this, suppose $\bm R : \rel(\bm A,\bm B)$ and let $(x,y) \in
%(T^nK_0)^* \bm R$. Then $((\iota^0_n)_{\bm A} x, (\iota^1_n)_{\bm B}
%y) \in \colim{n}{(T^nK_0)^*\bm R}$ since this is precisely what it
%means for $\colim{n}{(T^nK_0)^*}\bm R$ to be the colimit of the
%$(T^nK_0)^*\bm R$s.
%
%Now, to see that $\mu T = \colim{n}{T^nK_0}$ in $RT$, we first note
%that $\mu T$ is a cocone for the $T^nK_0$s with horizontal maps $T^n!
%: T^nK_0 \to T^{n+1}K_0$, where $! = (!,!,!)$ is the unique map from
%$K_0$ to $TK_0$, and structure maps $(\iota^0_n,\iota^1_n)$. To see
%that $\mu T$ is the colimiting cocone, let $C$ be another cocone with
%mediating morphisms $(\delta_n^0,\delta_n^1) : T^nK_0 \to C$. These
%morphisms are such that, for all $n$ and all $\bm R : \rel(\bm A,\bm B)$,
%\begin{equation}\label{eq:item1}
%\mbox{ if } (x,y) \in (T^nK_0)^*\bm R, \mbox{ then }
%((\delta_n^0)_{\bm A}x, (\delta_n^1)_{\bm B}y) \in C^*\bm R
%\end{equation}
%Let $\psi = (\psi^0,\psi^1)$, where $\psi^0$ is the unique morphism in
%$\set$ such that $\delta_n^0 = \psi^0 \circ \iota_n^0$ and $\psi^1$ is
%the unique morphism in $\set$ such that $\delta_n^1 = \psi^1 \circ
%\iota_n^1$. We claim that $\psi$ is the unique morphism from $\mu T$
%to $C$ in $RT$ such that $(\delta_n^0,\delta_n^1) = \psi \circ
%(\iota_n^0,\iota_n^1)$. If $\psi$ is a morphism in $RT$, then it is
%clearly unique with the required property. To see that $\psi$ is
%indeed a morphism in $RT$, let $\bm R : \rel(\bm A,\bm B)$ and suppose
%$(x,y) \in \colim{n}{(T^nK_0)^*\bm R}$. Then there exist $n$ and
%$(x',y') \in (T^nK_0)^*\bm R$ such that $x = (\iota^0_n)_{\bm A} x'$
%and $y = (\iota^1_n)_{\bm B} y'$, so $((\psi_n^0)_{\bm A}x,
%(\psi_n^1)_{\bm B}y) = ((\psi_n^0)_{\bm A}((\iota^0_n)_{\bm A} x'),
%(\psi_n^1)_{\bm B}((\iota^1_n)_{\bm B} y')) = ((\delta_n^0)_{\bm A}x',
%(\delta_n^1)_{\bm B}y')$, which is in $C^*\bm R$ by
%Equation~\ref{eq:item1}.
%\end{proof}

\begin{lemma}\label{lem:colimits}
$\colim{d \in {\cal D}}{(F^0_d, F^1_d,F^*_d)} = (\colim{d \in {\cal
      D}}{F^0_d}, \colim{d \in {\cal D}}{F^1_d}, \colim{d \in {\cal
      D}}{F^*_d})$
\end{lemma}
\begin{proof}
We first observe that $(\colim{d \in {\cal D}}{F^0_d}, \colim{d \in
  {\cal D}}{F^1_d}, \colim{d \in {\cal D}}{F^*_d})$ is in $RT_k$.  If
$R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then $\colim{d \in \cal
  D}{F^*_d\ol{R}} : \rel(\colim{d \in {\cal D}}{F^0_d\ol{A}},
\,\colim{d \in {\cal D}}{F^1_d\ol{B}})$ because of how colimits are
computed in $\rel$. Moreover, if $(\alpha_1, \beta_1) \in
\Homrel(R_1,S_1),..., (\alpha_k, \beta_k) \in \Homrel(R_k,S_k)$, then
\[\begin{array}{ll}
  & (\colim{d \in \cal D}{F_d^*})\ol{(\alpha,\beta)}\\
= & \colim{d \in \cal D}{F_d^*\ol{(\alpha,\beta)}}\\
= & \colim{d \in \cal D}{(F_d^0\ol{\alpha},\, F_d^1\ol{\beta})}\\
= & (\colim{d \in \cal D}{F^0_d \ol{\alpha}}, \,\colim{d \in \cal D}{
  F^1_d \ol{\beta}})
\end{array}\]
so $(\colim{d \in {\cal D}}{F^0_d}, \colim{d \in {\cal D}}{F^1_d},
\colim{d \in {\cal D}}{F^*_d})$ actually is in $RT_k$.

Now to see that $\colim{d \in {\cal D}}{(F^0_d, F^1_d,F^*_d)} =
(\colim{d \in {\cal D}}{F^0_d}, \colim{d \in {\cal D}}{F^1_d},
\colim{d \in {\cal D}}{F^*_d})$, let $\gamma^0_d : F^0_d \to \colim{d
  \in {\cal D}}{F^0_d}$ and $\gamma^1_d : F^1_d \to \colim{d \in {\cal
    D}}{F^1_d}$ be the injections for the colimits $\colim{d \in {\cal
    D}}{F^0_d}$ and $\colim{d \in {\cal D}}{F^1_d}$,
respectively. Then $(\gamma^0_d, \gamma^1_d) : (F^0_d, F^1_d,F^*_d)
\to \colim{d \in {\cal D}}{(F^0_d, F^1_d,F^*_d)}$ is a morphism in
$RT_k$ because, for all $\ol{R : \rel(A, B)}$,
$((\gamma^0_d)_{\ol{A}}, (\gamma^1_d)_{\ol{B}}) : F^*_d \ol{R} \to
\colim{d \in {\cal D}}{F^*_d \ol{R}}$ is a morphism in $\rel$. So
$\{(\gamma^0_d, \gamma^1_d)\}_{d \in {\cal D}}$ are the mediating
morphisms of a cocone in $RT_k$ with vertex $\colim{d \in {\cal
    D}}{(F^0_d, F^1_d,F^*_d)}$. To see that this cocone is a
colimiting cocone, let $C = (C^0,C^1,C^*)$ be the vertex of a cocone
for $\{(F^0_d,F^1_d,F^*_d)\}_{d \in {\cal D}}$ with injections
$(\delta^0_d,\delta^1_d) : (F^0_d,F^1_d,F^*_d) \to C$. If $\eta^0 :
\colim{d \in {\cal D}}{F^0_d} \to C^0$ and $\eta^1 : \colim{d \in
  {\cal D}}{F^1_d} \to C^1$ are the mediating morphisms in
$[\set^k,\set]$, then $\eta^0$ and $\eta^1$ are unique such that
$\delta^0_d = \eta^0 \circ \gamma^0_d$ and $\delta^1_d = \eta^1 \circ
\gamma^1_d$.  We therefore have that $(\eta^0,\eta^1) : \colim{d \in
  {\cal D}}{(F^0_d, F^1_d,F^*_d)} \to C$ is the mediating morphism in
$RT_k$. Indeed, for all $\ol{R : \rel(A,B)}$ and $(x,y) \in \colim{d
  \in {\cal D}}{F^*_d \ol{R}}$, there exist $d$ and $(x',y') \in
F^*_d\ol{R}$ such that $(\gamma^0_d)_{\ol{A}}x' = x$ and
$(\gamma^1_d)_{\ol{B}}y' = y$. But then $(\eta^0_{\ol{A}}x,
\eta^1_{\ol{B}}y) = (\eta^0_{\ol{A}}((\gamma^0_d)_{\ol{A}}x'),
\eta^1_{\ol{B}}((\gamma^1_d)_{\ol{B}}y')) = ((\delta^0_d)_{\ol{A}}x',
(\delta^1_d)_{\ol{B}}y')$, and this pair is in $C^*\ol{R}$ because
$(\delta^0_d, \delta^1_d)$ is a morphism from $(F^0_d,F^1_d,F^*_d)$ to
$C$ in $RT_k$.
\end{proof}

\begin{dfn}\label{def:omega-cocont}
An endofunctor $T = (T^0,T^1,T^*)$ on $RT_k$ is {\em
  $\omega$-cocontinuous} if $T^0$ and $T^1$ are $\omega$-cocontinuous
endofunctors on $[\set^k,\set]$ and $T^*$ is an $\omega$-cocontinuous
functor from $RT_k$ to $[\rel^k,\rel]$, i.e., is in
$[RT_k,[\rel^k,\rel]]$. 
%, for every $\omega$-directed set $\cal D$,
%\[T\,\colim{d \in {\cal D}}{(F^0_d, F^1_d,F^*_d)} = \colim{d \in {\cal
%    D}}{T (F^0_d, F^1_d,F^*_d)}\]
\end{dfn}

For any $k$ and $R : \rel(A, B)$, let $K^\rel_R$ be the constantly
$R$-valued functor from $\rel^k$ to $\rel$, and for any $k$ and set
$A$, let $K^\set_A$ be the constantly $A$-valued functor from $\set^k$
to $\set$. Moreover, let $0$ denote either the initial object of
$\set$ or the initial object of $\rel$, depending on the context.
Observing that, for every $k$, $K^\set_0$ is initial in
$[\set^k,\set]$, and similarly for $K^\rel_0$, we have that, for each
$k$, $K_0 = (K^\set_0,K^\set_0,K^\rel_0)$ is initial in $RT_k$. Thus,
if $T = (T^0,T^1,T^*) : RT_k \to RT_k$ is an endofunctor on $RT_k$
then we can define $\mu T$ to be the relation transformer
\begin{equation*}
\mu T = \colim{n \in \nat}{T^n K_0}
\end{equation*}
Then Lemma~\ref{lem:colimits} shows $\mu T$ is indeed a relation
transformer, and that it is given explicitly by
\begin{equation}\label{eq:mu}
\colim{n \in \nat}{T^n K_0} = (\mu T^0,\mu T^1,
\colim{n \in \nat}{(T^nK_0)^*})
\end{equation}

\begin{lemma}\label{lem:fp}
For any $T : [RT_k,RT_k]$, $\mu T \cong T(\mu T)$.
\end{lemma}
\begin{proof}
We have $T(\mu T) = T(\colim{n \in \nat}{(T^nK_0)}) \cong \colim{n \in
\nat}{T(T^nK_0)} =
\mu T$.
\end{proof}
In fact, the isomorphism in Lemma~\ref{lem:fp} is given by the
morphisms $(in_0, in_1) : T(\mu T) \to \mu T$ and $(in_0^{-1},
in_1^{-1}) : \mu T \to T(\mu T)$ in $RT_k$. It is worth noting that the
latter is always a morphism in $RT_k$, but the former isn't necessarily
a morphism in $RT_k$ unless $T$ is $\omega$-cocontinuous.

%For this, we need to show that $T (\mu T) = (T^0 (\mu T^0), T^1 (\mu
%T^1), T^*(\mu T))$ is isomorphic to $(\mu T^0, \mu T^1,
%\colim{n}{(T^nK_0)^*})$. Let $in_0 : T^0 (\mu T^0) \to \mu T^0$ and
%$in_1 : T^1 (\mu T^1) \to \mu T^1$ be the canonical isomorphisms given
%by the fixed points. Then $(in^{-1}_0, in^{-1}_1)$ is a morphism from
%$(\mu T^0, \mu T^1, \colim{n}{(T^nK_0)^*})$ to $(T^0 (\mu T^0), T^1
%(\mu T^1), T^*(\mu T))$. To see this we need to show that for all
%$R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, if $(x,y) \in
%\colim{n}{(T^nK_0)^*}\bm R$ then $((in_0^{-1})_{\bm A}x,
%(in_1^{-1})_{\bm B}y) \in T^*(\mu T)\bm R$. Letting $\{\iota^0_n :
%(T^0)^nK_0 \to \mu T^0$ be the cocone for the colimit $\mu T^0$ and
%$\{\iota^1_n : (T^1)^nK_0 \to \mu T^1$ be the cocone for the colimit
%$\mu T^1$, we first note that if $(x,y) \in \colim{n}{(T^nK_0)^* \bm
%  R}$, then there exists an $n$ such that $((\iota^0_n)^{-1}_{\bm A}
%x, (\iota^1_n)^{-1}_{\bm B} y) \in (T^nK_0)^*\bm R$. But this implies
%that $((\iota^0_n)^{-1}_{\bm A} x, (\iota^1_n)^{-1}_{\bm B} y) \in
%T^*(T^{n-1}K_0)\bm R$. Now note that $(\iota_n^0,\iota_n^1)$ is a
%morphism from $T^nK_0$ to $\mu T$ because if $(x,y) \in (T^nK_0)^*\bm
%R$ then $((\iota^0_n)_{\bm A} x, (\iota^1_n)_{\bm B} y) \in
%\colim{n}{(T^nK_0)^*\bm R}$ since this is precisely what it means for
%$\colim{n}{(T^nK_0)^*}$ to be the colimit of the $(T^nK_0)^*$s. Then
%since $T$ is a functor on $RT$, this entails that
%$((T^0\iota_{n-1}^0)_{\bm A} ((\iota^0_n)^{-1}_{\bm A} x),\,
%(T^1\iota_{n-1}^1)_{\bm B} ((\iota^1_n)^{-1}_{\bm B} y)) \in T^* (\mu
%T) \bm R$, i.e., that $((in_0^{-1} \circ \iota_n^0)_{\bm A}
%((\iota^0_n)^{-1}_{\bm A} x),\, (in_1^{-1} \circ \iota_n^1)_{\bm B}
%((\iota^1_n)^{-1}_{\bm B} y)) \in T^* (\mu T) \bm R$ by the universal
%properties of $in_0^{-1}$ and $in_1^{-1}$, and so $((in_0^{-1})_{\bm
%  A} x),\, (in_1^{-1})_{\bm B} y)) \in T^* (\mu T) \bm R$.

{\color{red} Say realizing that not being able to define third
  components directly, but rather only through the other two
  components, is an important conceptual contribution.  Not all
  functors on $\rel$ are third components of relation
  transformers. It's overly restrictive to require that the third
  component of a functor on $RT_k$ be a functor on all of
  $[\rel^k,\rel]$.  For example, we can define $T_\rho F$ when $F$ is
  a relation transformer, but it is not clear how we could define
  $T_\rho F$ when $F : [\rel^k,\rel]$.}

\begin{dfn}\label{def:reln-env}
A {\em relation environment} maps each type variable to a relation,
and each type constructor variable of arity $k$ to an
$\omega$-cocontinuous $k$-ary relation transformer.  A morphism $f :
\rho \to \rho'$ from a relation environment $\rho$ to a relation
environment $\rho'$ such that $\rho|_\V = \rho'|_\V$ maps each type
variable $v$ to $\id_{\rho v}$ and each type constructor variable
$\phi$ of arity $k$ to a natural transformation from the $k$-ary
relation transformer $\rho \phi$ to the $k$-ary relation transformer
$\rho' \phi$. Composition of morphisms on relation environments is
given componentwise, with the identity morphism mapping each relation
environment to itself. This gives a category of relation environments
and morphisms between them, which we denote $\relenv$.
\end{dfn}
When convenient we identify a $0$-ary relation transformer with the
relation (transformer) that is its codomain.  With this convention, a
relation environment maps a type constructor variable of arity $0$ to
a $0$-ary relation transformer --- i.e., to a relation --- just as it
does a type variable.  We write $\rho[\ol{\alpha := R}]$ for the
relation environment $\rho'$ such that $\rho' \alpha_i \, = R_i$ for
$i = 1,...,k$ and $\rho' \alpha = \rho\alpha$ if $\alpha \not \in
\{\alpha_1,...,\alpha_k\}$. If $\rho$ is a relation environment, we
write $\pi_1 \rho$ for the set environment mapping each type variable
$\beta$ to $\pi_1 (\rho \beta)$ and each type constructor variable
$\phi$ to the functor $(\rho\phi)^0$. The set environment $\pi_2 \rho$
is defined analogously.

We define, for each $k$, the notion of an $\omega$-cocontinuous
functor from $\relenv$ to $RT_k$:
\begin{dfn}\label{def:relenv-functor}
A functor $H : [\relenv, RT_k]$ is a triple $H = (H^0,H^1,H^*)$,
where
\begin{itemize}
\item $H^0$ and $H^1$ are objects in $[\setenv,[\set^k,\set]]$
\item $H^*$ is a an object in $[\relenv,[\rel^k,\rel]]$
\item for all $\overline{R : \rel(A,B)}$ and morphisms $f$ in
  $\relenv$, $\pi_1(H^*f \,{\overline{R}}) = H^0 (\pi_1
  f)\,{\overline{A}}$ and $\pi_2(H^*f \,{\overline{R}}) = H^1 (\pi_2
  f)\,{\overline{B}}$
\item The action of $H$ on $\rho$ in $\relenv$ is given by $H \rho =
  (H^0 (\pi_1 \rho),\,H^1 (\pi_2 \rho),\,H^*\rho)$  
\item The action of $H$ on morphisms $f : \rho \to \rho'$ in $\relenv$
  is given by $Hf = (H^0 (\pi_1 f),H^1 (\pi_2 f))$
\end{itemize}
\end{dfn}
\noindent Spelling out the last two bullet points above gives the
following analogues of Conditions (1), (2), and (3) immediately
following Definition~\ref{def:RT-functor}:
\begin{enumerate}
\item if $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then
  \[H^*\rho\, \ol{R} : \rel(H^0(\pi_1 \rho)\, \ol{A}, H^1(\pi_2 \rho)\,
  \ol{B})\] In other words, $\pi_1 (H^*\rho \ol{R}) = H^0(\pi_1 \rho)
  \,\ol{A}$ and $\pi_2 (H^*\rho \ol{R}) = H^1 (\pi_2 \rho) \,\ol{B}$.
\item if $(\alpha_1, \beta_1) \in \Homrel(R_1,S_1),..., (\alpha_k,
  \beta_k) \in \Homrel(R_k,S_k)$, then
  \[H^*\rho\, \ol{(\alpha, \beta)} = (H^0(\pi_1 \rho)\,\ol{\alpha},
  H^1(\pi_2 \rho)\, \ol{\beta})\] In other words, $\pi_1 (H^*\rho\,
  \ol{(\alpha, \beta)}) = H^0(\pi_1 \rho)\,\ol{\alpha}$ and $\pi_2
  (H^*\rho\, \ol{(\alpha, \beta)}) = H^1(\pi_2 \rho)\,\ol{\beta}$.
\item if $f : \rho \to \rho'$ and
  $R_1:\rel(A_1,B_1),...,R_k:\rel(A_k,B_k)$, then
  \[\mbox{ if }(x, y) \in H^*\rho\,\ol{R} \mbox{ then }
  (H^0(\pi_1 f)\,{\ol{A}}\,x, H^1(\pi_2 f)\,{\ol{B}}\,y) \in
  H^*\rho'\,\ol{R}\]
  Note, however, that this condition is automatically satisfied
  because it is implied by the third bullet point of
  Definition~\ref{def:relenv-functor}. 
\end{enumerate}

Considering $\relenv$ as a product $\Pi_{\phi^k \in \V \cup \tvars}
RT_k$, we extend Lemma~\ref{lem:colimits} to compute colimits in
$\relenv$ componentwise, and similarly extend
Definition~\ref{def:omega-cocont} to give a componentwise notion of
$\omega$-cocontinuity of functors from $\relenv$ to $RT_k$.

We recall from the start of this section that
Definition~\ref{def:rel-sem} is given mutually inductively with
Definition~\ref{def:set-sem}. We can, at last, define:

\begin{dfn}\label{def:rel-sem}
Let $\rho$ be a relation environment. The {\em relation
  interpretation} $\relsem{\cdot} : \F \to [\relenv, \rel]$ is
defined by
\begin{align*}
  \relsem{\Gamma;\emptyset \vdash v}\rho &= \rho v \mbox{ if
  } v \in \V\\ 
  \relsem{\Gamma;\emptyset \vdash \sigma \to \tau} \rho &=
  \relsem{\Gamma;\emptyset \vdash \sigma} \rho \to
  \relsem{\Gamma;\emptyset \vdash \tau} \rho \\ 
 & {\color{red} \mbox{need to interpret forall types if we include them}}\\
  \relsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}
    \,F\,G}\rho &= \{\eta : \relsem{\Gamma;
      \ol{\alpha} \vdash F}\rho[\ol{\alpha := \text{--}}] \Rightarrow \relsem{
      \Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha := \text{--}}]\}\\
  &=
  \{(t,t') \in \setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}
    \,F\,G} (\pi_1 \rho) \times \setsem{ 
      \Gamma;\emptyset \vdash \Nat^{\ol{\alpha}} \,F\,G} (\pi_2
  \rho)~|~\\ 
  & \hspace{0.3in} \forall {R_1 : \rel(A_1,B_1)}\,...\,{R_k : \rel(A_k,B_k)}.\\
  & \hspace{0.4in} (t_{\ol{A}},t'_{\ol{B}}) \in
  (\relsem{\Gamma;\ol{\alpha} \vdash G}\rho[\ol{\alpha :=
      R}])^{\relsem{\Gamma;\ol{\alpha}\vdash F}\rho[\ol{\alpha := R}]} \}\\  
  % exponential in $\rel$
  &= \{(t,t') \in \setsem{\Gamma;\emptyset \vdash \Nat^{
      \ol{\alpha}} \,F\,G} (\pi_1 \rho) \times 
  \setsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}} \,F\,G}
  (\pi_2 \rho)~|~\\ 
  & \hspace{0.3in} \forall {R_1 : \rel(A_1,B_1)}\,...\,{R_k : \rel(A_k,B_k)}.\\
  & \hspace{0.4in} \forall (a,b) \in \relsem{\Gamma;
      \ol{\alpha} \vdash F}\rho[\ol{\alpha := R}].\\
  & \hspace*{0.5in}  (t_{\ol{A}}a,t'_{\ol{B}}b) \in \relsem{
      \Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha := R}] \}\\
  \relsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \relsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
  \relsem{\Gamma;\Phi \vdash \phi \ol{\tau}}\rho &=
  (\rho\phi)\ol{\relsem{\Gamma;\Phi \vdash 
    \tau}\rho}\\
  \relsem{\Gamma;\Phi \vdash \sigma+\tau}\rho &=
  \relsem{\Gamma;\Phi \vdash \sigma}\rho +
  \relsem{\Gamma;\Phi \vdash \tau}\rho\\
  \relsem{\Gamma;\Phi \vdash \sigma\times \tau}\rho &=
  \relsem{\Gamma;\Phi \vdash \sigma}\rho \times
  \relsem{\Gamma;\Phi \vdash \tau}\rho\\  
   \relsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{\tau}}\rho
  &= (\mu T_{\rho})\ol{\relsem{\Gamma;\Phi \vdash
     \tau}\rho}\\
  \text{where }	T_{\rho}
    &= (T^\set_{\pi_1\rho}, T^\set_{\pi_2\rho}, T^\rel_{\rho}) \\
  \text{and } T^\rel_{\rho}F
    &= \lambda \ol{R}. \relsem{
      \Gamma;\Phi,\phi,\ol{\alpha} \vdash H}\rho[\phi :=
    F][\ol{\alpha := R}]\\
  \text{and } T^\rel_{\rho}\delta
    &= \lambda \ol{R}. \relsem{
      \Gamma;\Phi,\phi,\ol{\alpha} \vdash H}\id_\rho[\phi :=
    \delta][\ol{\alpha := \id_{\ol{R}}}]
\end{align*}
\end{dfn}

If $\rho$ is a relational environment and $\vdash \tau : \F$, then we
write $\relsem{\vdash \tau }$ instead of
$\relsem{\emptyset;\emptyset\vdash \tau }\rho$ as for set
interpretations.

For the last clause in Definition~\ref{def:rel-sem} to be
well-defined, we need to know that $T_{\rho}$ is an
$\omega$-cocontinuous endofunctor on $RT$ so that, by
Definition~\ref{lem:fp}, it admits a fixed point.  Since $T_\rho$ is
defined in terms of $\relsem{\Gamma;\Phi,\phi^k, \ol{\alpha} \vdash
  H}$, this means that relational interpretations of types must be
$\omega$-cocontinuous functors from $\relenv$ to $RT_0$.  This in turn
means that the actions of relational interpretations of types on
objects and on morphisms in $\relenv$ are intertwined.  In fact, we
already know from~\cite{jp19} that, for every $\Gamma; \ol{\alpha}
\vdash \tau : \F$, $\relsem{\Gamma; \ol{\alpha} \vdash \tau}$ is actually
functorial in $\ol{\alpha}$ and $\omega$-cocontinuous.  We first define
the actions of each of these functors on morphisms between
environments, and then argue that the functors given by
Definitions~\ref{def:rel-sem} and~\ref{def:rel-sem-funcs} are
well-defined and have the required properties.

% \begin{lemma} Given a type $\Gamma;\Phi \vdash \tau$ and relation
% environments $\rho$ and $\rho'$ such that $\rho|_{\Gamma,\Phi} =
% \rho'|_{\Gamma,\Phi}$, we have that $\relsem{\Gamma;\Phi \vdash
% \tau}\rho = \relsem{\Gamma;\Phi \vdash \tau}\rho'$.  \end{lemma}

\begin{dfn}\label{def:rel-sem-funcs}
Let $f: \rho \to \rho'$ for relation environments $\rho$ and $\rho'$
such that $\rho|_\V = \rho'|_\V$. The action $\relsem{\Gamma;\Phi
  \vdash \tau}f$ of $\relsem{\Gamma;\Phi \vdash \tau}$ on the morphism $f$
is given as follows:
\begin{itemize}
\item If $\Gamma,v;\emptyset \vdash v$ then
  $\relsem{\Gamma,v;\emptyset \vdash v}f = \id_{\rho v}$.
\item If $\Gamma;\emptyset \vdash \sigma \to \tau$ then
  $\relsem{\Gamma;\emptyset \vdash \sigma \to \tau}f =
  \id_{\relsem{\Gamma;\emptyset \vdash \sigma \to \tau}\rho}$.
\item If $\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G$, then we
  define $\relsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G} f =
  \id_{\relsem{\Gamma;\emptyset \vdash \Nat^{\ol{\alpha}}\,F\,G}\rho}$.
\item If $\Gamma;\Phi \vdash \zerot$ then $\relsem{\Gamma;\Phi \vdash
  \zerot}f = \id_0$.
\item If $\Gamma;\Phi \vdash \onet$ then $\relsem{\Gamma;\Phi \vdash
  \onet}f = \id_1$.
\item If $\Gamma;\Phi \vdash \phi \ol{\tau}$, then we have that
  $\relsem{\Gamma;\Phi \vdash \phi \ol{\tau}} f : \relsem{\Gamma;\Phi
  \vdash \phi \ol{\tau}}\rho \to \relsem{\Gamma;\Phi \vdash \phi
  \ol{\tau}}\rho' = (\rho\phi) \ol{\relsem{\Gamma;\Phi \vdash
    \tau}\rho} \to (\rho'\phi) \ol{\relsem{\Gamma;\Phi \vdash
    \tau}\rho'}$ is defined by $\relsem{\Gamma;\Phi \vdash \phi
  \tau{A}} f = (f\phi)_{\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho'}}
  \,\circ\, (\rho\phi) \ol{\relsem{\Gamma;\Phi \vdash \tau}f} =
  (\rho'\phi) \ol{\relsem{\Gamma;\Phi \vdash \tau}f} \,\circ\, (f
  \phi)_{\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho}}$.
\item If $\Gamma;\Phi\vdash \sigma + \tau$ then $\relsem{\Gamma;\Phi
  \vdash \sigma + \tau}f$ is defined by $\relsem{\Gamma;\Phi \vdash
  \sigma + \tau}f(\inl\,x) = \inl\,(\relsem{\Gamma;\Phi \vdash
  \sigma}f x)$ and $\relsem{\Gamma;\Phi \vdash \sigma +
  \tau}f(\inr\,y) = \inr\,(\relsem{\Gamma;\Phi \vdash \tau}f y)$.
\item If $\Gamma;\Phi\vdash \sigma \times \tau$ then
  $\relsem{\Gamma;\Phi \vdash \sigma \times \tau}f =
  \relsem{\Gamma;\Phi \vdash \sigma}f \times \relsem{\Gamma;\Phi
    \vdash \tau}f$.
\item If $\Gamma;\Phi \vdash (\mu \phi^k.\lambda
  \ol{\alpha}. H)\ol{\tau}$ then
% \[\begin{array}{ccc}
% T^\rel_\rho & = & F \mapsto \lambda R_1...R_k. \relsem{\Gamma;\Phi,\phi,\bm
%   \alpha \vdash H}\rho[\phi :=
%   F][\alpha_1 := R_1]...[\alpha_k := R_k]\\
% T^\rel_{\rho'} & = & F \mapsto \lambda
% R_1...R_k. \relsem{\Gamma;\Phi,\phi,\bm \alpha \vdash H}\rho'[\phi
%   := F][\alpha_1 := R_1]...[\alpha_k := R_k]\\
% \end{array}\]
% \noindent
% and
 letting $\sigma_f : T_\rho \to T_{\rho'}$ be the map
\[ F \mapsto \lambda \ol{R}. \relsem{\Gamma;\Phi,\phi,\ol{\alpha} \vdash
  H}f[\phi := \id_F][\ol{\alpha := \id_R}]\]
we define
\[\begin{array}{ll}
 & \relsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{\tau}} f\\
% : & \relsem{\Gamma;\Phi \vdash (\mu \phi^k.\lambda
%  \alpha_1...\alpha_k. H)A_1...A_k} \rho \to \relsem{\Gamma;\Phi \vdash (\mu
%  \phi^k.\lambda \alpha_1...\alpha_k. H)A_1...A_k} \rho'\\
% = & (\mu T_\rho)(\relsem{\Gamma;\Phi \vdash A_1}\rho)...(\relsem{\Gamma;\Phi \vdash A_k}\rho) \to (\mu
%T_{\rho'})(\relsem{\Gamma;\Phi \vdash A_1}\rho')...(\relsem{\Gamma;\Phi \vdash A_k}%\rho')  
%\end{array}\]
%\noindent
%by
= & (\mu \sigma_f)\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho'} \circ
(\mu T_\rho)\ol{\relsem{\Gamma;\Phi \vdash \tau}f})\\ = &
(\mu T_{\rho'})\ol{\relsem{\Gamma;\Phi \vdash \tau}f} \circ (\mu
\sigma_f)\ol{\relsem{\Gamma;\Phi \vdash \tau}\rho}
\end{array}\]
\end{itemize}
\end{dfn}

To see that the functors given by Definitions~\ref{def:rel-sem}
and~\ref{def:rel-sem-funcs} are well-defined we must show that $T_\rho
F$ is a relation transformer for any relation transformer $F$, and
that $\sigma_f F : T_\rho F \to T_{\rho'} F$ is a morphism of relation
transformers for every relation transformer $F$ and every morphism $f
: \rho \to \rho'$ in $\relenv$.

\begin{lemma}\label{lem:rel-transf-morph}
The interpretations in Definitions~\ref{def:rel-sem}
and~\ref{def:rel-sem-funcs} are well-defined and, for every
$\Gamma;\Phi \vdash \tau$,
\[\sem{\Gamma;\Phi \vdash \tau} =
(\setsem{\Gamma;\Phi \vdash \tau}, \setsem{\Gamma;\Phi \vdash
  \tau},\relsem{\Gamma;\Phi \vdash \tau})\] is an
$\omega$-cocontinuous functor from $\relenv$ to $RT_0$, i.e., is an
element of $[\relenv,RT_0]$.
\end{lemma}
\begin{proof}
By induction on the structure of $\tau$. The only interesting cases
are when $\tau = \phi\ol{\tau}$ and when $\tau = (\mu \phi^k. \lambda
\overline{\alpha}. H)\overline{\tau}$. We consider each in turn.

\begin{itemize}
\item When $\tau = \Gamma; \Phi \vdash \phi\ol{\tau}$, we have    
\[\begin{array}{ll}
  & \pi_i (\relsem{\Gamma; \Phi \vdash \phi\ol{\tau}}\rho)\\
= & \pi_i ((\rho \phi)\overline{\relsem{\Gamma; \Phi \vdash \tau}\rho})\\
= & (\pi_i (\rho \phi)) (\pi_i(\overline{\relsem{\Gamma; \Phi \vdash \tau}\rho}))\\
= & ((\pi_i \rho) \phi) (\overline{\setsem{\Gamma; \Phi \vdash
    \tau}(\pi_i \rho)})\\
= & \setsem{\Gamma; \Phi \vdash \phi\ol{\tau}}(\pi_i \rho)
\end{array}\]
and, for $f : \rho \to \rho'$ in $\relenv$,
\[\begin{array}{ll}
  & \pi_i (\relsem{\Gamma; \Phi \vdash \phi\ol{\tau}}f)\\
= & \pi_i ((f\phi)_{\overline{\relsem{\Gamma; \Phi \vdash \tau}\rho'}})
\circ \pi_i((\rho\phi)({\overline{\relsem{\Gamma; \Phi \vdash \tau}f}}))\\
= & (\pi_i (f\phi))_{\overline{\pi_i (\relsem{\Gamma; \Phi \vdash \tau}\rho')}}
\circ (\pi_i(\rho\phi))({\overline{\pi_i (\relsem{\Gamma; \Phi \vdash \tau}f}}))\\
= & ((\pi_i f)\phi)_{\overline{\setsem{\Gamma; \Phi \vdash \tau}(\pi_i\rho')}}
\circ ((\pi_i\rho)\phi)({\overline{\setsem{\Gamma; \Phi \vdash \tau}(\pi_i f)}})\\
= & \setsem{\Gamma; \Phi \vdash \phi\ol{\tau}}(\pi_i f)
\end{array}\]
The third equalities of each of the above derivations are by the
induction hypothesis. That $\sem{\Gamma; \Phi \vdash
  \phi\ol{\tau}}$ is $\omega$-cocontinuous is an immediate
consequence of the facts that $\set$ and $\rel$ are locally finitely
presentable, together with Corollary~12 of~\cite{jp19}.
\item When $\tau = (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}$ we first show that $\sem{ (\mu
    \phi. \lambda \overline{\alpha}. H)\overline{\tau}}$ is
  well-defined.
\begin{itemize}
\item \underline{$T_\rho : [RT_k,RT_k]$}:\/ We must show that, for any
  relation transformer $F = 
  (F^0, F^1, F^*)$, the triple $T_{\rho} F = (T^\set_{\pi_1 \rho}F^0,
  T^\set_{\pi_2 \rho}F^1, T^\rel_{\rho}F)$ is also a relation
  transformer.  Let $\overline{R : \rel(A, B)}$. Then for
  $i = 1, 2$, we have
\[\begin{split}
\pi_i(T^\rel_{\rho}\,F\,\overline{R})
&= \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi := F]\overline{[\alpha := R]}) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i (\rho[\phi := F]\overline{[\alpha := R]})) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i \rho)[\phi := \pi_i F]\overline{[\alpha := \pi_i R]}) \\
&= T^\set_{\pi_i \rho} (\pi_i F) (\overline{\pi_i R})
\end{split}\]
and 
\[\begin{split}
\pi_i(T^\rel_{\rho}\,F\,\overline{\gamma})
&= \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_\rho[\phi
  := \id_F]\overline{[\alpha := \gamma]}) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i (\id_\rho[\phi := \id_F]\overline{[\alpha := \gamma]})) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} \id_{\pi_i \rho}[\phi := \id_{\pi_i F}]\overline{[\alpha := \pi_i \gamma]} \\
&= T^\set_{\pi_i \rho} (\pi_i F) (\overline{\pi_i \gamma})
\end{split}\]
Here, the second equality in each of the above chains of equalities is
by the induction hypothesis.

We also have that, for every morphism $\delta = (\delta^0, \delta^1) :
F \to G$ in $RT_k$ and all $\overline{R : \rel(A, B)}$,
\[\begin{array}{ll}
  & \pi_i((T^\rel_\rho \delta)_{\overline{R}})\\
= & \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_\rho[\phi :=
  \delta]\overline{[\alpha := \id_R]})\\
= & \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_{\pi_i\rho}[\phi :=
  \pi_i \delta]\overline{[\alpha := \id_{\pi_i R}]}\\
= & (T^\set_{\pi_i \rho} (\pi_i \delta))_{\overline{\pi_i R}}
\end{array}\]

%$T_\rho \delta : T_\rho F \to T_\rho G$ is a
%morphism in $RT_k$. That is, we have that for all $\overline{R : \rel(A,
%  B)}$ and $(x, y) \in (T_\rho F)^* \overline{R}$, $((T_\rho
%\delta)^0_{\overline A} \,x, (T_\rho \delta)^1_{\overline B}\, y) \in
%(T_\rho G)^* \overline{R}$, i.e., $((T^\set_{\pi_1\rho}
%\delta^0)_{\overline A}\, x, (T^\set_{\pi_2 \rho} \delta^1)_{\overline
%  B}\, y) \in (T_\rho G)^* \overline{R}$. To see this, let
%$\overline{R : \rel(A, B)}$ and $(x, y) \in (T_\rho F)^* \overline{R}
%= \relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
%  F]\overline{[\alpha := R]}$. Then since
%$\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
%  \text{--}]\overline{[\alpha := R]}$ is a functor from $\relenv$ to
%$RT$ by the induction hypothesis, we have that
%\[\begin{array}{ll}
% & \relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}id_\rho[\phi :=
%  \delta]\overline{[\alpha := id_R]}\\
%: & \relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
%  F]\overline{[\alpha := R]} \to
%\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
%  G]\overline{[\alpha := R]}
%\end{array}\]
%is a morphism in $\rel$. Therefore,
%\[\begin{array}{ll}
% &\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_\rho[\phi :=
%  \delta]\overline{[\alpha := \id_R]} (x, y) \\
%=& ( (\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_\rho[\phi :=
%  \delta]\overline{[\alpha := \id_R]})^0 x,\\
% & \hspace*{0.4in}
%(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_\rho[\phi :=
%  \delta]\overline{[\alpha := \id_R]})^1 y)\\
%= &( \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_{\pi_1
%  \rho}[\phi := \delta^0]\overline{[\alpha := \id_A]} x,\\
%& \hspace*{0.4in}
%\setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\id_{\pi_2 \rho}[\phi
%  := \delta^1]\overline{[\alpha := \id_B]} y) \\ 
%= & ((T^\set_{\pi_1\rho} \delta^0)_{\overline A} x, (T^\set_{\pi_2
%  \rho} \delta^1)_{\overline B} y) 
%\end{array}\]
%is in $(T_\rho G)^* \overline{R}$.
Here, the second equality is by the induction hypothesis.  That
$T_\rho$ is $\omega$-cocontinuous follows immediately from the
induction hypothesis on $\sem{\Gamma;\Phi,\phi,\ol{\alpha} \vdash H}$
and the fact that colimts are computed componentwise in $RT$.
\item \underline{$\sigma_f = (\sigma^\set_{\pi_1 f},
  \sigma^\set_{\pi_2 f})$ is a natural transformation from $T_{\rho}$
  to $T_{\rho'}$}:\/ We must show that $(\sigma_f)_F =
  ((\sigma^\set_{\pi_1 f})_{F^0}, (\sigma^\set_{\pi_2 f})_{F^1})$ is a
  morphism in $RT_k$ for all relation transformers $F = (F^0, F^1,
  F^*)$, i.e., that $((\sigma_f)_F)_{\overline{R}}
  =(((\sigma^\set_{\pi_1 f})_{F^0})_{\overline{A}},
  ((\sigma^\set_{\pi_2 f})_{F_1})_{\overline{B}})$ is a morphism in
  $\rel$ for all relations $\overline{R : \rel(A, B)}$. Indeed, we
  have that
\[
((\sigma_f)_F)_{\overline{R}} =
\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}f[\phi :=
  \id_F]\overline{[\alpha := \id_R]}
\]
is a morphism in $RT_0$ (and thus in $\rel$) by the induction hypothesis.
\end{itemize}

\vspace*{0.05in}

The relation transformer $\mu T_\rho$ is therefore a fixed point of
$T_\rho$ by Lemma~\ref{lem:fp}, and $\mu \sigma_f$ is a morphism in
$RT_k$ from $\mu T_\rho$ to $\mu T_{\rho'}$. ($\mu$ is shown to be a
functor in~\cite{jp19}.)  So $\relsem{\Gamma; \Phi \vdash (\mu
  \phi. \lambda \overline{\alpha}. H)\overline{\tau}}$, and thus
$\sem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}}$, is well-defined.

\vspace*{0.1in}

To see that $\sem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}} : [\relenv,RT_0]$, we must
verify three conditions:
\begin{itemize}
\item Condition (1) after Definition~\ref{def:relenv-functor} is
  satisfied since
\[
\begin{split}
\pi_i(\relsem{\Gamma;\Phi \vdash (\mu \phi. \lambda \overline{\alpha}. H) \overline{\tau}}\rho)
&= \pi_i( (\mu T_\rho) (\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho})) \\
&= \pi_i(\mu T_{\rho}) (\overline{\pi_i(\relsem{\Gamma;\Phi \vdash \tau}\rho})) \\
&= \mu T^\set_{\pi_i\rho} (\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i\rho)}) \\
&= \setsem{\Gamma;\Phi \vdash (\mu \phi. \lambda \overline\alpha. H) \overline{\tau}}(\pi_i\rho)
\end{split}
\]
The third equality is by Equation ~\ref{eq:mu} and the induction
hypothesis.
\item Condition (2) after Definition~\ref{def:relenv-functor} is
  satisfied since it is subsumed by the previous condition because $k
  = 0$.
\item The third bullet point of Definition~\ref{def:relenv-functor} is
  satisfied because
\[
\begin{split}
& \pi_i(\relsem{\Gamma;\Phi \vdash (\mu \phi. \lambda
  \overline\alpha. H)\overline{\tau}}f)\\
&= \pi_i((\mu T_{\rho'})(\overline{\relsem{\Gamma;\Phi \vdash
    \tau}f}) \circ (\mu \sigma_f)_{\overline{\relsem{\Gamma;\Phi
      \vdash \tau}\rho}}) \\ 
&= \pi_i((\mu T_{\rho'})(\overline{\relsem{\Gamma;\Phi \vdash
    \tau}f})) \circ \pi_i((\mu
\sigma_f)_{\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho}}) \\  
&= \pi_i(\mu T_{\rho'})(\overline{\pi_i(\relsem{\Gamma;\Phi
    \vdash \tau}f})) \circ \pi_i(\mu
\sigma_f)_{\overline{\pi_i(\relsem{\Gamma;\Phi \vdash 
      \tau}\rho})} \\ 
&= (\mu T^\set_{\pi_i \rho'})(\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i f)}) \circ (\mu \sigma^\set_{\pi_i f})_{\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i\rho)}} \\
&= \setsem{\Gamma;\Phi \vdash (\mu \phi. \lambda \overline\alpha. H)\overline{\tau}}(\pi_i f).
\end{split}
\]
The fourth equality is by~\ref{eq:mu} and the induction hypothesis.
\end{itemize}
As before, that $\sem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\alpha}. H)\overline{\tau}}$ is $\omega$-concontinuous
follows from the facts that $\set$ and $\rel$ are locally finitely
presentable, and that colimits in $\relenv$ are computed
componentwise, together with Corollary~12 of~\cite{jp19}.
\end{itemize}
\end{proof}

%{\color{red} This generalizes the usual result that
%  $(\setsem{\tau},\relsem{\tau})$ is a fibred functor to
%  non-homogeneous relations.}


The following lemma ensures that substitution interacts well with type
interpretations.  It is a consequence of
Definitions~\ref{def:second-order-subst},~\ref{def:set-interp},
and~\ref{def:rel-interp}. {\color{red} Double check that no results
  from the next lemma are used in the preceding proof.}

\begin{lemma}\label{lem:substitution}
Let $\rho$ be a set environment $\rho$ and $f : \rho \to \rho'$ be a
morphism of set environments. 
\begin{itemize}
\item If $\Gamma;\Phi,\ol{\alpha} \vdash F$ and $\Gamma;\Phi \vdash \tau$,
  then  
\begin{gather}\label{eq:subs-var}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}\rho =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash F}\rho[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}\rho}]\\
\intertext{and}\label{eq:subs-var-morph}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}f =
\setsem{\Gamma;\Phi,\ol{\alpha} \vdash F}f[\ol{\alpha :=
\setsem{\Gamma;\Phi \vdash \tau}f}]
\end{gather}
\item If $\Gamma;\Phi,\phi^k\vdash F$ and
  $\Gamma;\Phi,\alpha_1...\alpha_k \vdash H$, then 
\begin{gather}\label{eq:subs-const}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}\rho
= \setsem{\Gamma; \Phi, \phi \vdash F}\rho
[\phi := \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}\rho[\overline{\alpha := \text{--}}]] \\ 
\intertext{and}\label{eq:subs-const-morph}
\setsem{\Gamma; \Phi \vdash F[\phi := H]}f
= \setsem{\Gamma; \Phi, \phi \vdash F}f
[\phi := \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}f[\overline{\alpha := \text{--}}]] 
\end{gather}
\end{itemize}
Analogous identities hold for relation environments and morphisms
between them.
\end{lemma}

{\color{red} ISSUE: the substitution $[\phi := H]$ should specify that
  the $\alpha$s in $H$ correspond to the arguments of $\phi$.  For
  example, we could write $[\phi :=_{\alpha} H]$. Also add
  $\overline{\alpha}$ notation to Definition~4.}

\begin{proof}
The proofs for the set and relational interpretations are completely
analogous, so we just prove the former. Likewise, we only prove
Equations~\ref{eq:subs-var} and~\ref{eq:subs-const}, since the proofs
for Equations~\ref{eq:subs-var-morph} and~\ref{eq:subs-const-morph}
are again analogous. Finally, we prove Equation~\ref{eq:subs-var} for
substitution for just a single type or type constructor variable since
the proof for multiple simultaneous substitutions proceeds similarly.

Although Equation~\ref{eq:subs-var} is a special case of
Equation~\ref{eq:subs-const}, it is convenient to prove
Equation~\ref{eq:subs-var} first, and then use it to prove
Equation~\ref{eq:subs-const}. We prove Equation~\ref{eq:subs-var} by
induction on the structure of $F$ as follows:
\begin{itemize}
\item If $\Gamma, \emptyset \vdash F : \T$, or if $F$ is $\onet$ or
  $\zerot$, then $F$ does not contain any type constructor variables
  to replace, so there is nothing to prove.
\item If $F$ is $F_1 \times F_2$ or $F_1 + F_2$, then the substitution
  distributes over the product or coproduct as appropriate, so the
  result follows immediately from the induction hypothesis.
\item If $F = \beta$ with $\beta \neq \alpha$, then there is nothing to
  prove.
\item If $F = \alpha$, then
\[\setsem{\Gamma;\Phi\vdash\alpha[\alpha := \tau]}\rho \, = \,
\setsem{\Gamma;\Phi\vdash\tau}\rho \, = \,
\setsem{\Gamma;\Phi,\alpha\vdash\alpha}\rho[\alpha :=
  \setsem{\Gamma;\Phi\vdash\tau}\rho]\]
\item If $F = \phi \overline{\sigma}$ with $\phi \neq \alpha$, then
\[\begin{array}{ll}
 &\setsem{\Gamma; \Phi \vdash (\phi \overline{\sigma})[\alpha := \tau]}\rho\\
=&\setsem{\Gamma; \Phi \vdash \phi (\overline{\sigma[\alpha := \tau]})}\rho \\
=&(\rho\phi)\overline{\setsem{\Gamma;\Phi\vdash\sigma[\alpha := \tau]}\rho} \\
=&(\rho\phi)\overline{\setsem{\Gamma;\Phi,\alpha\vdash\sigma}
      \rho [\alpha := \setsem{\Gamma;\Phi\vdash\tau}] } \\
=&\setsem{\Gamma; \Phi, \alpha \vdash \phi \overline{\sigma}}
      \rho [\alpha := \setsem{\Gamma;\Phi\vdash\tau}]
\end{array}\]
Here, the third equality is by the induction hypothesis.
\item If $F = (\mu \phi. \lambda \overline{\beta}. G)
  \overline{\sigma}$, then
\[\begin{array}{ll}
 & \setsem{\Gamma; \Phi \vdash ((\mu \phi. \lambda
  \overline{\beta}. G) \overline{\sigma}) [\alpha := \tau]}\rho \\
=&\setsem{\Gamma; \Phi \vdash (\mu \phi. \lambda
  \overline{\beta}. G[\alpha := \tau]) (\overline{\sigma [\alpha :=
      \tau]})}\rho \\ 
=&\mu(\setsem{\Gamma; \Phi, \phi, \overline{\beta} \vdash G[\alpha := \tau]}
      \rho[\phi := \text{--}][\overline{\beta := \text{--}}])
      (\overline{\setsem{\Gamma;\Phi \vdash \sigma [\alpha := \tau]}\rho}) \\
=&\mu(\setsem{\Gamma; \Phi, \phi, \overline{\beta}, \alpha \vdash G}
\rho [\alpha := \setsem{\Gamma;\Phi \vdash \tau}\rho] [\phi := \text{--}]
[\overline{\beta := \text{--}}]) \\
 &\hspace{0.5in} (\overline{\setsem{\Gamma;\Phi,\alpha \vdash \sigma}
   \rho [\alpha := \setsem{\Gamma;\Phi\vdash \tau}\rho]}) \\
=&\setsem{\Gamma;\Phi,\alpha\vdash(\mu\phi.\lambda\overline{\beta}.G)
  \overline{\sigma}}\rho  [\alpha := \setsem{\Gamma;\Phi \vdash
   \tau}\rho] 
\end{array}  \]
Here, the third equality is by the induction hypothesis {\color{red}
  and weakening}.
\end{itemize}

We now prove Equation~\ref{eq:subs-const}, again by induction on the
structure of $F$.
\begin{itemize}
\item If $\Gamma, \emptyset \vdash F : \T$, or if $F$ is $\onet$ or
  $\zerot$, then $F$ does not contain any type constructor variables
  to replace, so there is nothing to prove.
\item If $F$ is $F_1 \times F_2$ or $F_1 + F_2$, then the substitution
  distributes over the product or coproduct as appropriate, so the
  result follows immediately from the induction hypothesis.
\item If $F = \phi \overline{\tau}$, then
\[\begin{array}{ll}
 &\setsem{\Gamma; \Phi \vdash (\phi \overline{\tau})[\phi := H]}\rho \\
=&\setsem{\Gamma; \Phi \vdash H[\overline{\alpha:= \tau[\phi := H]}]}\rho \\
=&\setsem{\Gamma; \Phi \vdash H}\rho [\overline{\alpha:=
    \setsem{\Gamma;\Phi\vdash\tau[\phi := H]}\rho}] \\ 
=&\setsem{\Gamma; \Phi \vdash H}\rho [\overline{\alpha:=
    \setsem{\Gamma;\Phi,\phi\vdash\tau} \rho [\phi :=
      \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
        H}\rho[\overline{\alpha := \text{--}}]]}] \\
=&\setsem{\Gamma; \Phi, \phi \vdash \phi \overline{\tau}}\rho [\phi :=
  \setsem{\Gamma;\Phi,\overline{\alpha}\vdash H}\rho[\overline{\alpha
      := \text{--}}]] 
  \end{array}\]
Here, the first equality is by
Definition~\ref{def:second-order-subst}, the second is by
Equation~\ref{eq:subs-var}, the third is by the induction hypothesis,
and the fourth is by Definition~\ref{def:set-sem}.
\item If $F = \psi \overline{\tau}$ with $\psi \neq \phi$, then the
  proof is similar to that for the previous case, but simpler, because
  $\phi$ only needs to be substituted in the arguments $\ol{\tau}$ of
  $\psi$.
\item If $F = (\mu \psi. \lambda \overline{\beta}. G)
  \overline{\tau}$, then
\[\begin{array}{ll}
 &\setsem{\Gamma; \Phi \vdash ((\mu \psi. \lambda \overline{\beta}. G)
 \overline{\tau})[\phi := H]}\rho \\ 
=&\setsem{\Gamma; \Phi \vdash (\mu \psi. \lambda
  \overline{\beta}. G[\phi := H]) (\overline{\tau[\phi := H]})}\rho \\
=&\mu(\setsem{\Gamma; \Phi, \psi, \overline{\beta} \vdash G[\phi := H]}
    \rho[\psi := \text{--}][\overline{\beta := \text{--}}])
    (\overline{\setsem{\Gamma;\Phi \vdash \tau[\phi := H]}\rho}) \\
=&\mu(\setsem{\Gamma; \Phi, \psi, \overline{\beta}, \phi \vdash G}
\rho [\phi := \setsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}\rho[\overline{\alpha := \text{--}}]][\psi := \text{--}]
     [\overline{\beta := \text{--}}]) \\
&\hspace{0.5in} (\overline{\setsem{\Gamma;\Phi,\phi \vdash \tau} \rho
       [\phi := \setsem{\Gamma;\Phi,\overline{\alpha}\vdash H}
         \rho[\overline{\alpha := \text{--}}]]}) \\
=&\setsem{\Gamma;\Phi,\phi\vdash(\mu\psi.\lambda\overline{\beta}.G)
  \overline{\tau}}\rho [\phi :=
  \setsem{\Gamma;\Phi,\overline{\alpha}\vdash H}\rho[\overline{\alpha
      := \text{--}}]] 
\end{array}\]
Here, the first equality is by
Definition~\ref{def:second-order-subst}, the second and fourth are by
Definition~\ref{def:set-sem}, and the third is by the induction
hypothesis {\color{red} and weakening}.
\end{itemize}
\end{proof}


\subsection{The Identity Extension Lemma}

%\begin{dfn}\label{def:eq-reln-functors}
%If $F$ is a functor from $\set^k$ to $\set$, define $\Eq_F^* : \rel^k \to \rel$ as follows.
%Let $\overline{R : \rel(A, B)}$ be relations in $\set$, i.e. $\overline{R \subseteq A \times B}$.
%Notice that we can restrict the projections of $\overline{A \times B}$
%to $\overline{\pi_1|_R : R \to A}$ and $\overline{\pi_2|_R : R \to B}$.
%%let $\overline{i_R : R \hookrightarrow A \times B}$
%%be the inclusion of $\overline{R}$ as a subset of $\overline{A \times B}$.
%Then, $\Eq_F^* \overline{R} : \rel(F\overline{A}, F\overline{B})$ is the relation which relates
%$x : F\overline{A}$ and $y : F\overline{B}$
%if and only if there exists $z : F\overline{R}$
%such that $F(\overline{\pi_1|_R})z = x$ and $F(\overline{\pi_2|_R})z = y$.
%If $\overline{(\alpha, \beta) : R \to S}$ are morphisms in $\rel$,
%then $\Eq_F^*\overline{(\alpha, \beta)}$ is defined as $(F\overline\alpha, F\overline\beta)$.
%\end{dfn}
%
%\begin{lemma}
%If $F$ is a functor from $\set^k$ to $\set$,
%then the triple $\Eq_F = (F, F, \Eq_F^*)$ is in $RT_k$.
%\end{lemma}
%\begin{proof}
%Consider $\overline{R : \rel(A, B)}$.
%Then, by Definition~\ref{def:eq-reln-functors}, we have that
%$\Eq_F^* \overline{R} : \rel(F\overline{A}, F\overline{B})$.
%
%Consider $\overline{(\alpha, \beta) : R \to_\rel S}$,
%$x : F\overline{A}$ and $y : F\overline{B}$ such that
%$(x, y) \in \Eq_F^*\overline{R}$, i.e., there exists $z : F\overline{R}$
%such that $F(\overline{\pi_1|_R})z = x$ and $F(\overline{\pi_2|_R})z = y$.
%Then, we want to show that
%$(F\overline{\alpha}x, F\overline{\beta}y) \in \Eq_F^*\overline{S}$,
%i.e., that there exists $w : F\overline{S}$ such that
%$F(\overline{\pi_1|_S})w = F\overline{\alpha}x$
%and $F(\overline{\pi_2|_S})w = F\overline{\beta}y$.
%First, consider $\overline{\gamma : R \to_\set S}$
%defined as $\overline{\gamma(a, b) = (\alpha a, \beta b)}$,
%which is well defined because $\overline{(\alpha, \beta)}$ is a morphism in $\rel$.
%Observe that $\overline{\pi_1|_S \circ \gamma = \alpha \circ \pi_1|_R}$
%and $\overline{\pi_2|_S \circ \gamma = \beta \circ \pi_2|_R}$.
%Then, let $w = F \overline{\gamma} z$.
%We have that
%\[
%F(\overline{\pi_1|_S})w
%= F(\overline{\pi_1|_S})(F \overline{\gamma} z)
%= F(\overline{\pi_1|_S \circ \gamma}) z
%= F(\overline{\alpha \circ \pi_1|_R}) z
%= F\overline{\alpha}(F(\overline{\pi_1|_R})z)
%= F\overline{\alpha}x
%\]
%and, analogously, $F(\overline{\pi_2|_S})w = F\overline{\beta}y$.
%\end{proof}
%
%\begin{lemma}
%If $F$ is a functor from $\set^k$ to $\set$ and $\overline{A : \set}$, then we have $\Eq_F^* \overline{\Eq^*_A} = (\Eq_{F\overline{A}})^*$.
%\end{lemma}
%\begin{proof}
%Let $x, x' : F\overline{A}$.
%We have that $(x, x') \in \Eq_F^* \overline{\Eq^*_A}$ if and only if
%there exists $z : F\overline{\Eq^*_A}$ such that
%$F(\overline{\pi_1|_{\Eq^*_A}})z = x$ and $F(\overline{\pi_2|_{\Eq^*_A}})z = x'$.
%Notice that there is an isomorphism $\overline{\phi : A \to_{\set} \Eq^*_A}$
%such that $\overline{\phi a = (a, a)}$ for $\overline{a : A}$,
%and thus $\overline{\pi_1|_{\Eq^*_A} \circ \phi = \pi_2|_{\Eq^*_A} \circ \phi = \Id_A}$.
%Then,
%\[
%F(\overline{\pi_1|_{\Eq^*_A}})z
%= F(\overline{\pi_1|_{\Eq^*_A} \circ \phi \circ \phi^{-1}})z
%= F \overline{\phi^{-1}} z
%\]
%and, analogously, $F(\overline{\pi_2|_{\Eq^*_A}})z = F \overline{\phi^{-1}} z$.
%Then, $(x, x') \in \Eq_F^* \overline{\Eq^*_A}$ if and only if
%there exists $z : F\overline{\Eq^*_A}$ such that
%$F \overline{\phi^{-1}} z = x$ and $F \overline{\phi^{-1}} z = x'$;
%equivalently, if and only if $x = x'$
%(by letting $z = F \overline{\phi} x = F \overline{\phi} x'$).
%That means that $\Eq_F^* \overline{\Eq^*_A}$ is the equality relation.
%\end{proof}

\begin{dfn}
If $F$ is a functor from $\set^k$ to $\set$, we define the functor
%$F^\wedge$ on relations as follows.
$\Eq_F^* : \rel^k \to \rel$ as follows.  Given $R_1 : \rel(A_1,
B_1),...,R_k : \rel(A_k,B_k)$, let $\iota_{R_i} : R_i \hookrightarrow
A_i \times B_i$, for $i = 1,...,k$, be the inclusion of $R_i$ as a
subset of $A_i \times B_i$. By the universal property of the product,
there exists a unique $h_{\overline{A \times B}}$ making the diagram
\[
\begin{tikzcd}[row sep = large]
F\overline{A}
&F(\overline{A \times B})
\ar[l, "{F\overline{\pi_1}}"']
\ar[r, "{F\overline{\pi_2}}"]
\ar[d, dashed, "{h_{\overline{A \times B}}}"]
&F\overline{B} \\
&F\overline{A} \times F\overline{B}
\ar[ul, "{\pi_1}"] \ar[ur, "{\pi_2}"']
\end{tikzcd}
\]
commute. Let $h_{\overline{R}} : F\overline{R} \to F\overline{A}
\times F\overline{B}$ be $h_{\overline{A \times B}} \circ
F\overline{\iota_R}$. Define $F^\wedge\overline{R}$ to be the subobject
through which $h_{\overline{R}}$ is factorized by the mono-epi
factorization system in $\set$, as shown in the following diagram:
\[
\begin{tikzcd}
F\overline{R}
\ar[rr, "{h_{\overline{R}}}"]
\ar[dr, twoheadrightarrow, "{q_{F^\wedge\overline{R}}}"']
&&F\overline{A} \times F\overline{B} \\
&F^\wedge\overline{R}
\ar[ur, hookrightarrow, "{\iota_{F^\wedge\overline{R}}}"']
\end{tikzcd}
\]
%
%NO! $Eq_F^* \overline{(A,B,R)} =
%(F\overline{A},F\overline{B},Eq_F^*\overline{R})$ 
%Choose a different name for third component above, i.e., for the thing
%in Def 22. Maybe $F^\wedge$ on relations, i.e., subsets of domains and
%codomains? 
Note that $F^\wedge\overline{R} : \rel(F\overline{A}, F\overline{B})$
by construction, so we can define $\Eq_F^* \overline{(A,B,R)} =
(F\overline{A}, F\overline{B}, \iota_{F^\wedge \overline{R}}F^\wedge\overline{R})$.  Moreover, if
$\overline{(\alpha, \beta) : (A,B,R) \to (C,D,S)}$ are morphisms in
$\rel$, then we define $\Eq_F^*\overline{(\alpha, \beta)}$ to be
$(F\overline\alpha, F\overline\beta)$.
\end{dfn}

If $F$ is a functor from $\set^k$ to $\set$, let $\Eq_F = (F, F,
  \Eq_F^*)$. Note that if $A : \set$ then $\Eq_A$ is precisely as
  defined in Section~\ref{sec:prelims}. This is consistent with the
  fact that a set can be seen as a $0$-ary functor on sets and a
  relation can be seen as a $0$-ary functor on relations.

\begin{lemma}\label{lem:eq-reln-functors}
If $F : [\set^k,\set]$ then $\Eq_F$ is in $RT_k$.
\end{lemma}
\begin{proof}
Clearly, $\Eq^*_F$ is $\omega$-cocontinuous, so $\Eq^*_F :
[\rel^k,\rel]$.

Now, consider $\overline{(\alpha, \beta) : R \to S}$, where
$\overline{R : \rel(A, B)}$ and $\overline{S : \rel(C, D)}$.  We want
to show that there exists a morphism $\epsilon : F^\wedge\overline{R}
\to F^\wedge\overline{S}$ such that
\[
\begin{tikzcd}
F^\wedge\overline{R}
	\ar[r, hookrightarrow, "{\iota_{F^\wedge\overline{R}}}"]
	\ar[d, "{\epsilon}"']
& F\overline{A} \times F\overline{B}
	\ar[d, "{F\overline{\alpha} \times F\overline{\beta}}"] \\
F^\wedge\overline{S}
	\ar[r, hookrightarrow, "{\iota_{F^\wedge\overline{S}}}"']
& F\overline{C} \times F\overline{D}
\end{tikzcd}
\]
commutes.  By hypothesis, there exist $\overline{\gamma : R \to S}$
such that each diagram
\[
\begin{tikzcd}
R_i
	\ar[d, "{\gamma_i}"']
	\ar[r, hookrightarrow, "{\iota_{R_i}}"]
&A_i \times B_i
	\ar[d, "{\alpha_i \times \beta_i}"] \\
S_i
	\ar[r, hookrightarrow, "{\iota_{S_i}}"]
&C_i \times D_i
\end{tikzcd}
\]
commutes. Now note that both $h_{\overline{C \times D}} \circ
F(\overline{\alpha \times \beta})$ and $(F\overline{\alpha} \times
  F\overline{\beta}) \circ h_{\overline{A \times B}}$ make
\[
\begin{tikzcd}[row sep = large]
F\overline{C}
&F\overline{C} \times F\overline{D}
\ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
&F\overline{D}\\
&F(\overline{A \times B})
\ar[u, dashed, "{\exists !}"]
\ar[ul, "{F\pi_1 \circ F(\overline{\alpha \times \beta})}"]
\ar[ur, "{F\pi_2 \circ F(\overline{\alpha \times \beta})}"']
\end{tikzcd}
\]
commute, so they must be equal. We therefore get that the right-hand
square below commutes, and thus that the entire following diagram does
as well:
\[
\begin{tikzcd}
F\overline{R}
	\ar[d, "{F\overline{\gamma}}"']
	\ar[r, hookrightarrow, "{F\overline{\iota_R}}"]
	\ar[rr, bend left, "{h_{\overline{R}}}"]
&F(\overline{A \times B})
	\ar[d, "{F(\overline{\alpha \times \beta})}"]
	\ar[r, "{h_{\overline{A \times B}}}"]
&F\overline{A} \times F\overline{B}
	\ar[d, "{F\overline{\alpha} \times F\overline{\beta}}"] \\
F\overline{S}
	\ar[r, hookrightarrow, "{F\overline{\iota_S}}"']
	\ar[rr, bend right, "{h_{\overline{S}}}"']
&F(\overline{C \times D})
	\ar[r, "{h_{\overline{C \times D}}}"']
&F\overline{C} \times F\overline{D}
\end{tikzcd}
\]
Finally, by the left-lifting property of $q_{F^\wedge\overline{R}}$
with respect to $\iota_{F^\wedge\overline{S}}$ given by the epi-mono
factorization system, there exists an $\epsilon$ such that the diagram
\[
\begin{tikzcd}
F\overline{R}
	\ar[d, "{F\overline{\gamma}}"']
	\ar[r, twoheadrightarrow, "{q_{F^\wedge\overline{R}}}"]
&F^\wedge\overline{R}
	\ar[d, dashed, "{\epsilon}"]
	\ar[r, hookrightarrow, "{\iota_{F^\wedge\overline{R}}}"]
&F\overline{A} \times F\overline{B}
	\ar[d, "{F\overline{\alpha} \times F\overline{\beta}}"] \\
F\overline{S}
	\ar[r, twoheadrightarrow, "{q_{F^\wedge\overline{S}}}"']
&F^\wedge\overline{S}
	\ar[r, hookrightarrow, "{\iota_{F^\wedge\overline{S}}}"']
&F\overline{C} \times F\overline{D}
\end{tikzcd}
\]
commutes.
\end{proof}

\begin{lemma}\label{lem:eq-reln-equalities}
If $F : [\set^k,\set]$ and $A_1,...,A_k : \set$, then $\Eq_F^*
  \overline{\Eq_A} = \Eq_{F\overline{A}}$.
\end{lemma}
\begin{proof}
Each $\Eq_A : \rel$ has as its third component $\Delta_{A} A$, where
$\Delta_{A} : A \to A \times A$ is given by $\Delta_{A} A =
\{(x,x)~|~x \in A\}$.  Since $h_{\overline{A \times A}}$ is the unique
morphism making the bottom triangle of the following diagram commute
\[
\begin{tikzcd}[row sep = large]
&F\overline{A}
\ar[d, "{F \overline{\Delta_{A}}}"']
\ar[dl, equal]
\ar[dr, equal]\\
F\overline{A}
&F(\overline{A \times A})
\ar[l, "{F\overline{\pi_1}}"']
\ar[r, "{F\overline{\pi_2}}"]
\ar[d, "{h_{\overline{A \times A}}}"]
&F\overline{A} \\
&F\overline{A} \times F\overline{A}
\ar[ul, "{\pi_1}"] \ar[ur, "{\pi_2}"']
\end{tikzcd}
\]
and since $h_{\overline{\Eq_A^*}} = h_{\overline{A \times A}} \circ F
  \overline{\Delta_A}$, the universal property of the product 
\[
\begin{tikzcd}[row sep = large]
F\overline{A}
&F\overline{A} \times F\overline{A}
\ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
&F\overline{A}\\
&F\overline{A}
\ar[u, dashed, "{\exists !}"]
\ar[ul, equal]
\ar[ur, equal]
\end{tikzcd}
\]
gives that $h_{\overline{\Eq^*_A}} = \Delta_{F\overline{A}}$.
Moreover, since $\Delta_{F\overline{A}}$ is a monomorphism, its
epi-mono factorization gives that $\Delta_{F\overline{A}} =
\iota_{F^\wedge \overline{\Delta_A}}$, and thus that $F^\wedge
\overline{\Delta_A} = F\overline{A}$.  Therefore, $\Eq_F^* \overline{\Eq_A} =
(F\overline{A}, F\overline{A}, \iota_{F^\wedge \overline{\Delta_A}}\,
F^\wedge \overline{\Delta_A}) = (F\overline{A}, F\overline{A},
\Delta_{F\overline{A}}\, F\overline{A}) = \Eq_{F\overline{A}}$.
\end{proof}

We now show that the Identity Extension Lemma holds for the
interpretations given in Definitions~\ref{def:set-sem}
and~\ref{def:rel-sem}. If $\rho$ is a set environment, define
$\Eq_\rho$ to be the relation environment such that $\Eq_\rho v =
\Eq_{\rho v}$ for all $v \in \V \cup \tvars$. This is exactly the same
definition that was given informally in Section~\ref{sec:set-interp}.
The Identity Extension Lemma can then be stated and proved as follows:

\begin{thm}\label{thm:iel}
  If $\rho$ is a set environment, and $\Gamma; \Phi \vdash \tau : \F$,
  then $\relsem{\Gamma; \Phi \vdash \tau} \Eq_\rho =
  \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}$.
\end{thm}
\begin{proof}
By induction on the structure of $\tau$.
\begin{itemize}
\item $\relsem{\Gamma; \emptyset \vdash v}\Eq_{\rho} = \Eq_{\rho} v =
  \Eq_{\rho v} = \Eq_{\setsem{\Gamma; \emptyset \vdash v}\rho}$ where
  $v \in \Gamma$.
\item $\relsem{\Gamma; \emptyset \vdash \sigma \to \tau} \Eq_{\rho} =
  \relsem{\Gamma; \emptyset \vdash \sigma} \Eq_{\rho} \to
  \relsem{\Gamma; \emptyset \vdash \tau} \Eq_{\rho} =
  \Eq_{\setsem{\Gamma; \emptyset \vdash \sigma}\rho} \to
  \Eq_{\setsem{\Gamma; \emptyset \vdash \tau}\rho} =
  \Eq_{\setsem{\Gamma; \emptyset \vdash \sigma \to \tau}\rho}$, where
  the second equality is by the induction hypothesis.
\item {\color{red} $\tau = \forall v.\tau_1$}
\item By definition, $\relsem{\Gamma; \emptyset \vdash
  \Nat^{\overline\alpha} \,F\,G} \Eq_{\rho}$ is the relation on
  $\setsem{\Gamma; \emptyset \vdash \Nat^{\overline\alpha} \,F\,G}
  \rho$ relating $t$ and $t'$ if, for all ${R_1 :
    \rel(A_1,B_1)},...,{R_k : \rel(A_k,B_k)}$, $(t_{\overline{A}},
  t'_{\overline{B}})$ is a morphism from $\relsem{\Gamma;
    \overline\alpha \vdash F} \Eq_{\rho}\overline{[\alpha := R]}$ to
  $\relsem{\Gamma ; \overline\alpha \vdash G}
  \Eq_{\rho}\overline{[\alpha := R]}$ in $\rel$.  To prove that this
  is equal to $\Eq_{\setsem{\Gamma; \emptyset \vdash
      \Nat^{\overline\alpha} \,F\,G} \rho}$ we need to show that
  $(t_{\overline{A}}, t'_{\overline{B}})$ is a morphism from
  $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ;
    \overline\alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in
  $\rel$ for all ${R_1 : \rel(A_1,B_1)},...,{R_k : \rel(A_k,B_k)}$ if
  and only if $t = t'$ and $(t_{\overline{A}}, t_{\overline{B}})$ is a
  morphism from $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ; \overline
    \alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in $\rel$ for
  all ${R_1 : \rel(A_1,B_1)}, ...,$ ${R_k : \rel(A_k,B_k)}$. The only
  interesting part of this equivalence is to show that if
  $(t_{\overline{A}}, t'_{\overline{B}})$ is a morphism from
  $\relsem{\Gamma; \overline\alpha \vdash F}
  \Eq_{\rho}\overline{[\alpha := R]}$ to $\relsem{\Gamma ;
    \overline\alpha \vdash G} \Eq_{\rho}\overline{[\alpha := R]}$ in
  $\rel$ for all ${R_1 : \rel(A_1,B_1),}$ $...,{R_k : \rel(A_k,B_k)}$,
  then $t = t'$.  By hypothesis, $(t_{\overline{A}},
  t'_{\overline{A}})$ is a morphism from $\relsem{\Gamma;
    \overline\alpha \vdash F} \Eq_{\rho}\overline{[\alpha :=
      \Eq_{A}]}$ to $\relsem{\Gamma ; \overline\alpha \vdash G}
  \Eq_{\rho}\overline{[\alpha := \Eq_{A}]}$ in $\rel$ for all
  $A_1\,...\,A_k : \set$. By the induction hypothesis, it is therefore
  a morphism from $\Eq_{\setsem{\Gamma; \overline\alpha \vdash F}
    \rho\overline{[\alpha := A]}}$ to $\Eq_{\setsem{\Gamma ;
      \overline\alpha \vdash G} \rho\overline{[\alpha := A]}}$ in
  $\rel$. This means that, for every $x : \Eq_{\setsem{\Gamma;
      \overline\alpha \vdash F} \rho\overline{[\alpha := A]}}$,
  $t_{\overline{A}}x = t'_{\overline{A}}x$.  Then, by extensionality,
  $t = t'$.
\item $\relsem{\Gamma; \Phi \vdash \zerot} \Eq_{\rho} = 0_\rel =
  \Eq_{0_\set} = \Eq_{\setsem{\Gamma; \Phi \vdash \zerot}\rho}$
\item $\relsem{\Gamma; \Phi \vdash \onet} \Eq_{\rho} = 1_\rel =
  \Eq_{1_\set} = \Eq_{\setsem{\Gamma; \Phi \vdash \onet}\rho}$
\item The application case is proved by the following sequence of
  equalities, where the second equality is by the induction hypothesis
  and the definition of the relation environment $\Eq_\rho$, the third
  is by the definition of application of relation transformers from
  Definition~\ref{def:rel-transf}, and the fourth is by
  Lemma~\ref{lem:eq-reln-equalities}:
\[
\begin{split}
\relsem{\Gamma; \Phi \vdash \phi\ol{\tau}}\Eq_{\rho} &=
(\Eq_{\rho}\phi)\ol{\relsem{\Gamma; \Phi \vdash \tau}
\Eq_{\rho}}\\
&= \Eq_{\rho \phi}\, \ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}
  \rho}}\\
&= (\Eq_{\rho \phi})^* \,\ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}
  \rho}}\\
&= \Eq_{(\rho \phi) \,\ol{\setsem{\Gamma; \Phi \vdash \tau} \rho}}\\
%&= (\Eq_{\rho \phi})^* \ol{\setsem{\Gamma; \Phi \vdash \tau} \rho}\\
&= \Eq_{\setsem{\Gamma; \Phi \vdash \phi\ol{\tau}}\rho}
\end{split}
\]
\item The fixed point case is proven by the sequence of equalities
\[
\begin{split}
\relsem{\Gamma; \Phi \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{\tau}}\Eq_{\rho} 
&=(\mu {T_{\Eq_{\rho}}}) \,\ol{\relsem{\Gamma; \Phi \vdash \tau}\Eq_{\rho}}\\ 
&= \colim{n \in \nat}{T^n_{\Eq_{\rho}} K_0}\, \ol{\relsem{\Gamma; \Phi
  \vdash \tau}\Eq_{\rho}}\\
%&= \colim{n \in \nat}{(T^n_{\Eq_{\rho}} K_0)}
%\ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}\\
&= \colim{n \in \nat}{ T^n_{\Eq_{\rho}} K_0 \,\ol{\Eq_{\setsem{\Gamma;
    \Phi \vdash \tau}\rho}}}\\
&= \colim{n \in \nat}{(\Eq_{(T^\set_\rho)^n K_0})^*
  \ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}}\\
&= \colim{n \in \nat}{\Eq_{(T^\set_\rho)^n K_0 \,\ol{\setsem{\Gamma;
        \Phi \vdash \tau}\rho}}}\\ 
&= \Eq_{\colim{n \in \nat}{ (T^\set_{\rho})^n K_0\,
    \ol{\setsem{\Gamma; \Phi \vdash \tau}\rho}}}\\
&= \Eq_{\setsem{\Gamma; \Phi \vdash (\mu \phi.\lambda
      \ol{\alpha}. H)\ol{\tau}}\rho}
\end{split}
\]
Here, the third equality is by induction hypothesis, the fifth is by
Lemma~\ref{lem:eq-reln-equalities} and the fourth equality is because,
for every $n \in \nat$, the following two statements can be proved by
simultaneous induction:
\begin{equation}\label{eq:iel-fix-point-intermediate1}
T^n_{\Eq_{\rho}} K_0\, \ol{\Eq_{\setsem{\Gamma; \Phi \vdash
      \tau}\rho}} = (\Eq_{(T^\set_\rho)^n K_0})^*
\ol{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}
\end{equation}
and
\begin{equation}\label{eq:iel-fix-point-intermediate2}
\begin{split}
  \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H}
\Eq_{\rho} [\phi := 
 & T^{n}_{\Eq_{\rho}} K_0] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} \\
=\;\; & \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho} [\phi
  := \Eq_{(T^\set_\rho)^n K_0}] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]}
\end{split}
\end{equation}
We prove~\eqref{eq:iel-fix-point-intermediate1}.  The case $n=0$ is
trivial, because $T^0_{\Eq_{\rho}} K_0 = K_0$ and
$(T^\set_\rho)^0 K_0 = K_0$; the inductive step is
proved by the following sequence of equalities:
\[
\begin{split}
T^{n+1}_{\Eq_{\rho}} K_0\, \overline{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}}
&= T^\rel_{\Eq_{\rho}} (T^{n}_{\Eq_{\rho}} K_0)
\overline{\Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho} [\phi
  := T^{n}_{\Eq_{\rho}} K_0] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho} [\phi
  := \Eq_{(T^\set_\rho)^n K_0}] \overline{[\alpha :=
    \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \Eq_{\rho [\phi
    := (T^\set_\rho)^n K_0] \overline{[\alpha :=
      \setsem{\Gamma; \Phi \vdash \tau}\rho]}} \\ 
&= \Eq_{\setsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash H} \rho [\phi
    := (T^\set_\rho)^n K_0] \overline{[\alpha :=
      \setsem{\Gamma; \Phi \vdash \tau}\rho]}} \\ 
&= \Eq_{(T^\set_\rho)^{n+1} K_0 \overline{\setsem{\Gamma; \Phi
      \vdash \tau}\rho}} \\ 
&= (\Eq_{(T^\set_\rho)^{n+1} K_0})^*\, \overline{\Eq_{\setsem{\Gamma;
      \Phi \vdash \tau}\rho}} 
\end{split}
\]
Here, the third equality is by~\eqref{eq:iel-fix-point-intermediate2},
the fifth by the induction hypothesis on $H$, and the last by
Lemma~\ref{lem:eq-reln-equalities}.  We prove the induction step
of~\eqref{eq:iel-fix-point-intermediate2} by structural induction on
$H$: the only interesting case, though, is when $\phi$ is applied,
i.e., for $H = \phi \ol{\sigma}$, which is proved by the sequence of
equalities:
\[
\begin{split}
& \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash \phi
    \ol{\sigma}} \Eq_{\rho} [\phi := T^{n}_{\Eq_{\rho}} K_0]
  \overline{[\alpha := \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]}
  \\
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi,
      \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho} [\phi :=
      T^{n}_{\Eq_{\rho}} K_0] \overline{[\alpha :=
        \Eq_{\setsem{\Gamma; \Phi \vdash \tau} \rho}]}} \\ 
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi,
      \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho} [\phi :=
      \Eq_{(T^\set_\rho)^{n} K_0}] \overline{[\alpha :=
        \Eq_{\setsem{\Gamma; \Phi \vdash \tau} \rho}]}} \\ 
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\relsem{\Gamma; \Phi,
      \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho [\phi := (T^\set_\rho)^{n}
        K_0] \overline{[\alpha := \setsem{\Gamma; \Phi \vdash
            \tau} \rho]}}} \\ 
&= T^{n}_{\Eq_{\rho}} K_0\, \overline{\Eq_{\setsem{\Gamma;
        \Phi, \phi, \ol{\alpha} \vdash \sigma} \rho [\phi :=
        (T^\set_\rho)^{n} K_0] \overline{[\alpha :=
          \setsem{\Gamma; \Phi \vdash \tau} \rho]}}} \\ 
&= (\Eq_{(T^\set_\rho)^{n} K_0})^* \,\overline{\Eq_{\setsem{\Gamma;
        \Phi, \phi, \ol{\alpha} \vdash \sigma} \rho [\phi :=
        (T^\set_\rho)^{n} K_0] \overline{[\alpha :=
          \setsem{\Gamma; \Phi \vdash \tau} \rho]}}} \\ 
&= (\Eq_{(T^\set_{\rho})^{n} K_0})^* \overline{\relsem{\Gamma;
      \Phi, \phi, \ol{\alpha} \vdash \sigma} \Eq_{\rho} [\phi :=
      \Eq_{(T^\set_{\rho})^{n} K_0}] \overline{[\alpha :=
        \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]}} \\ 
&= \relsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash \phi \ol{\sigma}}
  \Eq_{\rho} [\phi := \Eq_{(T^\set_{\rho})^{n} K_0}]
  \overline{[\alpha := \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}]} 
\end{split}
\]
Here, the second equality is by the induction hypothesis
for~\eqref{eq:iel-fix-point-intermediate2} on the $\sigma$s, the
fourth is by the induction hypothesis for Theorem~\ref{thm:iel} on the
$\sigma$s, and the fifth is by the induction hypothesis on $n$
for~\eqref{eq:iel-fix-point-intermediate1}.
\item $\relsem{\Gamma; \Phi \vdash \sigma + \tau} \Eq_{\rho} =
  \relsem{\Gamma; \Phi \vdash \sigma} \Eq_{\rho} + \relsem{\Gamma;
    \Phi \vdash \tau} \Eq_{\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash
      \sigma}\rho} + \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho} =
  \Eq_{\setsem{\Gamma; \Phi \vdash \sigma}\rho + \setsem{\Gamma; \Phi
      \vdash \tau}\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash \sigma +
      \tau}\rho}$
\item $\relsem{\Gamma; \Phi \vdash \sigma \times \tau} \Eq_{\rho} =
  \relsem{\Gamma; \Phi \vdash \sigma}\Eq_{\rho} \times \relsem{\Gamma;
    \Phi \vdash \tau}\Eq_{\rho} = \Eq_{\setsem{\Gamma; \Phi \vdash
      \sigma}\rho} \times \Eq_{\setsem{\Gamma; \Phi \vdash \tau}\rho}
  = \Eq_{\setsem{\Gamma; \Phi \vdash \sigma}\rho \times
    \setsem{\Gamma; \Phi \vdash \tau}\rho} = \Eq_{\setsem{\Gamma;
      \Phi \vdash \sigma \times \tau}\rho}$
\end{itemize}
\end{proof}

\section{Interpreting Terms}\label{sec:term-interp}

If $\Delta = x_1 : \tau_1,...,x_n : \tau_n$ is a term context for $\Gamma$
and $\Phi$, then the interpretations $\setsem{\Gamma;\Phi \vdash \Delta}$ and
$\relsem{\Gamma;\Phi \vdash \Delta}$ are defined by
\[\begin{array}{lll}
\setsem{\Gamma;\Phi \vdash \Delta} & = & \setsem{\Gamma;\Phi \vdash
  \tau_1} \times ... \times \setsem{\Gamma;\Phi \vdash \tau_n}\\ 
\relsem{\Gamma;\Phi \vdash \Delta} & = & \relsem{\Gamma;\Phi \vdash
  \tau_1} \times ... \times \relsem{\Gamma;\Phi \vdash \tau_n}\\ 
\end{array}\]
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : \tau$ then has
a set interpretation $\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}$
as a natural transformation from $\setsem{\Gamma; \Phi \vdash \Delta}$
to $\setsem{\Gamma; \Phi \vdash \tau}$, and a relational
interpretation $\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}$ as a
natural transformation from $\relsem{\Gamma; \Phi \vdash \Delta}$ to
$\relsem{\Gamma; \Phi \vdash \tau}$. These are given in the next two
definitions. 

\begin{dfn}\label{def:set-interp}
If $\rho$ is a set environment and $\Gamma;\Phi~|~\Delta \vdash t :
\tau$ then $\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho$ is
defined as follows:
\[\begin{array}{lll}
\setsem{\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
\setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau}\rho &
= & \curry (\setsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t :
  \tau}\rho)\\ 
\setsem{\Gamma;\emptyset \,|\, \Delta \vdash st: \tau} \rho & = &
\eval \circ
 \langle \setsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to
  \tau}\rho, \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}\rho
\rangle\\
\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline
    \alpha} \,F \,G}\rho & = &  \curry (\setsem{\Gamma;\overline \alpha
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
\setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline \tau} s:
  G [\overline{\alpha := \tau}]}\rho & = & \eval \circ \langle
  (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\; \_)_{\overline{\setsem{\Gamma;\Phi
      \vdash \tau}\rho}},\\ 
 & & \hspace*{0.5in} \setsem{\Gamma;\Phi \,|\,
    \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho \rangle\\ 
& & \\
\color{red} \mbox{Add rules for } \forall \mbox{ if we include
  it} & & \\
\setsem{\Gamma;\Phi \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
\setsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau} \rho& = &
!^0_{\setsem{\Gamma;\Phi \vdash \tau}\rho} \circ
  \setsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho, \mbox{ where } \\
 & & \hspace*{0.1in} !^0_{\setsem{\Gamma;\Phi \vdash \tau}\rho}
\mbox{ is the unique morphism from } 0\\
 & & \hspace*{0.1in} \mbox{ to } \setsem{\Gamma;\Phi \vdash \tau}\rho\\
\setsem{\Gamma;\Phi \,|\, \Delta \vdash \top : \onet}\rho & = &
!^{\setsem{\Gamma;\Phi\vdash \Delta}\rho}_1, \mbox{ where }
!^{\setsem{\Gamma;\Phi\vdash \Delta}\rho}_1\\ 
& & \hspace*{0.1in} \mbox{ is the unique morphism from }
\setsem{\Gamma;\Phi\vdash \Delta}\rho \mbox{ to } 1\\ 
\setsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau} \rho& = &
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma} \rho\times
\setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau} \rho\\
\setsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma} \rho& = &
\pi_1 \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau}\rho\\
\setsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : \sigma}\rho & = &
\pi_2 \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times
  \tau} \rho\\
\setsem{\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r} :
  \gamma}\rho & = & \eval \circ \langle \curry \,[\setsem{\Gamma;\Phi
    \,|\, \Delta, x : \sigma \vdash l : \gamma}\rho,\\
   & & \hspace*{0.79in} \setsem{\Gamma;\Phi \,|\, \Delta, y
    : \tau \vdash r : \gamma}\rho],\\
   & &  \hspace*{0.5in} \setsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  \sigma + \tau} \rho\rangle\\   
\setsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau} \rho& = &
\inl \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}\rho\\
\setsem{\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: \sigma + \tau}\rho & = & 
\inr \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho\\
\setsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t : (\mu \phi.\lambda 
 {\overline \alpha}.H){\overline \tau}} \rho & = & \mathit{in} \circ
  \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : H[\phi := (\mu
      \phi.\lambda {\overline
        \alpha}.H)\overline{\beta}][\overline{\alpha := \tau}]}
  \rho,\\
  & & \hspace*{0.1in} \mbox{ where the variables in } \overline{\beta}
  \mbox{ are fresh }\\
\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  \fold_{H,F}\, t : \Nat^{\overline \alpha}\,((\mu
  \phi.\lambda \overline \beta.H)\overline \alpha)\,F}\rho & = & 
\mathit{fold}\circ \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t : 
  \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta := \alpha}])\,F}\rho
\end{array}\]
\end{dfn}

\begin{dfn}\label{def:rel-interp}
If $\rho$ is a relation environment and $\Gamma;\Phi~|~\Delta \vdash t :
\tau$ then $\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho$ is
defined as follows:
\[\begin{array}{lll}
\relsem{\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
\relsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau}\rho &
= & \curry (\relsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t :
  \tau}\rho)\\ 
\relsem{\Gamma;\emptyset \,|\, \Delta \vdash st: \tau} \rho & = & \eval
\circ \langle \relsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to
  \tau}\rho, \relsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}\rho
\rangle\\
\relsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline
    \alpha} \,F \,G}\rho & = &  \curry (\relsem{\Gamma;\overline \alpha
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline{\tau}} s:
  G [\overline{\alpha := \tau}]}\rho & = & \eval \circ \langle
  (\relsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\; \_)_{\overline{\relsem{\Gamma;\Phi
      \vdash \tau}\rho}},\\ 
 & & \hspace*{0.5in} \relsem{\Gamma;\Phi \,|\,
    \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho \rangle\\ 
& & \\
\color{red} \mbox{Add rules for } \forall \mbox{ if we include
  it} & & \\
\relsem{\Gamma;\Phi \,|\, \Delta,x :\tau \vdash x : \tau} \rho& = &
\pi_{|\Delta|+1}\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau} \rho& = &
!^0_{\relsem{\Gamma;\Phi \vdash \tau}\rho} \circ
  \relsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho, \mbox{ where } \\
 & & \hspace*{0.1in} !^0_{\relsem{\Gamma;\Phi \vdash \tau}\rho}
\mbox{ is the unique morphism from } 0\\
 & & \hspace*{0.1in} \mbox{ to } \relsem{\Gamma;\Phi \vdash \tau}\rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \top : \onet}\rho & = &
!^{\relsem{\Gamma;\Phi\vdash \Delta}\rho}_1, \mbox{ where }
!^{\relsem{\Gamma;\Phi\vdash \Delta}\rho}_1\\ 
& & \hspace*{0.1in} \mbox{ is the unique morphism from }
\relsem{\Gamma;\Phi\vdash \Delta}\rho \mbox{ to } 1\\ 
\relsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau} \rho& = &
\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma} \rho\times
\relsem{\Gamma;\Phi \,|\, \Delta \vdash t: \tau} \rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma} \rho& = &
\pi_1 \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau}\rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : \sigma}\rho & = &
\pi_2 \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times
  \tau} \rho\\
\relsem{\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r} :
  \gamma}\rho & = & \eval \circ \langle \curry \,[\relsem{\Gamma;\Phi
    \,|\, \Delta, x : \sigma \vdash l : \gamma}\rho,\\
   & & \hspace*{0.79in} \relsem{\Gamma;\Phi \,|\, \Delta, y
    : \tau \vdash r : \gamma}\rho],\\
   & &  \hspace*{0.5in} \relsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  \sigma + \tau} \rho\rangle \\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau} \rho& = &
\inl \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}\rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: \sigma + \tau}\rho & = & 
\inr \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho\\
\relsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t : (\mu \phi.\lambda 
 {\overline \alpha}.H){\overline \tau}} \rho & = & \mathit{in} \circ
  \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : H[\phi := (\mu
      \phi.\lambda {\overline \alpha}.H)
      \overline{\beta}][\overline{\alpha := \tau}]} \rho\\   
  & & \hspace*{0.1in} \mbox{ where the variables in } \overline{\beta}
  \mbox{ are fresh }\\
  \relsem{\Gamma;\emptyset \,|\, \Delta \vdash
  \fold_{H,F}\, t : \Nat^{\overline \alpha}\,((\mu
  \phi.\lambda \overline \beta.H)\overline \alpha)\,F}\rho & = & 
\mathit{fold} \circ \relsem{\Gamma;\emptyset \,|\, \Delta \vdash t : 
  \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta := \alpha}])\,F}\rho
\end{array}\]
\end{dfn}

If $t$ is closed, i.e., if $\emptyset; \emptyset~|~\emptyset \vdash t
: \tau$, then we write $\setsem{\vdash t : \tau}$ instead of
$\setsem{\emptyset; \emptyset~|~\emptyset \vdash t : \tau}$, and
similarly for $\relsem{\emptyset; \emptyset~|~\emptyset \vdash t :
  \tau}$.

{\color{blue} Move factoids about interpretations here.}

\subsection{The Abstraction Theorem}\label{sec:thms} 

To prove the Abstraction Theorem we actually prove a more general
result in Theorem~\ref{thm:at-gen} about possibly open terms. We
then recover the Abstraction Theorem as the special case of
Theorem~\ref{thm:at-gen} for closed terms of closed type.

\begin{thm}\label{thm:at-gen}
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : \tau$ induces
a natural transformation from $\sem{\Gamma; \Phi \vdash \Delta}$ to
$\sem{\Gamma; \Phi \vdash \tau}$, i.e., a triple of natural
transformations 
\[(\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau},
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau},
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau})\]
where
\[\begin{array}{lll}
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau} & : & \setsem{\Gamma;
  \Phi \vdash \Delta} \to \setsem{\Gamma; \Phi \vdash \tau}
\end{array}\]
has as its component at $\rho : \setenv$ a morphism
\[\begin{array}{lll}
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho & : & \setsem{\Gamma;
  \Phi \vdash \Delta}\rho \to \setsem{\Gamma; \Phi \vdash \tau}\rho
\end{array}\]
in $\set$, and
\[\begin{array}{lll}
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau} & : & \relsem{\Gamma;
  \Phi \vdash \Delta} \to \relsem{\Gamma; \Phi \vdash \tau}
\end{array}\]
has as its component at $\rho : \relenv$ a morphism
\[\begin{array}{lll}
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho & : & \relsem{\Gamma;
  \Phi \vdash \Delta}\rho \to \relsem{\Gamma; \Phi \vdash \tau}\rho
\end{array}\]
in $\rel$, and for all $\rho : \relenv$,
\[\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho =
(\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}(\pi_1 \rho),
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}(\pi_2 \rho))\]
\end{thm}

\begin{proof}
We proceed by structural induction, showing only the interesting
cases.
\begin{itemize}
\item We first consider $\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G$.
\begin{itemize}
\item To see that $\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G}$ is a
  natural transformation from $\setsem{\Gamma;\emptyset \vdash
    \Delta}$ to $\setsem{\Gamma;\emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}$, since the functorial part
  $\Phi$ of the type context is empty, we need only show that, for
  every $\rho : \setenv$, $\setsem{\Gamma;\emptyset \,|\, \Delta
    \vdash L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F
    \,G}\rho$ is a morphism in $\set$ from $\setsem{\Gamma; \emptyset
    \vdash \Delta}\rho$ to $\setsem{\Gamma; \emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}\rho$. For this, recall that
\[\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
  x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho = \curry\,
(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := \_}])\]
By the induction hypothesis, $\sem{\Gamma;\overline{\alpha} \,|\,
  \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}]$ induces a
natural transformation
\[\begin{array}{ll}
& \setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := \_}]\\
 : & \setsem{\Gamma; \ol{\alpha} \vdash \Delta, x :
  F}\rho[\overline{\alpha := \_}] \to \setsem{\Gamma; \ol{\alpha}
  \vdash G}\rho[\overline{\alpha := \_}]\\   
 = & \setsem{\Gamma; \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha
    := \_}] \times \setsem{\Gamma; \ol{\alpha} \vdash
  F}\rho[\overline{\alpha := \_}] \to \setsem{\Gamma; \ol{\alpha}
  \vdash G}\rho[\overline{\alpha := \_}]  
\end{array}\]
and thus a family of morphisms
\[\begin{array}{ll}
& \curry\, (\sem{\Gamma;\overline{\alpha} \,|\,
  \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
: & \setsem{\Gamma; \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha
     := \_}] \to (\setsem{\Gamma; \ol{\alpha} \vdash
   F}\rho[\overline{\alpha := \_}] \to \setsem{\Gamma; \ol{\alpha} 
   \vdash G}\rho[\overline{\alpha := \_}]) 
\end{array}\]
That is, for each $\ol{A : \set}$ and each $d :
\setsem{\Gamma;\emptyset \vdash \Delta}\rho = \setsem{\Gamma;
  \ol{\alpha} \vdash \Delta}\rho[\overline{\alpha := A}]$ {\color{red}
  by weakening}, we have
\[\begin{array}{ll}
  & (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}}
  x.t : \Nat^{\overline{\alpha}} \,F \,G}\rho\,d)_{\ol{A}}\\
= & \curry\, (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\rho[\overline{\alpha := A}])\,d\\
: & \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\overline{\alpha := A}]
\to \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\overline{\alpha := 
    A}]
\end{array}\]
Moreover, these maps actually form a natural transformation $\eta :
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\overline{\alpha := \_}] \to
\setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\overline{\alpha := \_}]$
because each
\[ \eta_{\ol{A}} \, = \, \curry\, (\setsem{\Gamma;\overline{\alpha}
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := A}])\,d\]
is the partial specialization to $d$ of the natural transformation
$\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := \_}]$. 

To see that the components of $\eta$ also satisfy the additional
condition necessary for $\eta$ to be in $\setsem{\Gamma;\emptyset
  \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho$, let $\overline{R :
  \rel(A, B)}$ and \[(u, v) \in \relsem{\Gamma;\overline{\alpha} \vdash
  F} \Eq_{\rho}[\overline{\alpha := R}] =
(\setsem{\Gamma;\overline{\alpha} \vdash F} \rho[\overline{\alpha :=
    A}], \setsem{\Gamma;\overline{\alpha} \vdash F}
\rho[\overline{\alpha := B}])\] Then the induction hypothesis on the
term $t$ ensures that
\[\begin{array}{ll}
  & \relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
\Eq_{\rho}[\overline{\alpha := R}]\\
: & \relsem{\Gamma;\overline{\alpha} \vdash \Delta, x : F}
\Eq_{\rho}[\overline{\alpha := R}] \to
\relsem{\Gamma;\overline{\alpha} \vdash G} \Eq_{\rho}[\overline{\alpha
    := R}]
\end{array}\] and
\[\begin{array}{ll}
  &  \relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
\Eq_{\rho}[\overline{\alpha := R}] \hfill(*)\\
= & (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
\rho[\overline{\alpha := A}], \setsem{\Gamma;\overline{\alpha} \,|\,
  \Delta, x : F \vdash t: G} \rho[\overline{\alpha := B}])
\end{array}\] Since $(d,d) \in \relsem{\Gamma;\emptyset \vdash \Delta}
\Eq_\rho =  \relsem{\Gamma;\emptyset \vdash \Delta}
\Eq_\rho[\ol{\alpha := R}]$ we therefore have that
\[\begin{array}{ll}
& (\eta_{\ol{A}}u,\eta_{\ol{B}}v)\\
= & (\curry\, (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\rho[\overline{\alpha := A}])\,d\,u, \curry\,
(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t:
  G}\rho[\overline{\alpha := B}])\,d\,v)\\
= & \curry\, (\relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G}\Eq_\rho[\overline{\alpha := R}])\,(d,d)\,(u,v)\\
: & \relsem{\Gamma;\overline{\alpha} \vdash G}
\Eq_{\rho}[\overline{\alpha := R}]  
\end{array}\]
as desired. Here, the second equality is by $(*)$.  
\item To see that $\relsem{\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F \,G}$ is a
  natural transformation from $\relsem{\Gamma;\emptyset \vdash
    \Delta}$ to $\relsem{\Gamma;\emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}$, since the functorial part
  $\Phi$ of the type context is empty, we need only show that, for
  every $\rho : \relenv$, $\setsem{\Gamma;\emptyset \,|\, \Delta
    \vdash L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} \,F
    \,G}\rho$ is a morphism in $\rel$ from $\setsem{\Gamma; \emptyset
    \vdash \Delta}\rho$ to $\setsem{\Gamma; \emptyset \vdash
    \Nat^{\overline{\alpha}} \,F \,G}\rho$. The proof is similar to
  that in the previous bullet point for the set semantics. The only
  difference is in the additional condition on the components of the
  natural transformation
\[ \eta \, = \, \curry\, (\relsem{\Gamma;\overline{\alpha}
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\,d\]
for $d : \relsem{\Gamma;\emptyset \vdash \Delta}\rho$ that must be
verified to know that $\eta$ is in $\relsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\rho$. For that, let $\overline{R :
  \rel(A,B)}$ and
\[(u,v) \in \relsem{\Gamma;\overline{\alpha} \vdash
  F} \rho[\overline{\alpha := R}] = (\setsem{\Gamma;\overline{\alpha}
  \vdash F} (\pi_1\rho)[\overline{\alpha := A}],
\setsem{\Gamma;\overline{\alpha} \vdash F}
(\pi_2\rho)[\overline{\alpha := B}])\]
Then the induction hypothesis on the term $t$ ensures that
\[ \relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t: G}
\rho[\overline{\alpha := R}] \,: \, \relsem{\Gamma;\overline{\alpha}
  \vdash \Delta, x : F} \rho[\overline{\alpha := R}] \to
\relsem{\Gamma;\overline{\alpha} \vdash G} \rho[\overline{\alpha :=
    R}]\]
and
\[\eta_{\ol{R}} = ((\pi_1\eta)_{\ol{A}}, (\pi_1\eta)_{\ol{B}})\]
so that
\[\begin{array}{ll}
  & ((\pi_1\eta)_{\ol{A}} u,(\pi_2\eta)_{\ol{B}} v)\\
= & \eta_{\ol{R}}(u,v)\\
= & \curry\,\relsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F
  \vdash t: G} \rho[\overline{\alpha := R}]\,d\,(u,v)\\
: & \relsem{\Gamma;\overline{\alpha} \vdash G} \rho[\overline{\alpha
    := R}]
\end{array}\]
\item Finally, to see that $\pi_i(\relsem{\Gamma;\emptyset \,|\,
  \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline\alpha} \,F
  \,G}\rho) = \setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline \alpha} x.t : \Nat^{\overline\alpha} \,F
  \,G}(\pi_i\rho)$ we compute
\[\begin{split}
&~\pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline
    \alpha} x.t : \Nat^{\overline\alpha} \,F \,G}\rho) \\
=&~\pi_i(\curry (\relsem{\Gamma;\overline \alpha\,|\, \Delta, x : F
  \vdash t: G} \rho[\overline{\alpha := \_}])) \\
= &~\curry (\pi_i(\relsem{\Gamma;\overline \alpha\,|\, \Delta, x : F
  \vdash t: G} \rho[\overline{\alpha := \_}])) \\
= &~\curry (\setsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash
  t: G} (\pi_i(\rho[\overline{\alpha := \_}]))) \\
= &~\curry (\setsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash
  t: G} (\pi_i\rho)[\overline{\alpha := \_}]) \\
= &~\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha}
  x.t : \Nat^{\overline\alpha} \,F \,G}(\pi_i\rho)
\end{split}\]
\end{itemize}

\item We now consider $\Gamma;\Phi \,|\, \Delta \vdash t_{\overline
  \tau} s: G [\overline{\alpha := \tau}]$.
\begin{itemize}
\item To see that $\setsem{\Gamma;\Phi \,|\, \Delta \vdash
  t_{\overline \tau} s: G [\overline{\alpha := \tau}]}$ is a natural
  transformation from $\setsem{\Gamma; \Phi \vdash \Delta}$ to
  $\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}$ we need
  to show that, for every $\rho : \setenv$, $\setsem{\Gamma;\Phi \,|\,
    \Delta \vdash t_{\overline \tau} s: G [\overline{\alpha :=
        \tau}]}\rho$ is a morphism from $\setsem{\Gamma; \Phi \vdash
    \Delta}\rho$ to $\setsem{\Gamma;\Phi \vdash G [\overline{\alpha :=
        \tau}]}\rho$, and that these this family of morphisms is
  natural in $\rho$. Let $\rho : \setenv$ and $d : \setsem{\Gamma;
    \Phi \vdash \Delta}\rho$. Then
\[\begin{array}{ll}
  & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline \tau} s: G
  [\overline{\alpha := \tau}]}\,\rho\,d\\
= & (\eval \circ \langle (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}},\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho \rangle)\,d\\
= & \eval ((\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}} \,d,\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho\, d)\\
= & \eval ((\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\;
d)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}},\,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho\, d)\\
\end{array}\]
By the induction hypothesis, $(\setsem{\Gamma;\emptyset \,|\, \Delta
  \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
d)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}}$ has type
\[\setsem{\Gamma;
  \ol{\alpha} \vdash F}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      \tau}\rho}] \to \setsem{\Gamma; \ol{\alpha} \vdash
  G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash \tau}\rho}]\]
\noindent
and $\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho\, d$ has type
\[\begin{array}{ll}
  & \setsem{\Gamma; \Phi \vdash F[\ol{\alpha := \tau}]}\rho\\
= & \setsem{\Gamma; \Phi, \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}]\\
= & \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}]
\end{array}\]
by Equation~\ref{eq:subs-var}, and by {\color{red} weakening} in the
last step, since the type $\Gamma; \emptyset \vdash \Nat^{\ol{\alpha}}
F\,G$ is only well-formed if $\Gamma; \ol{\alpha} \vdash F : \F$ and
$\Gamma; \ol{\alpha} \vdash G : \F$. Thus, $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash t_{\overline \tau} s: G [\overline{\alpha :=
      \tau}]}\,\rho\,d$ has type $\setsem{\Gamma; \ol{\alpha} \vdash
  G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash \tau}\rho}] =
\setsem{\Gamma; \Phi \vdash G[\ol{\alpha := \tau}]}\rho$, as desired.

\vspace*{0.1in}

To see that the family of maps comprising $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash t_{\overline \tau} s: G [\overline{\alpha := \tau}]}$
form a natural transformation, i.e., are natural in their relation
environment argument, we need to show that the following diagram commutes: 
\[\begin{tikzcd}
\setsem{\Gamma;\Phi \vdash \Delta}\rho \ar[r, "{\setsem{\Gamma;\Phi
      \vdash \Delta}f}"] \ar[d, "{\langle \setsem{\Gamma;\emptyset
      \,|\, \Delta \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho,
    \setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
          \tau}]}\rho \rangle}"'] & \setsem{\Gamma;\Phi \vdash
  \Delta}\rho' \ar[d, "{\langle \setsem{\Gamma;\emptyset \,|\,
      \Delta \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho',
    \setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
          \tau}]}\rho' \rangle}"]\\
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho
\ar[d, "{\eval \circ ((-)_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} \times
    \id)}"']
<<<<<<< HEAD
\ar[r, bend left = 5, "{\setsem{\Gamma;\emptyset \vdash
      \Nat^{\overline{\alpha}} \,F \,G}f \times \setsem{\Gamma;\Phi
      \vdash F [\overline{\alpha := \tau}]}f}"] &
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho'
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho'
\ar[d, "{\eval \circ ((-)_{\overline{\sem{\Gamma;\Phi\vdash
          \tau}\rho'}} \times \id)}"] \\
=======
\ar[r, bend left = 5, "{\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}f
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}f}"]
& \setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F \,G}\rho'
\times \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho'
\ar[d, "{\eval \circ ((-)_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho'}} \times
    \id)}"]
\\
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
  %(\setsem{\Gamma;\overline{\alpha} \vdash F}\rho[\overline{\alpha :=
%    \setsem{\Gamma;\Phi\vdash\tau}\rho}] \to
%%\setsem{\Gamma;\overline{\alpha} \vdash G}\rho[\overline{\alpha :=
%    \setsem{\Gamma;\Phi\vdash\tau}\rho}]) \times \setsem{\Gamma;\Phi
%       \vdash F [\overline{\alpha := \tau}]}\rho \ar[d, equal] \\
%(\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho \to
%\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}\rho) \times
%\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho \ar[d,
%  "{\eval}"]\\
%
\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}\rho
\ar[r, "{\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}f}"']
&
\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}\rho'
\end{tikzcd}\]
<<<<<<< HEAD
The top diagram commutes because the induction hypothesis ensures
$\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}$ and $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash s: F [\overline{\alpha := \tau}]}$ are natural in
$\rho$. To see that the bottom diagram commutes, we first note that
since $\rho|_\Gamma = \rho'|_\Gamma$, $\Gamma; \ol{\alpha} \vdash F :
\F$, and $\Gamma; \ol{\alpha} \vdash G : \F$ we can replace the
instance of $f$ in $\setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}f$ with $\id$. Then, using the fact
that $\setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F
  \,G}$ is a functor, we have that $\setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\id = \id$. We must therefore prove
that, for every $\eta \in \setsem{\Gamma;\emptyset \vdash
=======
The top diagram commutes because the induction hypothesis ensures that
$\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}$ and $\setsem{\Gamma;\Phi \,|\,
  \Delta \vdash s: F [\overline{\alpha := \tau}]}$ are natural in
$\rho$. To see that the bottom diagram commutes, we must prove that,
for every $\phi \in \setsem{\Gamma;\emptyset \vdash
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
  \Nat^{\overline{\alpha}} \,F \,G}\rho$ and $x \in
\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}\rho$, we
have
\[\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}f
<<<<<<< HEAD
  (\eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} x) =
\eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho'}}
(\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}f x)\] i.e.,
for every $\eta \in \setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\rho$,
\[\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}f
 \circ \eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} =
 \eta_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho'}} \circ
 \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}f\] But this
 follows from the naturality of $\eta$. Indeed, $\eta \in
 \setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F
   \,G}\rho$ implies that $\eta$ is a natural transformation from
=======
  (\phi_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} x) =
\phi_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho'}}
(\setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}f x)\] i.e.,
for every $\phi \in \setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline{\alpha}} \,F \,G}\rho$,
\[\setsem{\Gamma;\Phi \vdash G [\overline{\alpha := \tau}]}f
 \circ \phi_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho}} =
 \phi_{\overline{\sem{\Gamma;\Phi\vdash \tau}\rho'}} \circ
 \setsem{\Gamma;\Phi \vdash F [\overline{\alpha := \tau}]}f\] But this
 follows from the naturality of $\phi$. Indeed, $\phi \in
 \setsem{\Gamma;\emptyset \vdash \Nat^{\overline{\alpha}} \,F
   \,G}\rho$ implies that $\phi$ is a natural transformation from
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
 $\setsem{\Gamma; \overline{\alpha} \vdash F}\rho[\overline{\alpha :=
     \_}]$ to $\setsem{\Gamma; \overline{\alpha} \vdash
   G}\rho[\overline{\alpha := \_}]$.
For each $\tau$, consider the morphism $\setsem{\Gamma;\Phi \vdash
  \tau}f : \setsem{\Gamma;\Phi \vdash \tau}\rho \to
\setsem{\Gamma;\Phi \vdash \tau}\rho'$. The following diagram commutes
<<<<<<< HEAD
by naturality of $\eta$:
=======
by naturality of $\phi$:
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
\[\begin{tikzcd}
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}\rho \ar[d, equal] &
\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := \tau}]}\rho \ar[d,
  equal]\\
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho}] \ar[r,
<<<<<<< HEAD
  "{\;\;\;\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}}\;\;\; }"]
=======
  "{\;\;\;\phi_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}}\;\;\; }"]
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash F}\id_\rho[\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash \tau}f}]}"]
& \setsem{\Gamma;
  \ol{\alpha} \vdash G}\rho[\ol{\alpha := \setsem{\Gamma;\Phi \vdash
      \tau}\rho}]
\ar[d, "{\setsem{\Gamma; \ol{\alpha} \vdash G}\id_\rho[\ol{\alpha := 
        \setsem{\Gamma;\Phi \vdash \tau}f}]}"]\\
\setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho'}] \ar[r,
<<<<<<< HEAD
  "{\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}} }"]
=======
  "{\phi_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho'}} }"]
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
& \setsem{\Gamma; \ol{\alpha} \vdash G}\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi \vdash \tau}\rho'}]
\end{tikzcd}\]
That is, $\setsem{\Gamma;\ol{\alpha} \vdash G}\id_\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi\vdash \tau}f}] \,\circ\,
<<<<<<< HEAD
\eta_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}} =
\eta_{\setsem{\Gamma;\Phi \vdash \tau}\rho'} \,\circ\,
=======
\phi_{\ol{\setsem{\Gamma;\Phi \vdash \tau}\rho}} =
\phi_{\setsem{\Gamma;\Phi \vdash \tau}\rho'} \,\circ\,
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
\setsem{\Gamma;\ol{\alpha} \vdash F}\id_\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi\vdash \tau}f}]$.  But since the only variables
in the functorial contexts for $F$ and $G$ are $\ol{\alpha}$, we have
that $\setsem{\Gamma;\Phi \vdash F}\id_\rho[\ol{\alpha :=
    \setsem{\Gamma;\Phi\vdash \tau}f}] = \setsem{\Gamma;\Phi \vdash
  F}f[\ol{\alpha := \setsem{\Gamma;\Phi\vdash \tau}f}] =
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}f$, and similarly
for $G$.  Commutativity of this last diagram thus gives that
$\setsem{\Gamma;\Phi \vdash G[\ol{\alpha := \tau}]}f \,\circ\,
<<<<<<< HEAD
\eta_{\setsem{\Gamma;\Phi \vdash \tau}\rho} =
\eta_{\setsem{\Gamma;\Phi \vdash \tau}\rho'} \,\circ\,
=======
\phi_{\setsem{\Gamma;\Phi \vdash \tau}\rho} =
\phi_{\setsem{\Gamma;\Phi \vdash \tau}\rho'} \,\circ\,
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
\setsem{\Gamma;\Phi \vdash F[\ol{\alpha := \tau}]}f$, as desired.

\item The proof that the relational interpretation of the same term is
  a natural transformation of the right type is analogous.
\item Finally, to see that $\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta
  \vdash t_{\bf \tau} s: G [\overline{\alpha := \tau}]}\rho) =
  \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s: G
    [\overline{\alpha := \tau}]}(\pi_i\rho)$ we compute
\[\begin{array}{ll}
  & \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s: G
  [\overline{\alpha := \tau}]}\rho)\\
= & \pi_i( \eval \circ \langle (\relsem{\Gamma;\emptyset \,|\, \Delta
  \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho}},
\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}\rho \rangle)\\
= & \eval \circ \langle \pi_i((\relsem{\Gamma;\emptyset \,|\, \Delta
  \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho}}),
\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha
      := \tau}]}\rho) \rangle\\
= & \eval \circ \langle \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta
  \vdash t : \Nat^{\overline{\alpha}} \,F \,G}\rho\;
\_)_{\overline{\pi_i(\relsem{\Gamma;\Phi \vdash \tau}\rho)}},
\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha
      := \tau}]}\rho) \rangle\\
= & \eval \circ \langle (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  t : \Nat^{\overline{\alpha}} \,F \,G}(\pi_i\rho)\;
\_)_{\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i\rho)}},
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha :=
      \tau}]}(\pi_i\rho) \rangle\\
= & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s: G
  [\overline{\alpha := \tau}]}(\pi_i\rho)
\end{array}\]
\end{itemize}
\item We now consider $\Gamma;\Phi \,|\, \Delta \vdash \tin\,t : (\mu
  \phi.\lambda {\overline \alpha}.H){\overline \tau}$.
\begin{itemize}
\item To see that $\setsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t :
  (\mu \phi.\lambda {\overline \alpha}.H)\overline \tau}$ is a natural
  transformation from $\setsem{\Gamma;\Phi \vdash \Delta}$ to
  $\setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda {\overline
      \alpha}.H)\overline \tau}$, we first note that it has the right
  domain and codomain. Indeed, by the induction hypothesis we have
  that $\setsem{\Gamma;\Phi~|~\Delta \vdash t : H[\phi := \mu
      \phi.\lambda \ol{\alpha}.H][\ol{\alpha := \tau}]}$ is a natural
  transformation from $\setsem{\Gamma;\Phi \vdash \Delta}$ to
  $\setsem{\Gamma;\Phi\vdash H[\phi := \mu \phi.\lambda
      \ol{\alpha}.H][\ol{\alpha := \tau}]}$. We therefore have that,
  for each $\rho \in \setenv$, 
\[\begin{tikzcd}
\setsem{\Gamma;\Phi \vdash \Delta} \rho \ar[d, "{\setsem{\Gamma;\Phi
      \,|\, \Delta \vdash t : H[\phi := \mu \phi.\lambda {\overline
          \alpha}.H] [\overline{\alpha :=
          \tau}]}\rho}"]\\
\setsem{\Gamma;\Phi \vdash H[\phi := \mu \phi.\lambda {\overline
      \alpha}.H] [\overline{\alpha := \tau}]}\rho \ar[d, equal]\\
\setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho [\phi := \mu
  T_\rho^\set] [\overline{\alpha := \setsem{\Gamma;\Phi \vdash
      \tau}\rho}] \ar[d, equal]\\
T^\set_\rho(\mu T^\set_\rho) (\overline{\setsem{\Gamma;\Phi \vdash
    \tau}\rho}) \ar[d, "{\tin}"]\\
\mu T^\set_\rho (\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho})
\ar[d, equal]\\
\setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda {\overline
    \alpha}.H){\overline \tau}} \rho
\end{tikzcd}\]
Here, the first equality is by Equations~\ref{eq:subs-var}
and~\ref{eq:subs-const} in Lemma~\ref{lem:substitution}, the second
equality uses the definition of $T_\rho^\set$, and the final equality
is by Definition~\ref{def:set-sem}. The entire morphism above from
$\setsem{\Gamma;\Phi \vdash \Delta}\rho$ to $\setsem{\Gamma;\Phi
  \vdash (\mu \phi.\lambda \ol{\alpha}.H)\ol{\tau}}\rho$ is, by
Definition~\ref{def:set-interp}, $\setsem{\Gamma;\Phi \,|\, \Delta
  \vdash \tin\,t : (\mu \phi.\lambda {\overline \alpha}.H)\overline
  \tau}$.

\vspace*{0.5in}

To see that $\setsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t : (\mu
  \phi.\lambda {\overline \alpha}.H){\overline \tau}}$ is natural, we
first note that since, by the induction hypothesis,
$\setsem{\Gamma;\Phi~|~\Delta \vdash t : H[\phi := \mu \phi.\lambda
    \ol{\alpha}.H][\ol{\alpha := \tau}]}$ is natural, the following
diagram commutes:
\[\begin{tikzcd}
\setsem{\Gamma;\Phi \vdash \Delta}\rho \ar[d,
  "{\setsem{\Gamma;\Phi~|~\Delta \vdash t : H[\phi := \mu \phi.\lambda
        \ol{\alpha}.H][\ol{\alpha := \tau}]}\rho}"'] \ar[r,
  "{\setsem{\Gamma;\Phi \vdash \Delta}f}"]& \setsem{\Gamma;\Phi
  \vdash \Delta}\rho' \ar[d, "{\setsem{\Gamma;\Phi~|~\Delta \vdash t :
      H[\phi := \mu \phi.\lambda \ol{\alpha}.H][\ol{\alpha :=
          \tau}]}\rho'}"]\\
\setsem{\Gamma;\Phi \vdash H[\phi := \mu \phi.\lambda {\overline
       \alpha}.H] [\overline{\alpha := \tau}]}\rho 
 \ar[r, bend left = 5, "{\setsem{\Gamma;\Phi \vdash H[\phi := \mu
         \phi.\lambda {\overline \alpha}.H] [\overline{\alpha :=
           \tau}]}f}"]
 &\setsem{\Gamma;\Phi \vdash H[\phi := \mu \phi.\lambda {\overline
      \alpha}.H] [\overline{\alpha := \tau}]}\rho'\\
\end{tikzcd}\]
Naturality of $\setsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t : (\mu
  \phi.\lambda {\overline \alpha}.H){\overline \tau}}$ then follows
from the naturality of $\mathit{in}$ with respect to the set arguments
to the functor in the third commuting square below. Indeed, for any
morphism of set environments $f : \rho \to \rho'$, the following
diagram commutes:

\vspace*{0.1in}

\[\begin{tikzcd}
 \setsem{\Gamma;\Phi \vdash H[\phi := \mu \phi.\lambda {\overline
       \alpha}.H] [\overline{\alpha := \tau}]}\rho \ar[d, equal]
 \ar[r, bend left = 5, "{\setsem{\Gamma;\Phi \vdash H[\phi := \mu
         \phi.\lambda {\overline \alpha}.H] [\overline{\alpha :=
           \tau}]}f}"] &\setsem{\Gamma;\Phi \vdash H[\phi := \mu
     \phi.\lambda {\overline \alpha}.H] [\overline{\alpha :=
       \tau}]}\rho' \ar[d,
   equal]\\ \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho
    [\phi := \mu T_\rho^\set] [\overline{\alpha := \setsem{\Gamma;\Phi
          \vdash \tau}\rho}] \ar[r, bend left = 5, "{
        \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}f [\phi :=
          \mu \sigma_f^\set] [\overline{\alpha := \setsem{\Gamma;\Phi
              \vdash \tau}f}] }"] \ar[d, equal]
    &\setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho' [\phi
      := \mu T_{\rho'}^\set] [\overline{\alpha := \setsem{\Gamma;\Phi
          \vdash \tau}\rho'}] \ar[d, equal]\\ T^\set_\rho(\mu
    T^\set_\rho) (\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho})
    \ar[r, "{ \sigma^\set_f(\mu \sigma^\set_f)
        (\overline{\setsem{\Gamma;\Phi \vdash \tau}f}) }"] \ar[d,
      "\mathit{in}_{\overline{\setsem{\Gamma;\Phi \vdash \tau}f}}"]
    &T^\set_{\rho'}(\mu T^\set_{\rho'}) (\overline{\setsem{\Gamma;\Phi
        \vdash \tau}\rho'}) \ar[d,
      "\mathit{in}_{\overline{\setsem{\Gamma;\Phi \vdash
            \tau}\rho'}}"]\\ \mu T^\set_\rho
    (\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho}) \ar[r, "{ \mu
        \sigma^\set_f (\overline{\setsem{\Gamma;\Phi \vdash \tau}f})
      }"] \ar[d, equal] &\mu T^\set_{\rho'}
    (\overline{\setsem{\Gamma;\Phi \vdash \tau}\rho'}) \ar[d,
      equal]\\ \setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda {\overline
        \alpha}.H){\overline \tau}} \rho \ar[r, "{ \setsem{\Gamma;\Phi
          \vdash (\mu \phi.\lambda {\overline \alpha}.H){\overline
            \tau}} f }"] &\setsem{\Gamma;\Phi \vdash (\mu \phi.\lambda
      {\overline \alpha}.){\overline \tau}} \rho'
\end{tikzcd}\]
\item The proof that the relational interpretation of the same term is a
natural transformation of the right type is analogous.
\item Finally, to see that $\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta
  \vdash \tin\,t : (\mu \phi.\lambda {\overline \alpha}.H){\overline
    \tau}} \rho) = \setsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t :
  (\mu \phi.\lambda {\overline \alpha}.H){\overline \tau}}
  (\pi_i\rho)$ we compute
\[\begin{split}
  &~\pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t : (\mu
  \phi.\lambda {\overline \alpha}.H){\overline \tau}} \rho) \\
= &~\pi_i(\mathit{in} \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  H[\phi := \mu \phi.\lambda {\overline \alpha}.H][\overline{\alpha :=
      \tau}]} \rho)\\
= &~\mathit{in} \circ \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  H[\phi := \mu \phi.\lambda {\overline \alpha}.H][\overline{\alpha :=
      \tau}]} \rho)\\
= &~\mathit{in} \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  H[\phi := \mu \phi.\lambda {\overline \alpha}.H][\overline{\alpha :=
      \tau}]} (\pi_i\rho)\\
= &~\setsem{\Gamma;\Phi \,|\, \Delta \vdash \tin\,t : (\mu \phi.\lambda
  {\overline \alpha}.H){\overline \tau}} (\pi_i\rho)
\end{split}\]
\end{itemize}
\item We now consider $\Gamma;\emptyset \,|\, \Delta \vdash
  \fold_{H,F}\, t : \Nat^{\overline\alpha}\,((\mu \phi.\lambda
  \overline{\beta}.H)\overline{\alpha})\,F$.
\begin{itemize}
\item To see that $\setsem{\Gamma;\emptyset \,|\, \Delta \vdash
  \fold_{H,F}\, t : \Nat^{\overline\alpha}\,((\mu \phi.\lambda
  \overline{\beta}.H)\overline{\alpha})\,F}$ is a natural
  transformation from $\setsem{\Gamma;\Phi \vdash \Delta}$ to
  $\setsem{\Nat^{\overline\alpha}\,((\mu \phi.\lambda
    \overline{\beta}.H)\overline{\alpha})\,F}$, since $\Phi$ is empty,
  we need only show that, for every $\rho : \setenv$,
  $\setsem{\Gamma;\emptyset \,|\, \Delta \vdash \fold_{H,F}\, t :
    \Nat^{\overline\alpha}\,((\mu \phi.\lambda
    \overline{\beta}.H)\overline{\alpha})\,F}$ is a morphism in $\set$
  from $\setsem{\Gamma;\Phi \vdash \Delta}\rho$ to
  $\setsem{\Nat^{\overline\alpha}\,((\mu \phi.\lambda
    \overline{\beta}.H)\overline{\alpha})\,F}\rho$. We first note that
  it has the right domain and codomain. By the induction hypothesis,
  $\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
    \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
        \alpha}])\,F}$ is a natural transformation from
  $\setsem{\Gamma;\Phi \vdash \Delta}$ to
  $\setsem{\Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
        \alpha}])\,F}$. Thus, for each $\rho \in \setenv$, we have
\[\begin{tikzcd}
\setsem{\Gamma;\emptyset \vdash \Delta}\rho \ar[d,
  "{\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
      \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
          \alpha}])\,F}\rho}"] \\
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline\alpha}\,(H[\phi :=
    F][\overline{\beta := \alpha}])\,F}\rho \ar[d,
  "{\text{\textit{fold}}}_{H,F}"] \\
\setsem{\Gamma;\emptyset \vdash \Nat^{\overline\alpha}\,((\mu
  \phi.\lambda \overline{\beta}.H)\overline{\alpha})\,F}\rho
\end{tikzcd}\]

The result follows from observing that $\setsem{\Gamma;\emptyset \,|\,
  \Delta \vdash \fold_{H,F}\, t : \Nat^{\overline\alpha}\,((\mu
<<<<<<< HEAD
  \phi.\lambda \overline{\beta}.H)\overline{\alpha})\,F}\rho$ is exactly
=======
  \phi.\lambda \overline{\beta}.H)\overline{\alpha})\,F}$ is exactly
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
$\mathit{fold} \circ \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta :=
      \alpha}])\,F}\rho$ by Definition~\ref{def:set-interp}, and that
the second arrow above is justified because, for every $d \in
\setsem{\Gamma;\emptyset \vdash \Delta}\rho$, we have that
\[\begin{array}{ll}
  &  \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
      \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
          \alpha}])\,F}\rho\,d\\
<<<<<<< HEAD
: & \setsem{\Gamma;\emptyset \vdash \Nat^{\overline\alpha}\,(H[\phi :=
    F][\overline{\beta := \alpha}])\,F}\rho\\
= & \{\eta : \setsem{\Gamma;\ol{\alpha} \vdash H[\phi :=
    F][\overline{\beta := \alpha}]}\rho[\ol{\alpha := \_}] \Rightarrow
\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha := \_}] ~|~ ...\}\\
= & \{\eta : T_{\rho}(\setsem{\Gamma; \ol{\alpha}
=======
: & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
      \alpha}])\,F}\rho\\
= & \{\eta : \setsem{\Gamma;\ol{\alpha} \vdash H[\phi :=
    F][\overline{\beta := \alpha}]}\rho[\ol{\alpha := \_}] \Rightarrow
\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha := \_}] ~|~ ...\}\\
= & \{\eta : T_{\rho[\ol{\alpha := \_}]}(\setsem{\Gamma; \ol{\alpha}
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
  \vdash F}\rho[\ol{\alpha := \_}]) \Rightarrow
\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha := \_}] ~|~ ...\}
\end{array}\]
Here, the final equality holds because using {\color{red} weakening}
<<<<<<< HEAD
in the third and fifth equalities below, and using
=======
in the third fifth, and sixth equalities below, and using
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
Equations~\ref{eq:subs-var} and ~\ref{eq:subs-const} in the first and
fourth, respectively, ensures that
\[\begin{array}{ll}
  & \setsem{\Gamma;\ol{\alpha} \vdash H[\phi :=
    F][\overline{\beta := \alpha}]}\rho[\ol{\alpha := \_}]\\
= & \setsem{\Gamma;\ol{\alpha}; \ol{\beta} \vdash H[\phi :=
    F]}\rho[\ol{\alpha := \_}][\ol{\beta := \setsem{\Gamma;\ol{\alpha}
      \vdash \alpha}\rho[\ol{\alpha := \_}]}]\\
= & \setsem{\Gamma; \ol{\alpha}, \ol{\beta} \vdash H[\phi :=
    F]}\rho[\ol{\alpha := \_}][\ol{\beta := \_}]\\
= & \setsem{\Gamma; \ol{\beta} \vdash H[\phi :=  F]}\rho[\ol{\beta :=
    \_}]\\ 
<<<<<<< HEAD
= & \lambda \ol{B}.\, \setsem{\Gamma; \ol{\beta}, \phi \vdash
  H}\rho[\ol{\beta := B}][\phi := \lambda \ol{A}.\,\setsem{\Gamma;
    \ol{\beta},\ol{\alpha} \vdash F}\rho[\ol{\beta := B}][\ol{\alpha
      := A}]]\\
= &\lambda \ol{B}.\, \setsem{\Gamma; \ol{\beta}, \phi \vdash
  H}\rho[\ol{\beta := B}][\phi := \lambda \ol{A}.\,\setsem{\Gamma;
    \ol{\alpha} \vdash F}\rho[\ol{\alpha := A}]]\\
= & T^\set_\rho \,(\lambda \ol{A}. \setsem{\Gamma; \ol{\alpha} \vdash
  F}\rho[\ol{\alpha := A}])
=======
= & \setsem{\Gamma; \ol{\beta}, \phi \vdash H}\rho[\ol{\beta :=
    \_}]p[\phi := \setsem{\Gamma; \ol{\beta},\ol{\alpha} \vdash
    F}\rho[\ol{\beta := \_}][\ol{\alpha := \_}]\\
= & \setsem{\Gamma; \ol{\beta}, \phi \vdash H}\rho[\ol{\beta :=
    \_}][\phi := \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha
      := \_}]]\\
= & \setsem{\Gamma; \ol{\alpha}, \ol{\beta}, \phi \vdash H}\rho[\phi
  := \setsem{\Gamma; \ol{\alpha} \vdash F}\rho[\ol{\alpha :=
      \_}]][\ol{\beta := \_}]\\
= & T_{\rho[\ol{\alpha := \_}]}(\setsem{\Gamma; \ol{\alpha} \vdash
  F}\rho[\ol{\alpha := \_}])
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
\end{array}\]
That is, for each $d : \setsem{\Gamma;\emptyset \vdash \Delta}\rho =
\setsem{\Gamma;\emptyset \vdash \Delta}\rho[\ol{\alpha := \_}]$
       {\color{red} by weakening}, we have that
       $\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
         \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
<<<<<<< HEAD
             \alpha}])\,F}\rho\,d$ is a natural transformation
       that is a $T^\set_\rho$-algebra with carrier
       $\setsem{\Gamma;\ol{\alpha} \vdash F} \rho[\ol{\alpha :=
           \_}]$. Thus, if
       $\eta = \setsem{\Gamma;\emptyset~|~\Delta
          \vdash t: \Nat^{\overline\alpha}\,(H[\phi :=
           F][\overline{\beta := \alpha}])\,F}\rho\,d$ then
       $\mathit{fold}_{H,F}$ can actually be applied to $\eta$ to get
       a new natural transformation $\mathit{fold}\,\eta$ from $\mu
       T^\set_\rho$ to $\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha
           := \_}]$, i.e., from $\setsem{\Gamma;\ol{\alpha} \vdash
         (\mu \phi.\lambda \ol{\beta}.H) \ol{\alpha}}\rho[\ol{\alpha
           := \_}]$ to $\setsem{\Gamma;\ol{\alpha} \vdash
         F}\rho[\ol{\alpha := \_}]$.
=======
             \alpha}])\,F}\rho\,d$ comprises a family of natural
       transformations, each of which is a $T^\set_{\rho[\ol{\alpha :=
             \_}]}$-algebra with carrier $\setsem{\Gamma;\ol{\alpha}
         \vdash F} \rho[\ol{\alpha := \_}]$. Thus, if $\eta :
       \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
         \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
             \alpha}])\,F}\rho\,d$ then $\mathit{fold}_{H,F}$ can
       actually be applied to $\eta$ to get a new natural
       transformation $\mathit{fold}\,\eta$ from $\mu
       T_{\rho[\ol{\alpha := \_}]}$ to $\setsem{\Gamma;\ol{\alpha}
         \vdash F}\rho[\ol{\alpha := \_}]$, i.e., from
       $\setsem{\Gamma;\ol{\alpha} \vdash (\mu \phi.\lambda
         \ol{\beta}.H) \ol{\alpha}}\rho[\ol{\alpha := \_}]$ to
       $\setsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha := \_}]$.
>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1

\vspace*{0.1in}

We now show that if $\eta$ satisfies the additional condition on its
<<<<<<< HEAD
components necessary for it to be in $\setsem{\Gamma;\emptyset
  \vdash \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
      \alpha}])\,F}\rho$ --- i.e., if for all $\overline{R :
  \rel(A,B)}$ we have $(\eta_{\ol{A}}, \eta_{\ol{B}}) \in
\relsem{\Gamma;\ol{\alpha} \vdash H[\phi := F][\overline{\beta :=
      \alpha}]}\Eq_\rho[\ol{\alpha := R}] \to \relsem{\Gamma;
  \ol{\alpha} \vdash F}\Eq_\rho[\ol{\alpha := R}]$ --- then
%and $(x,y) \in \relsem{\Gamma;\ol{\alpha} \vdash H[\phi
%    := F][\overline{\beta := \alpha}]}\Eq_\rho[\ol{\alpha := \_}]$ we
%have that $(\eta_{\ol{A}} x, \eta_{\ol{B}} y) \in \relsem{\Gamma;
%  \ol{\alpha} \vdash F}\Eq_\rho[\ol{\alpha := \_}]$ --- then
$\mathit{fold}\,\eta$
%$(\mathit{fold}\,\eta_{\ol{A}},\mathit{fold}\,\eta_{\ol{B}})$
satisfies the additional condition necessary for it to be in
$\setsem{\Gamma;\emptyset \vdash \Nat^{\overline\alpha}\,((\mu
  \phi.\lambda \overline{\beta}.H)\overline{\alpha})\,F}\rho$. To
show this, note that since $(\eta_{\ol{A}}, \eta_{\ol{B}})$ has type
\[\begin{array}{ll}
  & \relsem{\Gamma;\ol{\alpha} \vdash H[\phi := F][\overline{\beta :=
      \alpha}]}\Eq_\rho[\ol{\alpha := R}] \to \relsem{\Gamma;
  \ol{\alpha} \vdash F}\Eq_\rho[\ol{\alpha := R}]\\
= & T_{\Eq_\rho}\, (\relsem{\Gamma; \ol{\alpha}
  \vdash F}\Eq_\rho[\ol{\alpha := \_}]) \,\ol{R} \to \relsem{\Gamma;
  \ol{\alpha} \vdash F}\Eq_\rho[\ol{\alpha := \_}] \,\ol{R}
\end{array}\]
we have that $(\mathit{fold}\, \eta)_{\ol{R}} =
((\mathit{fold}\,\eta)_{\ol{A}}, (\mathit{fold}\,\eta)_{\ol{B}}) =
(\mathit{fold}\,\eta_{\ol{A}}, \mathit{fold}\,\eta_{\ol{B}})$ has type
\[\begin{array}{ll}
& (\mu T_{\Eq_\rho}) \,\ol{R} \to \relsem{\Gamma;\ol{\alpha} \vdash
  F}\rho[\ol{\alpha := R}]\\
= & (\mu T_{\Eq_\rho})\,\ol{\relsem{\Gamma;\ol{\alpha}
  \vdash \alpha}\Eq_\rho[\ol{\alpha := R}]} \to
  \relsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha := R}]\\
= & \relsem{\Gamma; \ol{\alpha} \vdash (\mu \phi. \lambda
  \ol{\beta}. H)\ol{\alpha}}\Eq_\rho[\ol{\alpha := R}] \to
  \relsem{\Gamma;\ol{\alpha} \vdash F}\rho[\ol{\alpha := R}]
\end{array}\]
as desired.


\item The proofs that the relational interpretation of the same term
  has the right type, and that if $\eta$ satisfies the additional
  condition on its components necessary for it to be in
  $\relsem{\Gamma;\emptyset \vdash \Nat^{\overline\alpha}\,(H[\phi :=
      F][\overline{\beta := \alpha}])\,F}\rho$ then
  $\mathit{fold}\,\eta$ satisfies the additional condition necessary
  for it to be in $\relsem{\Gamma;\emptyset \vdash
    \Nat^{\overline\alpha}\,((\mu \phi.\lambda
    \overline{\beta}.H)\overline{\alpha})\,F}\rho$, are analogous.
=======
components necessary for it to be in $\setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline\alpha}\,(H[\phi := F][\overline{\beta :=
      \alpha}])\,F}\rho\,d$ --- i.e., if for all $\overline{R :
  \rel(A,B)}$ and $(x,y) \in \relsem{\Gamma;\ol{\alpha} \vdash H[\phi
    := F][\overline{\beta := \alpha}]}\Eq_\rho[\ol{\alpha := \_}]$ we
have that $(\eta_{\ol{A}} x, \eta_{\ol{B}} y) \in \relsem{\Gamma;
  \ol{\alpha} \vdash F}\Eq_\rho[\ol{\alpha := \_}]$ --- then
$\mathit{fold}\,\eta$ satisfies the additional condition on its
components necessary for it to be in $\setsem{\Gamma;\emptyset \vdash
  \Nat^{\overline\alpha}\,((\mu \phi.\lambda
  \overline{\beta}.H)\overline{\alpha})\,F}\rho\,d$. To show this, let
$\overline{R : \rel(A, B)}$ and let $(u,v) \in \relsem{\Gamma;
  \ol{\alpha} \vdash (\mu \phi. \lambda
  \ol{\beta}.H)\ol{\alpha}}\Eq_\rho[\ol{\alpha := R}]$. If 

{\color{red} FINISH extra condition!}

{\color{blue}
To Do:
\begin{itemize}
\item show set interp is natural in $\rho$
\item show relational interp has right type and is natural
\end{itemize}}

>>>>>>> ac9c14a1eaf68e34c526c8615f340de74304bdb1
\item Finally, to see that
\[\begin{array}{ll}
  &  \pi_i(\relsem{\Gamma;\emptyset \,|\,
  \Delta \vdash \fold_{H,F}\, t : \Nat^{\overline \alpha}\,((\mu
  \phi.\lambda \overline \beta.H)\overline \alpha)\,F}\rho)\\
= & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \fold_{H,F}\, t :
    \Nat^{\overline \alpha}\,((\mu \phi.\lambda \overline
    \beta.H)\overline \alpha)\,F}(\pi_i\rho)
\end{array}\]
we compute
\[\begin{array}{ll}
  & \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash \fold_{H,F}\, t
  : \Nat^{\overline \alpha}\,((\mu \phi.\lambda \overline
  \beta.H)\overline \alpha)\,F}\rho)\\
= & \pi_i(\mathit{fold} \circ \relsem{\Gamma;\emptyset \,|\, \Delta
  \vdash t : \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta :=
      \alpha}])\,F}\rho)\\
= & \mathit{fold} \circ \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta
  \vdash t : \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta :=
      \alpha}])\,F}\rho)\\
= & \mathit{fold} \circ \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t
  : \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta :=
      \alpha}])\,F}(\pi_i\rho)\\
= &\setsem{\Gamma;\emptyset \,|\, \Delta \vdash \fold_{H,F}\, t :
  \Nat^{\overline \alpha}\,((\mu \phi.\lambda \overline
  \beta.H)\overline \alpha)\,F}(\pi_i\rho) 
\end{array}\]
\end{itemize}  
\end{itemize}
\end{proof}

\vspace*{1in}


The Abstraction Theorem is now the special case of
Theorem~\ref{thm:at-gen} for closed terms of close type:

\begin{thm}\label{thm:abstraction}
If $\,\vdash \tau : \F$ and $\vdash t : \tau$, then $(\setsem{\vdash t
  : \tau},\setsem{\vdash t : \tau}) \in \relsem{\vdash \tau}$.
\end{thm}

\pagebreak



\begin{dfn}
% Substitution of a type in a term, in place of a 0-ary type constructor variable.
Let $\Gamma;\Phi,\alpha \,|\, \Delta \vdash t : \tau$
be a term and $\Gamma;\Phi \vdash \sigma : \F$
be a type.
We define a term
$\Gamma;\Phi \,|\, \Delta [\alpha := \sigma] \vdash t[\alpha := \sigma] : \tau [\alpha := \sigma]$
by structural induction on $t$ as
\begin{align*}
x[\alpha := \sigma] &= x \\
 (\lambda x.t)[\alpha := \sigma] &= \lambda x.(t[\alpha := \sigma]) \\
 (st)[\alpha := \sigma] &= (s[\alpha := \sigma])(t[\alpha := \sigma]) \\
 (L_{\overline \alpha} x.t)[\beta := \sigma] &= L_{\overline \alpha} x.(t[\beta := \sigma]) \\
 (t_{\overline\tau}s)[\alpha := \sigma] &= t_{\overline{\tau[\alpha := \sigma]}}(s[\alpha := \sigma]) \\
 (\bot_\tau t) [\alpha := \sigma] &= \bot_{\tau [\alpha := \sigma]} (t[\alpha := \sigma]) \\
\top [\alpha := \sigma] &= \top \\
(s,t)[\alpha := \sigma] &= (s[\alpha := \sigma], t[\alpha := \sigma]) \\
(\pi_1 t)[\alpha := \sigma] &= \pi_1 (t[\alpha := \sigma]) \\
(\pi_2 t)[\alpha := \sigma] &= \pi_2 (t[\alpha := \sigma]) \\
(\case{t}{x \mapsto l}{y \mapsto r})[\alpha := \sigma] &= \case{t[\alpha := \sigma]}{x \mapsto l[\alpha := \sigma]}{y \mapsto r[\alpha := \sigma]} \\   
(\inl\,s)[\alpha := \sigma] &= \inl\,(s[\alpha := \sigma]) \\
(\inr\,s)[\alpha := \sigma] &= \inr\,(s[\alpha := \sigma]) \\
(\tin\,t)[\alpha := \sigma] &= \tin(t[\alpha := \sigma]) \\
(\fold_{H,F}\, t)[\alpha := \sigma] &= \fold_{H[\alpha := \sigma],F}\, (t[\alpha := \sigma])
\end{align*}
\end{dfn}

\begin{lemma}\label{lemma:subst-type-in-term}
Let $\Gamma;\Phi,\alpha \,|\, \Delta \vdash t : \tau$
be a term and $\Gamma;\Phi \vdash \sigma : \F$
be a type.
Then, for any set environment $\rho$ we have that
\[
  \setsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash t[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho
  = \setsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash t : \tau }\rho [ \alpha := \setsem{\Gamma;\Phi\vdash\sigma}\rho ]
\]
and, analogously, for any relational environment $\rho$ we have that
\[
  \relsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash t[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho
  = \relsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash t : \tau }\rho [ \alpha := \relsem{\Gamma;\Phi\vdash\sigma}\rho ]
\]
\end{lemma}
\begin{proof}
By induction on $\Gamma;\Phi,\alpha \,|\, \Delta \vdash t : \tau$
\begin{itemize}
  \item $\Gamma;\Phi,\alpha \,|\, \Delta \vdash t_{\overline\tau}s : G[\overline{\beta := \tau}]$
  \[
  \begin{array}{cl}
      & \setsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash (t_{\overline\tau}s)[\alpha := \sigma] : G[\overline{\beta := \tau}][\alpha := \sigma]}\rho \\
    = & \setsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash t_{\overline{\tau[\alpha := \sigma]}}(s[\alpha := \sigma]) : G[\overline{\beta := \tau[\alpha := \sigma]}]}\rho \\
    = & \eval \circ \langle
      (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \Nat^{\overline{\beta}} \,F \,G}\rho\; \_)_{\overline{\setsem{\Gamma;\Phi\vdash \tau[\alpha := \sigma]}\rho}}, \\
      & \hspace{0.3in} \setsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash s[\alpha := \sigma]: F [\overline{\beta := \tau[\alpha := \sigma]}]}\rho
    \rangle \\
    = & \eval \circ \langle
      (
        \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \Nat^{\overline{\beta}} \,F \,G}\rho\; \_
      )_{\overline{\setsem{\Gamma;\Phi,\alpha\vdash \tau}\rho [\alpha:=\setsem{\Gamma;\Phi\vdash\sigma}\rho] }}, \\
      & \hspace{0.3in} \setsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash s: F [\overline{\beta := \tau}]}\rho [\alpha:=\setsem{\Gamma;\Phi\vdash\sigma}\rho]
    \rangle \\
    = & \setsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash t_{\overline\tau}s : G[\overline{\beta := \tau}]}\rho [\alpha:=\setsem{\Gamma;\Phi\vdash\sigma}\rho]
  \end{array}
  \]
\end{itemize}
\end{proof}

\begin{dfn}
% Substitution of a term in a term.
Let $\Gamma;\Phi \,|\, \Delta, x: \sigma \vdash t : \tau$
and $\Gamma;\Phi \,|\, \Delta \vdash s: \sigma$
be terms.
We define a term
$\Gamma;\Phi \,|\, \Delta \vdash t[x := s] : \tau$
by structural induction on $t$ as
\begin{align*}
x[x := s] &= s \\
y[x := s] &= y \hspace{0.3in}\text{if $x \neq y$} \\
(\lambda x.t)[y := s] &= \lambda x.(t[y := s]) \\
(st)[x := u] &= (s[x := u])(t[x := u]) \\
(L_{\overline \alpha} x.t)[y := s] &= L_{\overline \alpha} x.(t[y := s]) \\
(t_{\overline\tau}s)[x := u] &= (t[x := u])_{\overline{\tau}}(s[x := u]) \\
(\bot_\tau t) [x := s] &= \bot_\tau (t[x := s]) \\
\top [x := s] &= \top \\
(s,t)[x := u] &= (s[x := u], t[x := u]) \\
(\pi_1 t)[x := s] &= \pi_1 (t[x := s]) \\
(\pi_2 t)[x := s] &= \pi_2 (t[x := s]) \\
(\case{t}{x \mapsto l}{y \mapsto r})[z := s] &= \case{t[z := s]}{x \mapsto l[z := s]}{y \mapsto r[z := s]} \\   
(\inl \,s)[x := u] &= \inl\,(s[x := u]) \\
(\inr \,s)[x := u] &= \inr\,(s[x := u]) \\
(\tin\,t)[x := s] &= \tin(t[x := s]) \\
(\fold_{H,F}\, t)[x:=s] &= \fold_{H,F}\, (t[x:=s])
\end{align*}
\end{dfn}

\begin{lemma}\label{lemma:subst-term-in-term}
Let $\Gamma;\Phi \,|\, \Delta, x: \sigma \vdash t : \tau$
and $\Gamma;\Phi \,|\, \Delta \vdash s: \sigma$
be terms.
Then, for any set environment $\rho$ we have that
\[
  \setsem{\Gamma;\Phi \,|\, \Delta \vdash t[x := s] : \tau }\rho(\_)
  = \setsem{\Gamma;\Phi \,|\, \Delta, x: \sigma \vdash t : \tau}\rho
    (\_, \setsem{\Gamma;\Phi \,|\, \Delta\vdash s: \sigma}\rho(\_)) \\
\]
and, analogously, for any relational environment $\rho$ we have that
\[
\relsem{\Gamma;\Phi \,|\, \Delta \vdash t[x := s] : \tau }\rho(\_)
  = \relsem{\Gamma;\Phi \,|\, \Delta, x: \sigma \vdash t : \tau}\rho
    (\_, \relsem{\Gamma;\Phi \,|\, \Delta\vdash s: \sigma}\rho(\_))
\]
\end{lemma}
\begin{proof}
By induction on $\Gamma;\Phi,\alpha \,|\, \Delta, x: \sigma \vdash t : \tau$
\begin{itemize}
  \item $\Gamma;\Phi \,|\, x:\sigma \vdash x: \sigma$
  \[
  \begin{array}{rcl}
    \setsem{\Gamma;\Phi \,|\, \Delta \vdash x[x := s] : \sigma}\rho(\_)
    & = & \setsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}\rho(\_) \\
    & = & \setsem{\Gamma;\Phi \,|\, \Delta, x: \sigma \vdash x : \sigma}\rho
    (\_, \setsem{\Gamma;\Phi \,|\, \Delta\vdash s: \sigma}\rho(\_))
  \end{array}
  \]
  \item $\Gamma;\Phi \,|\, \Delta \vdash t_{\overline\tau}s : G[\overline{\alpha := \tau}]$
  \[
  \begin{array}{cl}
    &\setsem{\Gamma;\Phi \,|\, \Delta \vdash (t_{\overline\tau}s)[x := u] : G[\overline{\alpha := \tau}]}\rho \\
    = & \setsem{\Gamma;\Phi \,|\, \Delta \vdash (t[x:=u])_{\overline{\tau}}(s[x := u]) : G[\overline{\alpha := \tau]}]}\rho \\
    = & \eval \circ \langle
      (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t[x:=u]: \Nat^{\overline{\alpha}} \,F \,G}\rho\; \_)_{\overline{\setsem{\Gamma;\Phi\vdash\tau}\rho}}, \\
      & \hspace{0.3in} \setsem{\Gamma;\Phi \,|\, \Delta \vdash s[x := u]: F [\overline{\alpha := \tau}]}\rho
    \rangle \\
    = & \eval \circ \langle
      (
        \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \Nat^{\overline{\alpha}} \,F \,G}\rho(\_, \setsem{\Gamma;\Phi\,|\,\Delta\vdash u:\sigma}\rho\;\_\;)
      )_{\overline{\setsem{\Gamma;\Phi,\vdash \tau}\rho}}, \\
      & \hspace{0.3in} \setsem{\Gamma;\Phi, \,|\, \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho(\_, \setsem{\Gamma;\Phi\,|\,\Delta\vdash u:\sigma}\rho\;\_
    \rangle \\
    = & \setsem{\Gamma;\Phi \,|\, \Delta, x:\sigma \vdash t_{\overline\tau}s : G[\overline{\alpha := \tau}]}\rho(\_, \setsem{\Gamma;\Phi\,|\,\Delta\vdash u:\sigma}\rho\;\_)
  \end{array}
  \]
\end{itemize}
\end{proof}

\begin{lemma}[Weakening]\label{lemma:weakening}
Weakening is supported by the following facts:
\begin{itemize}
\item Let $\Gamma;\emptyset \vdash \sigma : \T$ be a type.
Then, $\Gamma,v;\emptyset \vdash \sigma : \T$ is well-typed,
and for any set environment $\rho$ we have that
\[
\setsem{\Gamma,v;\emptyset \vdash \sigma}\rho
= \setsem{\Gamma;\emptyset \vdash \sigma}\rho
\]
and for any relation environment $\rho$ we have that
\[
\relsem{\Gamma,v;\emptyset \vdash \sigma}\rho
= \relsem{\Gamma;\emptyset \vdash \sigma}\rho
\]
\item Let $\Gamma;\Phi \vdash \sigma : \F$ be a type.
Then, $\Gamma;\Phi,\alpha \vdash \sigma : \F$ is well-typed,
and for any set environment $\rho$ we have that
\[
\setsem{\Gamma;\Phi,\alpha \vdash \sigma}\rho
= \setsem{\Gamma;\Phi \vdash \sigma}\rho
\]
and for any relation environment $\rho$ we have that
\[
\relsem{\Gamma;\Phi,\alpha \vdash \sigma}\rho
= \relsem{\Gamma;\Phi \vdash \sigma}\rho
\]
\item Let $\Gamma;\Phi \,|\, \Delta \vdash t : \tau$ be a term
and $\Gamma;\Phi \vdash \sigma$ be a type.
Then, $\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t : \tau$ is well-formed,
and for any set environment $\rho$ we have that
\[
  \setsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t : \tau}\rho
  = \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho \pi_{\Delta}
\]
where $\pi_{\Delta}$ is the projection
$\setsem{\Gamma;\Phi \vdash \Delta, x : \sigma} \to \setsem{\Gamma;\Phi \vdash \Delta}$,
and for any relation environment $\rho$ we have that
\[
  \relsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t : \tau}\rho
  = \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \tau}\rho \pi_{\Delta}
\]
where $\pi_{\Delta}$ is the projection
$\relsem{\Gamma;\Phi \vdash \Delta, x : \sigma} \to \relsem{\Gamma;\Phi \vdash \Delta}$.
\end{itemize}
\end{lemma}
\begin{proof}
{\color{red} Do we need a proof for this?}
\end{proof}

{\color{red} All of the following lemmas are stated and proved for set semantics,
but they hold for relational semantics just as well.}

\begin{lemma}\label{lemma:subst-variable}
Let $\Gamma;\Phi \,|\, \Delta, x: \sigma \vdash t : \tau$
be a term.
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\emptyset \,|\, \Delta, y: \sigma \vdash t[x := y] : \tau}\rho
= \setsem{\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t: \tau}\rho$
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{cl}
  & \setsem{\Gamma;\emptyset \,|\, \Delta, y: \sigma \vdash t[x := y] : \tau}\rho({\_}_{\Delta}, {\_}_{\sigma}) \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta, y: \sigma, x: \sigma \vdash t: \tau}
  \rho({\_}_{\Delta}, {\_}_{\sigma}, \setsem{\Gamma;\emptyset \,|\, \Delta, y: \sigma \vdash y: \sigma}\rho({\_}_{\Delta}, {\_}_{\sigma})) \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta, y: \sigma, x: \sigma \vdash t: \tau} \rho({\_}_{\Delta}, {\_}_{\sigma}, {\_}_{\sigma}) \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t: \tau} \rho \pi_{\Delta \times \sigma} ({\_}_{\Delta}, {\_}_{\sigma}, {\_}_{\sigma}) \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t: \tau} \rho({\_}_{\Delta}, {\_}_{\sigma})
\end{array}
\]
where the first equality is by Lemma~\ref{lemma:subst-term-in-term}
and the third equality is given by Lemma~\ref{lemma:weakening}.
\end{proof}

\begin{lemma}
Let $\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t : \tau$
be a term.
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda y. t[x := y] : \sigma \to \tau}\rho
= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x. t : \sigma \to \tau}\rho$
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{cl}
  & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda y. t[x := y] : \sigma \to \tau}\rho \\
= & \curry \circ \setsem{\Gamma;\emptyset \,|\, \Delta, y: \sigma \vdash t[x := y] : \tau}\rho \\
= & \curry \circ \setsem{\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t : \tau}\rho \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x. t : \sigma \to \tau}\rho
\end{array}
\]
where the second equality is by Lemma~\ref{lemma:subst-variable}.
\end{proof}

\begin{lemma}
Let $\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t : G$ be a term.
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\emptyset \,|\, \Delta
  \vdash L_{\overline{\beta}} y. (t[\overline{\alpha := \beta}][x := y])
  : \Nat^{\beta} F[\overline{\alpha := \beta}] G[\overline{\alpha := \beta}]}\rho
= \setsem{\Gamma;\emptyset \,|\, \Delta
  \vdash L_{\overline{\alpha}} x. t : \Nat^{\alpha} F G}\rho$
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{cl}
  & \setsem{\Gamma;\emptyset \,|\, \Delta
  \vdash L_{\overline{\beta}} y. (t[\overline{\alpha := \beta}][x := y])
  : \Nat^{\beta} F[\overline{\alpha := \beta}] G[\overline{\alpha := \beta}]}\rho \\
= & \curry(\setsem{\Gamma;\overline{\beta} \,|\, \Delta, y : F[\overline{\alpha := \beta}]
  \vdash t[\overline{\alpha := \beta}][x := y]
  : G[\overline{\alpha := \beta}]}\rho[\overline{\beta := \_}]) \\
= & \curry(\setsem{\Gamma;\overline{\beta} \,|\, \Delta, x : F[\overline{\alpha := \beta}]
  \vdash t[\overline{\alpha := \beta}]
  : G[\overline{\alpha := \beta}]}\rho[\overline{\beta := \_}]) \\
= & \curry(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t : G}
  \rho[\overline{\beta := \_}][\overline{\alpha := \setsem{\Gamma; \overline{\beta} \vdash \beta}\rho[\overline{\beta := \_}]}]) \\
= & \curry(\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t : G}
  \rho[\overline{\alpha := \_}]) \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta
  \vdash L_{\overline{\alpha}} x. (t) : \Nat^{\alpha} F G}\rho
\end{array}
\]
where the second equality is by Lemma~\ref{lemma:subst-variable}
and the third equality is by Lemma~\ref{lemma:subst-type-in-term}.
\end{proof}

\begin{lemma}
Let $\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t : \tau$ be a term.
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\emptyset \,|\, \Delta \vdash (\lambda x.t)s :\tau}\rho
= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t[x := s] : \tau}\rho
$
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{cl}
  & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash (\lambda x.t)s :\tau}\rho \\
= & \eval \circ \langle
    \setsem{\Gamma;\emptyset \,|\, \Delta \vdash (\lambda x. t) : \sigma \to \tau}\rho,
    \setsem{\Gamma;\emptyset \,|\, \Delta \vdash s : \sigma}\rho
    \rangle \\
= & \eval \circ \langle
    \curry \setsem{\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t : \tau}\rho,
    \setsem{\Gamma;\emptyset \,|\, \Delta \vdash s : \sigma}\rho
    \rangle \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta, x: \sigma \vdash t : \tau}
    \rho(\_, \setsem{\Gamma;\emptyset \,|\, \Delta \vdash s : \sigma}\rho\_) \\
= & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t[x := s] : \tau}\rho
\end{array}
\]
where the last equality is by Lemma~\ref{lemma:subst-term-in-term}.
\end{proof}

\begin{lemma}
Let $\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t : G$,
$\Gamma;\Phi, \overline{\alpha} \,|\, \Delta \vdash s : F$,
and $\Gamma;\Phi\vdash\tau$ be terms.
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\Phi \,|\, \Delta \vdash {(L_{\overline{\alpha}} x.t)}_{\overline{\tau}}s :G[\overline{\alpha := \tau}]}\rho
= \setsem{\Gamma;\Phi \,|\, \Delta \vdash t[\overline{\alpha := \tau}][x := s] : G[\overline{\alpha := \tau}]}\rho$,
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{cl}
  & \setsem{\Gamma;\Phi \,|\, \Delta \vdash {(L_{\overline{\alpha}} x.t)}_{\overline{\tau}}s :G[\overline{\alpha := \tau}]}\rho \\
= & \eval \circ \langle
  (
    \setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}} x.t : \Nat^{\overline{\alpha}} F G}\rho\_
  )_{\setsem{\Gamma;\Phi\vdash\tau}\rho},
  \setsem{\Gamma;\Phi \,|\, \Delta \vdash s : F[\overline{\alpha := \tau}]}\rho
  \rangle \\
= & \eval \circ \langle
    \curry ( \setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t : G}\rho[\overline{\alpha := \setsem{\Gamma;\Phi\vdash\tau}\rho}] ) \_,
    \setsem{\Gamma;\Phi \,|\, \Delta \vdash s : F[\overline{\alpha := \tau}]}\rho
    \rangle \\
= & \setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t : G}\rho[\overline{\alpha := \setsem{\Gamma;\Phi\vdash\tau}\rho}]
    (\_, \setsem{\Gamma;\Phi \,|\, \Delta \vdash s : F[\overline{\alpha := \tau}]}\rho\_) \\
= & \setsem{\Gamma;\Phi \,|\, \Delta, x : F[\overline{\alpha := \tau}] \vdash t[\overline{\alpha := \tau}] : G[\overline{\alpha := \tau}]}\rho
    (\_, \setsem{\Gamma;\Phi \,|\, \Delta \vdash s : F[\overline{\alpha := \tau}]}\rho\_) \\
= & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t[\overline{\alpha := \tau}][x := s] : G[\overline{\alpha := \tau}]}\rho
\end{array}
\]
where the second-to-last equality is by Lemma~\ref{lemma:subst-type-in-term}
and the last equality is by Lemma~\ref{lemma:subst-term-in-term}.
\end{proof}

\begin{lemma}
Let $\Gamma;\Phi \,|\, \Delta \vdash t_1 : \sigma_1$ and $\Gamma;\Phi \,|\, \Delta \vdash t_2 : \sigma_2$ be terms.
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_i(t_1,t_2) : \sigma_i}\rho = \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_i : \sigma_i}\rho$
for $i = 1, 2$.
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{cl}
    & \setsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_i(t_1,t_2) : \sigma_i}\rho \\
  = & \pi_i \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash (t_1,t_2) : \sigma_1 \times \sigma_2}\rho \\
  = & \pi_i \circ (\setsem{\Gamma;\Phi \,|\, \Delta \vdash t_1 : \sigma_1}\rho
      \times \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_2 : \sigma_2}\rho) \\
  = & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_i : \sigma_i}\rho
\end{array}
\]
\end{proof}

\begin{lemma}
Let $\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t_1 : \gamma$
and $\Gamma;\Phi \,|\, \Delta, x : \tau \vdash t_2 : \gamma$ be terms.
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\Phi \,|\, \Delta \vdash \case{\inl \, t}{x_1 \mapsto t_1}{x_2 \mapsto t_2} : \gamma }\rho
= \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_1[x := t] : \gamma }\rho$
and
$\setsem{\Gamma;\Phi \,|\, \Delta \vdash \case{\inr \, t}{x_1 \mapsto t_1}{x_2 \mapsto t_2} : \gamma }\rho
= \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_2[x := t] : \gamma }\rho$
\end{lemma}
\begin{proof}
We prove the $\inl$ case, as the $\inr$ case is completely analogous.
We have that
\[
\begin{array}{cl}
& \setsem{\Gamma;\Phi \,|\, \Delta \vdash \case{\inl \, t}{x_1 \mapsto t_1}{x_2 \mapsto t_2} : \gamma }\rho \\
=& \eval \circ \langle
  \curry [
    \setsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t_1 : \gamma }\rho,
    \setsem{\Gamma;\Phi \,|\, \Delta, x : \tau \vdash t_2 : \gamma }\rho
  ],
  \setsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \, t : \sigma + \tau }\rho
\rangle \\
=& \eval \circ \langle
  \curry [
    \setsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t_1 : \gamma }\rho,
    \setsem{\Gamma;\Phi \,|\, \Delta, x : \tau \vdash t_2 : \gamma }\rho
  ],
  \inl \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma}\rho
\rangle \\
=& [
    \setsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t_1 : \gamma }\rho,
    \setsem{\Gamma;\Phi \,|\, \Delta, x : \tau \vdash t_2 : \gamma }\rho
  ] (
    \_,
    \inl \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma}\rho\_
  ) \\
=& \setsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash t_1 : \gamma }\rho (
    \_,
    \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma}\rho\_
  ) \\
=& \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_1[x := t] : \gamma }\rho
\end{array}
\]
where the last equality is by Lemma~\ref{lemma:subst-term-in-term}.
\end{proof}

\begin{lemma}
Let
\begin{gather*}
\Gamma;\Phi \,|\, \Delta \vdash t_1 : \sigma \to \gamma \\
\Gamma;\Phi \,|\, \Delta \vdash t_2 : \sigma \to \gamma \\
\Gamma;\Phi \,|\, \Delta \vdash s_1 : \sigma \\
\Gamma;\Phi \,|\, \Delta \vdash s_2 : \sigma
\end{gather*}
be terms such that, for any set environment $\rho$,
\[
\setsem{\Gamma;\Phi \,|\, \Delta \vdash t_1 : \sigma \to \gamma}\rho
 = \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_2 : \sigma \to \gamma}\rho
\]
and
\[
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s_1 : \sigma}\rho
= \setsem{\Gamma;\Phi \,|\, \Delta \vdash s_2 : \sigma}\rho
\]
Then, for any set environment $\rho$ we have that
$\setsem{\Gamma;\Phi \,|\, \Delta \vdash t_1s_1 : \gamma}\rho
= \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_2s_2 : \gamma}\rho$
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{rcl}
\setsem{\Gamma;\Phi \,|\, \Delta \vdash t_1s_1 : \gamma}\rho
& = & \eval \langle \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_1 : \sigma \to \gamma}\rho,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s_1 : \sigma}\rho \rangle \\
& = & \eval \langle \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_2 : \sigma \to \gamma}\rho,
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s_2 : \sigma}\rho \rangle \\
& = & \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_2s_2 : \gamma}\rho
\end{array}
\]
\end{proof}

\begin{lemma}
Let $\Gamma;\Phi\vdash\tau$ be a type and
\begin{gather*}
\Gamma;\emptyset \,|\, \Delta \vdash t_1 : \Nat^{\overline{\alpha}} F G \\
\Gamma;\emptyset \,|\, \Delta \vdash t_2 : \Nat^{\overline{\alpha}} F G \\
\Gamma;\Phi \,|\, \Delta \vdash s_1 : F[\overline{\alpha := \tau}] \\
\Gamma;\Phi \,|\, \Delta \vdash s_2 : F[\overline{\alpha := \tau}]
\end{gather*}
be terms such that, for any set environment $\rho$,
\[
\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t_1 : \Nat^{\overline{\alpha}} F G }\rho
 = \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t_2 : \Nat^{\overline{\alpha}} F G }\rho
\]
and
\[
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s_1 : F[\overline{\alpha := \tau}]}\rho
= \setsem{\Gamma;\Phi \,|\, \Delta \vdash s_2 : F[\overline{\alpha := \tau}]}\rho
\]
Then, for any set environment $\rho$ we have that
\[
\setsem{\Gamma;\Phi \,|\, \Delta \vdash {(t_1)}_{\tau}s_1 : G[\overline{\alpha := \tau}]}\rho
= \setsem{\Gamma;\Phi \,|\, \Delta \vdash {(t_2)}_{\tau}s_2 : G[\overline{\alpha := \tau}]}\rho
\]
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{cl}
  & \setsem{\Gamma;\Phi \,|\, \Delta \vdash {(t_1)}_{\tau}s_1 : G[\overline{\alpha := \tau}]}\rho \\
= & \eval \langle (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t_1 : \Nat^{\overline{\alpha}} F G}\rho\_)_{\overline{\setsem{\Gamma;\Phi\vdash\tau}\rho}},
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s_1 : F[\overline{\alpha := \tau}]}\rho \rangle \\
= & \eval \langle (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t_2 : \Nat^{\overline{\alpha}} F G}\rho\_)_{\overline{\setsem{\Gamma;\Phi\vdash\tau}\rho}},
\setsem{\Gamma;\Phi \,|\, \Delta \vdash s_2 : F[\overline{\alpha := \tau}]}\rho \rangle \\
= & \setsem{\Gamma;\Phi \,|\, \Delta \vdash {(t_2)}_{\tau}s_2 : G[\overline{\alpha := \tau}]}\rho
\end{array}
\]
\end{proof}

\begin{lemma}
Let
\begin{gather*}
\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t_1 : \tau \\
\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t_2 : \tau
\end{gather*}
be terms such that, for any set environment $\rho$,
\[
\setsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t_1 : \tau}\rho
 = \setsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t_2 : \tau}\rho
\]
Then, for any set environment $\rho$ we have that
\[
\setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x. t_1 : \sigma \to \tau}\rho
= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x. t_1 : \sigma \to \tau}\rho
\]
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{rcl}
  \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x. t_1 : \sigma \to \tau}\rho
  & = & \curry (\setsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t_1 : \tau}\rho) \\
  & = & \curry (\setsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t_2 : \tau}\rho) \\
  & = & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x. t_2 : \sigma \to \tau}\rho
\end{array}
\]
\end{proof}

\begin{lemma}
Let
\begin{gather*}
\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t_1 : G \\
\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t_2 : G
\end{gather*}
be terms such that, for any set environment $\rho$,
\[
\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t_1 : G}\rho
 = \setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t_2 : G}\rho
\]
Then, for any set environment $\rho$ we have that
\[
\setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}} x. t_1 : \Nat^{\overline{\alpha}} F G}\rho
= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}} x. t_2 : \Nat^{\overline{\alpha}} F G}\rho
\]
\end{lemma}
\begin{proof}
We have that
\[
\begin{array}{rcl}
  \setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}} x. t_1 : \Nat^{\overline{\alpha}} F G}\rho
  & = & \curry (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t_1 : G}\rho[\overline{\alpha := \_}]) \\
  & = & \curry (\setsem{\Gamma;\overline{\alpha} \,|\, \Delta, x : F \vdash t_2 : G}\rho[\overline{\alpha := \_}]) \\
  & = & \setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline{\alpha}} x. t_2 : \Nat^{\overline{\alpha}} F G}\rho
\end{array}
\]
\end{proof}

{\color{red} There might be more congruence lemmas (one for each term introduction/elimination rule)}

{\color{blue} We will need to go back and add typing rules for
  well-formed terms involving $\map^\F$ and $\map^\T$ in Def 5, set
  and relational interpretations of these maps (just the actual
  functorial actions), and cases for $\map$ to all of our proofs thus
  far having to do with terms.

Next we will want to sanity-check our model by showing that term
interps respect conversion rules. These are
\begin{itemize}
\item $\lambda x. t = \lambda y. t[x := y]$
\item $L_{\bm \alpha} x.t = L_{\bm \beta}y.(t[\bm \alpha := \bm
  \beta][x := y])$
\item $(\lambda x. t) s = t[x := s]$  
\item $(L_{\bm \alpha} x.t)_{\bm \tau} s = t[\bm \alpha := \bm
  \tau][x := s]$
\item $\pi_i(t_1,t_2) = t_i$
\item $\case{\inl \, t}{x_1 \mapsto t_1}{x_2 \mapsto t_2} = t_i[x_i := t]$
\item and other conversion rules as on page 18 of MFPS paper
\item perhaps add weakening rules explicitly here?

\vspace*{0.2in}
  
\item All of the above are shorthands for saying that the interps of
  the LHSs are the same as the interps of the RHSs. For this
  conversion rule: $\fold\,k\,(\tin\,t) = k\,(\map\,(\fold\,k)\,t)$,
  we can't express it in syntax. So what we really want to say here is
  that some semantic equivalent of this syntacic rule holds. And
  similarly for the next rules.
\item Maybe we want to show that $(\sem{\mu \alpha. F[\alpha]},
  \sem{\tin})$ is an initial $\sem{F}$-algebra in the model? See
  Birkedal and Mogelberg Section 5.4. As part of this we would have
  the next bullet point, plus some other intermediate results as in
  5.17, 5.18, and 5.19 there. We would also need representations of
  map functions. Perhaps we can define them syntactically as in
  Plotkin and Abadi section 2.1? (But isn't this precisely what we
  tried?)
\item $\fold_H \, \tin_H x = x$ (Intuitively, this is the syntactic
  counterpart to initiality of $\tin$.)  
\item $\map^\F_H \,\overline{(L_{\bm \alpha} x.x)} = L_{\bigcup \bm
  \alpha} x.x$ for all $H$
\item $\map^\F_H \,(\overline{L_{\bm \alpha} x. \eta_{\bm \alpha}
  (\mu_{\bm \alpha} x)}) = L_{\bigcup {\bm \alpha}}x.(\map^\F_H\,
  \overline{\eta})_{\bigcup \bm \alpha} ((\map^\F_H\,
  \overline{\mu})_{\bigcup \bm \alpha} x)$
%\item $\map^\T_F\, (\overline{\lambda x. x}) = \lambda x. x$
%\item $\map^\T_F\, \overline{\lambda x. g(fx)} = \lambda x. \map^\T_F\,
%  \overline{g}\, (\map^\T_F\, \overline{f}\, x)$
%\item $\star\;\;\;\lambda x. \map^\T_G\, \overline{f}\,
%  (\eta_{\overline \sigma} x) = \lambda x.\eta_{\overline \tau}\,
%  (\map^\T_F \,\overline{f}\, x)$
\item $\lambda x. \map^\F_G\, \overline{f}\, (\eta_{\overline \sigma}
  x) = \lambda x.\eta_{\overline \tau}\, (\map^\F_F \,\overline{f}\,
  x)$ (note that $.. \vdash f : \Nat^\emptyset\,F\,G$)
\item $ \map^\F_H (\overline{\map^\F_{K_i} \overline{t_i}}) =
  \map^\F_{H[\overline{\psi := K}]}\,\overline{t}$
%\item $\map^\T_G \, (\map^\T_F \, \overline{t}) =
%  \map^\T_{G[\overline{\beta := F}]}\,\overline{t}$
%\item $\map^\T_\alpha \, f = f$
\item $\map^\F_\phi\, \eta = \eta$
\end{itemize}
Note that there are no computation rules for types because types are
always fully applied in our syntax.

Show $\sem{\Gamma; \emptyset \vdash \sigma \to \tau} = \sem{\Gamma;
  \emptyset \vdash \Nat^\emptyset\, \sigma\, \tau}$. Oh, this doesn't
appear to hold. Unfolding the definitions, the latter appears to
impose a commutativity condition ($\relsem{\Gamma \vdash \tau}(\Eq\,
\rho) \circ \eta = \eta \circ \relsem{\Gamma \vdash \sigma}(\Eq
\,\rho)$ that the former does not require.

Other sanity checks?

Note that our calculus does not support Church encodings of data types
like pair or sum or list types because all of the ``forall''s in our
calculus must be at the top level.  Nevertheless, our calculus does
admit actual sum and product and list types because they are coded by
$\mu$-terms in our calculus. We just don't have an equivalence of
these types and their Church encodings in our calculus, that's all.

}

\section{Free Theorems for Nested Types}

We can use the results of Section~\ref{sec:thms} to prove interesting
results about nested types. To this end, let $\alpha_i$ have arity
$n_i$ for $i = 1,...,k$,
%let $R_i : \rel^{n_i} \to \rel$ for $i = 1,...,k$,
and suppose further that $\emptyset;\bm \alpha \vdash E : \F$, that $F
= \lambda \bm A. \setsem{\emptyset;\bm \alpha \vdash E}[\bm \alpha :=
  \bm A]$, and that $F^* = \lambda \bm R. \relsem{\emptyset;\bm \alpha
  \vdash E}[\bm \alpha := \bm R]$.

%{\color{red}
%  Some $\alpha$s can have arity $k > 0$ here. Then set environment
%  maps them to functors and relation environment maps them to relation
%  transformers.  For these interpretations the statement below
%  becomes: if $(x_i,y_i) \in R_i$ implies $(\beta_i x_i, \gamma_i y_i)
%  \in R'_i$ for $i = 1,...,k$, then $(x,y) \in \relsem{E}[\bm \alpha
%    := \bm R]$ implies $(F\bm \beta x, F \bm \gamma y) \in
%  \relsem{E}[\bm \alpha := \bm {R'}]$.  If we now let $F = \lambda \bm
%  A. \setsem{E}[\bm \alpha := \bm A]$ and $F^* = \lambda \bm
%  R. \relsem{E}[\bm \alpha := \bm R]$, then if $\bm \alpha$ consisted
%  exclusively of type constructor variable of arity greater than $0$,
%  this statement would become: if $(\bm \beta,\bm \gamma) : \bm
%  {(G^0,G^1,G^*)} \to \bm {(H^0,H^1,H^*)}$ then $(\bm {F\beta},\bm
%  {F\gamma}) : \bm {(F G^0, F G^1,F^*G^*)} \to \bm {(F H^0,F
%    H^1,F^*H^*)}$. So this is what's happening for type constructor
%  variables of arity greater than $0$.}

{\color{red} The next proposition is the only place where we use the
  syntactic structure of $E$.}

{\color{red} Propagate contexts?}
\begin{prop}\label{prop:factoid1}
If $(\beta_i, \gamma_i) \in \Hom_{\rel^{n_i}}(R_i, R_i')$ for $i =
1,...,k$, then $(F\bm \beta, F \bm \gamma) \in \Hom_\rel(F^* \bm R,
F^* \bm {R'})$.
\end{prop}
\begin{proof}
  By induction on the structure of $E$.
\begin{itemize}
\item If $\emptyset; \bm \alpha \vdash E : \T$, then the functor $F$
  is constant in $\bm \alpha$. Since $F$ therefore maps every morphism
  in $\set$ to $\id$, we need only show that $(\id,\id) \in
  \Hom_\rel(F^* \bm R,F^* \bm {R'})$ for all $\bm R$ and $\bm
      {R'}$. But since the functor $F^*$ is also constant in $\bm
      \alpha$, this holds trivially.
\item $E = \zerot$.
  %In this case $\relsem{E}$ is the constantly
  %$\zerot$-valued functor, so its action on morphisms takes every
  %morphism to $\id_\zerot$. So we have to show that
  %$(\id_\zerot,\id_\zerot) \in \Hom_\rel(\relsem{E},\relsem{E})$,
  %which holds trivially.
  Similar to previous case.
\item $E = \onet$.
  %In this case $\relsem{E}$ is the constantly
  %$\onet$-valued functor, so its action on morphisms takes every
  %morphism to $\id_\onet$. So we have to show that
  %$(\id_\onet,\id_\onet) \in \Hom_\rel(\relsem{E},\relsem{E})$, which
  %holds trivially.
  Similar to previous case.
\item $E = E_1 * E_2$. If $\bm R : \rel(\bm A,\bm B)$, $\bm {R'} :
  \rel(\bm {A'},\bm {B'})$, $(\bm \beta, \bm \gamma) \in
  \Hom_{\rel^{\bm n}}(\bm R, \bm {R'})$, and $(x,y) \in \relsem{E}[\bm
    \alpha := \bm R]$, then $x \in \setsem{\vdash E}[\bm \alpha := \bm
    A]$ and $y \in \setsem{E}[\bm \alpha := \bm B]$, so $x =
  (x_1,x_2)$ where $x_i \in \setsem{\emptyset;\bm \alpha \vdash
    E_i}[\bm \alpha := \bm A]$ and $y = (y_1,y_2)$ where $y_i \in
  \setsem{E_i}[\bm \alpha := \bm B]$. Therefore $(x_1,y_1) \in
  \relsem{\emptyset;\bm \alpha \vdash E_1}[\bm \alpha := \bm R]$ and
  $(x_2,y_2) \in \relsem{E_2}[\bm \alpha := \bm R]$.  Using the
  induction hypothesis twice we get that $(\setsem{E_1}\bm \beta x_1,
  \setsem{E_1}\bm \gamma y_1) \in \relsem{E_1}[\bm \alpha := \bm
    {R'}]$ and $(\setsem{E_2}\bm \beta x_2, \setsem{E_2}\bm \gamma
  y_2) \in \relsem{E_2}[\bm \alpha := \bm {R'}]$, i.e.,
  $((\setsem{E_1}\bm \beta x_1, \setsem{E_2}\bm \beta x_2),
  (\setsem{E_1}\bm \gamma y_1, \setsem{E_2}\bm \gamma y_2)) \in
  \relsem{E_1}[\bm \alpha := \bm {R'}] \times \relsem{E_2}[\bm \alpha
    := \bm {R'}]$, i.e., $((\setsem{E_1}\bm \beta \times
  \setsem{E_2}\bm \beta)(x_1, x_2), (\setsem{E_1}\bm \gamma \times
  \setsem{E_2}\bm \gamma)(y_1, y_2)) \in \relsem{E_1}[\bm \alpha :=
    \bm {R'}] \times \relsem{E_2}[\bm \alpha := \bm {R'}]$, i.e.,
  $(\setsem{E}\bm \beta x, \setsem{E}\bm \gamma y) \in \relsem{E}[\bm
    \alpha := \bm {R'}]$.
  %The last equivalences use the definition of
  %the action of $\times$ on morphisms.
\item $E = E_1 + E_2$.  If $\bm R : \rel(\bm A,\bm B)$, $\bm {R'} :
  \rel(\bm {A'},\bm {B'})$, $(\bm \beta, \bm \gamma) \in
  \Hom_{\rel^k}(\bm R, \bm {R'})$, and $(x,y) \in \relsem{E}[\bm
    \alpha := \bm R]$, then $x \in \setsem{E}[\bm \alpha := \bm A] =
  \setsem{E_1}[\bm \alpha := \bm A] + \setsem{E_2}[\bm \alpha := \bm
    A]$ and $y \in \setsem{E}[\bm \alpha := \bm B] = \setsem{E_1}[\bm
    \alpha := \bm B] + \setsem{E_2}[\bm \alpha := \bm B]$.  Since
  $(x,y) \in \relsem{E}[\bm \alpha := \bm R]$, we must have either $x
  = \inl\, x_1$ for $x_1 \in \setsem{E_1}[\bm \alpha := \bm A]$, $y =
  \inl\, y_1$ for $y_1 \in \setsem{E_1}[\bm \alpha := \bm B]$, and
  $(x_1,y_1) \in \relsem{E_1}[\bm \alpha := \bm R]$, or $x = \inr
  \,x_2$ for $x_2 \in \setsem{E_2}[\bm \alpha := \bm A]$, $y = \inr
  \,y_2$ for $y_2 \in \setsem{E_2}[\bm \alpha := \bm B]$, and
  $(x_2,y_2) \in \relsem{E_2}[\bm \alpha := \bm R]$.  We prove the
  result for the first case; the second is analogous. By the induction
  hypothesis, $(\setsem{E_1}\bm \beta x_1, \setsem{E_1}\bm \gamma y_1)
  \in \relsem{E_1}[\bm \alpha := \bm {R'}]$, so $(\inl\,
  (\setsem{E_1}\bm \beta x_1), \inl\, (\setsem{E_1}\bm \gamma y_1))
  \in \relsem{E_1}[\bm \alpha := \bm {R'}] + \relsem{E_2}[\bm \alpha
    := \bm {R'}]$, i.e., $(\setsem{E}\bm \beta (\inl\, x_1),
  \setsem{E}\bm \gamma (\inl\, y_1)) \in \relsem{E}[\bm \alpha := \bm
    {R'}]$, i.e., $(\setsem{E}\bm \beta x, \setsem{E}\bm \gamma y) \in
  \relsem{E}[\bm \alpha := \bm {R'}]$.
  %The last couple of
  %equivalences use the definition of the action of $+$ on morphisms.
\item $E = \phi^mE_1...E_m$. Suppose $\bm R : \rel(\bm A,\bm B)$, $\bm
  {R'} : \rel(\bm {A'},\bm {B'})$, $(\bm \beta, \bm \gamma) \in
  \Hom_{\rel^k}(\bm R, \bm {R'})$, $R_\phi =
  (R_\phi^0,R_\phi^1,R_\phi^*)$, and $R'_\phi =
  ({R'_\phi}^0,{R'_\phi}^1,{R'_\phi}^*)$. If
\[  (x,y) \in
  \relsem{\phi^mE_1...E_m}[\bm \alpha := \bm R] =
  R_\phi^*({\relsem{E_1}[\bm \alpha := \bm R]})...({\relsem{E_m}[\bm
      \alpha := \bm R]})\]
  (since $\phi \in \bm \alpha$), then
\[x \in R_\phi^0({\setsem{E_1}[\bm \alpha := \bm
    A]})...({\setsem{E_m}[\bm \alpha := \bm A]})\]
\noindent
and
\[y \in R_\phi^1({\setsem{E_1}[\bm \alpha := \bm A]})...({\setsem{E_m}[\bm
      \alpha := \bm A]})\] Since $(\bm \beta,\bm \gamma) \in \Hom(\bm
R, \bm {R'})$, the induction hypothesis gives that, for each $i =
1,...,m$, $(w,z) \in \relsem{E_i}[\bm \alpha := \bm R]$ implies
$(\setsem{E_i}\bm \beta w, \setsem{E_i}\bm \gamma z) \in
\relsem{E_i}[\bm \alpha := \bm {R'}]$, i.e., $(\setsem{E_i}\bm \beta,
\setsem{E_i}\bm \gamma ) \in \Hom_\rel(\relsem{E_i}[\bm \alpha := \bm
  {R}], \relsem{E_i}[\bm \alpha := \bm {R'}])$. The remark after
Definition~\ref{def:rel-transf} thus gives that
$(R_\phi^0(\setsem{E_1}\bm \beta)...(\setsem{E_m}\bm \beta),
R_\phi^1(\setsem{E_1}\bm \gamma)...(\setsem{E_m}\bm \gamma)) \in
\Hom_\rel(R_\phi^*(\relsem{E_1}[\bm \alpha := \bm
  R])...(\relsem{E_m}[\bm \alpha := \bm R]), R_\phi^*(\relsem{E_1}[\bm
  \alpha := \bm {R'}])...(\relsem{E_m}[\bm \alpha := \bm
  {R'}]))$. Then since $(x,y) \in R_\phi^*(\relsem{E_1}[\bm \alpha :=
  \bm R])...(\relsem{E_m}[\bm \alpha := \bm R])$, we have that
  \begin{eqnarray}\label{eq:app-case}
& &  (R_\phi^0(\setsem{E_1}\bm \beta)...(\setsem{E_m}\bm \beta) x,
    R_\phi^1(\setsem{E_1}\bm \gamma)...(\setsem{E_m}\bm \gamma) y) \nonumber\\
& \in &  R_\phi^*(\relsem{E_1}[\bm \alpha := \bm
      {R'}])...(\relsem{E_m}[\bm \alpha := \bm {R'}])
\end{eqnarray}  
By hypothesis, $(\beta_\phi,\gamma_\phi) : R_\phi^* \to
{R'_\phi}^*$. Since $\beta_\phi$ and $\gamma_\phi$ are natural
transformations, this gives that for all $\bm S : \rel(\bm C,\bm D)$,
$((\beta_\phi)_{\bm C}, (\gamma_\phi)_{\bm D}) \in
\Hom_\rel({R_\phi}^*\bm S, {R'_\phi}^* \bm S)$.  Letting $\bm S =
(\relsem{E_1}[\bm \alpha := \bm {R'}]),...,(\setsem{E_m}[\bm \alpha :=
  \bm {R'}])$, $\bm C = (\setsem{E_1}[\bm \alpha := \bm
  {A'}]),...,(\setsem{E_m}[\bm \alpha := \bm {A'}])$, and $\bm D =
(\setsem{E_1}[\bm \alpha := \bm {B'}]),...,(\setsem{E_m}[\bm \alpha :=
  \bm {B'}])$, and noting that
\[(R_\phi^0(\setsem{E_1}\bm
\beta)...(\setsem{E_m}\bm \beta) x, R_\phi^1(\setsem{E_1}\bm
\gamma)...(\setsem{E_m}\bm \gamma) y) \in R_\phi^*\bm S\] by
Equation~\ref{eq:app-case}, our hypothesis gives that
%$R_\phi^0(\setsem{E_1}\bm \beta)...(\setsem{E_k}\bm \beta) x \in
%R_\phi^0 \bm C$ and $R_\phi^1(\setsem{E_1}\bm
%\gamma)...(\setsem{E_k}\bm \gamma) y \in R_\phi^1 \bm D$,
\begin{eqnarray}\label{eq:app-case2}
& & ((\beta_\phi)_{\bm C} (R_\phi^0(\setsem{E_1}\bm
\beta)...(\setsem{E_m}\bm \beta) x), (\gamma_\phi)_{\bm D}
(R_\phi^1(\setsem{E_1}\bm \gamma)...(\setsem{E_m}\bm \gamma) y)) \nonumber\\
&\in & {R'}_\phi^* \bm S = {R'}_\phi^* (\relsem{E_1}[\bm \alpha := \bm
       {R'}])...(\relsem{E_m}[\bm \alpha := \bm {R'}]) =
\relsem{E}[\bm \alpha := \bm {R'}]
\end{eqnarray}
Using the definition of the action of $\setsem{E}\bm \beta$ on
morphisms (see Diagram~\ref{eq:cd2}) twice --- once with
instantiations $\rho = \bm A$, $\rho' = \bm {A'}$, $f = \bm \beta$ and
$\phi\rho = R_\phi^0$, and once with instantiations $\rho = \bm B$,
$\rho' = \bm {B'}$, $f = \bm \gamma$ and $\phi\rho = R_\phi^1$ ---
Equation~\ref{eq:app-case2} is exactly $(\setsem{E}\bm \beta x,
\setsem{E} \bm \gamma y) \in \relsem{E}[\bm \alpha := \bm {R'}]$.

\item $E = (\mu \phi^m.\lambda \delta_1...\delta_m.h)T_1...T_m$.
  Suppose $\bm R : \rel(\bm A,\bm B)$, $\bm {R'} : \rel(\bm {A'},\bm
  {B'})$, $(\bm \beta, \bm \gamma) \in \Hom_{\rel^k}(\bm R, \bm
  {R'})$, and $(x,y) \in F^* \bm R = \relsem{E}[\bm \alpha := \bm R]$.
%  Then $\bm \beta : \bm A \to \bm {A'}$ and $\bm \gamma : \bm B \to
% \bm {B'}$.
  If $(x,y) \in \relsem{E}[\bm \alpha := \bm R]$, then $x \in
  \setsem{E}[\bm \alpha := \bm A]$ and $y \in \setsem{E}[\bm \alpha :=
    \bm B]$. Consider the relation transformers $(L^0,L^1,L^*)$ and
  $(G^0,G^1,G^*)$, where
\[\begin{array}{lll}
L^0 & = & \mu (H \mapsto \lambda \bm X. \setsem{h}[\phi :=
  H][\bm \delta := \bm X][\bm \alpha := \bm A])\\
L^1 & = & \mu (H \mapsto \lambda \bm X. \setsem{h}[\phi :=
  H][\bm \delta := \bm X][\bm \alpha := \bm B])\\
L^* & = & \mu (W \mapsto \lambda \bm S. \relsem{h}[\phi :=
  W][\bm \delta := \bm S][\bm \alpha := \bm R])\\
G^0 & = & \mu (H \mapsto \lambda \bm X. \setsem{h}[\phi :=
  H][\bm \delta := \bm X][\bm \alpha := \bm {A'}])\\
G^1 & = & \mu (H \mapsto \lambda \bm X. \setsem{h}[\phi :=
  H][\bm \delta := \bm X][\bm \alpha := \bm {B'}])\\
G^* & = & \mu (W \mapsto \lambda \bm S. \relsem{h}[\phi :=
  W][\bm \delta := \bm S][\bm \alpha := \bm {R'}])
\end{array}\]
Then $(x,y) \in L^*(\relsem{T_1}[\bm \alpha := \bm
  R])...(\relsem{T_m}[\bm \alpha := \bm R])$, i.e., $x \in
L^0(\setsem{T_1}[\bm \alpha := \bm A]) ... (\relsem{T_m}[\bm \alpha :=
  \bm A])$ and $y \in L^1(\setsem{T_1}[\bm \alpha := \bm B])
... (\relsem{T_m}[\bm \alpha := \bm B])$. Lemma~\ref{lem:rel-transf}
ensures that each $i = 1,...m$,
$(\setsem{T_i},\setsem{T_i},\relsem{T_i})$ is a relation transformer,
so the induction hypothesis gives that $(w,z) \in \relsem{T_i}[\bm
  \alpha := \bm R]$ implies $(\setsem{T_i}\bm \beta w, \setsem{T_i}\bm
\gamma z) \in \relsem{T_i}[\bm \alpha := \bm {R'}]$ for all $i =
1,...,m$, i.e., $(\setsem{T_i}\bm \beta, \setsem{T_i}\bm \gamma) \in
\Hom_\rel(\relsem{T_i}[\bm \alpha := \bm R], \relsem{T_i}[\bm \alpha
  := \bm R'])$. The remark after Definition~\ref{def:rel-transf} thus
gives that
\begin{eqnarray}
 & & (L^0(\setsem{T_1}\bm \beta)...(\setsem{T_m}\bm \beta),
  L^1(\setsem{T_1}\bm \gamma)...(\setsem{T_m}\bm \gamma))
  \nonumber\\ & \in & \Hom_\rel(L^*(\relsem{T_1}[\bm \alpha := \bm
    R])...(\relsem{T_m}[\bm \alpha := \bm R]), \nonumber\\
 & & \hspace{0.46in}L^*(\relsem{T_1}[\bm \alpha := \bm
    {R'}])...(\relsem{T_m}[\bm \alpha := \bm {R'}])) \nonumber
\end{eqnarray}
Then since
$(x,y) \in L^*(\relsem{T_1}[\bm \alpha := \bm R])...(\relsem{T_m}[\bm
  \alpha := \bm R])$, we have that
\begin{eqnarray}\label{eq:app-case}
 & & (L^0(\setsem{T_1}\bm \beta)...(\setsem{T_m}\bm \beta) x,
  L^1(\setsem{T_1}\bm \gamma)...(\setsem{T_m}\bm \gamma) y) \nonumber\\
 & \in &
  L^*(\relsem{T_1}[\bm \alpha := \bm {R'}])...(\relsem{T_m}[\bm \alpha
    := \bm {R'}])
\end{eqnarray}  
%In particular,
%\begin{eqnarray}\label{eq:fst}
%L^0(\setsem{T_1}\bm \beta)...(\setsem{T_k}\bm \beta) x & \in &
%L^0(\relsem{T_1}[\bm \alpha := \bm {A'}])...(\relsem{T_k}[\bm \alpha
%  := \bm {A'}])
%\end{eqnarray}
%and
%\begin{eqnarray}\label{eq:snd}
%L^1(\setsem{T_1}\bm \gamma)...(\setsem{T_k}\bm \gamma) y & \in &
%L^1(\relsem{T_1}[\bm \alpha := \bm {B'}])...(\relsem{T_k}[\bm \alpha
%  := \bm {B'}])
%\end{eqnarray}

\vspace*{0.1in}

Now, note that for every functor $H$ and sequence of sets $\bm X$,
\begin{eqnarray}
\eta^0_{H,\bm X} & = & \setsem{h}[\phi := \id][\bm \delta := \bm
    \id][\bm \alpha := \bm \beta] \nonumber\\ & : & \setsem{h}[\phi := H][\bm
    \delta := \bm X][\bm \alpha := \bm A] \to \setsem{h}[\phi :=
    H][\bm \delta := \bm X][\bm \alpha := \bm A'] \nonumber
\end{eqnarray}
is a morphism in $\set^k$, so 
\begin{eqnarray}
  \eta^0 & = & (H \mapsto \lambda \bm X.\, \setsem{h}[\phi := H][\bm
    \delta := \bm X][\bm \alpha := \bm \beta])
  \nonumber\\ &  & \hspace*{0.1in} : (H \mapsto \lambda \bm X.\,
  \setsem{h}[\phi := H][\bm \delta := \bm X][\bm \alpha := \bm A])
  \nonumber\\ & & \hspace*{0.2in} \to (H \mapsto \lambda \bm X.\,
  \setsem{h}[\phi := H][\bm \delta := \bm X][\bm \alpha := \bm A'])
  \nonumber
\end{eqnarray}
is a morphism (i.e., a higher-order natural transformation) between
higher-order functors between functors on $\set^m \to \set$:\, indeed,
for every natural transformation $f : H \to H'$ we have that
\begin{equation}\label{eq:cd3}
\begin{CD}
\setsem{h}[\phi := H][\bm \delta := \bm X][\bm \alpha := \bm A] @>
\eta^0_{H,\bm X} >> \setsem{h}[\phi := H][\bm \delta := \bm X][\bm
  \alpha := \bm {A'}] \\ 
@V\setsem{h}[\phi := f][\bm \delta := \bm \id_{\bm X}][\bm \alpha := \bm
  \id_{\bm A}] VV
@V\setsem{h}[\phi := f][\bm \delta := \bm \id_{\bm X}][\bm \alpha := \bm
  \id_{\bm {A'}}] VV \\
\setsem{h}[\phi := H'][\bm \delta := \bm X][\bm \alpha := \bm A] @>
\eta^0_{H',\bm X} >> \setsem{h}[\phi := H'][\bm
    \delta := \bm X][\bm \alpha := \bm {A'}] 
\end{CD}
\end{equation}

\vspace*{0.2in}

\noindent
commutes because the vertical arrows are the $\bm A$ and $\bm {A'}$
components of the natural transformation $\setsem{h}[\phi := f][\bm
  \delta := \bm \id_{\bm X}][\bm \alpha := \bm \id_{\bm \_}]$ induced
by $f$ between the functors $\setsem{h}[\phi := H][\bm \delta := \bm
  X][\bm \alpha := \bm \_]$ and $\setsem{h}[\phi := H'][\bm \delta :=
  \bm X][\bm \alpha := \bm \_]$. Similarly, if
\begin{eqnarray}
\eta^1_{H,\bm X} & = & \setsem{h}[\phi := \id][\bm \delta := \bm
  \id][\bm \alpha := \bm \gamma] \nonumber\\ & : & \setsem{h}[\phi :=
  H][\bm \delta := \bm X][\bm \alpha := \bm B] \to \setsem{h}[\phi :=
  H][\bm \delta := \bm X][\bm \alpha := \bm B'] \nonumber
\end{eqnarray}
and
\begin{eqnarray}
\eta^1 & = & (H \mapsto \lambda \bm X.\, \setsem{h}[\phi := H][\bm
    \delta := \bm X][\bm \alpha := \bm \gamma])
  \nonumber\\ &  & \hspace*{0.1in} : (H \mapsto \lambda \bm X.\,
  \setsem{h}[\phi := H][\bm \delta := \bm X][\bm \alpha := \bm B])
  \nonumber\\ & & \hspace*{0.2in} \to (H \mapsto \lambda \bm X.\,
  \setsem{h}[\phi := H][\bm \delta := \bm X][\bm \alpha := \bm B'])
  \nonumber
%  \eta^1 & : & (H \mapsto \lambda \bm X.\, \setsem{h}[\phi := H][\bm
%    \delta := \bm X][\bm \alpha := \bm B]) \nonumber\\ & \to & (H
%  \mapsto \lambda \bm X.\, \setsem{h}[\phi := H][\bm \delta :=
%    \bm X][\bm \alpha := \bm B']) \nonumber
\end{eqnarray}
then $\eta^1$ is a morphism between higher-order functors between
functors on $\set^m \to \set$.

Since $\mu$ is functorial, it has an action on morphisms, so $\mu
\eta^0 : L^0 \to G^0$ and $\mu \eta^1 : L^1 \to G^1$ are
well-defined. Moreover, since $(\bm \beta, \bm \gamma) \in
\Hom_{\rel}(\bm R, \bm {R'})$, the following diagram commutes:


\begin{equation}\label{eq:cd4}
\scalebox{0.7}{


{\centering
 
\begin{tikzpicture}

\node (UL) at (0, 0) {$L^0(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm {A'}])$}; 
\node (LL) at (0, -3) {$L^1(\setsem{T_1}[\bm \alpha := \bm {B'}])...(\setsem{T_m}[\bm \alpha := \bm {B'}])$};
\node (UR) at (12, 0) {$G^0(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm {A'}])$};
\node (LR) at (12, -3) {$G^1(\setsem{T_1}[\bm \alpha := \bm {B'}])...(\setsem{T_m}[\bm \alpha := \bm {B'}])$};
\draw[->,right] (UL) to node[above]{${\footnotesize (\mu \eta^0)(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm {A'}])}$}(UR); 
\draw[->,right] (LL) to node[above]{${\footnotesize (\mu \eta^1)(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm {A'}])}$}(LR);
\draw[<->, left] (UL) to node[right]{${\footnotesize L^*(\setsem{T_1}[\bm \alpha := \bm {R'}])...(\setsem{T_m}[\bm \alpha := \bm {R'}])}$}(LL);
\draw[<->, right] (UR) to node[left]{${\footnotesize G^*(\setsem{T_1}[\bm \alpha := \bm {R'}])...(\setsem{T_m}[\bm \alpha := \bm {R'}])}$}(LR);
\end{tikzpicture}
}}
\end{equation}


%\begin{equation}\label{eq:cd4}
%\begin{CD}
%L^0(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm {A'}]) @>
%(\mu \eta^0)(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm
%  \alpha := \bm {A'}]) >>
%G^0(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm {A'}])\\
%@V L^*(\setsem{T_1}[\bm \alpha := \bm {R'}])...(\setsem{T_m}[\bm \alpha
%  := \bm {R'}]) VV 
%@V  G^*(\setsem{T_1}[\bm \alpha := \bm {R'}])...(\setsem{T_m}[\bm \alpha
% := \bm {R'}]) VV \\
%L^1(\setsem{T_1}[\bm \alpha := \bm {B'}])...(\setsem{T_m}[\bm \alpha := \bm {B'}]) @>
%(\mu \eta^1)(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm
%  \alpha := \bm {A'}]) >>
%G^1(\setsem{T_1}[\bm \alpha := \bm {B'}])...(\setsem{T_m}[\bm \alpha := \bm {B'}])\\
%\end{CD}
%\end{equation}
Together with Equation~\ref{eq:app-case}, Equation~\ref{eq:cd4} gives
\begin{eqnarray}\label{eq:cd5}
 & (\,(\mu \eta^0)(\setsem{T_1}[\bm \alpha := \bm
    {A'}])...(\setsem{T_m}[\bm \alpha := \bm
    {A'}])(L^0(\setsem{T_1}[\bm \alpha := \bm
    \beta])...(\setsem{T_m}[\bm \alpha := \bm \beta]) x), &
  \nonumber\\ & \hspace*{0.1in}(\mu \eta^1)(\setsem{T_1}[\bm \alpha :=
    \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm
    {A'}])(L^1(\setsem{T_1}[\bm \alpha := \bm
    \gamma])...(\setsem{T_m}[\bm \alpha := \bm \gamma])
  y)\,) &\nonumber\\ & \hspace*{-1.9in}\in \; G^*(\relsem{T_1}[\bm
    \alpha := \bm {R'}])...(\setsem{T_m}[\bm \alpha := \bm {R'}]) & \nonumber\\
& \hspace*{-2.8in}= \; \relsem{(\mu \phi.\lambda \bm \delta.h)\bm T}[\bm
  \alpha := \bm {R'}]\nonumber\\
& \hspace*{-3.35in}= \; \relsem{E}[\bm \alpha := \bm {R'}]
\end{eqnarray}  

We also have that if $\psi$ is a fresh type constructor variable, then
\[\setsem{\psi T_1...T_m}[\bm \alpha := \bm A][\psi := L^0] \; = \; L^0
(\setsem{T_1}[\bm \alpha := \bm {A}])...(\setsem{T_m}[\bm \alpha :=
  \bm {A}])\] and
\[\setsem{\psi T_1...T_m}[\bm \alpha := \bm {A'}][\psi := G^0] \; = \; G^0
(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm \alpha :=
  \bm {A'}])\]
so that
\begin{eqnarray}\label{eq:cd6}
& & \setsem{\psi T_1...T_m}[\bm \alpha := \bm \beta][\psi := \mu
    \eta^0] \nonumber\\ & = & (\mu \eta^0)(\setsem{T_1}[\bm \alpha :=
    \bm {A'}])...(\setsem{T_m}[\bm \alpha := \bm {A'}]) \circ
  L^0(\setsem{T_1}[\bm \alpha := \bm \beta])...(\setsem{T_m}[\bm
    \alpha := \bm \beta]) \nonumber\\ & : & L^0 (\setsem{T_1}[\bm
    \alpha := \bm {A}])...(\setsem{T_m}[\bm \alpha := \bm {A}]) \to
  G^0 (\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm
    \alpha := \bm {A'}])
\end{eqnarray}
Similarly,
\begin{eqnarray}\label{eq:cd7}
& & \setsem{\psi T_1...T_m}[\bm \alpha := \bm \gamma][\psi := \mu
    \eta^1] \nonumber\\ & = & (\mu \eta^1)(\setsem{T_1}[\bm \alpha :=
    \bm {B'}])...(\setsem{T_m}[\bm \alpha := \bm {B'}]) \circ
  L^1(\setsem{T_1}[\bm \alpha := \bm \gamma])...(\setsem{T_m}[\bm
    \alpha := \bm \gamma]) \nonumber\\ & : & L^1 (\setsem{T_1}[\bm
    \alpha := \bm {B}])...(\setsem{T_m}[\bm \alpha := \bm {B}]) \to
  G^1 (\setsem{T_1}[\bm \alpha := \bm {B'}])...(\setsem{T_m}[\bm
    \alpha := \bm {B'}])
\end{eqnarray}

Rewriting Equation~\ref{eq:cd5} using Equations~\ref{eq:cd6}
and~\ref{eq:cd7} gives
\begin{eqnarray}\label{eq:cd8}
(\setsem{\psi T_1...T_m}[\bm \alpha := \bm \beta][\psi := \mu
    \eta^0]x, \setsem{\psi T_1...T_m}[\bm \alpha := \bm \gamma][\psi := \mu
  \eta^1]y) \in \relsem{E}[\bm \alpha := \bm {R'}]
\end{eqnarray}
Now we have that 
\begin{eqnarray}
&   & \setsem{\psi T_1...T_m}[\bm \alpha := \bm \beta][\psi := \mu \eta^0]\nonumber\\  
& = & \mu \eta^0(\setsem{T_1}[\bm \alpha := \bm \beta])...(\setsem{T_m}[\bm
    \alpha := \bm \beta])\nonumber\\
& = & \mu (H \mapsto \lambda \bm X.\, \setsem{h}[\phi := H][\bm
    \delta := \bm X][\bm \alpha := \bm \beta])(\setsem{T_1}[\bm \alpha :=
    \bm \beta])...(\setsem{T_m}[\bm \alpha := \bm \beta])\nonumber\\ 
& = & \setsem{(\mu \phi. \lambda \bm \delta.h)T_1...T_m}[\bm \alpha :=
    \bm \beta]\nonumber
\end{eqnarray}
\noindent
and 
\begin{eqnarray}
&   & \setsem{\psi T_1...T_m}[\bm \alpha := \bm \gamma][\psi := \mu \eta^1]\nonumber\\
& = & \mu \eta^1(\setsem{T_1}[\bm \alpha := \bm \gamma])...(\setsem{T_m}[\bm
    \alpha := \bm \gamma])\nonumber\\
& = & \mu (H \mapsto \lambda \bm X.\, \setsem{h}[\phi := H][\bm
    \delta := \bm X][\bm \alpha := \bm \gamma])(\setsem{T_1}[\bm \alpha :=
    \bm \gamma])...(\setsem{T_m}[\bm \alpha := \bm \gamma])\nonumber\\ 
& = & \setsem{(\mu \phi. \lambda \bm \delta.h)T_1...T_m}[\bm \alpha :=
    \bm \gamma]\nonumber
\end{eqnarray}
%\begin{eqnarray}
%&   & \setsem{\psi T_1...T_m}[\bm \alpha := \bm A][\psi := L^0]\nonumber\\
%& = & L^0(\setsem{T_1}[\bm \alpha := \bm A])...(\setsem{T_m}[\bm
%    \alpha := \bm A])\nonumber\\
%& = & \setsem{(\mu \phi. \lambda \bm \delta.h)T_1...T_m}[\bm \alpha :=
%    \bm A]\nonumber
%\end{eqnarray}
%and
%\begin{eqnarray}
%&   & \setsem{\psi T_1...T_m}[\bm \alpha := \bm {A'}][\psi := G^0]\nonumber\\
%& = & G^0(\setsem{T_1}[\bm \alpha := \bm {A'}])...(\setsem{T_m}[\bm
%    \alpha := \bm {A'}])\nonumber\\
%& = & \setsem{(\mu \phi. \lambda \bm \delta.h)T_1...T_m}[\bm \alpha :=
%    \bm {A'}]\nonumber
%\end{eqnarray}
%{\color{red} Since $\emptyset; \psi,\bm \alpha \vdash E : \F$, the results
%of~\cite{jp19} ensure that $\setsem{E} = \setsem{(\mu \phi. \lambda
%  \bm \delta.h)T_1...T_m}$ is functorial in $\psi,\bm \alpha$.
%Moreover, since $\emptyset; \psi, \bm \alpha \vdash \psi T_1...T_k :
%\F$,~\cite{jp19} also ensures that $\setsem{\psi T_1...T_k}$ is
%functorial in $\psi, \bm \alpha$.
%It follows that $\setsem{\psi
%  T_1...T_k}$ and $\setsem{\psi T_1...T_k}$
%are functorial in $\bm \alpha$.
%
%We therefore have the equalities
%\[\setsem{\psi T_1...T_m}[\psi := L^0]\;
%= \; L^0\setsem{T_1}...\setsem{T_m} \;= \; \setsem{(\mu \phi. \lambda
%  \bm \delta.h)T_1...T_m}\]
%and
%\[\setsem{\psi T_1...T_m}[\psi := G^0]
%\; = \; G^0\setsem{T_1}...\setsem{T_m} \; = \; \setsem{(\mu
%  \phi. \lambda \bm \delta.h)T_1...T_m}\] between functors in $\psi, \bm
%\alpha$.
\noindent
so (\ref{eq:cd8}) becomes 
%\begin{eqnarray}
%(\setsem{(\mu \phi. \lambda \bm \delta.h)T_1...T_m}[\bm \alpha := \bm
%    \beta][\psi := \mu \eta^0]x, \setsem{(\mu \phi. \lambda \bm
%    \delta.h)T_1...T_m}[\bm \alpha := \bm \gamma][\psi := \mu \eta^1]y)
%  \in \relsem{E}[\bm \alpha := \bm {R'}] \nonumber
%\end{eqnarray}
%But since $\psi$ was fresh, this is just
\begin{eqnarray}\label{eq:cd9}
(\setsem{(\mu \phi. \lambda \bm \delta.h)T_1...T_m}[\bm \alpha := \bm
    \beta]x, \setsem{(\mu \phi. \lambda \bm \delta.h)T_1...T_m}[\bm
    \alpha := \bm \gamma]y) \in \relsem{E}[\bm \alpha := \bm {R'}]
\end{eqnarray}
i.e., $(\setsem{E}\bm \beta x, \setsem{E} \bm \gamma y) \in
\relsem{E}[\bm \alpha := \bm {R'}]$.
\end{itemize}
\end{proof}

With the following standard definition, we can prove that our
interpretations give rise to a Graph Lemma.

\begin{dfn}
If $f : A \to B$ then the relation $\graph{f} : \rel(A,B)$ is defined
by $(x,y) \in \graph{f}$ iff $fx = y$.
\end{dfn}
Note that $\graph{\id_B} = \Eq_B$.

\begin{thm}\label{thm:graph-lemma}
If $f_i : A_i \to B_i$ for $i = 1,...,k$ then $F^* {\graph
  f_1}...{\graph f_k} = \graph{F f_1 ... f_k}$.
\end{thm}
\begin{proof}
  First observe that
  \[((f_1,...,f_k),(\id_{B_1},...,\id_{B_k})) \in
  \Hom_{\rel^k}(\bm {\graph f}, \bm {\Eq_{B_i}})\]
  \noindent
  and
  \[((\id_{A_1},...,\id_{A_k}),(f_1,...,f_k)) \in \Hom_{\rel^k}(\bm
  {\Eq_{A_i}},\bm {\graph f})\] Applying
  Proposition~\ref{prop:factoid1} to each of these observations gives
  that
    \begin{equation}\label{eq:one}
    (F \bm f, F \bm \id_{B_i}) \in \Hom_\rel(F^* \bm
        {\graph{f}}, F^* \bm {\Eq_{B_i}})
        \end{equation}
      and
      \begin{equation}\label{eq:two}
        (F \bm \id_{A_i},F \bm f) \in \Hom_\rel(F^* \bm
        {\Eq_{A_i}},F^* \bm {\graph{f}})
        \end{equation}
      \noindent
      Expanding Equation~\ref{eq:one} gives that if $(x,y) \in F^* \bm
      {\graph{f}}$ then $(F {\bm f} x, F {\bm \id_{B_i}} y) \in F^*
      \bm \Eq_{B_i} = \relsem{E}[\bm \alpha := \bm \Eq_{B_i}] =
      \Eq_{\setsem{E}[\bm \alpha := \bm B_i]} = \Eq_{F \bm B}$, where
      the penultimate equality holds by Theorem~\ref{thm:iel}. That
      is, if $(x,y) \in F^* \bm {\graph{f}}$ then $(F \bm f x, y) \in
      \Eq_{F \bm B}$, i.e., if $(x,y) \in F^* \bm {\graph{f}}$ then
      $F\bm f x = y$, i.e., if $(x,y) \in F^* \bm {\graph{f}}$ then
      ($x, y) \in \graph{F \bm f}$. Thus $F^* \bm {\graph{f}}
      \subseteq \graph{F \bm f}$.

      Similar analysis of Equation~\ref{eq:two} gives that $\graph{F
        \bm f} \subseteq F^* \bm {\graph{f}}$.
\end{proof}

Inlining the definitions of $F$ and $F^*$ in the statement of
Theorem~\ref{thm:graph-lemma} gives

\begin{equation}\label{eq:three}
\relsem{E}[\bm \alpha := \bm {\graph{f}}] = \graph{\setsem{E}[\bm
    \alpha:= \bm f]}
\end{equation}
\noindent
We can use Equation~\ref{eq:three} to prove that the set
interpretation of a closed term of (closed) type $\Nat^{\bm
  \alpha}\,F\,G$ is a natural transformation.
%To see this, write $\fmap\, \bm f$ for $\setsem{F} \bm
%f = \setsem{F}[\bm \alpha := \bm f]$ and $\gmap\, \bm f$ for
%$\setsem{G} \bm f = \setsem{G}[\bm \alpha := \bm f]$.

\begin{thm}
If $\vdash t : \Nat^{\bm \alpha}\,F\,G$ and $\bm f : \bm A \to \bm B$,
then $\setsem{t}_{\bm B} \circ \setsem{F}[\bm \alpha := \bm f]
%Fmap \bm f = Gmap \bm f
= \setsem{G}[\bm \alpha := \bm f] \circ \setsem{t}_{\bm A}$.
\end{thm}
\begin{proof}
Theorem~\ref{thm:abstraction} ensures that $(\setsem{t},\setsem{t})
\in \relsem{\Nat^{\bm \alpha}\,F\,G}$, i.e., that for all $\bm R :
\rel(\bm A,\bm B)$, $x : F\bm A$, and $x': F\bm B$, if $(x,x') \in
\relsem{F}[\bm \alpha := \bm R]$ then $(\setsem{t}_{\bm A}
x,\setsem{t}_{\bm B} x') \in \relsem{G}[\bm \alpha := \bm R]$. If $\bm
f : \bm A \to \bm B$, then taking $\bm R = \bm {\graph{f}}$ and
instantiating gives that if $(x,x') \in \relsem{F}[\bm \alpha := \bm
  {\graph{f}}]$ then $(\setsem{t}_{\bf A} x,\setsem{t}_{\bf B} x') \in
\relsem{G}[\bm \alpha := \bm {\graph{f}}]$. By Equation~\ref{eq:three}
this is the same as the requirement that if $(x,x') \in
\graph{\setsem{F}[\bm \alpha := \bm f]}$ then $(\setsem{t}_{\bm A}
x,\setsem{t}_{\bm B} x') \in \graph{\setsem{G}[\bm \alpha := \bm f]}$
i.e., that if $x' = \setsem{F}[\bm \alpha := \bm f]x$ then
$\setsem{t}_{\bm B} x' = \setsem{G}[\bm \alpha := \bm
  f](\setsem{t}_{\bm A})$, i.e., that $\setsem{t}_{\bm B}
(\setsem{F}[\bm \alpha := \bm f]x) = \setsem{G}[\bm \alpha := \bm f]
(\setsem{t}_{\bm A} x)$ for all $x : F\bm A$, i.e., that
$\setsem{t}_{\bm B} \circ \setsem{F}[\bm \alpha := \bm f] =
\setsem{G}[\bm \alpha := \bm f] \circ \setsem{t}_{\bm A}$.
\end{proof}

\bibliography{bibfile}


\end{document}







First, some preliminaries. For $F \in \F$ define $\lift{F}$ as in Agda
code file. This is the syntactic reflection of $\relsem{F}$, we think.

\begin{lemma}
%For $F \in \F$, if $\lift{F} \,\graph{f} \subseteq \graph{Ff}$ then
%$(Ff, \id) : \rel(\lift{F} \,\graph{f}, \id)$.  
For $F \in \F$, if $\relsem{F} \,\graph{f} \subseteq \graph{\setsem{F}f}$ then
$(\setsem{F}f, \id) : \rel(\relsem{F} \,\graph{f}, \id)$.  
\end{lemma}
\begin{proof}
If $\relsem{F} \, \graph{f} \subseteq \graph{\setsem{F}f}$ then $(a,b) \in
    \relsem{F}\,\graph{f}$ implies $(a,b) \in \graph{\setsem{F}f}$,
    i.e., $b = \setsem{F}fa$, i.e., $(\setsem{F}fa, b) \in \id$, i.e.,
    $(\setsem{F}f,\id) \in \rel(\relsem{F}\,\graph{f}, \id)$.
\end{proof}


\begin{lemma}\label{lem:props}
If $\bm \alpha = \{\alpha_1,...,\alpha_k\}$, $t : \Nat^{\bm
  \alpha}\,F\,G$, and $f_i : A_i \to B_i$ for $i = 1,...,k$, then
%\begin{itemize}
%\item
$(t_{A_1,...A_k},t_{B_1...B_k}) : \lift{F} \, \graph{f} \to
  \lift{G}\,\graph{f}$ in $\rel$.
%\item $(t_{A_1,...A_k},t_{B_1...B_k}) : \graph{\setsem{F}map \, f} \to
%  \graph{\setsem{G}map \, f}$ in $\rel$.
%\end{itemize}
\end{lemma}
\begin{proof}
  %The first
This is proved by noting that $\graph{f_i} : \rel(A_i,B_i)$ and
$t = \Lambda \alpha. \lambda x : F\alpha.\, v[x]$, and inducting on
the structure of $v$. {\color{red} Check!}
\end{proof}

If we knew that {\color{red} for more than one $\alpha$?}
\begin{prop}
  If $\emptyset; \alpha~|~\emptyset \vdash F \in \F$,
  %$\gamma$ is a set
%environment, $\ol{\gamma}$ is the relation environment mapping each
%type variable $\beta$ to the identity relation on $\beta \gamma$, each
%type constructor variable $\beta$ of arity $0$ to the identity
%relation on $\beta \gamma$, and each type constructor variable to the
  %identity relation transformer,
  and $f : A \to B$ then
  $\relsem{F}%\ol{\gamma}
  [\alpha := \graph{f}] = \graph{(\setsem{F}map)
    %\gamma map)
  \,f}$. 
\end{prop}
\noindent
then we'd get as a corollary the following useful free theorem:

\begin{cor}
Let $\bm \alpha = \{\alpha_1,...,\alpha_k\}$, $\vdash t : \Nat^{\bm
  \alpha}\,F\,G$, and $f_i : A_i \to B_i$ for $i = 1,...,k$. If
$\emptyset; \bm \alpha~|~\emptyset \vdash s : \setsem{F}[\alpha_1 :=
  A_1]...[\alpha_k := A_k]$ then $t_{B_1...B_k}
\,((\setsem{F}map)\,f_1\,...\,f_k\,s) = (\setsem{G}map) \,
f_1\,...\,f_k\,(t_{A_1...A_k} s)$.
\end{cor}
\begin{proof}
By part 2 of Lemma~\ref{lem:props} we have that for all $(s,s') \in
\relsem{F}[\bm \alpha := \bm {\graph{f}}]$, $(t_{A_1...A_k} s,
t_{B_1...B_k}s') \in \relsem{G}[\bm \alpha := \bm {\graph{f}}]$, i.e.,
for all $(s,s') \in \graph{\setsem{F}map \,\bm f}$, $(t_{A_1...A_k} s,
t_{B_1...B_k}s') \in \graph{\setsem{G}map\,\bm f}$ {\color{red} by a
  suitable proposition above}, i.e., $t_{B_1...B_k}
\,((\setsem{F}map)\,f_1\,...\,f_k\,s) = (\setsem{G}map) \,
f_1\,...\,f_k\,(t_{A_1...A_k} s)$.


An alternative proof might be: See p.1,15 july
\end{proof}






  






\section{Conclusion}

Can do everything in abstract locally presentable cartesian closed
category. 

Give definitions for arb lpccc, but compute free theorems in Set/Rel.



\bibliography{references}

\end{document}



\begin{lemma}\label{lem:rel-transf}
For any \,$\Gamma;\Phi \vdash \tau : \F$ and any relation environment
$\rho$,
\[\relsem{\Gamma;\Phi \vdash \tau}\rho :
\rel(\setsem{\Gamma;\Phi \vdash \tau} (\pi_1 \rho),
\setsem{\Gamma;\Phi \vdash \tau} (\pi_2 \rho))\]
\end{lemma}
\begin{proof}
By induction on the structure of $\tau$. The only interesting case is
when $\tau = (\mu \phi. \lambda
\overline{\alpha}. H)\overline{\tau}$. We first observe that $T_\rho$
is an endofunctor on $RT$, i.e., that, for any relation transformer $F
= (F^0, F^1, F^*)$, the triple $T_{\rho} F = (T^\set_{\pi_1 \rho}F^0,
T^\set_{\pi_2 \rho}F^1, T^\rel_{\rho}F)$ is also a relation
transformer.  Indeed, for every $R_j : \rel(A_j, B_j)$, $j = 1, \dots,
k$, and for $i = 1, 2$, we have
\[\begin{split}
\pi_i(T^\rel_{\rho}\,F\,\overline{R})
&= \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi := F]\overline{[\alpha := R]}) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i (\rho[\phi := F]\overline{[\alpha := R]})) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i \rho)[\phi := \pi_i F]\overline{[\alpha := \pi_i R]}) \\
&= T^\set_{\pi_i \rho} (\pi_i F) (\overline{\pi_i R})
\end{split}\]
and 
\[\begin{split}
\pi_i(T^\rel_{\rho}\,F\,(\overline{\gamma_1}, \overline{\gamma_2}))
&= \pi_i(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi
  := F]\overline{[\alpha := (\overline{\gamma_1}, \overline{\gamma_2})]}) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i (\rho[\phi := F]\overline{[\alpha := (\gamma_1,\gamma_2)]})) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H} (\pi_i \rho)[\phi := \pi_i F]\overline{[\alpha := \pi_i \gamma_i]}) \\
&= T^\set_{\pi_i \rho} (\pi_i F) (\overline{\pi_i \gamma_i})
\end{split}\]
Here, the second equality in each of the above chains of equalities is
by the induction hypothesis. The upshot is that
$T^\rel_{\rho}F^*\overline{R} : \rel( T^\set_{\pi_1\rho} F^0
\overline{A}, T^\set_{\pi_2\rho} F^1 \overline{B} )$, and, in
particular, that
\begin{equation}\label{eq:rel-transf-T}
\pi_i (T_\rho F) = T^\set_{\pi_i \rho} (\pi_i F)
\end{equation}
We now show that, for every morphism $\delta = (\delta^0, \delta^1) :
F \to G$ in $RT$, $T_\rho \delta : T_\rho F \to T_\rho G$ is a
morphism in $RT$. That is, we show that for all $\overline{R : \rel(A,
  B)}$ and $(x, y) \in (T_\rho F)^* \overline{R}$, we have that
$((T_\rho \delta)^0_{\overline A} \,x, (T_\rho \delta)^1_{\overline
  B}\, y) \in (T_\rho G)^* \overline{R}$, i.e., that
$((T^\set_{\pi_1\rho} \delta^0)_{\overline A}\, x, (T^\set_{\pi_2
  \rho} \delta^1)_{\overline B}\, y) \in (T_\rho G)^*
\overline{R}$. Let $\overline{R : \rel(A, B)}$ and $(x, y) \in (T_\rho
F)^* \overline{R} = \relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash
  H}\rho[\phi := F]\overline{[\alpha := R]}$.  Since
$\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
  \text{--}]\overline{[\alpha := R]}$ is a functor from $\relenv$ to
$RT$ by the induction hypothesis, we have that
\[\begin{array}{ll}
 & \relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
  \delta]\overline{[\alpha := R]}\\
: & \relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
  F]\overline{[\alpha := R]} \to
\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
  G]\overline{[\alpha := R]}
\end{array}\]
is a morphism in $\rel$. Therefore,
\[\begin{array}{ll}
 &\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
  \delta]\overline{[\alpha := R]} (x, y) \\
=& ( (\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
  \delta]\overline{[\alpha := R]})^0 x,
(\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}\rho[\phi :=
  \delta]\overline{[\alpha := R]})^1 y)\\
= &( \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}(\pi_1
\rho)[\phi := \delta^0]\overline{[\alpha := A]} x, 
\setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}(\pi_2 \rho)[\phi
  := \delta^1]\overline{[\alpha := B]} y) \\ 
= & ((T^\set_{\pi_1\rho} \delta^0)_{\overline A} x, (T^\set_{\pi_2
  \rho} \delta^1)_{\overline B} y) 
\end{array}\]
is in $(T_\rho G)^* \overline{R}$.  Here, the second equality is by
Lemma~\ref{lem:rel-transf-morph}.  This concludes the proof that
$T_\rho$ is an endofunctor on $RT$.

Next, we prove by induction on natural numbers that, for every $n :
\nat$ and for every relation transformer $F = (F^0, F^1, F^*)$, the
triple $T_{\rho}^n F = ({(T^\set_{\pi_1 \rho})}^n F^0, {(T^\set_{\pi_2
    \rho})}^n F^1, {(T^\rel_{\rho})}^n F^*)$ is a relation transformer
and, in particular, that
\begin{equation}\label{eq:rel-transf-T-iter}
\pi_i(T_{\rho}^n F) = {(T^\set_{\pi_i \rho})}^{n} (\pi_i F)
\end{equation}
for $i = 1, 2$.
Indeed, the base case $n = 0$ is obvious, and the inductive step is proven by
\[\begin{split}
\pi_i(T_{\rho}^{n+1} F)
&= \pi_i(T_{\rho}^{n} (T_{\rho} F))\\
&= {(T^\set_{\pi_i \rho})}^{n} ( \pi_i(T_{\rho} F) )\\
&= {(T^\set_{\pi_i \rho})}^{n} ( T^\set_{\pi_i \rho} (\pi_i F) ) \\
&= {(T^\set_{\pi_i \rho})}^{n+1} (\pi_i F)
\end{split}\]
The second equality is by the induction hypothesis, and the third is
by Equation~\ref{eq:rel-transf-T}. We can now prove that the triple
$\mu T_{\rho} = (\mu T^\set_{\pi_1 \rho}, \mu T^\set_{\pi_2 \rho}, \mu
T^\rel_\rho)$ is a relation transformer and, in particular, that
\begin{equation}\label{eq:rel-transf-T-limit}
\pi_i ( \mu T_\rho ) = \mu T^\set_{\pi_i \rho}
\end{equation}
for $i = 1, 2$. Moreover,
\[\begin{split}
\pi_i(\mu T_{\rho})
&= \pi_i( \lim_{\xrightarrow[n]{}} \, T_{\rho}^n K_0 )  \\
&= \lim_{\xrightarrow[n]{}} \, \pi_i ( T_{\rho}^n K_0 )  \\
&= \lim_{\xrightarrow[n]{}} \, {(T^\set_{\pi_i \rho})}^n (\pi_i K_0)  \\
&= \lim_{\xrightarrow[n]{}} \, {(T^\set_{\pi_i \rho})}^n K^\set_0  \\
&= \mu T^\set_{\pi_i \rho}
\end{split}\]
The third equality above is by
Equation~\ref{eq:rel-transf-T-iter}. Finally, we can prove the lemma
we seek for the $\mu$ case.  For $i = 1, 2$ we have
\[
\begin{split}
\pi_i(\relsem{\Gamma;\Phi \vdash (\mu \phi. \lambda \overline{\alpha}. H) \overline{\tau}}\rho)
&= \pi_i( \mu T_\rho (\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho})) \\
&= \pi_i(\mu T_{\rho}) (\overline{\pi_i(\relsem{\Gamma;\Phi \vdash \tau}\rho})) \\
&= \mu T^\set_{\pi_i\rho} (\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i\rho)}) \\
&= \setsem{\Gamma;\Phi \vdash (\mu \phi. \lambda \overline\alpha. H) \overline{\tau}}(\pi_i\rho)
\end{split}
\]
The third equality is by Equation ~\ref{eq:rel-transf-T-limit} and
induction on $\tau$.
\end{proof}

\noindent

%%% We don't currently need this, but it should be true.
%\begin{lemma}
%\label{lem:rel-transf-uniqueness}
%In a relation transformer $(H^0, H^1, H^*)$, the $\set$-functors $H^0$ and $H^1$ are uniquely determined by the $\rel$-functor $H^*$.
%%A functor \(H^* : \rel^k \to \rel\) carries at most one relation transformer structure \((H^0, H^1, H^*)\).
%\end{lemma}
%\begin{proof}
%Notice that, for any $\bar{A} \in \set^k$, there exists a $\bar{R} \in \rel^k$ such that $\pi_i(\bar{R}) = \bar{A}\) for \(i = 1, 2$.
%In particular, $\bar{R}$ can be taken to be the equality relation $\delta_{\bar{A}}$ on $\bar{A}$.
%Then, $H^i$ is uniquely determined by $H^i(\bar{A}) = H^i(\pi_i(\delta_{\bar{A}})) = \pi_i(H^*(\delta_{\bar{A}}))$.
%\end{proof}

Since a well-formed type involves only finitely many (free) variables,
when convenient we identify relation environments with finite tuples
containing the relations to which the environment maps those
variables.  With this convention we also see by induction on the
structure of $\tau$ that in fact the following morphism counterpart to
Lemma~\ref{lem:rel-transf} also holds:


{\color{red} This makes the ``morphism counterpart'' comment clear. We
  actually need more than what is proved in
  Lemma~\ref{lem:rel-transf-morph} to conclude that the black version
  of this theorem holds, no?
\begin{lemma}
  For any \,$\Gamma;\Phi \vdash \tau : \F$ and any morphism $f : \rho
  \to \rho'$ between relation environments $\rho$ and $\rho'$,
\[\relsem{\Gamma;\Phi \vdash \tau}f :
\rel(\setsem{\Gamma;\Phi \vdash \tau} (\pi_1 f),
\setsem{\Gamma;\Phi \vdash \tau} (\pi_2 f))\]
\end{lemma}}

\begin{lemma}\label{lem:rel-transf-morph}
$\sem{\Gamma;\Phi \vdash \tau} = (\setsem{\Gamma;\Phi \vdash
    \tau},\setsem{\Gamma;\Phi \vdash \tau},\relsem{\Gamma;\Phi \vdash
    \tau})$ is a relation transformer.
\end{lemma}
\begin{proof}
By induction on the structure of $\tau$. Let $ i = 1,2$.
\begin{itemize}
\item When $\tau = v$, $\tau = \sigma_1 \to \sigma_2$, or $\tau =
  \Nat^{\bm \alpha}\,F\,G$, then the result follows from the fact
  that
\[\begin{array}{lll}
       \pi_i(\relsem{\Gamma;\emptyset \vdash \tau}f)
 & = & \id_{\pi_i(\setsem{\Gamma;\emptyset \vdash \tau}\rho)}\\
 & = & \id_{\setsem{\Gamma;\emptyset \vdash \tau}(\pi_i\rho)}\\
 & = & \setsem{\Gamma;\emptyset \vdash \tau}(\pi_i f)
\end{array}\]
The third equality is by Lemma~\ref{lem:rel-transf}.
\item When $\tau = 0$, $\tau = 1$, $\tau = \sigma_1 + \sigma_2$, or
  $\tau = \sigma \times \sigma_2$, the result follows from the
  definitions of the initial and terminal objects, and the definitions
  of sums and products, in $\rel$.
\item When $\tau = \Gamma; \Phi \vdash \phi^k\tau_1...\tau_k$, we have    
\[\begin{array}{lll}
&   & \pi_i \relsem{\Gamma; \Phi \vdash \phi^k\tau_1...\tau_k}f\\
& = & \pi_i ((f\phi)_{\overline{\relsem{\Gamma; \Phi \vdash \tau}\rho'}})
\circ \pi_i((\rho\phi)({\overline{\relsem{\Gamma; \Phi \vdash \tau}f}}))\\
& = & (\pi_i (f\phi))_{\overline{\pi_i (\relsem{\Gamma; \Phi \vdash \tau}\rho')}}
\circ \pi_i(\rho\phi)({\overline{\pi_i (\relsem{\Gamma; \Phi \vdash \tau}f}}))\\
& = & ((\pi_i f)\phi)_{\overline{\setsem{\Gamma; \Phi \vdash \tau}(\pi_i\rho')}}
\circ ((\pi_i\rho)\phi)({\overline{\setsem{\Gamma; \Phi \vdash \tau}(\pi_i f)}})\\
& = & \setsem{\Gamma; \Phi \vdash \phi^k\tau_1...\tau_k}(\pi_i f)
\end{array}\]
\item When $\tau = (\mu \phi. \lambda \overline\alpha. H)
  \overline{\tau}$, we first observe that if $F = (F^0,F^1, F^*)$ is a
  relation transformer, then so is the triple $\sigma_f F =
  (\sigma^\set_{\pi_i f} F^0,\sigma^\set_{\pi_2 f} F^1,\sigma^\rel_f
  F^*)$. Moreover, for any relation transformer $F = (F^0,F^1,F^*)$,
  we have that
\begin{equation}\label{eq:rel-transf-sigma}
\pi_i(\sigma_f F) = \sigma^\set_{\pi_i f} (\pi_i F)
\end{equation}
Indeed, for every $R_j : \rel(A_j, B_j)$ and $j = 1, \dots, k$
\[
\begin{split}
\pi_i (\sigma_f \,F \,\overline{R})
&= \pi_i (\relsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}f[\phi
  := \id_F]\overline{[\alpha := \id_R]}) \\ 
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}(\pi_i(f[\phi := \id_F]\overline{[\alpha := \id_R]})) \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}(\pi_i f)[\phi := \pi_i\id_F]\overline{[\alpha := \pi_i\id_R]} \\
&= \setsem{\Gamma;\Phi,\phi,\overline{\alpha} \vdash H}(\pi_i f)[\phi := \id_{\pi_i F}]\overline{[\alpha := \id_{\pi_i R}]} \\
&= \sigma^\set_{\pi_i f} (\pi_i F) (\overline{\pi_i R})
\end{split}
\]
Next, we prove by induction on natural numbers, for every $n : \nat$
and for every relation transformer $F = (F^0,F^1,F^*)$, the triple
$\sigma_f^n F = ((\sigma^\set_{\pi_1 f})^n F^0,(\sigma^\set_{\pi_2
  f})^n F^1, (\sigma^\rel_f)^n F^*)$ is a relation transformer. In
particular,
\begin{equation}\label{eq:rel-transf-sigma-iter}
\pi_i(\sigma_f^n F) = {(\sigma^\set_{\pi_i f})}^n (\pi_i F)
\end{equation}
for $i = 1, 2$.
Indeed, the base case $n = 0$ is obvious, and the inductive step is proven by
\[
\begin{split}
\pi_i(\sigma_f^{n+1} F)
&= \pi_i(\sigma_f^n (\sigma_f F) ) \\
&= {(\sigma^\set_{\pi_i f})}^n (\pi_i(\sigma_f F)) \\
&= {(\sigma^\set_{\pi_i f})}^n (\sigma^\set_{\pi_i f} (\pi_i F)) \\
&= {(\sigma^\set_{\pi_i f})}^{n+1} (\pi_i F)
\end{split}
\]
The third equality is by Equation~\ref{eq:rel-transf-sigma}.
Now we prove that
\begin{equation}\label{eq:rel-transf-sigma-limit}
\pi_i ( \mu \sigma_f ) = \mu \sigma^\set_{\pi_i f}
\end{equation}
for $i = 1, 2$.
Indeed,
\[
\begin{split}
\pi_i ( \mu \sigma_f )
&= \pi_i( \lim_{\xrightarrow[n]{}} \,\sigma_{f}^n K_0 )  \\
&= \lim_{\xrightarrow[n]{}} \, \pi_i( \sigma_{f}^n K_0 )  \\
&= \lim_{\xrightarrow[n]{}} \, (\sigma^\set_{\pi_i f})^n (\pi_i K_0)  \\
&= \lim_{\xrightarrow[n]{}} \, (\sigma^\set_{\pi_i f})^n K^\set_0  \\
&= \mu \sigma^\set_{\pi_i f}
\end{split}
\]
The third equality is by Equation~\ref{eq:rel-transf-sigma-iter}.
Finally, we can prove the lemma we seek for the $\mu$ case. We have
\[
\begin{split}
\pi_i(\relsem{\Gamma;\Phi \vdash (\mu \phi. \lambda
  \overline\alpha. H)\overline{\tau}}f) 
&= \pi_i(\mu T_{\rho'}(\overline{\relsem{\Gamma;\Phi \vdash
    \tau}f}) \circ (\mu \sigma_f)_{\overline{\relsem{\Gamma;\Phi
      \vdash \tau}\rho}}) \\ 
&= \pi_i(\mu T_{\rho'}(\overline{\relsem{\Gamma;\Phi \vdash
    \tau}f})) \circ \pi_i((\mu
\sigma_f)_{\overline{\relsem{\Gamma;\Phi \vdash \tau}\rho}}) \\  
&= \pi_i(\mu T_{\rho'})(\pi_i(\overline{\relsem{\Gamma;\Phi
    \vdash \tau}f})) \circ \pi_i(\mu
\sigma_f)_{\pi_i(\overline{\relsem{\Gamma;\Phi \vdash 
      \tau}\rho})} \\ 
&= (\mu T^\set_{\pi_i \rho'})(\overline{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i f)}) \circ (\mu \sigma^\set_{\pi_i f})_{\overline{\setsem{\Gamma;\Phi \vdash \tau}\pi_i(\rho)}} \\
&= \setsem{\Gamma;\Phi \vdash (\mu \phi. \lambda \overline\alpha. H)\overline{\tau}}(\pi_i f).
\end{split}
\]
for $i = 1, 2$.
The fourth equality is by~\ref{eq:rel-transf-T-limit},
\ref{eq:rel-transf-sigma-limit}, and induction on $\tau$.
\end{itemize}
\end{proof}




\begin{thm}\label{thm:at}
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : \tau$ induces
a natural transformation from $\sem{\Gamma; \Phi \vdash \Delta}$ to
$\sem{\Gamma; \Phi \vdash \tau}$, i.e., a triple of natural
transformations 
\[(\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau},
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau},
\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau})\] such that, for all
$\rho : \relenv$,
\[\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho =
(\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}(\pi_1 \rho),
\setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}(\pi_2 \rho))\]
\end{thm}
\begin{proof}
We proceed by induction on the judgement
$\Gamma;\Phi~|~\Delta \vdash t : \tau$, proving that
\[
\pi_i(\relsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}\rho)
= \setsem{\Gamma;\Phi~|~\Delta \vdash t : \tau}(\pi_i\rho)
\]
for $i = 1, 2$.
We will use Definitions~\ref{def:set-interp} and~\ref{def:rel-interp}, together
with the facts that the cartesian structure of $\rel$ is derived from
that of $\set$ and that initial algebras in $\rel$ are computed in
terms of initial algebras in $\set$.
\begin{itemize}
\item for $\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau} \rho) \\
    &= \pi_i(
      \pi_{|\Delta|+1}: \relsem{\Gamma;\emptyset \vdash \Delta}\rho
      \times \relsem{\Gamma;\emptyset \vdash \tau}\rho
      \to \relsem{\Gamma;\emptyset \vdash \tau}\rho
    ) \\
    &= \pi_{|\Delta|+1}: \pi_i(\relsem{\Gamma;\emptyset \vdash \Delta}\rho)
      \times \pi_i(\relsem{\Gamma;\emptyset \vdash \tau}\rho)
      \to \pi_i(\relsem{\Gamma;\emptyset \vdash \tau}\rho) \\
    &= \pi_{|\Delta|+1}: \setsem{\Gamma;\emptyset \vdash \Delta}(\pi_i\rho)
      \times \setsem{\Gamma;\emptyset \vdash \tau}(\pi_i\rho)
      \to \setsem{\Gamma;\emptyset \vdash \tau}(\pi_i\rho) \\
    &= \setsem{\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau} (\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau}\rho) \\
    &= \pi_i(\curry (\relsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t : \tau}\rho)) \\
    &= \curry(\pi_i (\relsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t : \tau}\rho)) \\
    &= \curry(\setsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t : \tau}(\pi_i \rho)) \\
    &= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau}(\pi_i \rho)
  \end{split}
  \]
\item for $\Gamma;\emptyset \,|\, \Delta \vdash st: \tau$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash st: \tau} \rho) \\
    &= \pi_i(\eval \circ \langle \relsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to
    \tau}\rho, \relsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}\rho) \\
    &= \eval \circ \langle
       \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to \tau}\rho),
       \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}\rho)
     \rangle \\
    &= \eval \circ \langle
       \setsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to \tau}(\pi_i\rho),
       \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}(\pi_i\rho)
     \rangle \\
    &= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash st: \tau} (\pi_i \rho)
  \end{split}
  \]
\item for $\Gamma;\emptyset \,|\, \Delta \vdash
  L_{\overline \alpha} x.t: \Nat^{\overline\alpha} \,F \,G$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t
      : \Nat^{\overline\alpha} \,F \,G}\rho) \\
    &= \pi_i(\curry (\relsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash t: G}
      \rho[\overline{\alpha := \_}])) \\
    &= \curry (\pi_i(\relsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash t: G}
      \rho[\overline{\alpha := \_}])) \\
    &= \curry (\setsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash t: G}
      (\pi_i(\rho[\overline{\alpha := \_}]))) \\
    &= \curry (\setsem{\Gamma;\overline \alpha\,|\, \Delta, x : F \vdash t: G}
      (\pi_i\rho)[\overline{\alpha := \_}]) \\
    &= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t
      : \Nat^{\overline\alpha} \,F \,G}(\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\Phi \,|\, \Delta \vdash
  t_{\bf \tau} s: G [\overline{\alpha := \tau}]$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s:
      G [\overline{\alpha := \tau}]}\rho) \\
    &= \pi_i( \eval \circ \langle
        (\relsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
          \Nat^{\overline{\alpha}} \,F \,G}\rho\; \_)_{\overline{\relsem{\Gamma;\Phi
          \vdash \tau}\rho}},
        \relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho
      \rangle) \\ 
    &= \eval \circ \langle
        \pi_i((\relsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
          \Nat^{\overline{\alpha}} \,F \,G}\rho\; \_)_{\overline{\relsem{\Gamma;\Phi
          \vdash \tau}\rho}}),
        \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho)
      \rangle \\ 
    &= \eval \circ \langle
        (\pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
          \Nat^{\overline{\alpha}} \,F \,G}\rho)\; \_)_{\overline{\pi_i(\relsem{\Gamma;\Phi
          \vdash \tau}\rho)}},
        \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha := \tau}]}\rho)
      \rangle \\ 
    &= \eval \circ \langle
        (\setsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
          \Nat^{\overline{\alpha}} \,F \,G}(\pi_i\rho)\; \_)_{\overline{\setsem{\Gamma;\Phi
          \vdash \tau}(\pi_i\rho)}},
        \setsem{\Gamma;\Phi \,|\, \Delta \vdash s: F [\overline{\alpha := \tau}]}(\pi_i\rho)
      \rangle \\
    &= \setsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\bf \tau} s:
      G [\overline{\alpha := \tau}]}(\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\Phi \,|\, \Delta,x :\tau \vdash x : \tau$ is analogous to
  $\Gamma;\emptyset \,|\, \Delta,x :\tau \vdash x : \tau$.
\item for $\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau$ we have
  \[
  \begin{split}
    \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau} \rho)
    &= \pi_i(!^0_{\relsem{\Gamma;\Phi \vdash \tau}\rho}
      \circ \relsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho) \\
    &= !^0_{\pi_i(\relsem{\Gamma;\Phi \vdash \tau}\rho)}
      \circ \pi_i(\relsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho) \\
    &= !^0_{\setsem{\Gamma;\Phi \vdash \tau}(\pi_i\rho)}
      \circ \setsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}(\pi_i\rho) \\
    &= \setsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau}(\pi_i\rho) 
  \end{split}
  \]
\item for $\Gamma;\Phi \,|\, \Delta \vdash \top : \onet$ is analogous to
  $\Gamma;\Phi \,|\, \Delta \vdash \bot_\tau t : \tau$
\item for $\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau$ we have
  \[
  \begin{split}
    \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau} \rho)
    &= \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma} \rho
      \times \relsem{\Gamma;\Phi \,|\, \Delta \vdash t: \tau} \rho) \\
    &= \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma} \rho)
      \times \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t: \tau} \rho) \\
    &= \setsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma} (\pi_i\rho)
      \times \setsem{\Gamma;\Phi \,|\, \Delta \vdash t: \tau} (\pi_i\rho) \\
    &= \setsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : \sigma \times \tau} (\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma$ we have
  \[
  \begin{split}
    \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma} \rho)
    &= \pi_i(\pi_1 \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau}\rho) \\
    &= \pi_1 \circ \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau}\rho) \\
    &= \pi_1 \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : \sigma \times \tau}(\pi_i\rho) \\
    &= \setsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma} (\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : \sigma$
  is analogous to $\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : \sigma$.
\item for $\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r}: \gamma$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r}: \gamma}\rho) \\
    &= \pi_i(\eval \circ \langle
        \curry \,[
          \relsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash l : \gamma}\rho,
          \relsem{\Gamma;\Phi \,|\, \Delta, y: \tau \vdash r : \gamma}\rho
        ],
        \relsem{\Gamma;\Phi \,|\, \Delta \vdash t :\sigma + \tau} \rho
      \rangle) \\
    &= \eval \circ \langle
        \curry \,[
          \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash l : \gamma}\rho),
          \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta, y: \tau \vdash r : \gamma}\rho)
        ],
        \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t :\sigma + \tau} \rho)
      \rangle \\
    &= \eval \circ \langle
        \curry \,[
          \setsem{\Gamma;\Phi \,|\, \Delta, x : \sigma \vdash l : \gamma}(\pi_i\rho),
          \setsem{\Gamma;\Phi \,|\, \Delta, y: \tau \vdash r : \gamma}(\pi_i\rho)
        ],
        \setsem{\Gamma;\Phi \,|\, \Delta \vdash t :\sigma + \tau}(\pi_i\rho)
      \rangle \\
    &= \setsem{\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r}: \gamma}(\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau$ we have
  \[
  \begin{split}
    \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau} \rho)
    &=\pi_i(\inl \circ \relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}\rho) \\
    &=\inl \circ \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}\rho) \\
    &=\inl \circ \setsem{\Gamma;\Phi \,|\, \Delta \vdash s: \sigma}(\pi_i\rho) \\
    &= \setsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: \sigma + \tau} (\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: \sigma + \tau$
  is analogous to $\Gamma;\Phi \,|\, \Delta \vdash \inl \,t: \sigma + \tau$.
\item for $\Gamma;\Phi \,|\, \Delta
      \vdash \tin\,t : (\mu \phi.\lambda {\overline \alpha}.H){\overline \tau}$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta
      \vdash \tin\,t : (\mu \phi.\lambda {\overline \alpha}.H){\overline \tau}} \rho) \\
    &= \pi_i(\mathit{in} \circ
      \relsem{\Gamma;\Phi \,|\, \Delta \vdash t : H[\phi := \mu
      \phi.\lambda {\overline \alpha}.H][\overline{\alpha := \tau}]} \rho) \\
    &= \mathit{in} \circ
      \pi_i(\relsem{\Gamma;\Phi \,|\, \Delta \vdash t : H[\phi := \mu
      \phi.\lambda {\overline \alpha}.H][\overline{\alpha := \tau}]} \rho) \\
    &= \mathit{in} \circ
      \setsem{\Gamma;\Phi \,|\, \Delta \vdash t : H[\phi := \mu
      \phi.\lambda {\overline \alpha}.H][\overline{\alpha := \tau}]} (\pi_i\rho) \\
    &= \setsem{\Gamma;\Phi \,|\, \Delta
      \vdash \tin\,t : (\mu \phi.\lambda {\overline \alpha}.H){\overline \tau}} (\pi_i\rho)
  \end{split}
  \]
\item for $\Gamma;\emptyset \,|\, \Delta \vdash \fold_{H,F}\, t
  : \Nat^{\overline \alpha}\, ((\mu\phi.\lambda \overline \beta.H)\overline \alpha)\,F$ we have
  \[
  \begin{split}
    &\hspace{-0.3in} \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash
      \fold_{H,F}\, t : \Nat^{\overline \alpha}\,((\mu
      \phi.\lambda \overline \beta.H)\overline \alpha)\,F}\rho) \\
    &= \pi_i(\mathit{fold} \circ \relsem{\Gamma;\emptyset \,|\, \Delta \vdash t : 
      \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta := \alpha}])\,F}\rho) \\
    &= \mathit{fold} \circ \pi_i(\relsem{\Gamma;\emptyset \,|\, \Delta \vdash t : 
      \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta := \alpha}])\,F}\rho) \\
    &= \mathit{fold} \circ \setsem{\Gamma;\emptyset \,|\, \Delta \vdash t : 
      \Nat^{\overline \alpha}\,(H[\phi := F][\overline{\beta := \alpha}])\,F}(\pi_i\rho) \\
    &= \setsem{\Gamma;\emptyset \,|\, \Delta \vdash
      \fold_{H,F}\, t : \Nat^{\overline \alpha}\,((\mu
      \phi.\lambda \overline \beta.H)\overline \alpha)\,F}(\pi_i\rho) \qedhere
  \end{split}
  \]
\end{itemize}
\end{proof}
