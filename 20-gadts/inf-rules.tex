% For double-blind review submission, w/o CCS and ACM Reference (max
% submission space)
\documentclass[acmsmall,review,anonymous]{acmart}
\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{POPL} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2020}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations
%\citestyle{acmnumeric}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\usepackage[utf8]{inputenc}
\usepackage{ccicons}
\usepackage{verbatim}

\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amscd}
%\usepackage{MnSymbol}
\usepackage{xcolor}

\usepackage{bbold}
\usepackage{url}
\usepackage{upgreek}
%\usepackage{stmaryrd}

\usepackage{lipsum}
\usepackage{tikz-cd}
\usetikzlibrary{cd}
\usetikzlibrary{calc}
\usetikzlibrary{arrows}

\usepackage{bussproofs}
\EnableBpAbbreviations

\input{macros}
\input{mytheorem}

\theoremstyle{definition}
\newtheorem{exmpl}{Example}

\renewcommand{\greyout}[1]{} %{{\color{gray} {#1}}} -- toggle to remove greyed text

\newcommand{\new}[1]{{\color{blue} {#1}}}


\newcommand{\emptyfun}{{[]}}
\newcommand{\cal}{\mathcal}
%\newcommand{\fold}{\mathit{fold}}
\newcommand{\F}{\mathcal{F}}
\renewcommand{\G}{\mathcal{G}}
\newcommand{\N}{\mathcal{N}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\B}{\mathcal{B}}
\renewcommand{\P}{\mathcal{A}}
\newcommand{\pred}{\mathsf{Fam}}
\newcommand{\env}{\mathsf{Env}}
\newcommand{\set}{\mathsf{Set}}
\renewcommand{\S}{\mathcal S}
\renewcommand{\C}{\mathcal{C}}
\newcommand{\D}{\mathcal{D}}
\newcommand{\A}{\mathcal{A}}
\renewcommand{\id}{\mathit{id}}
\newcommand{\map}{\mathsf{map}}
\newcommand{\pid}{\underline{\mathit{id}}}
\newcommand{\pcirc}{\,\underline{\circ}\,}
\newcommand{\pzero}{\underline{0}}
\newcommand{\pone}{\underline{1}}
\newcommand{\psum}{\,\underline{+}\,}
\newcommand{\pinl}{\underline{\mathit{inL}}\,}
\newcommand{\pinr}{\underline{\mathit{inR}}\,}
\newcommand{\ptimes}{\,\underline{\times}\,}
\newcommand{\ppi}{\underline{\pi_1}}
\newcommand{\pppi}{\underline{\pi_2}}
\newcommand{\pmu}{\underline{\mu}}
\newcommand{\semmap}{\mathit{map}}
\newcommand{\subst}{\mathit{subst}}

\newcommand{\tb}[1]{~~ \mbox{#1} ~~}
\newcommand{\listt}[1]{(\mu \phi. \lambda \beta . \onet + \beta \times
  \phi \beta) #1} 
\newcommand{\filtype}{\Nat^\emptyset 
 (\Nat^\emptyset \, \alpha \, \mathit{Bool})\, (\Nat^\emptyset 
  (List \, \alpha) \, (List \, \alpha))} 
\newcommand{\filtypeGRose}{\Nat^\emptyset 
 (\Nat^\emptyset \, \alpha \, \mathit{Bool})\, (\Nat^\emptyset 
  (\mathit{GRose}\,\psi \, \alpha) \, (\mathit{GRose}\,\psi \, (\alpha
  + \onet)))} 
\newcommand{\maplist}{\mathit{map}_{\lambda A. \setsem{\emptyset; \alpha
      \vdash \mathit{List} \, \alpha} \rho[\alpha := A]}} 
\newcommand{\PLeaves}{\mathsf{PLeaves}}
\newcommand{\swap}{\mathsf{swap}}
\newcommand{\reverse}{\mathsf{reverse}}
\newcommand{\Bcons}{\mathit{Bcons}}
\newcommand{\Bnil}{\mathit{Bnil}}

\title[Practical Parametricity for GADTs]{Practical Parametricity for GADTs}
  %Primitive
  %% [Short Title] is optional; when present,
                         %% will be used in header instead of Full
                         %% Title.
%\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{Patricia Johann, Enrico Ghiorzi, and Daniel Jeffries}
%\authornote{with author1 note}          %% \authornote is optional;
%                                        %% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
%  \position{Position1}
%  \department{Department1}              %% \department is recommended
  \institution{Appalachian State University}            %% \institution is required
%  \streetaddress{Street1 Address1}
%  \city{City1}
%  \state{State1}
%  \postcode{Post-Code1}
%  \country{Country1}                    %% \country is recommended
}
\email{johannp@appstate.edu, ghiorzie@appstate.edu, jeffriesd@appstate.edu}          %% \email is recommended


\begin{document}

\begin{abstract}
Abstract goes here
\end{abstract}

%\begin{CCSXML}
%<ccs2012>
%<concept>
%<concept_id>10011007.10011006.10011008</concept_id>
%<concept_desc>Software and its engineering~General programming languages</concept_desc>
%<concept_significance>500</concept_significance>
%</concept>
%<concept>
%<concept_id>10003456.10003457.10003521.10003525</concept_id>
%<concept_desc>Social and professional topics~History of programming languages</concept_desc>
%<concept_significance>300</concept_significance>
%</concept>
%</ccs2012>
%\end{CCSXML}
%
%\ccsdesc[500]{Software and its engineering~General programming languages}
%\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
%\keywords{keyword1, keyword2, keyword3}  %% \keywords is optional


\maketitle

{\color{blue} We should ask what, intuitively, it means to have
  parametricity for a calculus with GADTs. In particular it should
  mean that any polymorphic function that takes a GADT as input should
  operate uniformly over all type instances of the GADT. That means
  that the GADT must itself be ``parametric'', i.e., uniform in its
  type indices. But what does this mean? For ADTs and nested types it
  means that the datatype elements are constructed in exactly the same
  ways at each type instance. For GADTs, it means that as well. That
  is, we require related elements of a GADT to be constructed with the
  same sequence of constructors acting on related data. This entails
  that which instances are inhabited, as well as how the data in each
  of those instances are constructed, is type independent.}

\new{Locally presentable categories are the closest approximation to
  small complete categories. It's remarkable that local presentability
  is sufficient not just to give semantics to GADTs, but is also all
  that is needed to ensure that the model induced by that semantics is
  actually parametric.}

\new{Maybe develop our theory for {\em any} $\lambda \geq \omega$, and
  then specialize to $\omega_1$ (for $\omega$CPO) when discussing
  GADTs in future work? Can we do that? It seems we really use
  properties of $\oCPO$ to get that interpretations of $\Nat$-types
  are well-defined. It's not clear how to put $\omega$CPO structures
  on the interpretations of $\Lan$-types.}

\section{The Calculus}

\subsection{Types}\label{sec:types}

For each $k \ge 0$, we assume countable sets $\tvars^k$ of \emph{type
  constructor variables of arity $k$} and $\fvars^k$ of
\emph{functorial variables of arity $k$}, all mutually disjoint.
%disjoint for distinct $k$ and disjoint from each other.
The sets of all type constructor variables and functorial variables
are $\tvars = \bigcup_{k \ge 0} \tvars^k$ and $\fvars = \bigcup_{k \ge
  0} \fvars^k$, respectively, and a \emph{type variable} is any
element of $\tvars \cup \fvars$.  We use lower case Greek letters for
type variables, writing $\phi^k$ to indicate that $\phi \in \tvars^k
\cup \fvars^k$, and omitting the arity indicator $k$ when convenient,
unimportant, or clear from context. We reserve letters from the
beginning of the alphabet to denote type variables of arity $0$, i.e.,
elements of $\tvars^0 \cup \fvars^0$. We write $\overline{\zeta}$ for
either a set $\{\zeta_1,...,\zeta_n\}$ of type constructor variables
or a set of functorial variables when the cardinality $n$ of the set
is unimportant or clear from context. If $\Pos\,$ is a set of type
variables we write $\Pos, \overline{\phi}$ for $\Pos\, \cup
\overline{\phi}$ when $\Pos\, \cap \overline{\phi} = \emptyset$.  We
omit the vector notation for a singleton set, thus writing $\phi$,
instead of $\overline{\phi}$, for $\{\phi\}$.
\begin{dfn}
Let $V$ be a finite subset of\, $\tvars$, $\Pos$ be a finite
subset of\, $\fvars$, $\overline{\alpha}$ be a finite subset of\,
$\fvars^0$ disjoint from $\Pos$, and $\phi^k \in \fvars^k
\setminus \Pos$.  The set $\mcF^\Pos(V)$ of {\em functorial
  expressions} over $\Pos$ and $V$ are given by
\begin{align*}
  \mcF^\Pos(V) \; ::= \; 
  & \hspace*{0.15in}
\zerot \mid \onet 
\mid \Nat^\Pos \, \mcF^\Pos (V) \;
\mcF^\Pos (V) 
\mid \Pos\; \ol{\mcF^\Pos(V)}  \,
\mid V\, \ol{\mcF^\Pos(V)}  
\mid \mcF^{\Pos}(V) + \mcF^\Pos(V)\\
&\mid \mcF^{\Pos}(V) \times \mcF^\Pos(V) \mid \left(\mu
\phi^{~k}. \lambda \alpha_1...\alpha_k.  
\mcF^{\Pos,\alpha_1,...,\alpha_k,\phi}(V)\right)
\ol{\mcF^{\Pos}(V)}\\
&\mid (\Lan^{\ol\alpha}_{\ol{\F^{\ol\alpha}}} \F^{\Pos,\ol\alpha})\ol{\F^\Pos}
\end{align*}
\end{dfn}
\noindent
A \emph{type} over $\Pos$ and $V$ is any element of $\F^\Pos(V)$. The
difference with~\cite{jgj20} here lies solely in the incorporation of
functorial expressions constructed using $\Lan$.

The notation for types entails that an application $F F_1...F_k$ is
allowed only when $F$ is a type variable of arity $k$, or $F$ is a
subexpression of the form $\mu \phi^{k}.\lambda
\alpha_1...\alpha_k.F'$ or $\Lan^{\ol\alpha}_{\ol K}\, F'$. Moreover,
if $F$ has arity $k$ then $F$ must be applied to exactly $k$
arguments.  Accordingly, an overbar indicates a sequence of
subexpressions whose length matches the arity of the type applied to
it.  The fact that types are always in \emph{$\eta$-long normal form}
avoids having to consider $\beta$-conversion at the level of types. In
a subexpression $\Nat^\Phi F\,G$, the $\Nat$ operator binds all
occurrences of the variables in $\Phi$ in $F$ and $G$. Note that, by
contrast with~\cite{jgj20}, variables of arity greater than $0$ are
allowed in $\Phi$; this is necessary to construct well-typed terms of
$\Lan$ types. In a subexpression $\mu \phi^k.\lambda \ol{\alpha}.F$,
the $\mu$ operator binds all occurrences of the variable $\phi$, and
the $\lambda$ operator binds all occurrences of the variables in
$\ol{\alpha}$, in the body $F$. And in a subexpression
$(\Lan^{\ol\alpha}_{\ol K}\, F)\ol A$, the $\Lan$ operator binds all
occurrences of the variables in $\ol\alpha$ in every element of $\ol
K$, as well as in $F$.

A {\em type constructor context} is a finite set $\Gamma$ of type
constructor variables, and a {\em functorial context} is a finite set
$\Phi$ of functorial variables. In Definition~\ref{def:wftypes}, a
judgment of the form $\Gamma;\Phi \vdash F$ indicates that the
type $F$ is intended to be functorial in the variables in $\Phi$
but not necessarily in those in $\Gamma$.

\begin{dfn}\label{def:wftypes}
The formation rules for the set $\F \subseteq \bigcup_{V \subseteq
  \tvars, \Pos\, \subseteq \fvars}\F^\Pos(V)$ of\, {\em well-formed
  types} are

\[\begin{array}{cc}
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \zerot$}
\DisplayProof
&
\AXC{\phantom{$\Gamma,\Phi$}}
\UIC{$\Gamma;\Phi \vdash \onet$}
\DisplayProof
\end{array}\]

\vspace*{0.1in}

\[\begin{array}{cc}
\AXC{$\Gamma;\Phi \vdash F$}
\AXC{$\Gamma;\Phi \vdash G$}
\BIC{$\Gamma; \Phi \vdash F + G$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \vdash F$}
\AXC{$\Gamma;\Phi \vdash G$}
\BIC{$\Gamma; \Phi \vdash F \times G$}
\DisplayProof
\end{array}\]

\vspace*{0.05in}

\[\begin{array}{c}
\AXC{$\Gamma;\Phi \vdash F$}
\AXC{$\Gamma;\Phi  \vdash G$}
\BIC{$\Gamma;\emptyset \vdash \Nat^\Phi F \,G$}
\DisplayProof
\\[4ex]
\AXC{$\phi^k \in \Gamma \cup \Phi$}
\AXC{$\quad\quad\ol{\Gamma;\Phi \vdash F}$}
\BIC{$\Gamma;\Phi \vdash \phi^k \ol{F}$}
\DisplayProof
\\[3ex]
\AXC{$\Gamma;\ol{\gamma^0},\ol{\alpha^0},\phi^k \vdash F$}
\AXC{$\quad\quad\ol{\Gamma;\Phi,\ol{\gamma^0} \vdash G}$}
\BIC{$\Gamma;\Phi,\ol{\gamma^0} \vdash (\mu \phi^k.\lambda
  \ol{\alpha^0}. \,F)\,\ol{G}$} 
\DisplayProof
\\[5ex]
\AXC{$\Gamma; \Phi,\ol\alpha^0 \vdash F$}
\AXC{$\ol{\Gamma;\ol\alpha^0 \vdash K}$}
\AXC{$\ol{\Gamma;\Phi \vdash A}$}
\TIC{$\Gamma;\Phi \vdash (\Lan^{\ol{\alpha^0}}_{\ol K} F)\, \ol A$}
\DisplayProof
\end{array}\]
\end{dfn}

In addition to textual replacement, we also have a proper substitution
operation on types. If $F$ is a type over $P$ and $V$, if $\Pos$
and $V$ contain only type variables of arity $0$, and if $k=0$ for
every occurrence of $\phi^k$ bound by $\mu$ in $F$, then we say
that $F$ is {\em first-order}; otherwise we say that $F$ is {\em
  second-order}.  Substitution for first-order types is the usual
capture-avoiding textual substitution. We write $F[\alpha :=
  \sigma]$ for the result of substituting $\sigma$ for $\alpha$ in
$F$, and $F[\alpha_1 := F_1,...,\alpha_k := F_k]$, or
$F[\ol{\alpha := F}]$ when convenient, for $F[\alpha_1 :=
  F_1][\alpha_2 := F_2,...,\alpha_k := F_k]$. Substitution
for second-order types is defined below, where we adopt a similar
notational convention for vectors of types. Note that it is not
correct to substitute along non-functorial variables.

\begin{dfn}\label{def:second-order-subst}
If \,$\Gamma; \Phi,\phi^k \vdash H$
%with $k \geq 1$,
and if\, $\Gamma;\Phi, \ol{\alpha} \vdash F$ with
$|\ol\alpha| = k$, then $\Gamma;\Phi \vdash H[\phi :=_{\ol{\alpha}}
  F]$.  Similarly, if \,$\Gamma, \phi^k; \Phi \vdash H$,
%with $k \geq 1$,
and if\, $\Gamma; \ol\psi,\ol{\alpha} \vdash F$ with $|\ol\alpha| = k$
and $\Phi \cap \ol\psi = \emptyset$, then $\Gamma,\ol\psi';\Phi \vdash
H[\phi :=_{\ol{\alpha}} F[\ol{\psi :== \psi'}]]$. Here, the operation
  $(\cdot)[\phi :=_{\ol \alpha} F]$ of {\em second-order type
    substitution along $\ol\alpha$} is defined by:
\[\begin{array}{lll}
\zerot[\phi :=_{\ol{\alpha}} F] & = & \zerot\\[0.5ex]
\onet[\phi :=_{\ol{\alpha}} F] & = & \onet\\[0.25ex]
(\Nat^{\ol\beta} G \,K)[\phi :=_{\ol{\alpha}} F]
& = & \Nat^{\ol\beta}\, (G[\phi :=_{\ol{\alpha}} F]) \,(K[\phi
  :=_{\ol{\alpha}} F])\\
(\psi\ol{G})[\phi :=_{\ol{\alpha}} F] & = &
\left\{\begin{array}{ll}
\psi \,\ol{G[\phi :=_{\ol{\alpha}} F]} & \mbox{if } \psi \not = \phi\\
  F[\ol{\alpha  := G[\phi :=_{\ol{\alpha}} F]}] 
  & \mbox{if } \psi = \phi
\end{array}\right.\\[2.8ex]
(G + K)[\phi :=_{\ol{\alpha}} F] & = & G[\phi
  :=_{\ol{\alpha}} F] + K[\phi :=_{\ol{\alpha}} F]\\[0.5ex] 
(G \times K)[\phi :=_{\ol{\alpha}} F] & = &
G[\phi :=_{\ol{\alpha}} F] \times K[\phi
  :=_{\ol{\alpha}} F]\\[0.5ex]   
((\mu \psi. \lambda \ol{\beta}.\, G)\ol{K})[\phi :=_{\ol{\alpha}}
  F] & = & (\mu \psi. \lambda \ol{\beta}. \,G[\phi :=_{\ol{\alpha}}
  F])\, \ol{K[\phi :=_{\ol{\alpha}} F]}\\[0.5ex]
((\Lan^{\ol{\beta}}_{\ol H}\, G)\ol{K})[\phi :=_{\ol{\alpha}}
  F] & = & (\Lan^{\ol\beta}_{\ol H} \,G[\phi :=_{\ol{\alpha}}
  F])\, \ol{K[\phi :=_{\ol{\alpha}} F]}
\end{array}\]
\end{dfn}
\noindent
We note that $(\cdot)[\phi^0 :=_\emptyset F]$ coincides with
first-order substitution. We also omit $\ol\alpha$ when convenient.

\subsection{Terms}\label{sec:terms}

We now define our term calculus. To do so we assume an infinite set
$\cal V$ of term variables disjoint from $\tvars$ and $\fvars$. If
$\Gamma$ is a type constructor context and $\Phi$ is a functorial
context, then a {\em term context for $\Gamma$ and $\Phi$} is a finite
set of bindings of the form $x : F$, where $x \in {\cal V}$ and
$\Gamma; \Phi \vdash F$. We adopt the same conventions for denoting
disjoint unions and for vectors in term contexts as for type
constructor contexts and functorial contexts.

\begin{dfn}\label{def:well-formed-terms}
Let $\Delta$ be a term context for $\Gamma$ and $\Phi$.  The formation
rules for the set of\, {\em well-formed terms over $\Delta$} are
\[\begin{array}{ccc}
\AXC{$\Gamma;\Phi \vdash F$}
\UIC{$\Gamma;\Phi \,|\, \Delta,x :F \vdash x : F$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : \zerot$}
\AXC{$\Gamma;\Phi \vdash F$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash \bot_F t  : F$}
\DisplayProof
&
\AXC{$\phantom{\Gamma;\Phi}$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \top : \onet$}
\DisplayProof\\\\
\end{array}\]
\[\begin{array}{cc}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: F + G$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : G$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: F + G$}
\DisplayProof\\\\
\end{array}\]
\[\begin{array}{c}
\AXC{$\Gamma; \Phi \vdash F,G$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : F+G$}
\AXC{$\Gamma;\Phi \,|\, \Delta, x : F \vdash l : K \hspace{0.3in} \Gamma;\Phi \,|\, \Delta, y : G \vdash r : K$}
\TIC{$\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r} : K$}
\DisplayProof
\end{array}\]

\vspace*{0.05in}

\[\begin{array}{lll}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : G$}
\BIC{$\Gamma;\Phi \,|\, \Delta \vdash (s,t) : F \times G$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : F \times G$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : F$}
\DisplayProof
&
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash t : F \times G$}
\UIC{$\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : G$}
\DisplayProof
\end{array}\]

\vspace*{0.05in}

\[\begin{array}{c}
\AXC{$\Gamma; \Phi \vdash F$}
\AXC{$\Gamma; \Phi \vdash G$}
\AXC{$\Gamma; \Phi \,|\, \Delta, x : F \vdash t: G$} 
\TIC{$\Gamma; \emptyset
  \,|\, \Delta \vdash L_\Phi x.t : \Nat^\Phi \,F \,G$}
\DisplayProof
\\\\
\AXC{$\ol{\Gamma;\Phi,\ol\beta \vdash K}$}
\AXC{$\Gamma; \emptyset
  \,|\, \Delta \vdash t : \Nat^{\ol\psi} \,F \,G$}
\AXC{$\Gamma;\Phi \,|\, \Delta \vdash s: F[\overline{\psi :=_{\ol\beta} K}]$}
\TIC{$\Gamma;\Phi\,|\, \Delta \vdash t_{\ol K} s:
  G[\overline{\psi :=_{\ol\beta} K}]$}
\DisplayProof
\\\\
\AXC{$\Gamma; \Phi, \ol{\phi} \vdash H$}
\AXC{$\ol{\Gamma; \Phi,\ol{\beta} \vdash F}$}
\AXC{$\ol{\Gamma; \Phi,\ol{\beta} \vdash
    G}$}
\TIC{$\Gamma; \emptyset
  ~|~\emptyset
  \vdash \map^{\ol{F},\ol{G}}_H :
  \Nat^\emptyset\;(\ol{\Nat^{\Phi,\ol{\beta}}\,F\,G})\;
  (\Nat^\Phi\,H[\ol{\phi :=_{\ol{\beta}} F}]\;H[\ol{\phi
      :=_{\ol{\beta}} G}])$} 
\DisplayProof
\\\\
\AXC{$\Gamma; \Phi, \phi, \ol{\alpha} \vdash H$}
\UIC{$\Gamma; \emptyset  \,|\, \emptyset \vdash \tin_H :
  \Nat^{\Phi,\ol{\beta}} H[\phi :=_{\ol{\beta}} (\mu
    \phi.\lambda \ol{\alpha}.H)\ol{\beta}][\ol{\alpha := \beta}]\,(\mu
  \phi.\lambda \ol{\alpha}.H)\ol{\beta}$}
\DisplayProof
\\\\
\AXC{$\Gamma; \phi,\Phi,\ol{\alpha} \vdash H$}
\AXC{$\Gamma; \Phi, \ol{\beta} \vdash F$}
\BIC{$\Gamma; \emptyset  \,|\, \emptyset \vdash \fold^F_H :
  \Nat^\emptyset\; (\Nat^{\Phi,\ol{\beta}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F)\; (\Nat^{\Phi,\ol{\beta}}
    \,(\mu \phi.\lambda \ol{\alpha}.H)\ol{\beta}\,F)$}
\DisplayProof
\\\\
\AXC{$\Gamma; \Phi,\ol{\alpha}\vdash F$}
\AXC{$\ol{\Gamma; \ol{\alpha} \vdash K}$}
%\AXC{$\ol{\Gamma;\Phi \vdash A} \hspace*{0.3in} \Gamma;\Phi~|~\Delta \vdash t : F[\ol{\alpha :=A}]$}
\BIC{$\Gamma;\emptyset~|~\emptyset \vdash \int_{\ol K,F} :
\Nat^{\Phi,\ol\alpha}\,F\, (\Lan^{\ol\alpha}_{\ol K}\,  F)\ol{K}$}  
\DisplayProof
\\\\
\AXC{$\Gamma;\emptyset~|~\Delta \vdash \eta : \Nat^{\Phi,\ol\alpha}\,
  F\;G[\ol{\beta := K}]$}
%\AXC{$\ol{\Gamma;\Phi \vdash B}$}
%\AXC{$\Gamma;\Phi~|~\Delta \vdash t : (\Lan^{\ol\alpha}_{\ol K} F)\,\ol B $}
\UIC{$\Gamma;\emptyset~|~\Delta \vdash \partial^{G, \ol K}_F \eta :
\Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K} F)\ol \beta\; G$}
\DisplayProof
\end{array}\]
\end{dfn}

\vspace*{0.2in}

\new{Sum and product intro and elim rules should be annotated with
  constituent types for consistency?}

In the rule for $L_{\ol{\alpha}}x.t$, the $L$ operator binds all
occurrences of the type variables in $\ol{\alpha}$ in the type of the
term variable $x$ and in the body $t$, as well as all occurrences of
$x$ in $t$. In the rule for $t_{\ol K} s$ there is one functorial
expression in $\ol K$ for every functorial variable in $\ol
\alpha$. In the rule for $\map^{\ol{F},\ol{G}}_H$ there is one
functorial expression $F$ and one functorial expression $G$ for each
functorial variable in $\ol\phi$. Moreover, for each $\phi^k$ in
$\ol\phi$ the number of functorial variables in $\ol\beta$ in the
judgments for its corresponding functorial expresssions $F$ and $G$ is
$k$. In the rules for $\tin_H$ and $\fold^F_H$, the functorial
variables in $\ol{\beta}$ are fresh with respect to $H$, and there is
one $\beta$ for every $\alpha$. (Recall from above that, in order for
the types of $\tin_H$ and $\fold^F_H$ to be well-formed, the length of
$\alpha$ must equal the arity of $\phi$.) 

Substitution for terms is the obvious extension of the usual
capture-avoiding textual substitution, and
Definition~\ref{def:well-formed-terms} ensures that the expected
weakening rules for well-formed terms hold.

\vspace*{0.1in}

\new{We should have a computation rule along the lines of: If $\eta :
\Nat^{\ol\alpha} F \,G[\ol{\beta := K}]$ then
\[\begin{array}{ll}
& (\partial_F^{G,\ol K} \eta)_{\ol{K[\ol{\alpha := A}]}} \circ (\int_{K,F})_{\ol
  A}\; \rightarrow \; \eta_{\ol A}\\
: & F[\ol{\alpha := A}] \to G[\ol{\beta := K[\ol{\alpha :=A}]}]\\
= & F[\ol{\alpha := A}] \to G[\ol{\beta := K}][\ol{\alpha := A}]
\end{array}\]
This will appear as a computational property of the term
interpretations.}

\section{Interpreting Types}\label{sec:type-interp}

We denote the category of sets and functions by $\set$. The category
$\rel$ has as its objects triples $(A,B,R)$ where $R$ is a relation
between the objects $A$ and $B$ in $\set$, i.e., a subset of $A \times
B$, and has as its morphisms from $(A,B,R)$ to $(A',B',R')$ pairs $(f
: A \to A',g : B \to B')$ of morphisms in $\set$ such that $(f a,g\,b)
\in R'$ whenever $(a,b) \in R$. We write $R : \rel(A,B)$ in place of
$(A,B,R)$ when convenient.  If $R : \rel(A,B)$ we write $\pi_1 R$ and
$\pi_2 R$ for the {\em domain} $A$ of $R$ and the {\em codomain} $B$
of $R$, respectively.  If $A : \set$, then we write $\Eq_A =
(A,A,\{(x,x)~|~ x \in A\})$ for the {\em equality relation} on $A$.

The fundamental idea underlying Reynolds' parametricity is to give
each type $F(\alpha)$ with one free variable $\alpha$ both an {\em
  object interpretation} $F_0$ taking sets to sets and a
\emph{relational interpretation} $F_1$ taking relations $R :
\rel(A,B)$ to relations $F_1 (R) : \rel(F_0 (A), F_0 (B))$, and to
interpret each term $t(\alpha,x) : F(\alpha)$ with one free term
variable $x : G(\alpha)$ as a map $t_0$ associating to each set $A$ a
function $t_0(A) : G_0(A) \to F_0(A)$, and to each relation $R$ a
morphism $t_1(R) : G_1(R) \to F_1(R)$.  These interpretations are to
be given inductively on the structures of $F$ and $t$ in such a way
that they imply two fundamental theorems. The first is an
\emph{Identity Extension Lemma}, which states that $F_1(\Eq_A) =
\Eq_{F_0(A)}$, and is the essential property that makes a model
relationally parametric rather than just induced by a logical
relation. The second is an \emph{Abstraction Theorem}, which states
that, for any $R :\rel(A, B)$, $(t_0(A),t_0(B))$ is a morphism in
$\rel$ from $(G_0(A),G_0(B),G_1(R))$ to $(F_0(A),F_0(B),F_1(R))$. The
Identity Extension Lemma is similar to the Abstraction Theorem except
that it holds for {\em all} elements of a type's interpretation, not
just those that are interpretations of terms.  Similar theorems are
expected to hold for types and terms with any number of free
variables.

In the remainder of this section we first inductively define, for each
type, an object interpretation in $\set$ and a relational
interpretation in $\rel$. In Section~\ref{sec:iel} we show that these
interpretations satisfy both an Identity Extension Lemma
(Theorem~\ref{thm:iel}) and an Abstraction Theorem
(Theorem~\ref{thm:gen-at}) appropriate to the GADT setting. The key to
proving our Identity Extension Lemma is a familiar ``cutting down'' of
the interpretations of universally quantified types to include only
the ``parametric'' elements; the relevant types of the calculus
defined above are the $\Nat$-types (which are now richer than those
of~\cite{jgj20}) and the $\Lan$-types. The requisite cutting down
requires that the object interpretations of our types in $\set$ are
defined simultaneously with their relational interpretations in
$\rel$. We give the object interpretations for our types in
Section~\ref{sec:obj-interp} and give their relational interpretations
in Section~\ref{sec:rel-interp}.  While the former are relatively
straightforward, the latter are less so because of the delicacy of
interpreting the $\Lan$-types. (The object and relational
interpretations of $\Lan$-types are not defined in the same
``parallel'' way, as are the two interpretations of the other types.)
Another subtle point is guaranteeing the cocontinuity conditions,
adapted to our richer setting from~\cite{jgj20}, that must hold if the
type interpretations are to be well-defined. We develop these
conditions in Section~\ref{sec:rel-interp}, which separates
Definitions~\ref{def:set-sem} and~\ref{def:rel-sem} in space, but
otherwise has no impact on the fact that these definitions are given
by mutual induction.

\subsection{Preliminaries}

\new{WHERE DOES THIS ALL GO? Must explain $\Lan$s, say why they are
  functors, say they can be computed using colimits in $\set$ and
  $\rel$, define injections, etc. If $f : B \to B'$ in $\set$, then
  the functorial action of $\mathit{Lan}_{\ol K}\,F$ on $f$ is the
  unique morphism $(\mathit{Lan}_{\ol K}\,F)f$ such that
  \begin{equation}\label{def:functorial-action-lan}
(\mathit{Lan}_{\ol K}\,F)f \circ \iota_{X,g} = \iota'_{X, f \circ
      g}~~~MISSING~SOME~BARS
\end{equation}
Here, $\iota_{X,g}$ is the injection of $FX$ into $(\mathit{Lan}_{\ol
  K}\,F)\,B = \colim{X : \set_0,\, g : KX \to B}{FX}$ and
$\iota'_{X,g'}$ is the injection of $FX$ into $(\mathit{Lan}_{\ol
  K}\,F)\,B' = \colim{X : \set_0,\, g' : KX \to B'}{FX}$.
**Say somewhere that recognizing the non-parallel nature of the Lan
interps, and yet still being able to define the set and rel interps so
that everything is intertwined in exactly the right way to make the
proofs (e.g., of the IEL) work, is what's hard here. This is where the
insight is required.**}

\subsection{Object Interpretations of Types}\label{sec:obj-interp}

The object interpretations of the types in our calculus will be
$\omega$-cocontinuous functors between categories of
$\omega$-cocontinuous functors between categories constructed from the
locally finitely presentable category $\set$~\cite{ar94}; the
relational interpretations will be similar for the locally finitely
presentable category $\rel$. The fact that functor categories of
locally finitely presentable categories are again locally finitely
presentable ensures that the fixpoints interpreting $\mu$-types in
$\set$ and $\rel$ exist, and thus that both the set and relational
interpretations of all of the types in Definition~\ref{def:wftypes}
are well-defined~\cite{jp19}.

To define the interpretations of the types in
Definition~\ref{def:wftypes} we must first interpret their variables.
Writing $[\C,\D]$ for the category of $\omega$-cocontinuous functors
from $\C$ to $\D$ for the locally finitely presentable categories $\C$
and $\D$, for our $\set$ interpretations we have:

{\color{red} We need to restrict set and relational environments to
  $\set_0$ and $\rel_0$ for interps of $\Lan$-types and -terms, and
  note that this is OK because these are our presentable objects, all
  (other) objects can be written as $\omega$-directed colimits of
  presentables, and our interpretations are $\omega$-cocontinuous and
  therefore preserve $\omega$-directed colimits. Say once here, and
  then just use throughout.}
  
\begin{dfn}\label{def:set-env}
A {\em $\set$ environment} maps each type variable in $\tvars^k \cup
\fvars^k$ to an element of\, $[\oCPO^k,\oCPO]$. A morphism $f : \rho
\to \rho'$ for set environments $\rho$ and $\rho'$ with $\rho|_\tvars
= \rho'|_\tvars$ maps each type constructor variable $\psi^k \in
\tvars$ to the identity natural transformation on $\rho \psi^k =
\rho'\psi^k$ and each functorial variable $\phi^k \in \fvars$ to a
natural transformation from the $k$-ary functor $\rho \phi^k$ on
$\oCPO$ to the $k$-ary functor $\rho' \phi^k$ on $\oCPO$.  Composition
of morphisms on set environments is given componentwise, with the
identity morphism mapping each set environment to itself. This gives a
category of set environments and morphisms between them, which we
denote $\oCPOenv$.
\end{dfn}

When convenient we identify a functor in $[\oCPO^0, \oCPO]$ with its
value on $\ast$ and consider a $\oCPO$ environment to map a type
variable of arity $0$ to an $\omega$-cocontinuous functor from
$\oCPO^0$ to $\oCPO$, i.e., to an $\oCPO$. If $\Phi =
\{\phi_1^{k_1},...,\phi_n^{k_n}\}$ and $\ol K = \{K_1,...,K_n\}$ where
$K_i : [\oCPO^{k_i},\oCPO]_{\omega}$ for $i = 1,...,n$, then we write
$\rho[\Phi := \ol K]$ for the $\oCPO$ environment $\rho'$ such that
$\rho' \phi_i = K_i$ for $i = 1,...,n$ and $\rho' \phi = \rho \phi$ if
$\phi \not \in \Phi$.  If $\rho$ is an $\oCPO$ environment, we write
$\Eq_\rho$ for the $\oCPOR$ environment (see
Definition~\ref{def:reln-env}) such that $\Eq_\rho v = \Eq_{\rho v}$
for every type variable $v$. The categories $\oCPORT_k$ and relational
interpretations appearing in the third clause of
Definition~\ref{def:set-sem} are given in full in
Section~\ref{sec:rel-interp}. 

\begin{dfn}\label{def:set-sem}
The {\em object interpretation} $\oCPOsem{\cdot} : \F \to [\oCPOenv,
  \oCPO]$ is defined by
\begin{align*}
  \oCPOsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \oCPOsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
  \oCPOsem{\Gamma; \emptyset
    \vdash \Nat^\Phi
    \,F\,G}\rho &= \{\eta : \lambda \ol{K}. \,\oCPOsem{\Gamma;
    \Phi \vdash
    F}\rho[\Phi := \ol K] 
      \Rightarrow \lambda \ol{K}.\,\oCPOsem{\Gamma; 
        \Phi \vdash G}\rho[\Phi := \ol K] \\ 
      &\hspace{0.3in}|~\forall \ol{K = (K^1, K^2, K^*) : \oCPORT_k}.\\
      &\hspace{0.4in}(\eta_{\overline{K^1}}, \eta_{\overline{K^2}})
      : \oCPORsem{\Gamma; \Phi \vdash F}\Eq_{\rho}[\Phi := \ol K]
      \rightarrow \oCPORsem{\Gamma; \Phi \vdash
        G}\Eq_{\rho}[\Phi := \ol K] \} \\
  \oCPOsem{\Gamma;\Phi \vdash \phi\ol{F}}\rho &=
  (\rho\phi)\,\ol{\oCPOsem{\Gamma;\Phi \vdash
    F}\rho}\\
  \oCPOsem{\Gamma;\Phi \vdash F+G}\rho &=
  \oCPOsem{\Gamma;\Phi \vdash F}\rho +
  \oCPOsem{\Gamma;\Phi \vdash G}\rho\\
  \oCPOsem{\Gamma;\Phi \vdash F \times G}\rho &=
  \oCPOsem{\Gamma;\Phi \vdash F}\rho \times
  \oCPOsem{\Gamma;\Phi \vdash G}\rho\\ 
  \oCPOsem{\Gamma;\Phi,\ol\gamma \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{G}}\rho &= (\mu
    T^\oCPO_{H,\rho})\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho}\\
    \text{where } T^\oCPO_{H,\rho}\,F & = \lambda
  \ol{A}. \oCPOsem{\Gamma;\ol\gamma,\phi, \ol{\alpha} \vdash
    H}\rho[\phi :=  F][\ol{\alpha := A}]\\
  \text{and } T^\oCPO_{H,\rho}\,\eta &= \lambda
  \ol{A}. \oCPOsem{\Gamma;\ol\gamma,\phi, \ol{\alpha} \vdash
    H}\id_\rho[\phi := \eta][\ol{\alpha := \id_{A}}] \\
  \oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}\rho &=
    \{ t : (\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash
          K}\rho[\ol{\alpha := \_}]}} \oCPOsem{\Gamma; \Phi, \ol\alpha
      \vdash F}\rho[\ol{\alpha := \_}]) \ol{\oCPOsem{\Gamma; \Phi
        \vdash A}\rho}\\
    &\hspace{0.3in}|~(t,t) \in \oCPORsem{\Gamma;\Phi \vdash
      (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}\Eq_\rho\}\\
\end{align*}
\end{dfn}

\vspace*{0.1in}

If $\rho : \oCPOenv$ and $\vdash F$ then we write $\oCPOsem{\vdash
  F}$ instead of $\oCPOsem{\vdash F}\rho$ since the environment is
immaterial. To know that Definition~\ref{def:set-sem} is
well-defined we have to check that each object interpretation is in
$\set$. First, we have
\begin{lemma}\label{lem:nat-types-sets}
The collection of all natural transformations 
\[
\eta : \lambda \ol K. \setsem{\Gamma;\Phi \vdash F}\rho[\Phi := \ol{K}]
\Rightarrow \lambda \ol K. \setsem{\Gamma;\Phi \vdash G}\rho[\Phi :=
  \ol{K}]
\]
defines a set.
\end{lemma}
\begin{proof}
We first note that $\lambda \ol K. \setsem{\Gamma;\Phi \vdash
  F}\rho[\Phi := \ol{K}]$ and $\lambda \ol K. \setsem{\Gamma;\Phi
  \vdash G}\rho[\Phi := \ol{K}]$ are both in $[\ol{[\oCPO^k , \oCPO]},
  \oCPO]$. Since $[\ol{[\oCPO^k , \oCPO]}, \oCPO]$ is locally finitely
presentable it is locally small. There are therefore only $\set$-many
morphisms (i.e., natural transformations) between any two functors in
$[\ol{[\oCPO^k , \oCPO]}, \oCPO]$. In particular, there are only
$\set$-many natural transformations from $\lambda \ol
K. \setsem{\Gamma;\Phi \vdash F}\rho[\Phi := \ol{K}]$ to $\lambda \ol
K. \setsem{\Gamma;\Phi \vdash G}\rho[\Phi := \ol{K}]$.
\end{proof}
\noindent
Moreover, for any $\rho : \setenv$ we have that $\oCPOsem{\Gamma;
  \emptyset \vdash \Nat^\Phi F\,G}\rho$ is an $\omega$-cocontinuous
functor because it is a constant functor.  Interpretations of
$\Nat$-types ensure that $\oCPOsem{\Gamma \vdash F \to G}\rho$ and
$\oCPOsem{\Gamma \vdash \forall \ol\alpha. F}\rho$ are as expected in
any parametric model.

To make sense of the penultimate clause of
Definition~\ref{def:set-sem}, we need to know that, for each $\rho :
\oCPOenv$, $T^\oCPO_{H,\rho}$ is an $\omega$-cocontinuous endofunctor
on $[\oCPO^k, \oCPO]$, and thus admits a fixpoint.  Since
$T_{H,\rho}^\oCPO$ is defined in terms of
$\oCPOsem{\Gamma;\ol\gamma,\phi, \ol{\alpha} \vdash H}$, this means
that interpretations of types must be such functors, which in turn
means that the actions of set interpretations of types on the objects
and morphisms in $\oCPOenv$ are intertwined. Fortunately, we know
from~\cite{jp19} that, for every $\Gamma; \ol\alpha \vdash F$,
$\oCPOsem{\Gamma; \Phi \vdash F}$ is actually in $[\oCPO^k,\oCPO]$,
where $k = |\ol\alpha|$.  Therefore, for each $\oCPOsem{\Gamma;
  \ol\gamma, \phi^k, \ol{\alpha} \vdash H}$, the corresponding
operator $T^\oCPO_{H}$ can be extended to a {\em functor} from
$\oCPOenv$ to $[[\oCPO^k,\oCPO],[\oCPO^k,\oCPO]]$.  The action of
$T^\oCPO_H$ on an object $\rho : \oCPOenv$ is given by the
higher-order functor $T_{H,\rho}^\oCPO$, whose actions on objects
(i.e., functors in $[\oCPO^k, \oCPO]$) and on morphisms (natural
transformations between such functors) are given in the penultimate
clause of Definition~\ref{def:set-sem}. The action of $T^\oCPO_H$ on a
morphism $f : \rho \to \rho'$ is the higher-order natural
transformation $T^\oCPO_{H,f} : T^\oCPO_{H,\rho} \to
T^\oCPO_{H,\rho'}$ whose action on $F : [\oCPO^k,\oCPO]$ is the
natural transformation $T^\oCPO_{H,f}\, F : T^\oCPO_{H,\rho}\,F \to
T^\oCPO_{H,\rho'}\,F$ whose component at $\ol A$ is given by
$(T^\oCPO_{H,f}\, F)_{\ol A} = \oCPOsem{\Gamma;
  \ol\gamma,\phi,\ol{\alpha} \vdash H}f[\phi := \id_F][\ol{\alpha :=
    \id_A}]$.

Finally, to make sense of the final clause
Definition~\ref{def:set-sem}, we first observe that, for any $\rho :
\setenv$, $\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash
      K}\rho[\ol{\alpha := \_}]}} \oCPOsem{\Gamma; \Phi, \ol\alpha
  \vdash F}\rho[\ol{\alpha := \_}]$ is a functor from $\set^m$ to
$\set$ for some $m$. This ensures that
$(\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash
      K}\rho[\ol{\alpha := \_}]}} \oCPOsem{\Gamma; \Phi, \ol\alpha
  \vdash F}\rho[\ol{\alpha := \_}]) \ol{\oCPOsem{\Gamma; \Phi \vdash
    A}\rho}$ is a set.  Moreover, for any $\rho : \setenv$, the fact
that $\oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
  F)\ol{A}}\rho$ is an $\omega$-cocontinuous functor follows from
Corollary~12 of~\cite{jp19} provided each functor in
$\ol{\setsem{\Gamma; \ol\alpha \vdash K}}$ is polynomial in the
variables in $\ol\alpha$. We also note that, for each vector of
functors $\ol K$, $\textit{Lan}_{\ol K}$ is itself a (higher-order)
functor. Specifically, given functors $F, F' : \C \to \D$, a sequence
of functors $\ol K = K_1, ..., K_n$ with $K_i : \C \to \C_i$ for $i =
1,...,n$, and a natural transformation $\alpha : F \to F'$, the
functorial action $\textit{Lan}_{\ol K} \alpha : \textit{Lan}_{\ol K}
F \to \textit{Lan}_{\ol K} F'$ of $\mathit{Lan}_{\ol K}$ on $\alpha$
is defined to be the unique natural transformation such that
$((\textit{Lan}_{\ol K} \alpha) \,\circ \,\langle K_1,...,K_n \rangle)
\circ \eta_F = \eta_{F'} \,\circ\, \alpha$. Here, $\eta_F : F \to
(\textit{Lan}_{\ol K} F) \circ \langle K_1,...,K_n \rangle$ and
$\eta_{F'} : F' \to (\textit{Lan}_{\ol K} F') \circ \langle
K_1,...,K_n \rangle$ are the natural transformations associated with
the functors $\textit{Lan}_{\ol K} F$ and $\textit{Lan}_{\ol K} F'$
from $\Pi_{i \in \{1,...,n\}} \C_i$ to $\D$, respectively. In $\set$,
we have the slightly more general property
\begin{equation}\label{eq:ho-functorial-action-lan}
(\textit{Lan}_{\ol K}\, \alpha)\ol B \circ 
  \iota_{X,g} = \iota'_{X,g} \circ \alpha_X
\end{equation}
Here, $\iota_{X,g}$ is the injection of $FX$ into $\colim{X :
  \set_0,\,g : KX \to B}{FX}$ and $\iota'_{X,g}$ is the injection of
$F'X$ into $\colim{X : \set_0, \,g : KX \to B}{F'X}$.

The next definition uses the functors $T^\oCPO_H$ and
$\mathit{Lan}_{\ol K}$ to define the actions of functors interpreting
types on morphisms between set environments.

\begin{dfn}\label{def:set-sem-funcs}
Let $f: \rho \to \rho'$ be a morphism between $\oCPO$ environments $\rho$
and $\rho'$ (so that $\rho|_\tvars = \rho'|_\tvars$). The action
$\oCPOsem{\Gamma;\Phi \vdash F}f$ of\, $\oCPOsem{\Gamma;\Phi \vdash F}$
on the morphism $f$ is given as follows:
\begin{itemize}
\item If \,$\Gamma;\Phi \vdash \zerot$ then $\oCPOsem{\Gamma;\Phi \vdash
  \zerot}f = \id_0$
\item If \,$\Gamma;\Phi \vdash \onet$ then $\oCPOsem{\Gamma;\Phi \vdash
  \onet}f = \id_1$
\item If \,$\Gamma; \emptyset
  \vdash \Nat^\Phi F\,G$ then
  $\oCPOsem{\Gamma; \emptyset
    \vdash \Nat^\Phi F\,G} f =
  \id_{\oCPOsem{\Gamma; \emptyset
      \vdash \Nat^\Phi F\,G}\rho}$
\item If \,$\Gamma;\Phi \vdash \phi \ol{F}$ then
 \begin{multline*}
 \oCPOsem{\Gamma;\Phi \vdash \phi \ol{F}} f : \oCPOsem{\Gamma;\Phi
  \vdash \phi \ol{F}}\rho \to \oCPOsem{\Gamma;\Phi \vdash
  \phi\ol{F}}\rho' \\
  = (\rho\phi) \ol{\oCPOsem{\Gamma;\Phi \vdash
  F}\rho} \to (\rho'\phi) \ol{\oCPOsem{\Gamma;\Phi \vdash
  F}\rho'}
 \end{multline*}
  is defined by
  \[
  \begin{split}
  \oCPOsem{\Gamma;\Phi \vdash \phi \ol{F}} f
  &= (f\phi)_{\ol{\oCPOsem{\Gamma;\Phi \vdash
      F}\rho'}}\, \circ\, (\rho\phi) {\ol{\oCPOsem{\Gamma;\Phi
      \vdash F}f}} \\
  &= (\rho'\phi) {\ol{\oCPOsem{\Gamma;\Phi \vdash
      F}f}}\, \circ\, (f \phi)_{\ol{\oCPOsem{\Gamma;\Phi \vdash
      F}\rho}}
  \end{split}
  \]
  The latter equality holds because $\rho\phi$ and
  $\rho'\phi$ are functors and $f\phi : \rho\phi \to \rho'\phi$ is a
  natural transformation, so the following naturality square commutes:
{\footnotesize\begin{equation}\label{eq:cd2}
\begin{CD}
  (\rho\phi) \ol{\oCPOsem{\Gamma;\Phi \vdash F}\rho} @> (f\phi)_{
    \ol{\oCPOsem{\Gamma;\Phi \vdash F}\rho}} >> (\rho'\phi)
  \ol{\oCPOsem{\Gamma;\Phi \vdash F}\rho} \\ @V(\rho\phi)
  \ol{\oCPOsem{\Gamma;\Phi \vdash F}f}VV @V (\rho'\phi)
  \ol{\oCPOsem{\Gamma;\Phi \vdash F}f} VV \\ (\rho\phi)
  \ol{\oCPOsem{\Gamma;\Phi \vdash F}\rho'} @>(f\phi)_{
    \ol{\oCPOsem{\Gamma;\Phi \vdash F}\rho'}}>> (\rho'\phi)
  \ol{\oCPOsem{\Gamma;\Phi \vdash F}\rho'}
\end{CD}
\end{equation}}
\item If\, $\Gamma;\Phi \vdash F + G$ then $\oCPOsem{\Gamma;\Phi
  \vdash F + G}f$ is defined by
  \begin{align*}
  \oCPOsem{\Gamma;\Phi \vdash F + G}f(\inl\,x) 
  &= \inl\,(\oCPOsem{\Gamma;\Phi \vdash
  F}f x) \\
  \oCPOsem{\Gamma;\Phi \vdash F + G}f(\inr\,y)
  &= \inr\,(\oCPOsem{\Gamma;\Phi \vdash G}f y)
  \end{align*}
\item If \,$\Gamma;\Phi\vdash F \times G$ then
  $\oCPOsem{\Gamma;\Phi \vdash F \times G}f = 
  \oCPOsem{\Gamma;\Phi \vdash F}f \times \oCPOsem{\Gamma;\Phi \vdash
    G}f$
\item If \,$\Gamma;\Phi,\ol\gamma \vdash (\mu \phi.\lambda
  \ol{\alpha}. H)\ol{G}$ then
  \[\begin{array}{lll}
  \oCPOsem{\Gamma;\Phi,\ol\gamma \vdash (\mu  \phi.\lambda
    \ol{\alpha}. H)\ol{G}} f &: &\oCPOsem{\Gamma;\Phi,\ol\gamma 
    \vdash (\mu \phi.\lambda \ol{\alpha}. H)\ol{G}} \rho \to
  \oCPOsem{\Gamma;\Phi,\ol\gamma \vdash (\mu
    \phi.\lambda\ol{\alpha}. H)\ol{G}} \rho'\\
  &= &(\mu
  T^\oCPO_{H,\rho})\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho} \to (\mu
  T^\oCPO_{H,\rho'})\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho'}
  \end{array}\]
  is
  defined by
  \[\begin{array}{ll}
  & (\mu T^\oCPO_{H,f})_{\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash
      G}\rho'}} \circ (\mu T^\oCPO_{H,\rho})\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma
      \vdash G}f}\\[2ex] = & (\mu
  T^\oCPO_{H,\rho'})\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma 
      \vdash G}f} \circ (\mu T^\oCPO_{H,f})_{\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma
      \vdash G}\rho}}\end{array}\]  The latter equality holds because $\mu
  T^\oCPO_{H,\rho}$ and $\mu T^\oCPO_{H,\rho'}$ are functors and $\mu
  T_{H,f}^\oCPO : \mu T_{H,\rho}^\oCPO \to \mu T_{H,\rho'}^\oCPO$ is a
  natural transformation, so the following naturality square commutes:
{\footnotesize\begin{equation}\label{eq:cd3}
\begin{CD}
 (\mu T^\oCPO_{H,\rho}) \ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho} @> (\mu
  T^\oCPO_{H,f})_{\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho}} >> (\mu
  T^\oCPO_{H,\rho'}) \ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho} \\ 
 @V(\mu T^\oCPO_{H,\rho}) \ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}f}VV @V  (\mu
 T^\oCPO_{H,\rho'}) \ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}f} VV \\ 
(\mu T^\oCPO_{H,\rho}) \ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho'} @>(\mu
 T^\oCPO_{H,f})_{\ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho'}}>> (\mu
 T^\oCPO_{H,\rho'}) \ol{\oCPOsem{\Gamma;\Phi,\ol\gamma \vdash G}\rho'}
\end{CD}
\end{equation}}
\item If\, $\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}$ then
  \[\oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f
: \oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
    F)\ol{A}}\rho \to \oCPOsem{\Gamma;\Phi \vdash
    (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}\rho'\] is defined by
\[\begin{array}{ll}
 & \big(\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := \_}]}}\,
      \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}f[\ol{\alpha := \id_{\_}}]\big)
    \ol{\oCPOsem{\Gamma; \Phi \vdash A}\rho'} \\
 &  \circ\;
  \big(\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := \_}]}}\,
      \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho[\ol{\alpha := \_}]\big)
    \ol{\oCPOsem{\Gamma; \Phi \vdash A}f} \\
= & \big(\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := \_}]}}\,
      \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho'[\ol{\alpha := \_}]\big)
    \ol{\oCPOsem{\Gamma; \Phi \vdash A}f} \\
 &  \circ\;
  \big(\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := \_}]}}\,
      \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}f[\ol{\alpha := \id_{\_}}]\big)
    \ol{\oCPOsem{\Gamma; \Phi \vdash A}\rho}
\end{array}\]
where the above equality holds by naturality of
$\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash
        K}\rho[\ol{\alpha := \_}]}}\,\oCPOsem{\Gamma; \Phi, \ol\alpha
    \vdash F}f[\ol{\alpha := \id_{\_}}]$.
%(and functoriality of
%  $\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash
%        K}\rho[\ol{\alpha := \_}]}}$,
%  $\textit{Lan}_{\ol{\oCPOsem{\Gamma; \ol\alpha \vdash
%        K}\rho'[\ol{\alpha := \_}]}}$, and $\ol{\oCPOsem{\Gamma; \Phi
%      \vdash A}}$).
\end{itemize}
\end{dfn}

To see that the functorial action on $\Lan$ types is well-defined, we
need to check that it preserves the extra condition in the
interpretation of $\Lan$ types. That is, we need to show that if $t :
\oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}
\rho$, then $\oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
  F)\ol{A}}f t : \oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} \rho'$.  By definition, if $t
: \oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}
\rho$, then $(t, t) \in \oCPORsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} \Eq_{\rho}$, i.e., there
exist $\ol{Z : \oCPO_0}$, $t_1 : \oCPOsem{\Gamma; \Phi, \ol\alpha
  \vdash F}\rho[\ol{\alpha := Z}]$, $t_2 : \oCPOsem{\Gamma; \Phi,
  \ol\alpha \vdash F}\rho[\ol{\alpha := Z}]$, and $\ol{g :
  \oCPORsem{\Gamma; \ol{\alpha} \vdash K}\Eq_{\rho}[\ol{\alpha :=
      \Eq_Z}] \to \oCPORsem{\Gamma; \Phi \vdash A}\Eq_{\rho}}$ such
that $\iota_{\ol{Z}, \ol{\pi_1 g}}t_1 = t$, $\kappa_{\ol{Z}, \ol{\pi_2
    g}}t_2 = t$, and $(t_1,t_2) : \oCPORsem{\Gamma; \Phi, \ol\alpha
  \vdash F}\Eq_{\rho}[\ol{\alpha := \Eq_Z}]$, where $\iota$ and
$\kappa$ are as in the final clause of Definition~\ref{def:rel-sem}
below.  Now, to prove that $\oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f t : \oCPOsem{\Gamma;\Phi
  \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} \rho'$, let $\ol{Z' =
  Z}$, let $t'_i = \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F} f
[\ol{\alpha := \id_{Z}}] t_i$ for $i = 1, 2$, and let $\ol{g' =
  \oCPORsem{\Gamma; \Phi \vdash A}\Eq_f \circ g}$.  We have to show
that $\iota'_{\ol{Z'}, \ol{\pi_1 g'}}t'_1 = \oCPOsem{\Gamma;\Phi
  \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f t$,
$\kappa'_{\ol{Z'}, \ol{\pi_2 g'}}t'_2 = \oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f t$, and $(t_1',t_2') :
\oCPORsem{\Gamma; \Phi, \ol\alpha \vdash F}\Eq_{\rho'}[\ol{\alpha :=
    \Eq_{Z'}}]$, where $\iota'$ and $\kappa'$ are the injections for
$\rho'$ corresponding to $\iota$ and $\kappa$ for $\rho$. The latter
is immediate from the facts that $(t_1',t_2') = \oCPORsem{\Gamma;
  \Phi, \ol\alpha \vdash F} \Eq_f [\ol{\alpha := \id_{\Eq_{Z}}}] (t_1,
t_2)$ and $(t_1,t_2) : \oCPORsem{\Gamma; \Phi, \ol\alpha \vdash
  F}\Eq_{\rho}[\ol{\alpha := \Eq_Z}]$.  That $\iota'_{\ol{Z'},
  \ol{\pi_1 g'}}t'_1 = \oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f t$ is because
\[
\begin{array}{rl}
\iota'_{\ol{Z'}, \ol{\pi_1 g'}}t'_1
&= \iota'_{\ol{Z'}, \ol{\pi_1 g'}} (\oCPOsem{\Gamma; \Phi, \ol\alpha
  \vdash F} f [\ol{\alpha := \id_{Z}}] t_1) \\ 
&= \oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f
(\iota_{\ol{Z}, \ol{\pi_1 g}} t_1) \\ 
&= \oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f
t 
\end{array}
\]
where the second equality here is justified by the commutativity of
the following diagram, and $\iota''$ is the obvious injection
indicated:
\begin{equation}\label{cd:lan-comm}
\begin{tikzcd}[row sep = huge]
\oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho[\ol{\alpha := Z}]
  \ar[r, "{\iota_{\ol{Z}, \ol{\pi_1 g}}}"]
  \ar[d, "{\oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F} f [\ol{\alpha :=
          \id_Z}]}" description] 
&\colim{\ol{S}, \ol{h : \oCPOsem{\Gamma; \ol{\alpha} \vdash
        K}\rho[\ol{\alpha := S}] \to \oCPOsem{\Gamma; \Phi \vdash
        A}\rho}} {\oCPOsem{\Gamma; \Phi, \ol\alpha \vdash
      F}\rho[\ol{\alpha := S}]} 
  \ar[d, "{(\mathit{Lan}_{\ol{\oCPOsem{\Gamma; \ol{\alpha} \vdash
            K}\rho[\ol{\alpha := \_}]}} \oCPOsem{\Gamma; \Phi,
        \ol\alpha \vdash F}f[\ol{\alpha := \id_{\_}}])
      \ol{\oCPOsem{\Gamma; \Phi \vdash A}\rho}}" description] \\ 
\oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho'[\ol{\alpha := Z}]
  \ar[r, "{\iota''_{\ol{Z}, \ol{\pi_1 g}}}"]
  \ar[d, equal]
& \colim{\ol{S}, \ol{h : \oCPOsem{\Gamma; \ol{\alpha} \vdash
        K}\rho'[\ol{\alpha := S}] \to \oCPOsem{\Gamma; \Phi \vdash
        A}\rho}} 
{\oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho'[\ol{\alpha := S}]} 
  \ar[d, "{ (\mathit{Lan}_{\ol{\oCPOsem{\Gamma; \ol{\alpha} \vdash
            K}\rho[\ol{\alpha := \_}]}} \oCPOsem{\Gamma; \Phi,
        \ol\alpha \vdash F}\rho'[\ol{\alpha := \_}])
      \ol{\oCPOsem{\Gamma; \Phi \vdash A}f}}" description] \\ 
\oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho'[\ol{\alpha := Z}]
  \ar[r, shift right = 1, "{\iota'_{\ol{Z'}, \ol{\pi_1
          (\oCPORsem{\Gamma; \Phi \vdash A}\Eq_f \circ g)}}}"'] 
& \colim{\ol{S}, \ol{h : \oCPOsem{\Gamma; \ol{\alpha} \vdash
        K}\rho'[\ol{\alpha := S}] \to \oCPOsem{\Gamma; \Phi \vdash
        A}\rho'}} 
{\oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho'[\ol{\alpha := S}]} 
\end{tikzcd}
\end{equation}
Here, the top diagram commutes by the definition of the ``higher''
functorial action of $\mathit{Lan}_{\ol{\oCPOsem{\Gamma; \ol{\alpha}
      \vdash K}\rho[\ol{\alpha := \_}]}}$ on $\oCPOsem{\Gamma; \Phi,
  \ol\alpha \vdash F}f[\ol{\alpha := \id_{\_}}]$ as given
in~\eqref{eq:ho-functorial-action-lan}, and the bottom one commutes by
the definition of the functorial action of
$\mathit{Lan}_{\ol{\oCPOsem{\Gamma; \ol{\alpha} \vdash
      K}\rho[\ol{\alpha := \_}]}} \oCPOsem{\Gamma; \Phi, \ol\alpha
  \vdash F}\rho'[\ol{\alpha := \_}]$ on $\ol{\oCPOsem{\Gamma; \Phi
    \vdash A}f}$ as given in~\eqref{def:functorial-action-lan}.  The
proof that $\kappa_{Z,\pi_2 g'}t'_2 = \oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}f t$ is analogous.

Definitions~\ref{def:set-sem} and~\ref{def:set-sem-funcs} respect
weakening. That is, they ensure that a type and its weakenings all
have the same set interpretations.

\subsection{Relational Interpretations of Types}\label{sec:rel-interp}

\begin{dfn}\label{def:rel-transf}
A {\em $k$-ary relation transformer} $F$ is a triple $(F^1,
F^2,F^*)$, where $F^1,F^2 : [\oCPO^k,\oCPO]_{\omega}$ and $F^* :
[\oCPOR^k, \oCPOR]_{\omega}$ are such that if
$R_1:\oCPOR(A_1,B_1),...,R_k:\oCPOR(A_k,B_k)$ then $F^* \ol{R} :
\oCPOR(F^1 \ol{A}, F^2 \ol{B})$, and if $(\alpha_1, \beta_1) \in
\HomoCPOR(R_1,S_1),..., (\alpha_k, \beta_k) \in \HomoCPOR(R_k,S_k)$
then $F^* \ol{(\alpha, \beta)} = (F^1 \ol{\alpha}, F^2 \ol{\beta})$.
We define $F\ol{R}$ to be $F^*\overline{R}$ and
$F\overline{(\alpha,\beta)}$ to be $F^*\overline{(\alpha,\beta)}$.
\end{dfn}
The first condition of the first sentence of
Definition~\ref{def:rel-transf} entails that $F^*\ol R$ relates sups
of chains of pairwise related elements in $F^1 \ol A$ and $F^2 \ol
B$. The last condition of the first sentence of
Definition~\ref{def:rel-transf} expands to: if $\ol{(a,b) \in R}$
implies $\ol{(\alpha\,a,\beta\,b) \in S}$ then $(c,d) \in F^*\ol{R}$
implies $(F^1 \ol{\alpha}\,c,F^2 \ol{\beta}\,d) \in F^*\ol{S}$. When
convenient we identify a $0$-ary relation transformer $(A,B,R)$ with
$R : \oCPOR(A,B)$. We may also write $\pi_1 F$ for $F^1$ and $\pi_2 F$
for $F^2$. Without loss of generality, we assume that $\pi_1$ and
$\pi_2$ are surjective on relations. We extend these conventions to
$\oCPO$ relation environments, introduced in
Definition~\ref{def:reln-env} below, in the obvious way.

\begin{dfn}
The category $\oCPORT_k$ of $k$-ary relation transformers is
given by the following data:
\begin{itemize}
\item An object of $\oCPORT_k$ is a $k$-ary relation transformer.
\item A morphism $\delta : (G^1,G^2,G^*) \to (H^1,H^2,H^*)$ in
  $\oCPORT_k$ is a pair of natural transformations $(\delta^1,
  \delta^2)$, where $\delta^1 : G^1 \to H^1$ and $\delta^2 : G^2 \to
  H^2$ are such that, for all $\ol{R : \oCPOR(A, B)}$, if $(x, y) \in
  G^*\ol{R}$ then $(\delta^1_{\ol{A}}x, \delta^2_{\ol{B}}y) \in
  H^*\ol{R}$.
\item Identity morphisms and composition are inherited from the
  category of functors on $\oCPO$.
\end{itemize}
\end{dfn}

\begin{dfn}\label{def:RT-functor}
An endofunctor $H$ on $\oCPORT_k$ is a triple $H = (H^1,H^2,H^*)$, where
\begin{itemize}
\item $H^1$ and $H^2$ are functors from $[\oCPO^k,\oCPO]$ to $[\oCPO^k,\oCPO]$
\item $H^*$ is a functor from $\oCPORT_k$ to $[\oCPOR^k,\oCPOR]$
\item for all $\overline{R : \oCPOR(A,B)}$,
  $\pi_1((H^*(\delta^1,\delta^2))_{\overline{R}}) = (H^1
  \delta^1)_{\overline{A}}$ and
  $\pi_2((H^*(\delta^1,\delta^2))_{\overline{R}}) = (H^2
  \delta^2)_{\overline{B}}$
\item The action of $H$ on objects is given by $H\,(F^1,F^2,F^*) =
  (H^1F^1,\,H^2F^2,\,H^*(F^1,F^2,F^*))$
\item The action of $H$ on morphisms is given by
  $H\,(\delta^1,\delta^2) = (H^1\delta^1,H^2\delta^2)$ for
  $(\delta^1,\delta^2) : (F^1,F^2,F^*)\to (G^1,G^2,G^*)$
\end{itemize}
\end{dfn}
Since the results of applying an endofunctor $H$ to $k$-ary 
relation transformers and morphisms between them must again be $k$-ary
relation transformers and morphisms between them,
respectively, Definition~\ref{def:RT-functor} implicitly requires that
the following three conditions hold:\,{\em i}) if
$R_1:\oCPOR(A_1,B_1),...,R_k:\oCPOR(A_k,B_k)$, then $H^*(F^1,F^2,F^*)
\ol{R} : \oCPOR(H^1F^1 \ol{A}, H^2F^2 \ol{B})$; {\em ii}) if
$(\alpha_1, \beta_1) \in \HomoCPOR(R_1,S_1),..., (\alpha_k, \beta_k)
\in \HomoCPOR(R_k,S_k)$, then $H^*(F^1,F^2,F^*)\, \ol{(\alpha, \beta)}
= (H^1F^1\ol{\alpha}, H^2F^2 \ol{\beta})$; and {\em iii}) if
$(\delta^1,\delta^2) : (F^1,F^2,F^*)\to (G^1,G^2,G^*)$ and
$R_1:\oCPOR(A_1,B_1),...,R_k:\oCPOR(A_k,B_k)$, then
$((H^1\delta^1)_{\ol{A}}x, (H^2\delta^2)_{\ol{B}}y) \in
H^*(G^1,G^2,G^*)\ol{R}$ whenever $(x, y) \in
H^*(F^1,F^2,F^*)\ol{R}$. Note, however, that this last condition is
automatically satisfied because it is implied by the third bullet
point of Definition~\ref{def:RT-functor}.

\begin{dfn}\label{def:RT-nat-trans}
If $H$ and $K$ are endofunctors on $\oCPORT_k$, then a {\em natural
  transformation} $\sigma : H \to K$ is a pair $\sigma = (\sigma^1,
\sigma^2)$, where $\sigma^1 : H^1 \to K^1$ and $\sigma^2 : H^2 \to
K^2$ are natural transformations between endofunctors on
$[\oCPO^k,\oCPO]$ and the component of $\sigma$ at $F = (F^1,F^2,F^*)
\in \oCPORT_k$ is $\sigma_F = (\sigma^1_{F^1}, \sigma^2_{F^2})$.
\end{dfn}

Definition~\ref{def:RT-nat-trans} entails that $\sigma^i_{F^i}$ must
be natural in $F^i : [\oCPO^k,\oCPO]$, and, for every $F$,
$(\sigma^1_{F^1})_{\overline{A}}$ and
$(\sigma^2_{F^2})_{\overline{B}}$ must be natural in $\overline{A}$
and $\ol B$, respectively.  Moreover, since the results of applying
$\sigma$ to $k$-ary relation transformers must be morphisms of $k$-ary
relation transformers, Definition~\ref{def:RT-nat-trans} implicitly
requires that $(\sigma_F)_{\overline{R}} = (
(\sigma^1_{F^1})_{\overline{A}}, (\sigma^2_{F^2})_{\overline{B}})$ is
a morphism in $\oCPOR$ for any $k$-tuple of relations $\overline{R :
  \rel(A, B)}$, i.e., that if $(x, y) \in H^*F\overline{R}$, then
$((\sigma^1_{F^1})_{\overline{A}} x, (\sigma^2_{F^2})_{\overline{B}}
y) \in K^*F\overline{R}$.

Critically, we can compute $\omega$-directed colimits in $\oCPORT_k$:
it is not hard to see that if $\cal D$ is an $\omega$-directed set
then $\colim{d \in {\cal D}}{(F^1_d, F^2_d,F^*_d)} = (\colim{d \in
  {\cal D}}{F^1_d}, \colim{d \in {\cal D}}{F^2_d}, \colim{d \in {\cal
    D}}{F^*_d})$.  We define an endofunctor $T = (T^1,T^2,T^*)$ on
$\oCPORT_k$ to be {\em $\omega$-cocontinuous} if $T^1$ and $T^2$ are
$\omega$-cocontinuous endofunctors on $[\oCPO^k,\oCPO]$ and $T^*$ is
an $\omega$-cocontinuous functor from $\oCPORT_k$ to
$[\oCPOR^k,\oCPOR]$, i.e., is in $[\oCPORT_k,[\oCPOR^k,\oCPOR]]$.

Now, for any $k$, any $A : \oCPO$, and any $R : \oCPOR(A, B)$, let
$K^\oCPO_A$ be the constantly $A$-valued functor from $\oCPO^k$ to
$\oCPO$ and $K^\oCPOR_R$ be the constantly $R$-valued functor from
$\oCPOR^k$ to $\oCPOR$.  Also let $0$ denote either the initial object
of $\oCPO$ or the initial object of $\oCPOR$, as appropriate.
Observing that, for every $k$, $K^\oCPO_0$ is initial in
$[\oCPO^k,\oCPO]$, and $K^\oCPOR_0$ is initial in $[\oCPOR^k,\oCPOR]$,
we have that, for each $k$, $K_0 = (K^\oCPO_0,K^\oCPO_0,K^\oCPOR_0)$
is initial in $\oCPORT_k$. Thus, if $T = (T^1,T^2,T^*) : \oCPORT_k \to
\oCPORT_k$ is an endofunctor on $\oCPORT_k$ then we can define the
relation transformer $\mu T$ to be $\colim{i < \omega}{T^i K_0}$. It
is not hard to see that $\mu T$ is given explicitly as
\begin{equation}\label{eq:mu}
  \mu T = (\mu T^1,\mu T^2,
\colim{i < \omega}{(T^iK_0)^*})
\end{equation}
and that, as our notation suggests, it really is a fixpoint for $T$ if
$T$ is $\omega$-cocontinuous:
\begin{lemma}\label{lem:fp}
For any $T : [\oCPORT_k,\oCPORT_k]$, $\mu T \cong T(\mu T)$.
\end{lemma}
\noindent
The isomorphism is given by the morphisms $(\mathit{in}_1,
\mathit{in}_2) : T(\mu T) \to \mu T$ and $(in_1^{-1}, in_2^{-1}) : \mu
T \to T(\mu T)$ in $\oCPORT_k$. The latter is always a morphism in $\oCPORT_k$,
but the former need not be if $T$ is not $\omega$-cocontinuous.

It is worth noting that the third component in Equation~(\ref{eq:mu})
is the colimit in $[\oCPOR^k,\oCPOR]$ of third components of relation
transformers, rather than a fixpoint of an endofunctor on
$[\oCPO^k,\oCPO]$. That there is an asymmetry between the first two
components of $\mu T$ and its third reflects the important conceptual
observation that the third component of an endofunctor on $\oCPORT_k$
need not be a functor on all of $[\oCPOR^k,\oCPOR]$. In particular,
although we can define $T_{H,\rho}\, F$ for a relation transformer $F$
in Definition~\ref{def:rel-sem} below, it is not clear how we could
define it for an arbitrary $F : [\oCPOR^k,\oCPOR]$.

\begin{dfn}\label{def:reln-env}
An {\em $\oCPO$ relation environment} maps each type variable in
$\tvars^k \cup \fvars^k$ to a $k$-ary relation
transformer.  A morphism $f : \rho \to \rho'$ between $\oCPO$
relation environments $\rho$ and $\rho'$ with $\rho|_\tvars =
\rho'|_\tvars$ maps each type constructor variable $\psi^k \in \tvars$
to the identity morphism on $\rho \psi^k = \rho' \psi^k$ and each
functorial variable $\phi^k \in \fvars$ to a morphism from the $k$-ary
relation transformer $\rho \phi$ to the $k$-ary
relation transformer $\rho' \phi$. Composition of
morphisms on $\oCPO$ relation environments is given
componentwise, with the identity morphism mapping each $\oCPO$
relation environment to itself. This gives a category of $\oCPO$
relation environments and morphisms between them, which we denote
$\oCPORenv$.
\end{dfn}

When convenient we identify a $0$-ary relation transformer with the
$\oCPO$ relation (transformer) that is its codomain and consider an
$\oCPO$ relation environment to map a type variable of arity $0$ to an
$\oCPO$ relation. If $\Phi = \{\phi_1^{k_1},...,\phi_n^{k_n}\}$ and
$\ol K = \{K_1,...,K_n\}$ where $K_i : [\oCPOR^{k_i},\oCPOR]$ for $i =
1,...,n$, then we write either $\rho[\ol{\Phi := K}]$ or
$\rho[\ol{\phi := K}]$ for the $\oCPO$ relation environment $\rho'$
such that $\rho' \phi_i = K_i$ for $i = 1,...,n$ and $\rho' \phi =
\rho \phi$ if $\phi \not \in \Phi$. If $\rho$ is an $\oCPO$ relation
environment, we write $\pi_1 \rho$ and $\pi_2 \rho$ for the $\oCPO$
relation environments mapping each type variable $\phi$ to the
functors $(\rho\phi)^1$ and $(\rho\phi)^2$, respectively.

We define, for each $k$, the notion of an $\omega$-cocontinuous
functor from $\oCPORenv$ to $\oCPORT_k$:
\begin{dfn}\label{def:relenv-functor}
A functor $H : [\oCPORenv, \oCPORT_k]$ is a triple $H =
(H^1,H^2,H^*)$, where
\begin{itemize}
\item $H^1$ and $H^2$ are objects in
  $[\oCPOenv,[\oCPO^k,\oCPO]]$
\item $H^*$ is a an object in $[\oCPORenv,[\oCPOR^k,\oCPOR]]$
\item for all $\overline{R : \oCPOR(A,B)}$ and morphisms $f$ in
  $\oCPORenv$, $\pi_1((H^*f)_{\overline{R}}) = (H^1 (\pi_1
  f))_{\overline{A}}$ and $\pi_2((H^*f)_{\overline{R}}) = (H^2 (\pi_2
  f))_{\overline{B}}$
\item The action of $H$ on $\rho$ in $\oCPORenv$ is given by $H \rho = (H^1
  (\pi_1 \rho),\,H^2 (\pi_2 \rho),\,H^*\rho)$
\item The action of $H$ on morphisms $f : \rho \to \rho'$ in $\oCPORenv$
  is given by $Hf = (H^1 (\pi_1 f),H^2 (\pi_2 f))$
\end{itemize}
\end{dfn}
\noindent Spelling out the last two bullet points above gives the
following analogues of the three conditions immediately following
Definition~\ref{def:RT-functor}: {\em i}) if $R_1 :
\oCPOR(A_1,B_1),...,R_k : \oCPOR(A_k,B_k)$, then $H^*\rho\, \ol{R} :
\oCPOR(H^1(\pi_1 \rho)\, \ol{A}, H^2(\pi_2 \rho)\, \ol{B})$; {\em ii})
if $(\alpha_1, \beta_1) \in \HomoCPOR(R_1,S_1),..., (\alpha_k,
\beta_k) \in \HomoCPOR(R_k,S_k)$, then $H^*\rho\, \ol{(\alpha, \beta)}
= (H^1(\pi_1 \rho)\,\ol{\alpha}, H^2(\pi_2 \rho)\, \ol{\beta})$; and
{\em iii}) if $f : \rho \to \rho'$ and
$R_1:\oCPOR(A_1,B_1),...,R_k:\oCPOR(A_k,B_k)$, then $((H^1(\pi_1
f))_{\ol{A}}\,x, (H^2(\pi_2 f))_{\ol{B}}\,y) \in H^*\rho'\,\ol{R}$
whenever $(x, y) \in H^*\rho\,\ol{R}$. As before, the last condition
is automatically satisfied because it is implied by the third bullet
point of Definition~\ref{def:relenv-functor}.

Considering $\oCPORenv$ as a product $\Pi_{\phi^k \in \tvars \cup
  \fvars} \oCPORT_k$, we extend the computation of $\omega$-directed
colimits in $\oCPORT_k$ to compute colimits in $\oCPORenv$ componentwise. We
similarly extend the notion of an $\omega$-cocontinuous endofunctor on
$\oCPORT_k$ componentwise to give a notion of $\omega$-cocontinuity for
functors from $\oCPORenv$ to $\oCPORT_k$.  Recalling from the start of this
subsection that Definition~\ref{def:rel-sem} is given mutually
inductively with Definition~\ref{def:set-sem} we can, at last, define:

\begin{dfn}\label{def:rel-sem}
The {\em relational interpretation} $\oCPORsem{\cdot} : \F \to
[\oCPORenv, \oCPOR]$ is defined by
\begin{align*}
  \oCPORsem{\Gamma;\Phi \vdash \zerot}\rho &= 0\\
  \oCPORsem{\Gamma;\Phi \vdash \onet}\rho &= 1\\
  \oCPORsem{\Gamma; \emptyset \vdash \Nat^\Phi \,F\,G}\rho &= \{\eta
  : \lambda \ol{K}.\,\oCPORsem{\Gamma; \Phi \vdash
    F}\rho[\ol{\Phi := K}] \Rightarrow \lambda \ol{K}. \,\oCPORsem{
    \Gamma; \Phi \vdash G}\rho[\ol{\phi := K}]\}\\
  &=
  \{(\eta_1,\eta_2) \in \oCPOsem{\Gamma; \emptyset
    \vdash \Nat^\Phi
    \,F\,G} (\pi_1 \rho) \times \oCPOsem{ 
    \Gamma;\emptyset
    \vdash \Nat^\Phi \,F\,G} (\pi_2
  \rho)~|~\\ 
  & \hspace{0.3in} \forall \ol{K = (K^1, K^2, K^*) : \oCPORT_{k}}.\\
  & \hspace{0.4in} ((\eta_1)_{\ol{K^1}},(\eta_2)_{\ol{K^2}}) \in
  (\oCPORsem{\Gamma; \Phi \vdash G}\rho[\ol{\Phi :=
      K}])^{\oCPORsem{\Gamma;\Phi\vdash F}\rho[\ol{\Phi := K}]} \}\\  
  \oCPORsem{\Gamma;\Phi \vdash \phi \ol{F}}\rho &=
  (\rho\phi)\ol{\oCPORsem{\Gamma;\Phi \vdash 
    F}\rho}\\
  \oCPORsem{\Gamma;\Phi \vdash F+G}\rho &=
  \oCPORsem{\Gamma;\Phi \vdash F}\rho +
  \oCPORsem{\Gamma;\Phi \vdash G}\rho\\
  \oCPORsem{\Gamma;\Phi \vdash F\times G}\rho &=
  \oCPORsem{\Gamma;\Phi \vdash F}\rho \times
  \oCPORsem{\Gamma;\Phi \vdash G}\rho\\  
   \oCPORsem{\Gamma;\Phi,\ol\gamma \vdash (\mu \phi.\lambda
    \ol{\alpha}. H)\ol{G}}\rho
  &= (\mu T_{H,\rho})\ol{\oCPORsem{\Gamma;\Phi,\ol\gamma \vdash
     G}\rho}\\
  \text{where }	T_{H,\rho}
    &= (T^\set_{H,\pi_1\rho}, T^\set_{H,\pi_2\rho}, T^\rel_{H,\rho}) \\
  \text{and } T^\oCPOR_{H,\rho}\,F
    &= \lambda \ol{R}. \oCPORsem{
      \Gamma;\ol\gamma,\phi,\ol{\alpha} \vdash H}\rho[\phi :=
    F][\ol{\alpha := R}]\\
  \text{and } T^\oCPOR_{H,\rho}\,\delta
    &= \lambda \ol{R}. \oCPORsem{
      \Gamma;\ol\gamma,\phi,\ol{\alpha} \vdash H}\id_\rho[\phi :=
    \delta][\ol{\alpha := \id_{\ol{R}}}] \\
  \oCPORsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
    F)\ol{A}}\rho &= \{ (t_1, t_2) : \oCPOsem{\Gamma;\Phi \vdash
    (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}(\pi_1 \rho) \,\times\,
  \oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
    F)\ol{A}}(\pi_2 \rho)\\
  &\hspace{0.2in}|~\exists\, \ol{Z : \oCPO_0}, t_1' : \oCPOsem{\Gamma;
    \Phi, \ol\alpha \vdash F}(\pi_1\rho)[\ol{\alpha := Z}],\, t_2' : 
  \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}(\pi_2\rho)[\ol{\alpha := Z}],\\
  & \hspace{0.2in} \ol{f :
  \oCPORsem{\Gamma; \ol{\alpha} \vdash K}\rho[\ol{\alpha := \Eq_Z}] \to
  \oCPORsem{\Gamma; \Phi \vdash A}\rho} \mbox{ such that }\\
  &\hspace{0.2in}\iota_{\ol{Z},\ol{\pi_1 f}}t_1' = t_1,\,
  \kappa_{\ol{Z}, \ol{\pi_2 f}}t_2' = t_2, \mbox{ and } (t_1',t_2') :
  \oCPORsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho[\ol{\alpha := \Eq_Z}]\,\}
\end{align*}
\end{dfn}
\noindent
In the final clause of Definition~\ref{def:rel-sem},
  $\iota_{Z,h}$ is the injection into
\[\colim{Z \,: \,\oCPO_0,\; h \,:\, \oCPOsem{\Gamma; \ol{\alpha} \vdash
      K}(\pi_1\rho)[\ol{\alpha := Z}] \to \oCPOsem{\Gamma; \Phi \vdash
      A}(\pi_1\rho)}{\oCPOsem{\Gamma; \Phi, \ol{\alpha} \vdash
    F}(\pi_1\rho)[\ol{\alpha := Z}]}\]
  and 
  $\kappa_{Z,h}$ is the injection into
\[\colim{Z\, :\, \oCPO_0, \;h \,:\, \oCPOsem{\Gamma; \ol{\alpha} \vdash
      K}(\pi_2\rho)[\ol{\alpha := Z}] \to \oCPOsem{\Gamma; \Phi \vdash
    A}(\pi_2\rho)}{\oCPOsem{\Gamma; \Phi, \ol{\alpha} \vdash
    F}(\pi_2\rho)[\ol{\alpha := Z}]}\]
We note that the pair $(\iota_{Z,h},\kappa_{Z,h})$ need not coincide
with the injection $j_{Z,\Eq_h}$ into 
\[\colim{Z\, :\, \oCPO_0, \;g \,:\, \oCPORsem{\Gamma; \ol{\alpha} \vdash
      K}\rho[\ol{\alpha := \Eq_Z}] \to \oCPORsem{\Gamma; \Phi \vdash
    A}\rho}{\oCPORsem{\Gamma; \Phi, \ol{\alpha} \vdash
    F}\rho[\ol{\alpha := \Eq_Z}]}\] In fact, it is precisely this that
keeps the object and relational interpretations of $\Lan$ types in
from being ``parallel''. {\color{blue} Of course $\iota$ and $\kappa$
  depend on $\rho$, too. Perhaps the notation should reflect this.}

If $\rho : \oCPORenv$ and $\vdash F$, then we write
$\oCPORsem{\vdash F}$ instead of $\oCPORsem{\vdash F}\rho$. The
interpretations in Definitions~\ref{def:rel-sem} and in
Definition~\ref{def:rel-sem-funcs} below respect weakening.

As for Definition~\ref{def:set-sem}, to know that
Definition~\ref{def:rel-sem} is well-defined we have to check that,
for every $\rho : \relenv$, each relational interpretation is in
$\oCPOR$. The proof that relational interpretations of $\Nat$-types
define relations is analogous to the proof of
Lemma~\ref{lem:nat-types-sets}.  Moreover, for any $\rho : \relenv$,
we have that $\oCPORsem{\Gamma; \emptyset \vdash \Nat^\Phi F\,G}\rho$
is an $\omega$-cocontinuous functor because it is a constant functor.
Interpretations of $\Nat$-types ensure that $\oCPORsem{\Gamma \vdash F
  \to G}\rho$ and $\oCPORsem{\Gamma \vdash \forall \ol \alpha. F}\rho$
are as expected in any parametric model.

To make sense of the penultimate clause of
Definition~\ref{def:rel-sem}, we need to know that, for each $\rho :
\relenv$, $T_{H,\rho}$ is an $\omega$-cocontinuous endofunctor on
$\oCPORT$, and thus admits a fixpoint. Since $T_{H,\rho}$ is defined
in terms of $\oCPORsem{\Gamma;\ol\gamma,\phi^k, \ol{\alpha} \vdash
  H}$, this means that relational interpretations of types must be
$\omega$-cocontinuous functors from $\oCPORenv$ to $\oCPORT_0$, which
in turn entails that the actions of relational interpretations of
types on objects and on morphisms in $\oCPORenv$ are intertwined.
%Moreover, for the last clause in Definition~\ref{def:rel-sem} to be
%well-defined we need $\oCPORsem{\Gamma; \ol\alpha \vdash
%  K}\rho[\ol{\alpha := \_}]$ and $\oCPORsem{\Gamma; \Phi, \ol\alpha
%  \vdash F}\rho[\ol{\alpha := \_}]$ to be $\omega$-cocontinuous
%functors.
As for $\oCPO$ interpretations, we know from~\cite{jp19} that, for
every $\Gamma; \ol\alpha \vdash F$, $\oCPORsem{\Gamma; \ol\alpha
  \vdash F}$ is actually in $[\oCPOR^k,\oCPOR]_{\omega}$, where $k =
|\ol\alpha|$. Therefore, for each $\oCPORsem{\Gamma;\ol\gamma,\phi^k,
  \ol{\alpha} \vdash H}$, the corresponding operator $T_H$ can be
extended to a {\em functor} from $\oCPORenv$ to $[[\oCPOR^k,\oCPOR],
  [\oCPOR^k,\oCPOR]]$. The action of $T_H$ on an object $\rho :
\oCPORenv$ is given by the higher-order functor $T_{H,\rho}$ whose
actions on objects and morphisms are given in the penultimate clause
of Definition~\ref{def:rel-sem}. The action of $T_{H}$ on a morphism
$f : \rho \to \rho'$ is the higher-order natural transformation
$T_{H,f} : T_{H,\rho} \to T_{H,\rho'}$ whose action on any $F :
[\oCPOR^k,\oCPOR]_{\omega}$ is the higher-order natural transformation
$T_{H,f}\, F : T_{H,\rho}\, F \to T_{H,\rho'}\, F$ whose component at
$\ol{R}$ is $(T_{H,f}\, F)_{\ol{R}} = \oCPORsem{\Gamma;
  \ol\gamma,\phi,\ol{\alpha} \vdash H}f[\phi := \id_F][\ol{\alpha :=
    \id_R}]$. Finally, to see that the functor given by the
penultimate clause of Definition~\ref{def:rel-sem} is well-defined we
must also show that, for every $H$, $T_{H,\rho}\,F$ is a relation
transformer for any relation transformer $F$. To know that the functor
given by Definition~\ref{def:rel-sem-funcs} is well-defined we will
similarly need to show and that $T_{H,f}\, F : T_{H,\rho}\, F \to
T_{H,\rho'}\, F$ is a morphism of relation transformers for every
relation transformer $F$ and every morphism $f : \rho \to \rho'$ in
$\oCPORenv$. These results will be immediate consequences of
Lemma~\ref{lem:rel-transf-morph} below.

To make sense of the final clause of
Definition~\ref{def:rel-sem}, we first observe that, for any $\rho :
\relenv$, $\oCPORsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
  F)\ol{A}}\rho$ is a set because $\oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}(\pi_1 \rho)$ and
$\oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
  F)\ol{A}}(\pi_2 \rho)$ are.  Moreover, for any $\rho : \relenv$, the
fact that $\oCPORsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
  F)\ol{A}}\rho$ is an $\omega$-cocontinuous functor follows from
Corollary~12 of~\cite{jp19} provided each functor in
$\ol{\setsem{\Gamma; \ol\alpha \vdash K}}$ is polynomial in the
variables in $\ol\alpha$.

The next definition gives the actions of functors interpreting types
on morphisms between relation environments.

\begin{dfn}\label{def:rel-sem-funcs}
Let $f: \rho \to \rho'$ for relation environments $\rho$ and $\rho'$
(so that $\rho|_\tvars = \rho'|_\tvars$). The actions
$\oCPORsem{\Gamma;\Phi \vdash F}f$ of $\oCPORsem{\Gamma;\Phi \vdash
  F}$ on the morphism $f$ for all types other than $\Lan$-types are
given exactly as in Definition~\ref{def:set-sem-funcs}, except that
all interpretations involved are now relational interpretations and
all occurrences of $T^\oCPO_{H,f}$ are replaced by $T_{H,f}$. For
$\Lan$-types, we define
\[ \oCPORsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} f
= \big( \oCPORsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}}
  F)\ol{A}} (\pi_1 f),\, \oCPORsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_2 f) \big)\]
\end{dfn}

We now need to show that the functorial actions of $\Lan$-types are
well-defined, i.e., that for every $(t_1, t_2) : \oCPORsem{\Gamma;\Phi
  \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}\rho$ we have that
\begin{equation}\label{eq:lan-rel-interp-well-defined}
  \big( \oCPOsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}
(\pi_1 f) t_1, \oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_2 f) t_2 \big) :
\oCPORsem{\Gamma;\Phi \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}
\rho'
\end{equation}
Since $(t_1, t_2) : \oCPORsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}}$ there exist $\ol{Z :
  \oCPO_0}$, $t_1' : \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash
  F}(\pi_1\rho)[\ol{\alpha := Z}]$, $t_2' : \oCPOsem{\Gamma; \Phi,
  \ol\alpha \vdash F}(\pi_2\rho)[\ol{\alpha := Z}]$, $\ol{g :
  \oCPORsem{\Gamma; \ol{\alpha} \vdash K}\rho[\ol{\alpha := \Eq_Z}]
  \to \oCPORsem{\Gamma; \Phi \vdash A}\rho}$ such that
$\iota_{\ol{Z},\ol{\pi_1 g}}t_1' = t_1$, $\kappa_{\ol{Z}, \ol{\pi_2
    g}}t_2' = t_2$, and $(t_1',t_2') : \oCPORsem{\Gamma; \Phi,
  \ol\alpha \vdash F}\rho[\ol{\alpha := \Eq_Z}]$.  To show that
\eqref{eq:lan-rel-interp-well-defined} holds, let $\ol{S = Z}$, $s_1'
= \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F} (\pi_1 f) [\ol{\alpha :=
    Z}] t'_1$, $s_2' = \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}
(\pi_2 f) [\ol{\alpha := Z}] t'_2$, and $\ol{h = \oCPORsem{\Gamma;
    \Phi \vdash A} f \circ g}$. Then $(s'_1, s'_2) : \oCPORsem{\Gamma;
  \Phi, \ol\alpha \vdash F}\rho'[\ol{\alpha := \Eq_Z}]$ because
$(t_1',t_2') : \oCPORsem{\Gamma; \Phi, \ol\alpha \vdash
  F}\rho[\ol{\alpha := \Eq_Z}]$ and $(s'_1, s'_2) = \oCPORsem{\Gamma;
  \Phi, \ol\alpha \vdash F} f [\ol{\alpha := \Eq_Z}] (t'_1, t'_2)$.
In addition, $\iota'_{\ol{Z},\ol{\pi_1 h}} s_1' = \oCPOsem{\Gamma;\Phi
  \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_1 f) t_1$ and
$\kappa'_{\ol{Z},\ol{\pi_2 h}} s_2' = \oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_2 f) t_2$ hold because
\[
\begin{array}{rl}
\iota'_{\ol{Z},\ol{\pi_1 h}} s_1' &=
\iota'_{\ol{Z},\ol{\oCPOsem{\Gamma; \Phi \vdash A} (\pi_1 f) \circ \pi_1
    g}} ( \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F} (\pi_1 f)
      [\ol{\alpha := \id_Z}] t'_1 ) \\
%      &= (\oCPOsem{\Gamma;\Phi \vdash
%        (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_1 f) \circ
      %      \iota_{\ol{Z},\ol{\pi_1 g}}) t'_1
       &= \oCPOsem{\Gamma;\Phi
        \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_1 f)
      (\iota_{\ol{Z},\ol{\pi_1 g}} t'_1) \\ &= \oCPOsem{\Gamma;\Phi
        \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_1 f)
      t_1 \end{array}
\]
where the second equality is by~\eqref{cd:lan-comm}, and similarly
for $\kappa'_{\ol{Z},\ol{\pi_2 h}} s_2' = \oCPOsem{\Gamma;\Phi \vdash
  (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{A}} (\pi_2 f) t_2$.

With the relational interpretations of types laid out we can now
prove:

\begin{lemma}\label{lem:rel-transf-morph}
For every $\Gamma;\Phi \vdash F$, \[\sem{\Gamma;\Phi \vdash F} =
(\oCPOsem{\Gamma;\Phi \vdash F}, \oCPOsem{\Gamma;\Phi \vdash
  F},\oCPORsem{\Gamma;\Phi \vdash F}) \in
[\oCPORenv,\oCPORT_0]\]
\end{lemma}
\noindent
The proof is a straightforward induction on the structure of $F$,
using an appropriate result from~\cite{jp19} to deduce
$\omega$-cocontinuity of $\sem{\Gamma;\Phi \vdash F}$ in each case,
together with Lemma~\ref{lem:fp} and Equation~\ref{eq:mu} for
$\mu$-types. The result holds by construction for $\Lan$-types.

We can also prove by simultaneous induction that our interpretations
of types interact well with demotion of functorial variables. Indeed,
we have that, if $\rho, \rho' : \oCPOenv$, \,$f : \rho \to \rho'$,
\,$\rho \phi = \rho \psi = \rho' \phi = \rho' \psi$, \, $f \phi = f
\psi = \id_{\rho \phi}$,\, $\Gamma; \Phi, \phi^k \vdash F$,\,
$\Gamma;\Phi,\ol{\alpha} \vdash G$,\, $\Gamma;\Phi,\alpha_1...\alpha_k
\vdash H$, and $\ol{\Gamma;\Phi \vdash K}$, then
{\color{red} WE NEED TO CHECK LAN CASES HERE!}
\begin{gather}
\label{thm:demotion-objects}
\oCPOsem{\Gamma; \Phi, \phi \vdash F} \rho = \oCPOsem{\Gamma, \psi; \Phi
  \vdash F[\phi :== \psi] } \rho\\
\label{thm:demotion-morphisms}
\oCPOsem{\Gamma; \Phi, \phi \vdash F} f = \oCPOsem{\Gamma, \psi; \Phi
  \vdash F[\phi :== \psi]} f\\
\label{eq:subs-var}
\oCPOsem{\Gamma;\Phi \vdash G[\ol{\alpha := K}]}\rho =
\oCPOsem{\Gamma;\Phi,\ol{\alpha} \vdash G}\rho[\ol{\alpha := 
\oCPOsem{\Gamma;\Phi \vdash K}\rho}]\\
\label{eq:subs-var-morph}
\oCPOsem{\Gamma;\Phi \vdash G[\ol{\alpha := K}]}f =
\oCPOsem{\Gamma;\Phi,\ol{\alpha} \vdash G}f[\ol{\alpha :=
\oCPOsem{\Gamma;\Phi \vdash K}f}]\\
\label{eq:subs-const}
\oCPOsem{\Gamma; \Phi \vdash F[\phi := H]}\rho
= \oCPOsem{\Gamma; \Phi, \phi \vdash F}\rho
[\phi := \lambda \ol{A}.\, \oCPOsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}\rho[\overline{\alpha := A}]] \\ 
\label{eq:subs-const-morph}
\oCPOsem{\Gamma; \Phi \vdash F[\phi := H]}f
= \oCPOsem{\Gamma; \Phi, \phi \vdash F}f
[\phi := \lambda \ol{A}.\,\oCPOsem{\Gamma;\Phi,\overline{\alpha}\vdash
    H}f[\overline{\alpha := \id_{\ol{A}}}]] 
\end{gather}
Identities analogous to (\ref{thm:demotion-objects}) through
(\ref{eq:subs-const-morph}) hold for relational interpretations as
well.
  
\section{The Identity Extension Lemma}\label{sec:iel}

The standard definition of the graph for a morphism $f : A \to B$ in
$\set$ is the relation $\graph{f} : \rel(A,B)$ defined by $(x,y) \in
\graph{f}$ iff $fx = y$. This definition naturally generalizes to
associate to each natural transformation between $k$-ary functors on
$\oCPO$ a $k$-ary relation transformer as follows.


The notion of a graph relation naturally generalizes to associate to
each natural transformation between $k$-ary functors on $\oCPO$ a
$k$-ary relation transformer as follows. Recall that, since $\oCPO$ is
a locally finitely presentable category, Proposition 1.6.1
of~\cite{ar94} ensures that it has a (strong epi, mono) factorization
system. We then have:

\begin{dfn}\label{dfn:graph-nat-transf}
If $F, G: \oCPO^k \to \oCPO$ and $\alpha : F \to G$ is a natural
transformation, then the functor $\graph{\alpha}^*: \oCPOR^k \to
\oCPOR$ is defined as follows. Given $R_1 : \oCPOR(A_1, B_1),...,R_k :
\oCPOR(A_k,B_k)$, let $\iota_{R_i} : R_i \hookrightarrow A_i \times
B_i$, for $i = 1,...,k$, be the inclusion of $R_i$ as a
sub$\oCPO$ of $A_i \times B_i$, let $h_{\overline{A \times B}}$
be the unique morphism making the diagram
{\footnotesize\[\begin{tikzcd}[row sep = large] F\overline{A}
  &F(\overline{A \times B}) \ar[l, "{F\overline{\pi_1}}"'] \ar[r,
    "{F\overline{\pi_2}}"] \ar[d, dashed, "{h_{\overline{A \times
          B}}}"] &F\overline{B} \ar[r, "{\alpha_{\ol{B}}}"]
  &G\overline{B} \\ &F\overline{A} \times G\overline{B} \ar[ul,
    "{\pi_1}"] \ar[urr, "{\pi_2}"']
\end{tikzcd}\]}
\noindent
\!\!commute, and let $h_{\overline{R}} : F\overline{R} \to
F\overline{A} \times G\overline{B}$ be $h_{\overline{A \times B}}
\circ F\overline{\iota_R}$. Further, let $\alpha^\wedge\overline{R}$
be the
%If $f = e \circ m = e' \circ m'$ then $cod e = dom m$ is the same as
%$cod e' = dom m'$ up to isomorphism. This follows easily from the
%definition of a factorization system.
subobject through which $h_{\overline{R}}$ is factorized by the
(strong epi, mono) factorization system of $\oCPO$, as shown in the
following diagram: {\footnotesize\[\begin{tikzcd} F\overline{R}
  \ar[rr, "{h_{\overline{R}}}"] \ar[dr, twoheadrightarrow,
    "{q_{\alpha^\wedge\overline{R}}}"'] &&F\overline{A} \times
  G\overline{B} \\ &\alpha^\wedge\overline{R} \ar[ur, hookrightarrow,
    "{\iota_{\alpha^\wedge\overline{R}}}"']
\end{tikzcd}\]}

\noindent
Then $\alpha^\wedge\overline{R} : \oCPOR(F\overline{A},
G\overline{B})$ by construction, so the action of $\graph{\alpha}^*$
on objects of $\oCPOR$ can be given by $\langle \alpha \rangle^*
\overline{(A,B,R)} = (F\overline{A}, G\overline{B},
\iota_{\alpha^\wedge \overline{R}}\alpha^\wedge\overline{R})$. The
action of $\graph{\alpha}^*$ on morphisms of $\oCPOR$ is given by
$\graph{\alpha}^*\overline{(\beta, \beta')} = (F\overline\beta,
G\overline\beta')$.
\end{dfn}

The next lemma shows that the data in
Definition~\ref{dfn:graph-nat-transf} actually yield a relation
transformer $\graph{\alpha} = (F, G, \graph{\alpha}^*)$. We call this
the {\em graph relation transformer} for $\alpha$.

\begin{lemma}\label{lem:graph-reln-functors}
If $F,G : [\oCPO^k,\oCPO]$, and if $\alpha : F \to G$ is a natural
transformation, then $\graph{\alpha}$ is in $\oCPORT_k$.
\end{lemma}
\begin{proof}
Clearly, $\graph{\alpha}^*$ is $\omega$-cocontinuous, so
$\graph{\alpha}^* : [\oCPOR^k,\oCPOR]$. Now, let $\overline{R :
  \oCPOR(A, B)}$,\, $\overline{S : \oCPOR(C, D)}$, and
$\overline{(\beta, \beta') : R \to S}$. We want to show that there
exists a morphism $\epsilon : \alpha^\wedge\overline{R} \to
\alpha^\wedge\overline{S}$ such that the diagram on the left below
commutes. Since $\ol{(\beta,\beta') : R \to S}$, there exist
$\overline{\gamma : R \to S}$ such that each diagram in the middle
commutes.  Moreover, since both $h_{\overline{C \times D}} \circ
F(\overline{\beta \times \beta'})$ and $(F\overline{\beta} \times
G\overline{\beta'}) \circ h_{\overline{A \times B}}$ make the diagram
on the right commute, they must be equal.
\begin{figure*}[ht]
\vspace*{-0.1in}
  \hspace*{-0.85in}
  \begin{minipage}[b]{0.25\linewidth}
 {\small    \[
    \begin{tikzcd}
        \alpha^\wedge\overline{R}
        \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"]
        \ar[d, "{\epsilon}"']
        & F\overline{A} \times G\overline{B}
        \ar[d, "{F\overline{\beta} \times G\overline{\beta'}}"] \\
        \alpha^\wedge\overline{S}
        \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{S}}}"']
        & F\overline{C} \times G\overline{D}
    \end{tikzcd}
    \]}
\end{minipage}
\begin{minipage}[b]{0.25\linewidth}
{\small    \[
    \begin{tikzcd}
        R_i
        \ar[d, "{\gamma_i}"']
        \ar[r, hookrightarrow, "{\iota_{R_i}}"]
        &A_i \times B_i
        \ar[d, "{\beta_i \times \beta'_i}"] \\
        S_i
        \ar[r, hookrightarrow, "{\iota_{S_i}}"]
        &C_i \times D_i
    \end{tikzcd}
    \]}
\end{minipage}
\begin{minipage}[b]{0.25\linewidth}
{\footnotesize \[
      \begin{tikzcd}[row sep = large]
          F\overline{C}
          &F\overline{C} \times F\overline{D}
          \ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
          &F\overline{D}
          \ar[r, "{\alpha_{\ol{D}}}"]
          &G\overline{D}\\
          &F(\overline{A \times B})
          \ar[u, dashed, "{\exists !}"]
          \ar[ul, "{F\ol{\pi_1} \circ F(\overline{\beta \times \beta'})}"]
          \ar[urr, "{\alpha_{\ol{D}} \circ F\ol{\pi_2} \circ F(\overline{\beta \times \beta'})}"']
      \end{tikzcd}
      \]}
\end{minipage}
\end{figure*}
We therefore get that the right-hand square in the diagram on the left
below commutes, and thus that the entire diagram does as well.
Finally, by the left-lifting property of
$q_{\alpha^\wedge\overline{R}}$ with respect to
$\iota_{\alpha^\wedge\overline{S}}$ given by the (strong epi, mono)
factorization system there exists an $\epsilon$ such that the diagram
on the right below commutes.
\[
      \begin{tikzcd}
          F\overline{R}
          \ar[d, "{F\overline{\gamma}}"']
          \ar[r, hookrightarrow, "{F\overline{\iota_R}}"]
          \ar[rr, bend left, "{h_{\overline{R}}}"]
          &F(\overline{A \times B})
          \ar[d, "{F(\overline{\beta \times \beta'})}"]
          \ar[r, "{h_{\overline{A \times B}}}"]
          &F\overline{A} \times G\overline{B}
          \ar[d, "{F\overline{\beta} \times F\overline{\beta'}}"] \\
          F\overline{S}
          \ar[r, hookrightarrow, "{F\overline{\iota_S}}"']
          \ar[rr, bend right, "{h_{\overline{S}}}"']
          &F(\overline{C \times D})
          \ar[r, "{h_{\overline{C \times D}}}"']
          &F\overline{C} \times G\overline{D}
      \end{tikzcd}
\qquad
      \begin{tikzcd}
          F\overline{R}
          \ar[d, "{F\overline{\gamma}}"']
          \ar[r, twoheadrightarrow, "{q_{\alpha^\wedge\overline{R}}}"]
          &\alpha^\wedge\overline{R}
          \ar[d, dashed, "{\epsilon}"]
          \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{R}}}"]
          &F\overline{A} \times G\overline{B}
          \ar[d, "{F\overline{\beta} \times G\overline{\beta'}}"] \\
          F\overline{S}
          \ar[r, twoheadrightarrow, "{q_{\alpha^\wedge\overline{S}}}"']
          &\alpha^\wedge\overline{S}
          \ar[r, hookrightarrow, "{\iota_{\alpha^\wedge\overline{S}}}"']
          &F\overline{C} \times G\overline{D}
      \end{tikzcd}
\]
\end{proof}

If $f : A \to B$ is a morphism in $\oCPO$ then the definition of the
graph relation transformer $\graph{f}$ for $f$ as a natural
transformation between $0$-ary functors $A$ and $B$ coincides with the
definition of $\graph{f}$ for $f$ as a morphism in $\oCPO$ given in
the second paragraph of this section.  As a result, graph relation
transformers are a reasonable extension of graph relations to
functors.

To prove the IEL, we will need to know that the equality relation
transformer preserves equality relations in $\oCPOR$; see
Equation~\ref{eq:eq-pres-eq} below. This will follow from the next
lemma, which shows how to compute the action of a graph relation
transformer on any graph relation.

\begin{lemma}\label{lem:eq-reln-equalities}
If $\alpha : F \to G$ is a morphism in $[\oCPO^k, \oCPO]$ and $f_1:
A_1 \to B_1, ..., f_k : A_k \to B_k$, then $\graph{\alpha}^*
\graph{\overline{f}} = \graph{G \ol{f} \circ \alpha_{\ol{A}}} =
\graph{\alpha_{\ol{B}} \circ F \ol{f}}$.
\end{lemma}
\begin{proof}
Since $h_{\overline{A \times B}}$ is the unique morphism making the
bottom triangle of the diagram on the left below commute, and since
$h_{\graph{\overline{f}}} = h_{\overline{A \times B}} \circ F
\,\ol{\iota_{\graph{f}}} = h_{\overline{A \times B}} \circ F
\overline{\graph{\id_A, f}}$, the universal property of the
product depicted in the diagram on the right gives
$h_{\graph{\overline{f}}} = \graph{\id_{F \ol{A}}, \alpha_{\ol{B}}
\circ F\ol{f}} : F \ol{A} \to F \ol{A} \times G \ol{B}$.
\begin{figure*}[ht]
  \vspace*{-0.15in}
  \begin{minipage}[b]{0.45\linewidth}
{\footnotesize
\[\begin{tikzcd}[row sep = large]
        &F\overline{A}
        \ar[d, "{F \overline{\graph{\id_A, f}}}" description]
        \ar[dl, equal]
        \ar[dr, "{F\ol{f}}"]\\
        F\overline{A}
        &F(\overline{A \times B})
        \ar[l, "{F\overline{\pi_1}}"']
        \ar[r, "{F\overline{\pi_2}}"]
        \ar[d, "{h_{\overline{A \times B}}}"]
        &F\overline{B}
        \ar[r, "{\alpha_{\ol{B}}}"]
        &G\overline{B}\\
        &F\overline{A} \times G\overline{B}
        \ar[ul, "{\pi_1}"] \ar[urr, "{\pi_2}"']
\end{tikzcd}\]}
\end{minipage}
  \begin{minipage}[b]{0.45\linewidth}
{\footnotesize
\[
      \begin{tikzcd}[row sep = large]
          F\overline{A}
          &F\overline{A} \times G\overline{B}
          \ar[l, "{\pi_1}"'] \ar[r, "{\pi_2}"]
          &G\overline{B}\\
          &F\overline{A}
          \ar[u, dashed, "{\exists !}"]
          \ar[ul, equal]
          \ar[r, "{F\ol{f}}"']
          &F{\ol{B}}
          \ar[u, "{\alpha_{\ol{B}}}"']
      \end{tikzcd}
      \]}
\end{minipage}
\end{figure*}

\vspace*{-0.1in}

\noindent
Moreover, $\graph{\id_{F \ol{A}}, \alpha_{\ol{B}} \circ F\ol{f}}$ is a
monomorphism in $\oCPO$ because $\id_{F \ol{A}}$ is, so its (strong
epi, mono) factorization gives $\iota_{\alpha^\wedge
  \graph{\overline{f}}} = \langle \id_{F \ol{A}}, \alpha_{\ol{B}}
\circ F\ol{f} \rangle$, and thus that $\alpha^\wedge
\graph{\overline{f}} = F\overline{A}$.
%If $e \circ m = e \circ m'$ then $m = m'$ is trivial from the
%definition of a factorization system.
Then $\iota_{\alpha^\wedge \graph{\overline{f}}} \alpha^\wedge
\graph{\overline{f}} = \graph{\id_{F \ol{A}}, \alpha_{\ol{B}} \circ
  F\ol{f}} (F \ol{A}) = \graph{ \alpha_{\ol{B}} \circ F\ol{f}
}^*$. Then $\graph{ \alpha }^* \graph{ \overline{f} } =
(F\overline{A}, G\overline{B}, \iota_{\alpha^\wedge
  \graph{\overline{f}}}\, \alpha^\wedge \graph{\overline{f}}) =
(F\overline{A}, G\overline{B}, \graph{ \alpha_{\ol{B}} \circ F\ol{f}
}^*) = \graph{ \alpha_{\ol{B}} \circ F\ol{f} }$, and, finally,
$\alpha_{\ol{B}} \circ F\ol{f} = G\ol{f} \circ \alpha_{\ol{A}}$ by
naturality of $\alpha$.
\end{proof}

The {\em equality relation transformer} on $F : [\oCPO^k,\oCPO]$ is
defined to be $\Eq_F = \graph{\id_{F}}$. Specifically, $\Eq_F = (F, F,
\Eq_F^*)$ with $\Eq_F^* = \graph{\id_{F}}^*$, and
Lemma~\ref{lem:eq-reln-equalities} indeed ensures that
\begin{equation}\label{eq:eq-pres-eq}
\Eq^*_F \ol{\Eq_A}
= \graph{\id_F}^* \graph{\id_{\ol{A}}}
= \graph{F \id_{\ol{A}} \circ (\id_F)_{\ol{A}}}
= \graph{\id_{F\ol{A}} \circ \id_{F\ol{A}}}
= \graph{\id_{F\ol{A}}}
= \Eq_{F\ol{A}}
\end{equation}
for all $\ol{A : \oCPO}$.  Graph relation transformers in
general, and equality relation transformers in particular,
extend to relation environments in the obvious ways.  Indeed,
if $\rho, \rho' : \oCPOenv$ and $f : \rho \to \rho'$, then the {\em
  graph relation environment} $\graph{f}$ is defined pointwise
by $\graph{f} \phi = \graph{f \phi}$ for every $\phi$, which entails
that $\pi_1 \graph{f} = \rho$ and $\pi_2 \graph{f} = \rho'$. In
particular, the {\em equality relation environment} $\Eq_\rho$
is defined to be $\graph{\id_{\rho}}$, which entails that $\Eq_\rho
\phi = \Eq_{\rho \phi}$ for every $\phi$.  With these definitions in
hand, we can state and prove both an Identity Extension Lemma and a
Graph Lemma for our calculus.

\begin{thm}[IEL]\label{thm:iel}
  If $\rho : \oCPOenv$ and $\Gamma; \Phi \vdash F$ then
  $\oCPORsem{\Gamma; \Phi \vdash F} \Eq_\rho = \Eq_{\oCPOsem{\Gamma;
      \Phi \vdash F}\rho}$.
\end{thm}
\begin{proof}
By induction on the structure of $F$. Only the $\Nat$, application,
fixpoint, and $\Lan$ cases are non-routine. The application and
fixpoint cases use Equation~\ref{eq:eq-pres-eq}. The fixpoint case
$\Gamma;\Phi,\ol\gamma \vdash (\mu \phi.\lambda \ol\alpha.H)\ol F$
also uses the observation that, for every $i < \omega$, the following
intermediate results can be proved by simultaneous induction with
Theorem~\ref{thm:iel}: for any $H$, $\rho$, $\ol A$, and any
subformula $J$ of $H$, $T^i_{H,\Eq_{\rho}} K_0\, \ol{\Eq_A} =
(\Eq_{(T^\set_{H,\rho})^i K_0})^* \ol{\Eq_A}$\; and\;
\[\begin{array}{ll}
&  \oCPORsem{\Gamma; \Phi, \phi, \ol{\alpha} \vdash J} \Eq_{\rho} [\phi
  := T^i_{H,\Eq_{\rho}} K_0] \overline{[\alpha := \Eq_A]}\\
=  &
\oCPORsem{\Gamma; \Phi, \phi,
  \ol{\alpha} \vdash J} \Eq_{\rho} [\phi := \Eq_{(T^\oCPO_{H,\rho})^i K_0}]
\overline{[\alpha := \Eq_A]}
\end{array}\]
The case of the latter equation for $J = (\Lan_{\ol K}^{\ol
  \beta}\,F)\ol B$ uses the facts that $\pi_1 (T^i_{H,\Eq_\rho} K_0) =
(T^\set_{H,\rho})^i K_0$ for all $i < \omega$, $\pi_2
(T^i_{H,\Eq_\rho} K_0) = (T^\set_{H,\rho})^i K_0$ for all $i <
\omega$, and that, without loss of generality, the variables in $\ol
\beta$ do not appear free in $H$. With these results in hand, the
proof of Theorem~\ref{thm:iel} follows. The simultaneous induction
required to make the various parts of the proof hang together
appropriately is somewhat delicate, so we give the proof in its
entirety in the {\color{blue} appendix}. As noted there, if functorial
variables of arity greater than $0$ were allowed in the bodies of
$\mu$-types then the IEL would fail.
\end{proof}

\begin{lemma}[Graph Lemma]\label{lem:graph}
If $\rho, \rho' : \oCPOenv$, $f : \rho \to \rho'$, and $\Gamma; \Phi
\vdash F$, then $\graph{\oCPOsem{\Gamma; \Phi \vdash F} f} =
\oCPORsem{\Gamma; \Phi \vdash F}\graph{f}$.
\end{lemma}
\begin{proof}
Applying Lemma~\ref{lem:rel-transf-morph} to the morphisms $(f,
\id_{\rho'}) : \graph{f} \to \Eq_{\rho'}$ and $(\id_{\rho}, f) :
\Eq_{\rho} \to \graph{f}$ of relation environments gives that
\begin{multline*}
(\oCPOsem{\Gamma; \Phi \vdash F}f, \oCPOsem{\Gamma; \Phi \vdash F}\id_{\rho'})
  = \oCPORsem{\Gamma; \Phi \vdash F} (f, \id_{\rho'}) \\
:\oCPORsem{\Gamma; \Phi \vdash F}\graph{f} \to 
  \oCPORsem{\Gamma; \Phi \vdash F}\Eq_{\rho'}
\end{multline*}
and
\begin{multline*}
(\oCPOsem{\Gamma; \Phi \vdash F}\id_{\rho}, \oCPOsem{\Gamma; \Phi \vdash F}f)
  = \oCPORsem{\Gamma; \Phi \vdash F} (\id_{\rho}, f) \\
: \oCPORsem{\Gamma; \Phi \vdash F}\Eq_{\rho} 
  \to \oCPORsem{\Gamma; \Phi \vdash F}\graph{f}
\end{multline*}
Expanding the first equation gives that if $(x,y) \in \oCPORsem{\Gamma;
  \Phi \vdash F}\graph{f}$ then \[(\oCPOsem{\Gamma; \Phi \vdash F} f\,
x, \oCPOsem{\Gamma; \Phi \vdash F}\id_{\rho'}\, y) \in \oCPORsem{\Gamma;
  \Phi \vdash F}\Eq_{\rho'}\] So $\oCPOsem{\Gamma; \Phi \vdash
  F}\id_{\rho'}\, y = \id_{\oCPOsem{\Gamma; \Phi \vdash F}\rho'}\, y =
y$ and $\oCPORsem{\Gamma; \Phi \vdash F}\Eq_{\rho'} =
\Eq_{\oCPOsem{\Gamma; \Phi \vdash F}\rho'}$, and if $(x,y) \in
\oCPORsem{\Gamma; \Phi \vdash F}\graph{f}$ then $(\oCPOsem{\Gamma; \Phi
  \vdash F} f\, x, y) \in \Eq_{\oCPOsem{\Gamma; \Phi \vdash F}\rho'}$,
i.e., $\oCPOsem{\Gamma; \Phi \vdash F} f\, x = y$, i.e., $(x, y) \in
\graph{\oCPOsem{\Gamma; \Phi \vdash F} f}$.  So, we have that
$\oCPORsem{\Gamma; \Phi \vdash F}\graph{f} \subseteq
\graph{\oCPOsem{\Gamma; \Phi \vdash F}f}$.  Expanding the second
equation gives that if $x \in \oCPOsem{\Gamma; \Phi \vdash F}\rho$ then
$(\oCPOsem{\Gamma; \Phi \vdash F}\id_{\rho}\, x,$\\
$\oCPOsem{\Gamma; \Phi
  \vdash F} f\, x) \in \oCPORsem{\Gamma; \Phi \vdash F}\graph{f}$.  Then
$\oCPOsem{\Gamma; \Phi \vdash F}\id_{\rho}\, x = \id_{\oCPOsem{\Gamma;
    \Phi \vdash F}\rho} x = x$, so for any $x \in \oCPOsem{\Gamma; \Phi
  \vdash F}\rho$ we have that $(x, \oCPOsem{\Gamma; \Phi \vdash F}f\,
x) \in \oCPORsem{\Gamma; \Phi \vdash F}\graph{f}$.  Moreover, $x \in
\oCPOsem{\Gamma; \Phi \vdash F}\rho$ if and only if $(x,
\oCPOsem{\Gamma; \Phi \vdash F} f\, x) \in \graph{\oCPOsem{\Gamma; \Phi
    \vdash F}f}$ and, if $x \in \oCPOsem{\Gamma; \Phi \vdash F}\rho$
then $(x, \oCPOsem{\Gamma; \Phi \vdash F} f\, x) \in \oCPORsem{\Gamma;
  \Phi \vdash F} \graph{f}$, so if $(x, \oCPOsem{\Gamma; \Phi \vdash F}
f\, x) \in \graph{\oCPOsem{\Gamma; \Phi \vdash F}f}$ then $(x,
\oCPOsem{\Gamma; \Phi \vdash F} f\, x) \in \oCPORsem{\Gamma; \Phi \vdash
  F} \graph{f}$, i.e., $\graph{\oCPOsem{\Gamma; \Phi \vdash F}f}
\subseteq \oCPORsem{\Gamma; \Phi \vdash F} \graph{f}$.
\end{proof}

\section{Interpreting Terms}

If $\Delta = x_1 : F_1,...,x_n : F_n$ is a term context for $\Gamma$
and $\Phi$, then the interpretations $\setsem{\Gamma;\Phi \vdash \Delta}$ and
$\relsem{\Gamma;\Phi \vdash \Delta}$ are defined by
\[\begin{array}{lll}
\setsem{\Gamma;\Phi \vdash \Delta} & = & \setsem{\Gamma;\Phi \vdash
  F_1} \times ... \times \setsem{\Gamma;\Phi \vdash F_n}\\ 
\relsem{\Gamma;\Phi \vdash \Delta} & = & \relsem{\Gamma;\Phi \vdash
  F_1} \times ... \times \relsem{\Gamma;\Phi \vdash F_n}\\ 
\end{array}\]
Every well-formed term $\Gamma;\Phi~|~\Delta \vdash t : F$ then
has, for every $\rho \in \setenv$, set interpretations
$\setsem{\Gamma;\Phi~|~\Delta \vdash t : F}\rho$ as natural
transformations from $\setsem{\Gamma; \Phi \vdash \Delta}\rho$ to
$\setsem{\Gamma; \Phi \vdash F}\rho$, and, for every $\rho \in
\relenv$, relational interpretations $\relsem{\Gamma;\Phi~|~\Delta
  \vdash t : F}\rho$ as natural transformations from
$\relsem{\Gamma; \Phi \vdash \Delta}\rho$ to $\relsem{\Gamma; \Phi
  \vdash F}\rho$. These are given in Definition~\ref{def:set-interp}.

\begin{dfn}\label{def:set-interp}
If $\rho$ is a set (resp., relation) environment and
$\Gamma;\Phi~|~\Delta \vdash t : F$ then
$\setsem{\Gamma;\Phi~|~\Delta \vdash t : F}\rho$ (resp.,
$\relsem{\Gamma;\Phi~|~\Delta \vdash t : F}\rho$) is defined as in
Figure~\ref{fig:term-sem}, where $\mathsf D$ is either $\set$ or
$\rel$ as appropriate.
\end{dfn}

\begin{figure*}
\hspace*{-3.1in}
\resizebox{0.46\linewidth}{!}{
\begin{minipage}[t]{0.5\textwidth}
\[\begin{array}{lll}
\dsem{\Gamma;\Phi \,|\, \Delta,x :F \vdash x : F} \rho& = &
\pi_{|\Delta|+1}\\
%\dsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : \sigma \to \tau}\rho &
%= & \curry (\dsem{\Gamma;\emptyset \,|\, \Delta, x : \sigma \vdash t :
%  \tau}\rho)\\ 
%\dsem{\Gamma;\emptyset \,|\, \Delta \vdash st: \tau} \rho & = &
%\eval \circ
% \langle \dsem{\Gamma;\emptyset \,|\, \Delta \vdash s: \sigma \to
%  \tau}\rho, \dsem{\Gamma;\emptyset \,|\, \Delta \vdash t: \sigma}\rho
%\rangle\\
\dsem{\Gamma;\emptyset \,|\, \Delta \vdash L_{\overline \alpha} x.t : \Nat^{\overline
    \alpha} \,F \,G}\rho & = &  \curry (\dsem{\Gamma;\overline \alpha
  \,|\, \Delta, x : F \vdash t: G}\rho[\overline{\alpha := \_}])\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash t_{\overline K} s:
  G [\overline{\alpha := K}]}\rho & = & \eval \circ \langle
  \lambda d.\,(\dsem{\Gamma;\emptyset \,|\, \Delta \vdash t :
  \Nat^{\overline{\alpha}} \,F \,G}\rho\; d)_{\overline{\dsem{\Gamma;\Phi
      \vdash K}\rho}},\\ 
 & & \hspace*{0.5in} \dsem{\Gamma;\Phi \,|\,
    \Delta \vdash s: F [\overline{\alpha := K}]}\rho \rangle\\ 
& & \\
%% \color{red} \mbox{Add rules for } \forall \mbox{ if we include it} & & \\
%\dsem{\Gamma;\Phi \,|\, \Delta,x :F \vdash x : F} \rho& = &
%\pi_{|\Delta|+1}\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \bot_F t : F} \rho& = &
!^0_{\dsem{\Gamma;\Phi \vdash F}\rho} \circ
  \dsem{\Gamma;\Phi~|~\Delta \vdash t : \zerot}\rho, \mbox{ where } \\
 & & \hspace*{0.1in} !^0_{\dsem{\Gamma;\Phi \vdash F}\rho}
\mbox{ is the unique morphism from } 0\\
 & & \hspace*{0.1in} \mbox{ to } \dsem{\Gamma;\Phi \vdash F}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \top : \onet}\rho & = &
!^{\dsem{\Gamma;\Phi\vdash \Delta}\rho}_1, \mbox{ where }
!^{\dsem{\Gamma;\Phi\vdash \Delta}\rho}_1\\ 
& & \hspace*{0.1in} \mbox{ is the unique morphism from }
\dsem{\Gamma;\Phi\vdash \Delta}\rho \mbox{ to } 1\vspace*{0.05in}\\ 
\dsem{\Gamma;\Phi \,|\, \Delta \vdash (s,t) : F \times G} \rho& = &
\dsem{\Gamma;\Phi \,|\, \Delta \vdash s: F} \rho\times
\dsem{\Gamma;\Phi \,|\, \Delta \vdash t : G} \rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_1 t : F} \rho& = &
\pi_1 \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : F \times G}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \pi_2 t : G}\rho & = &
\pi_2 \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : F \times
  G} \rho\\
\dsem{\Gamma;\Phi~|~\Delta \vdash \case{t}{x \mapsto l}{y \mapsto r} :
  K}\rho & = & \eval \circ \langle \curry \,[\dsem{\Gamma;\Phi
    \,|\, \Delta, x : F \vdash l : K}\rho,\\
   & & \hspace*{0.79in} \dsem{\Gamma;\Phi \,|\, \Delta, y
    : G \vdash r : K}\rho],\\
   & &  \hspace*{0.5in} \dsem{\Gamma;\Phi \,|\, \Delta \vdash t :
  F + G} \rho\rangle\vspace*{0.05in}\\   
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \inl \,s: F + G} \rho& = &
\inl \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash s: F}\rho\\
\dsem{\Gamma;\Phi \,|\, \Delta \vdash \inr \,t: F + G}\rho & = & 
\inr \circ \dsem{\Gamma;\Phi \,|\, \Delta \vdash t : G}\rho\\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \map^{\ol{F},\ol{G}}_H
  : \Nat^\emptyset (\Nat^{\ol\beta,\ol\gamma} F\,G)
& = & \lambda d\, \ol\eta\,\ol{C}.\,
\dsem{\Gamma; \ol{\phi},\ol{\gamma}\vdash H}\id_{\rho[\ol{\gamma:=
      C}]}[\ol{\phi := \lambda \ol B. \eta_{\ol B\, \ol C}}]\\ 
\hspace*{0.5in}
  (\Nat^{\ol{\gamma}}\,H[\ol{\phi :=_{\ol{\beta}} F}]\,H[\ol{\phi
      :=_{\ol{\beta}} G}]) \rrbracket^{\mathsf D} \rho & &\\
%\hspace*{0.79in}  & & \hspace*{0.1in}\id_{\rho[\ol{\gamma :=
%      C}]}[\ol{\phi := \lambda
%    \ol{B}. (\dsem{\Gamma;\ol\alpha\,|\,\Delta \vdash t : 
%    \Nat^{\ol{\beta},\ol{\gamma}}\,F\,G}\rho\,d)_{\ol{B}\,\ol{C}}}]\\
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash \tin_H :
Nat^{\ol{\beta},\ol{\gamma}} \, H[\phi := (\mu \phi.\lambda {\overline
    \alpha}.H){\overline \beta}][\ol{\alpha := \beta}] & = &
\lambda d\,\ol{B}\,
\ol{C}.\,(\mathit{in}_{{T}^X_{H,\rho[\ol{\gamma :=
        C}]}})_{\ol{B}} \;\;\mbox{ where } X \mbox{ is } \set \mbox{ when } \\ 
\hspace*{0.79in}(\mu \phi.\lambda {\overline \alpha}.H){\overline
  \beta} \rrbracket^{\mathsf{D}} \rho & & \hspace*{0.2in}  
\mathsf{D} = \set \mbox{ and not present when }
\mathsf{D} = \rel\vspace*{0.05in}\\  
\llbracket \Gamma;\emptyset \,|\, \emptyset \vdash
  \fold^F_H : \Nat^\emptyset\;(\Nat^{\ol{\beta}, \ol{\gamma}}\,H[\phi
    :=_{\ol{\beta}} F][\ol{\alpha := \beta}]\,F) & = &  
\lambda d\,\eta\,\ol{B}\,\ol{C}.\,
(\mathit{fold}_{T^X_{H,\rho[\ol{\gamma := C}]}} \, (\lambda
\ol{A}.\,\eta_{\ol{A}\,\ol{C}}))_{\ol{B}}\\ 
\hspace*{0.79in}(\Nat^{{\ol{\beta},\ol{\gamma}} }\,(\mu
  \phi.\lambda \overline \alpha.H)\overline \beta\;F)
\rrbracket^{\mathsf{D}} \rho & & \hspace*{0.2in} \mbox{ where } X
\mbox{ is as above }\vspace*{0.05in} \\
\setsem{\Gamma;\emptyset~|~\emptyset \vdash \int_{\ol K,F}
: \Nat^{\Phi,\ol\alpha}\,F\, (\Lan^{\ol\alpha}_{\ol K}\, F)\ol{K}}\rho
& = & \vspace*{0.05in}\\
\relsem{\Gamma;\emptyset~|~\emptyset \vdash \int_{\ol K,F} :
  \Nat^{\Phi,\ol\alpha}\,F\, (\Lan^{\ol\alpha}_{\ol K}\,
  F)\ol{K}}\rho\,d & = & \vspace*{0.05in} \\
\setsem{\Gamma;\emptyset~|~\Delta \vdash \partial^{G, \ol
      K}_F \eta : Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K}
  F)\ol \beta\; G}\rho & = &\lambda \ol{N} \, \ol{B}.\,
((\mu_{\ol{N}})_{\ol{B}})|_{\setsem{\Gamma; \Phi, \ol\beta \vdash
    (\Lan^{\ol\alpha}_{\ol K} F)\ol \beta } \rho[\Phi, \ol \beta :=
    \ol N, \ol B]}\\
& & \hspace*{0.2in} \mbox{where } \mu_{\ol{N}} \mbox{ is as described below}
\vspace*{0.05in}\\
\relsem{\Gamma;\emptyset~|~\Delta \vdash \partial^{G, \ol
      K}_F \eta : Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K}
    F)\ol \beta\; G}\rho & = & \\
\vspace*{-0.1in} 
\end{array}\]
\caption{Term semantics}\label{fig:term-sem} 
\end{minipage}}\vspace*{-0.05in}
\end{figure*}

\new{In the fourth-to-last clause of Definition~\ref{def:set-interp},...}

\new{In the third-to-last clause of Definition~\ref{def:set-interp},...}

In the next-to-last clause of Definition~\ref{def:set-interp},
  \[\mu_{\ol{N}} : \Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho
  {[\ol{\alpha := \_} ]}}} \setsem{\Gamma; \Phi, \ol\alpha \vdash
    F}\rho {[\Phi, \ol \alpha := \ol N, \_ ]} \to \setsem{\Gamma;
    \Phi, \ol\beta \vdash G} \rho[\Phi, \ol \beta := \ol N, \_]\]
  is the unique natural transformation such that
\begin{equation}\label{eq:defn-of-mu-sub-N}
    (\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta : \Nat^{\Phi,
    \ol\alpha} \, F \,\, G[\ol{\beta := K}]}\rho \, d)_{\ol{N}} =
\mu_{\ol{N}} \, \ol{\setsem{\Gamma; \ol\alpha \vdash K}
  \rho[\ol{\alpha := \_}]} \circ \epsilon_{\ol{N}}
  \end{equation}
Here, $\epsilon_{\ol{N}}$ is the natural transformation associated
with the left Kan extension
\[\begin{tikzcd} [column sep = large, row sep = large]
\set^{|\ol \alpha|}
\ar[rr, "\setsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho {[\Phi, \ol
      \alpha := \ol N, \_ ]}"{name=F}] 
\ar[dr, "\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho {[\ol{\alpha := \_} ]}}"{left}] && \set \\ 
&\set^{|\ol K|} \ar[ur, "\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho {[\ol{\alpha := \_} ]}}}
\setsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho {[\Phi, \ol \alpha :=
    \ol N, \_ ]}"{right}]
\ar[d, Rightarrow, shorten <= 2mm, shorten >= 1mm, 
          from=F, to=2-2,  "\epsilon_{\ol{N}}"{}]
\end{tikzcd}\]


\new{In the final last clause of Definition~\ref{def:set-interp},...}



\vspace*{1in}

If $t$ is closed, i.e., if $\emptyset; \emptyset~|~\emptyset \vdash t
: F$, then we write $\dsem{\vdash t : F}$ instead of $\dsem{\emptyset;
  \emptyset~|~\emptyset \vdash t : F}$.  The return type for the
semantic fold is $\dsem{\Gamma;\ol\beta,\ol\gamma \vdash
  F}\rho[\ol{\gamma := C}][\ol{\beta := B}]$.  This interpretation
gives $\dsem{\Gamma;\emptyset \,|\, \Delta \vdash \lambda x.t : F \to
  G}\rho = \curry (\dsem{\Gamma;\emptyset \,|\, \Delta, x : F \vdash t
  : G}\rho)$ and $\dsem{\Gamma;\emptyset \,|\, \Delta \vdash st: G}
\rho = \eval \circ \langle \dsem{\Gamma;\emptyset \,|\, \Delta \vdash
  s: F \to G}\rho, \dsem{\Gamma;\emptyset \,|\, \Delta \vdash t:
  F}\rho \rangle$, so it specializes to the standard interpretations
for System F terms.  To see that the object and relational
interpretations of $\Gamma;\emptyset~|~\emptyset \vdash \int_{\ol K,F}
: \Nat^{\Phi,\ol\alpha}\,F\, (\Lan^{\ol\alpha}_{\ol K}\, F)\ol{K}$ and
$\Gamma;\emptyset~|~\Delta \vdash \partial^{G, \ol K}_F \eta :
\Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K} F)\ol \beta\; G$ are
well-defined is significantly more involved, as we see in the next
four subsections.




\subsection{$\setsem{\Gamma;\emptyset~|~\emptyset \vdash \int_{\ol K,F}
: \Nat^{\Phi,\ol\alpha}\,F\, (\Lan^{\ol\alpha}_{\ol K}\, F)\ol{K}}$ is
  well-defined}

\subsection{$\relsem{\Gamma;\emptyset~|~\emptyset \vdash \int_{\ol K,F}
: \Nat^{\Phi,\ol\alpha}\,F\, (\Lan^{\ol\alpha}_{\ol K}\, F)\ol{K}}$ is
  well-defined}



\subsection{$\setsem{\Gamma;\emptyset~|~\Delta \vdash \partial^{G, \ol
      K}_F \eta : Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K}
    F)\ol \beta\; G}$ is well-defined} We must show that, for every
$\rho : \setenv$ and $d : \setsem{\Gamma; \emptyset \vdash \Delta}
\rho$, \[\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \partial^{G,
    \ol K}_F \eta : \Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K}
  F)\ol \beta\; G} \rho \, d\] has the correct type and satisfies the
condition required for it to be in $\setsem{\Gamma; \emptyset \vdash
  \Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K} F)\ol \beta\; G}
\rho$. For the former we observe that each component
$(\mu_{\ol{N}})_{\ol{B}}$ of $\mu_{\ol{N}}$ has type
  \[\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho
  {[\ol{\alpha := B} ]}}} \setsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho
        {[\Phi, \ol \alpha := \ol N, \ol B]} \to \setsem{\Gamma; \Phi,
          \ol\beta \vdash G} \rho[\Phi, \ol \beta := \ol N, \ol B]\]
        Each component of $(\mu_{\ol{N}})_{\ol{B}} |_{\setsem{\Gamma;
            \Phi, \ol\beta \vdash (\Lan^{\ol\alpha}_{\ol K} F)\ol
            \beta } \rho[\Phi, \ol \beta := \ol N, \ol B]}$ therefore
        has the correct type to be the component at $\ol N$ and $\ol
        B$ of a natural transformation in $\setsem{\Gamma; \emptyset
          \vdash \Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K}
          F)\ol \beta\; G} \rho$.

The next two lemmas show that $ \lambda \ol{N} \,
\ol{B}. (\mu_{\ol{N}})_{\ol{B}} |_{\setsem{\Gamma; \Phi, \ol\beta
    \vdash (\Lan^{\ol\alpha}_{\ol K} F)\ol \beta } \rho[\ol{\Phi,
      \beta := N, B}]}$ is natural in both $\ol{N}$ and $\ol{B}$ and
that it satisfies the condition required for it to be in
$\setsem{\Gamma; \emptyset \vdash \Nat^{\Phi, \ol\beta}\,
  (\Lan^{\ol\alpha}_{\ol K} F)\ol \beta\; G} \rho$, namely, if $\Phi =
{\phi_1,...,\phi_n}$ and $\phi_i$ has arity $k_i$ for $i = 1,...,n$,
then 
\begin{equation}\label{eq:P2}
    \begin{split}
      &\forall \ol{N = (N^1, N^2, N^*) : RT_{k_i}}, \forall \ol{B =
        (B^1, B^2, B^*) :
        RT_0}.\\ &((\mu_{\ol{N^1}})_{\ol{B^1}}|_{\setsem{\Gamma; \Phi,
          \ol\beta \vdash (\Lan^{\ol\beta}_{\ol K} F)\ol \beta }
        \rho[\Phi, \ol \beta := \ol{N^1}, \ol{B^1}]} ,
      (\mu_{\ol{N^2}})_{\ol{B^2}}|_{\setsem{\Gamma; \Phi, \ol\beta
          \vdash (\Lan^{\ol\beta}_{\ol K} F)\ol \beta } \rho[\Phi, \ol
          \beta := \ol{N^2}, \ol{B^2}]} )\\ &: \relsem{\Gamma; \Phi,
        \ol\beta \vdash (\Lan^{\ol\beta}_{\ol K} F)\ol \beta
      }\Eq_{\rho}[\Phi, \ol \beta := \ol N, \ol B] \rightarrow
      \relsem{\Gamma; \Phi, \ol\beta \vdash G}\Eq_{\rho}[\Phi, \ol
        \beta := \ol N, \ol B]
    \end{split}
    \end{equation}

\begin{lemma}
For every $\rho : \setenv$, $d : \setsem{\Gamma; \emptyset \vdash
  \Delta} \rho$, $\ol{N = (N^1, N^2, N^*) : RT_{k_i}}$, $\ol{B = (B^1,
  B^2, B^*) : RT_0}$, and $(t_1, t_2) \in \relsem{\Gamma; \Phi,
  \ol\beta \vdash (\Lan^{\ol\beta}_{\ol K} F)\ol \beta
}\Eq_{\rho}[\Phi, \ol \beta := \ol N, \ol B]$, it holds that
\[((\mu_{\ol{N^1}})_{\ol{B^1}} \,\, t_1, (\mu_{\ol{N^2}})_{\ol{B^2}} \,\, t_2) \in
\relsem{\Gamma; \Phi, \ol\beta \vdash G}\Eq_{\rho}[\Phi, \ol \beta :=
  \ol N, \ol B]\]
\end{lemma}

\begin{proof}
Unfolding the definition of relational interpretation for $\Lan$-types
in the hypothesis gives that $(t_1, t_2) : \setsem{\Gamma;\Phi,
  \ol\beta \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{\beta}}\rho[\Phi,
  \ol \beta := \ol{N^1}, \ol{B^1}] \,\times\, \setsem{\Gamma;\Phi,
  \ol\beta \vdash (\Lan^{\ol{\alpha}}_{\ol{K}} F)\ol{\beta}}\rho[\Phi,
  \ol \beta := \ol{N^2}, \ol{B^2}]$ and there exist $\ol{Z : \set_0},
t_1' : \setsem{\Gamma; \Phi, \ol\alpha \vdash F} \rho[\ol{\Phi :=
    N^1}][\ol{\alpha := Z}],\, t_2' : \setsem{\Gamma; \Phi, \ol\alpha
  \vdash F}\rho[\ol{\Phi := N^2 }][\ol{\alpha := Z}]$,\\ $\ol{f :
  \relsem{\Gamma; \ol{\alpha} \vdash K}\Eq_\rho[\ol{\alpha := \Eq_Z}]
  \to B}$ \, such that $\iota_{\ol{Z},\ol{\pi_1 f}}t_1' = t_1,\,
\kappa_{\ol{Z}, \ol{\pi_2 f}}t_2' = t_2,$ and $(t_1',t_2') \in
\\ \relsem{\Gamma; \Phi, \ol\alpha \vdash F}\Eq_\rho[\ol{\Phi :=
    N}][\ol{\alpha := \Eq_Z}].$ Inlining $t_1 =
\iota_{\ol{Z},\ol{\pi_1 f}}t_1'$ and $t_2 = \kappa_{\ol{Z}, \ol{\pi_2
    f}}t_2'$ in in the goal in the statement of the lemma gives us the
following rewritten goal to prove:
\begin{equation}\label{eq:new-goal}
((\mu_{\ol{N^1}})_{\ol{B^1}} \,\, \iota_{\ol{Z},\ol{\pi_1 f}}\, t_1' ,
  (\mu_{\ol{N^2}})_{\ol{B^2}} \,\,  \kappa_{\ol{Z}, \ol{\pi_2 f}}\, t_2'  )
\in \relsem{\Gamma; \Phi, \ol\beta \vdash
G}\Eq_{\rho}[\ol{\Phi, \beta := N, B}]
\end{equation}

To this end, consider the commuting diagram\\ 

\begin{tikzcd}[column sep = large, row sep = large]
    & \setsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho[\Phi, \ol \alpha
    := \ol{N^1}, \ol Z]
    \ar[dr, "\;\;\;\;\;\iota_{\ol{Z}, \ol{\pi_1 f}}"{right}] 
    \ar[dl, "\iota'_{\ol Z, 
                \ol{\id_{\setsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := Z}]}}}\;\;\;\;\;\;\;\;\;\;\;\;"{left}] 
        & \\
    LKZ % (\Lan_{\setsem{\Gamma; \ol\alpha \vdash K}\rho{[\ol{\alpha := \_}]}}
    %               \setsem{\Gamma; \Phi, \ol\alpha \vdash F}
    %                 \rho{[\ol{\Phi, \alpha := N^1, \_}]}) \ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := Z}]}
    \ar[rr, dashed, "(\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho{[\ol{\alpha := \_}]}}}
                  \setsem{\Gamma; \Phi, \ol\alpha \vdash F}
                    \rho{[\Phi, \ol \alpha := \ol{N^1}, \_]}) \ol{\pi_1 f}"{below}]
       & & LB
  \end{tikzcd}

\noindent
where $LKZ = (\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash
      K}\rho{[\ol{\alpha := \_}]}}} \setsem{\Gamma; \Phi, \ol\alpha
  \vdash F} \rho{[\Phi, \ol \alpha := \ol{N^1}, \_]})
\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := Z}]}$ and
\\ $LB = (\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash
      K}\rho{[\ol{\alpha := \_}]}}} \setsem{\Gamma; \Phi, \ol\alpha
  \vdash F} \rho{[\Phi, \ol \alpha := \ol{N^1}, \_]}) \ol{B^1}$. This
diagram commutes by the universal property of $LKZ$ regarded as a
colimit in $\set$.  Theorem 6.2.2 of~\cite{rie16} also gives that
$\iota'_{\ol Z, \ol{\id_{\setsem{\Gamma; \ol\alpha \vdash
        K}\rho[\ol{\alpha := Z}]}}} = (\epsilon_{\ol{N^1}})_{\ol{Z}}$.
Together these two facts give
\[  \iota_{\ol{Z}, \ol{\pi_1 f}}
  = (\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho{[\ol{\alpha := \_}]}}}
                  \setsem{\Gamma; \Phi, \ol\alpha \vdash F}
                    \rho{[\ol{\Phi, \alpha := N^1, \_}]}) \ol{\pi_1 f}
  \circ (\epsilon_{\ol{N^1}})_{\ol{Z}}
\]
\noindent
An analogous proof gives 
\[  \kappa_{\ol{Z}, \ol{\pi_2 f}}
  = (\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho{[\ol{\alpha := \_}]}}}
                  \setsem{\Gamma; \Phi, \ol\alpha \vdash F}
                    \rho{[\ol{\Phi, \alpha := N^2, \_}]}) \ol{\pi_2 f}
  \circ (\epsilon_{\ol{N^2}})_{\ol{Z}}
\]
Using these equalities, we can rewrite our goal~\eqref{eq:new-goal}
again, this time as
\begin{align}\label{eq:new-new-goal} 
  ((\mu_{\ol{N^1}})_{\ol{B^1}} \,\, 
  ((\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho{[\ol{\alpha := \_}]}}}
                  \setsem{\Gamma; \Phi, \ol\alpha \vdash F}
                    \rho{[\ol{\Phi, \alpha := N^1, \_}]}) \ol{\pi_1 f}
  ((\epsilon_{\ol{N^1}})_{\ol{Z}}
        \, t_1' )) , \\\nonumber
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
(\mu_{\ol{N^2}})_{\ol{B^2}} \,\,  
  ((\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho{[\ol{\alpha := \_}]}}}
                  \setsem{\Gamma; \Phi, \ol\alpha \vdash F}
                    \rho{[\ol{\Phi, \alpha := N^2, \_}]}) \ol{\pi_2 f}
  ((\epsilon_{\ol{N^2}})_{\ol{Z}}
        \, t_2'  ))) \\\nonumber
        \in \relsem{\Gamma; \Phi, \ol\beta \vdash
    G}\Eq_{\rho}[\Phi, \ol \beta := \ol N, \ol B]
\end{align}

Now, by naturality of $\mu_{\ol{N^i}}$ for the morphisms $\ol{\pi_i
  f}$ we have
\begin{align*}
(\mu_{\ol{N^i}})_{\ol{B^i}} \circ 
  ((\Lan_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}\rho{[\ol{\alpha := \_}]}}}
                  \setsem{\Gamma; \Phi, \ol\alpha \vdash F}
                    \rho{[\ol{\Phi, \alpha := N^i, \_}]}) \ol{\pi_i f} \\
= \setsem{\Gamma; \Phi, \ol\beta \vdash G}\id_\rho 
    [\ol{\Phi, \beta := \id_{N^i}, \pi_i f}]
  \circ 
  (\mu_{\ol{N^i}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}
      \rho[\ol{\alpha := Z}]}}
\end{align*}
Using this, we can rewrite our goal~\eqref{eq:new-new-goal} a final
time as
\begin{align}\label{eq:new-new-new-goal} 
  \big(\setsem{\Gamma; \Phi, \ol\beta \vdash G}\id_\rho 
    [\Phi, \ol \beta := \ol{\id_{N^1}}, \ol{\pi_1 f}]
  ((\mu_{\ol{N^1}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}
      \rho[\ol{\alpha := Z}]}}
  ((\epsilon_{\ol{N^1}})_{\ol{Z}}
        \, t_1' )) , \\\nonumber
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
  \setsem{\Gamma; \Phi, \ol\beta \vdash G}\id_\rho 
    [\Phi, \ol \beta := \ol{\id_{N^2}}, \ol{\pi_2 f}]
  ((\mu_{\ol{N^2}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K}
      \rho[\ol{\alpha := Z}]}}
  ((\epsilon_{\ol{N^2}})_{\ol{Z}}
        \, t_2'  ))\big) \\\nonumber
        \in \relsem{\Gamma; \Phi, \ol\beta \vdash
    G}\Eq_{\rho}[\Phi, \ol \beta := \ol N, \ol B]
\end{align}

  {\color{red} START HERE!}

To finish the proof, we would like to use that fact that
$\relsem{\Gamma; \Phi,\ol\beta \vdash G}\id_{\Eq_\rho} [\Phi,
   \ol \beta := \ol{\id_N}, \ol{f}]$ is a morphism in $\rel$ and thus preserves
related elements. But in order to apply this morphism, we must first show
that
\begin{align*}
((\mu_{\ol{N^1}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^1}})_{\ol{Z}} \,\, t_1') &, 
  %%%
  (\mu_{\ol{N^2}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^2}})_{\ol{Z}} \,\, t_2')) \\
  & \in 
  \relsem{\Gamma; \Phi, \ol\alpha \vdash
        G[\ol{\beta := K}]}\Eq_{\rho}[\Phi, \ol \alpha := \ol N,
    \ol{\Eq_Z}]
\end{align*}
To show this, we use the condition imposed on $\setsem{\Gamma;
  \emptyset \,|\, \Delta \vdash \eta : \Nat^{\Phi, \ol\alpha} \, F
  \,\, G[\ol{\beta := K}]} \rho \, d$ to be in $\setsem{\Gamma;
  \emptyset \vdash \Nat^{\Phi, \ol\alpha} \, F \,\, G[\ol{\beta :=
      K}]} \rho$, i.e.,

    \begin{equation}\label{eq:P1}
    \begin{split}
      &\forall \ol{N = (N^1, N^2, N^*) : RT_k}, 
          \forall \ol{M = (M^1, M^2, M^*) : RT_k}.\\
      &((\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta : \Nat^{\Phi, \ol\alpha} \, F \,\, G[\ol{\beta := K}]} \rho \, d)_{\ol{N^1}, \ol{M^1}}, 
      (\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta} : \Nat^{\Phi, \ol\alpha} \, F \,\, G[\ol{\beta := K}] \rho \, d)_{\ol{N^2}, \ol{M^2}}) \\
      &: \relsem{\Gamma; \Phi, \ol\alpha \vdash F}\Eq_{\rho}[\ol{\Phi, \alpha := N, M}]
      \rightarrow \relsem{\Gamma; \Phi, \ol\alpha \vdash
        G[\ol{\beta := K}]}\Eq_{\rho}[\ol{\Phi, \alpha := N, M}]
    \end{split}
    \end{equation}
along with the universal property of 
$\Lan_{\setsem{\Gamma; \ol\alpha \vdash K}\rho {[\ol{\alpha := \_} ]}}
      \setsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho {[\ol{\Phi, \alpha := N^i, \_} ]}$
      for $i = 1, 2$
and the fact that $t_1'$ and $t_2'$ are related in 
$\relsem{\Gamma; \Phi, \ol\alpha \vdash F}\Eq_{\rho}[\ol{\Phi, \alpha := N, \Eq_Z}]$.
Applying Equation \eqref{eq:P1} with $\ol{M} = \ol{Z}$ 
gives (eliding the type of $\eta$)
    \begin{equation*}
    \begin{split}
      &((\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta} \rho \, d)_{\ol{N^1}, \ol{Z}}, 
      (\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta} \rho \, d)_{\ol{N^2}, \ol{Z}}) \\
      &: \relsem{\Gamma; \Phi, \ol\alpha \vdash F}\Eq_{\rho}[\ol{\Phi, \alpha := N, \Eq_Z}]
      \rightarrow \relsem{\Gamma; \Phi, \ol\alpha \vdash
        G[\ol{\beta := K}]}\Eq_{\rho}[\ol{\Phi, \alpha := N, \Eq_Z}]
    \end{split}
    \end{equation*}
and since we know 
$(t_1',t_2') \in
  \relsem{\Gamma; \Phi, \ol\alpha \vdash F}\Eq_\rho[\ol{\Phi := N}][\ol{\alpha := \Eq_Z}]$, 
we can apply this morphism
%%
to $(t_1', t_2')$:
\begin{align*}
  ((\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta} \rho \, d)_{\ol{N^1}, \ol{Z}} t_1', 
  (\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta} \rho \, d)_{\ol{N^2}, \ol{Z}} t_2') 
  \in 
\relsem{\Gamma; \Phi, \ol\alpha \vdash
        G[\ol{\beta := K}]}\Eq_{\rho}[\ol{\Phi, \alpha := N, \Eq_Z}]
\end{align*}
%%
Applying the universal property at component $\ol{Z}$
$$
  ((\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta}\rho \, d)_{\ol{N^i}})_{\ol{Z}}
  = (\mu_{\ol{N^i}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} \circ 
  (\epsilon_{\ol{N^i}})_{\ol{Z}}
$$
yields 
\begin{align*}
((\mu_{\ol{N^1}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^1}})_{\ol{Z}} \,\, t_1') &, 
  %%%
  (\mu_{\ol{N^2}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^2}})_{\ol{Z}} \,\, t_2')) \\
  & \in 
  \relsem{\Gamma; \Phi, \ol\alpha \vdash
        G[\ol{\beta := K}]}\Eq_{\rho}[\ol{\Phi, \alpha := N, \Eq_Z}] \\
  & = \relsem{\Gamma; \Phi,\ol\beta \vdash G}\Eq_\rho
  [\ol{\Phi, \beta := N, \relsem{\Gamma; \ol\alpha \vdash K}\Eq_\rho[\ol{\alpha := \Eq_Z}]}]
\end{align*}


Finally, we can apply the morphism 
\begin{align*}
  \relsem{\Gamma; \Phi,\ol\beta \vdash G}\id_{\Eq_\rho} [\ol{\Phi, \beta := \id_N, f}] 
  : \,\,
  &\relsem{\Gamma; \Phi,\ol\beta \vdash G}\Eq_\rho
  [\ol{\Phi, \beta := N, \relsem{\Gamma; \ol\alpha \vdash K}\Eq_\rho[\ol{\alpha := \Eq_Z}]}] \\
  \rightarrow \,\,
  &\relsem{\Gamma; \Phi,\ol\beta \vdash G}\Eq_\rho [\ol{\Phi, \beta := N, B}]
\end{align*}
to the pair
$((\mu_{\ol{N^1}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^1}})_{\ol{Z}} \,\, t_1') , 
  %%%
  (\mu_{\ol{N^2}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^2}})_{\ol{Z}} \,\, t_2'))$
, which gives 

\begin{align*}
( 
  &\setsem{\Gamma; \Phi,\ol\beta \vdash G}\id_{\rho} [\ol{\Phi, \beta := \id_{N^1}, \pi_1 f}] 
  ((\mu_{\ol{N^1}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^1}})_{\ol{Z}} \,\, t_1')) ,  \\
  %%%
  &\setsem{\Gamma; \Phi,\ol\beta \vdash G}\id_{\rho} [\ol{\Phi, \beta := \id_{N^2}, \pi_2 f}] 
  ((\mu_{\ol{N^2}})_{\ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := Z}]}} 
  ((\epsilon_{\ol{N^2}})_{\ol{Z}} \,\, t_2'))) \\
  & \in 
  \relsem{\Gamma; \Phi, \ol\alpha \vdash
        G}\Eq_{\rho}[\ol{\Phi, \alpha := N,B}] 
\end{align*}
and thus 
$$((\mu_{\ol{N^1}})_{\ol{B^1}} \,\, t_1, 
                (\mu_{\ol{N^2}})_{\ol{B^2}} \,\, t_2)
                \in \relsem{\Gamma; \Phi, \ol\beta \vdash
            G}\Eq_{\rho}[\ol{\Phi, \beta := N, B}]$$

\end{proof}

\begin{lemma}
  For all $\rho : \setenv$ and $d : \setsem{\Gamma; \emptyset \vdash \Delta} \rho$, 
  the family of morphisms 
  $$
  \lambda \ol{N} \, \ol{B}. 
  ((\mu_{\ol{N}})_{\ol{B}})|_{\setsem{\Gamma; \Phi, \ol\beta 
                  \vdash (\Lan^{\ol\alpha}_{\ol K} F)\ol \beta } \rho[\ol{\Phi, \beta := N, B}]} 
  $$ 
  is natural in $\ol{N}$ and $\ol{B}$, where $\mu_{\ol{N}}$ is the unique natural transformation such that
  $$
  (\setsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta : \Nat^{\Phi, \ol\alpha} \, F \,\, G[\ol{\beta := K}]}\rho \, d)_{\ol{N}}
  = \mu_{\ol{N}} \, \ol{\setsem{\Gamma; \ol\alpha \vdash K} \rho[\ol{\alpha := \_}]} \circ 
  \epsilon_{\ol{N}}
  $$

\end{lemma}
\begin{proof}
To prove that this family of morphisms is natural, it suffices to show that the family of unrestricted morphisms 
  $\lambda \ol{N} \, \ol{B}. (\mu_{\ol{N}})_{\ol{B}}$ is natural in $\ol{N}$ and $\ol{B}$.
Let us give convenient shorthand names to the following functors and natural transformations.
\begin{align*}
\ol{K} &= \ol{\lambda \ol M. \oCPOsem{\Gamma; \ol\alpha \vdash K}\rho[\ol{\alpha := M}]} \\
F_{\ol N} &= \lambda \ol M. \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho[\Phi := \ol N][\ol{\alpha := M}] \\
F_{\ol{N'}} &= \lambda \ol M. \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\rho[\Phi := \ol{N'}][\ol{\alpha := M}] \\
F_{\ol h} &= \lambda \ol M. \oCPOsem{\Gamma; \Phi, \ol\alpha \vdash F}\id_{\rho}[\Phi := \ol{h}][\ol{\alpha := \id_{M}}] \colon F_{\ol{N}} \to F_{\ol{N'}} \\
G_{\ol N} &= \lambda \ol B. \oCPOsem{\Gamma; \Phi, \ol\beta \vdash G}\rho[\Phi := \ol N][\ol{\beta := B}] \\
G_{\ol{N'}} &= \lambda \ol B. \oCPOsem{\Gamma; \Phi, \ol\beta \vdash G}\rho[\Phi := \ol{N'}][\ol{\beta := B}] \\
G_{\ol h} &= \lambda \ol B. \oCPOsem{\Gamma; \Phi, \ol\beta \vdash G}\id_{\rho}[\Phi := \ol{h}][\ol{\beta := \id_{B}}] \colon G_{\ol{N}} \to G_{\ol{N'}} \\
\eta &= \oCPOsem{\Gamma; \emptyset \,|\, \Delta \vdash \eta : \Nat^{\Phi, \ol\alpha} F\; G[\ol{\beta := K}]} \rho\, d
\end{align*}
Moreover, let $|\ol \alpha| = j$ and $|\ol \beta| = |\ol K| = k$.

Notice that \(\eta\) is natural, so that
\begin{equation*}\label{eq:lan-elim-eta-nat}
	\eta_{\ol{N'}} \circ F_{\ol h} = G_{\ol h} \ol{K} \circ \eta_{\ol N} : F_{\ol N} \to G_{\ol{N'}} \ol{K}
\end{equation*}
The situation is illustrated in the following diagram.
\[
\begin{tikzcd}[column sep = huge, row sep = huge]
\Set^j
\ar[r, bend left, "{F_{\ol N}}", ""{name=F, below}]
\ar[r, bend right, "{F_{\ol{N'}}}"{name=F'b, below}, ""{name=F'a, above}]
\ar[Rightarrow, from=F, to=F'a, "{F_{\ol{h}}}"']
\ar[dr, bend right, "{\ol K}"']
&\Set \\
&\Set^k
\ar[Rightarrow, from=F'b, "{\eta_{\ol{N'}}}"']
\ar[Rightarrow, from=F, "{\eta_{\ol N}}" description]
\ar[u, "{G_{\ol N}}"{name=L, description}]
\ar[u, bend right = 90, "{G_{\ol{N'}}}"{name=L', right}]
\ar[Rightarrow, from=L, to=L', "{G_{\ol h}}"]
\end{tikzcd}
\]

Let $\epsilon_{\ol N} \colon F_{\ol N} \to (\Lan_{\ol K} F_{\ol N}) K$ and $\epsilon_{\ol{N'}} \colon F_{\ol{N'}} \to (\Lan_{\ol K} F_{\ol{N'}}) \ol{K}$ be the natural transformations associated to the left Kan extensions, and notice that $\epsilon$ is natural, so that
\begin{equation}\label{eq:lan-elim-epsilon-nat}
	(\Lan_{\ol K} F_{\ol h}) \ol{K} \circ \epsilon_{\ol N} = \epsilon_{\ol{N'}} \circ F_{\ol h}
\end{equation}
The situation is illustrated in the following diagram.
\[
\begin{tikzcd}[column sep = huge, row sep = huge]
\Set^j
\ar[r, bend left, "{F_{\ol N}}", ""{name=F, below}]
\ar[r, bend right, "{F_{\ol{N'}}}"{name=F'b, below}, ""{name=F'a, above}]
\ar[Rightarrow, from=F, to=F'a, "{F_{\ol{h}}}"']
\ar[dr, bend right, "{\ol K}"']
&\Set \\
&\Set^k
\ar[Rightarrow, from=F'b, "{\epsilon_{\ol{N'}}}"']
\ar[Rightarrow, from=F, "{\epsilon_{\ol N}}" description]
\ar[u, "{\Lan_{\ol K} F_{\ol N}}"{name=L, description}]
\ar[u, bend right = 90, "{\Lan_{\ol K} F_{\ol{N'}}}"{name=L', right}]
\ar[Rightarrow, from=L, to=L', "{\Lan_K F_{\ol h}}"]
\end{tikzcd}
\]

Let $\mu_{\ol N} : \Lan_{\ol K} F_{\ol N} \to G_{\ol{N}}$ be the unique natural transformation such that
\begin{equation}\label{eq:lan-elim-mu-univ}
	\mu_{\ol N} \ol{K} \circ \epsilon_{\ol N} = \eta_{\ol N}
\end{equation}
and $\mu_{\ol{N'}} : \Lan_{\ol K} F_{\ol{N'}} \to G_{\ol{N'}}$ be the unique natural transformation such that
\begin{equation}\label{eq:lan-elim-mu'-univ}
	\mu_{\ol{N'}} \ol{K} \circ \epsilon_{\ol{N'}} = \eta_{\ol{N'}}
\end{equation}
The situation is illustrated in the following diagrams.
\[
\begin{tikzcd}[column sep = huge, row sep = huge]
\Set^j
\ar[r, "{F_{\ol N}}"{name=Fa}, ""{name=F, below}]
\ar[dr, "{\ol K}"']
&\Set \\
&\Set^k
\ar[Rightarrow, from=F, "{\epsilon_{\ol N}}" description]
\ar[u, "{\Lan_{\ol K} F_{\ol N}}"{name=L, description}]
\ar[u, bend right = 90, "{G_{\ol N}}"{name=G, right}, ""'{name=Gr, right}]
\ar[Rightarrow, bend left = 90, from=Fa, to=Gr, "{\eta_{\ol{N}}}"]
\ar[Rightarrow, from=L, to=G, "{\mu_{\ol N}}"]
\end{tikzcd}
%%%
\begin{tikzcd}[column sep = huge, row sep = huge]
\Set^j
\ar[r, "{F_{\ol{N'}}}"{name=Fa}, ""{name=F, below}]
\ar[dr, "{\ol K}"']
&\Set \\
&\Set^k
\ar[Rightarrow, from=F, "{\epsilon_{\ol{N'}}}" description]
\ar[u, "{\Lan_{\ol K} F_{\ol{N'}}}"{name=L, description}]
\ar[u, bend right = 90, "{G_{\ol{N'}}}"{name=G, right}, ""'{name=Gr, right}]
\ar[Rightarrow, bend left = 90, from=Fa, to=Gr, "{\eta_{\ol{N'}}}"]
\ar[Rightarrow, from=L, to=G, "{\mu_{\ol{N'}}}"]
\end{tikzcd}
\]

Notice that, by the universal property of the left Kan extension, there exists a unique $\theta : \Lan_K F_{\ol{N}} \to G_{\ol{N'}}$ such that
\[
	\theta \ol{K} \circ \epsilon_{\ol N} = \eta_{\ol{N'}} \circ F_{\ol h} = G_{\ol h} \ol{K} \circ \eta_{\ol N}
\]
We shall now show that both $G_{\ol h} \circ \mu_{\ol N}$ and $\mu_{\ol{N'}} \circ \Lan_{\ol K} F_{\ol{h}}$ satisfy this universal property, and thus they are equal to each other.
\[
	(G_{\ol h} \circ \mu_{\ol N}) \ol{K} \circ \epsilon_{\ol N}
	= G_{\ol h}\ol{K} \circ \mu_{\ol N} \ol{K} \circ \epsilon_{\ol N}
	= G_{\ol h}\ol{K} \circ \eta_{\ol N}
\]
where the second equality is by Equation~\ref{eq:lan-elim-mu-univ}
and
\[
	(\mu_{\ol{N'}} \circ \Lan_{\ol K} F_{\ol{h}}) \ol{K} \circ \epsilon_{\ol N}
	= \mu_{\ol{N'}}\ol{K} \circ \Lan_{\ol K} F_{\ol{h}}\ol{K} \circ \epsilon_{\ol N}
	= \mu_{\ol{N'}}\ol{K} \circ \epsilon_{\ol{N'}} \circ F_{\ol h}
	= \eta_{\ol{N'}} \circ F_{\ol h}
\]
where the second equality is by Equation~\ref{eq:lan-elim-epsilon-nat} and the third equality is by Equation~\ref{eq:lan-elim-mu'-univ}.


\end{proof}





\subsection{$\relsem{\Gamma;\emptyset~|~\Delta \vdash \partial^{G, \ol
      K}_F \eta : Nat^{\Phi, \ol\beta}\, (\Lan^{\ol\alpha}_{\ol K}
    F)\ol \beta\; G}$ is well-defined} 





\section{Basic Properties of Term Interpretations}

The interpretations in Definition~\ref{def:set-interp} respect
weakening, i.e., a term and its weakenings all have the same set and
relational interpretations. Specifically, for any $\rho \in \setenv$,
$\setsem{\Gamma;\Phi \,|\, \Delta, x : F \vdash t : G}\rho =
(\setsem{\Gamma;\Phi \,|\, \Delta \vdash t : G}\rho) \circ
\pi_{\Delta}$, where $\pi_{\Delta}$ is the projection
$\setsem{\Gamma;\Phi \vdash \Delta, x : F} \to
\setsem{\Gamma;\Phi \vdash \Delta}$. A similar result holds for
relational interpretations.

Moreover, if
  $\Gamma,\alpha;\Phi \,|\, \Delta \vdash t : F$ and
  $\Gamma;\Phi,\alpha \,|\, \Delta \vdash t' : F$ and $\Gamma;\Phi
  \vdash G$ then
\begin{itemize}
\item $\setsem{\Gamma;\Phi \,|\, \Delta[\alpha := G] \vdash
  t[\alpha := G] : F[\alpha := G]}\rho =
  \setsem{\Gamma,\alpha;\Phi \,|\, \Delta \vdash t : F }\rho [
    \alpha := \setsem{\Gamma;\Phi\vdash G}\rho ]$
%\item $\relsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash
%  t[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho =
%  \relsem{\Gamma,\alpha;\Phi \,|\, \Delta \vdash t : \tau }\rho [
%    \alpha := \relsem{\Gamma;\Phi\vdash\sigma}\rho ]$
\item $\setsem{\Gamma;\Phi \,|\, \Delta[\alpha := G] \vdash
  t'[\alpha := G] : F[\alpha := G]}\rho =
  \setsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash t' : F }\rho [
    \alpha := \setsem{\Gamma;\Phi\vdash G}\rho ]$
%\item $\relsem{\Gamma;\Phi \,|\, \Delta[\alpha := \sigma] \vdash
%  t'[\alpha := \sigma] : \tau[\alpha := \sigma]}\rho =
%  \relsem{\Gamma;\Phi,\alpha \,|\, \Delta \vdash t' : \tau }\rho [
%    \alpha := \relsem{\Gamma;\Phi\vdash\sigma}\rho ]$
\end{itemize}
and if $\Gamma;\Phi \,|\, \Delta, x: G \vdash t : F$ and
$\Gamma;\Phi \,|\, \Delta \vdash s : G$ then
\begin{itemize}
\item $\lambda A.\, \setsem{\Gamma;\Phi \,|\, \Delta \vdash t[x := s]
  : F }\rho \, A = \lambda A.\,\setsem{\Gamma;\Phi \,|\, \Delta, x:
  G \vdash t : F}\rho \,(A, \setsem{\Gamma;\Phi \,|\,
  \Delta\vdash s: G}\rho\, A)$
%\item $\lambda R.\,\relsem{\Gamma;\Phi \,|\, \Delta \vdash t[x := s] :
%  \tau }\rho\,R = \lambda R.\,\relsem{\Gamma;\Phi \,|\, \Delta, x:
%  \sigma \vdash t : \tau}\rho \,(R, \relsem{\Gamma;\Phi \,|\,
%  \Delta\vdash s: \sigma}\rho\,R)$
\end{itemize}
Direct calculation reveals that the set interpretations of terms also
satisfy
\begin{itemize}
\item $\setsem{\Gamma; \Phi~|~\Delta \vdash
  (L_{\ol{\alpha}}x.t)_{\ol{K}}s} = \setsem{\Gamma; \Phi~|~\Delta
  \vdash t [\ol{\alpha := K}][x := s]}$
\end{itemize}
Term extensionality with respect to types and terms --- i.e.,
$\setsem{\Gamma;\Phi\vdash (L_\alpha x.t)_\alpha \top : F} =
\setsem{\Gamma;\Phi \vdash t : F}$ and $\setsem{\Gamma;\Phi\vdash
  (L_\alpha x.t)_\alpha x : F} = \setsem{\Gamma;\Phi \vdash t : F}$
%$\relsem{\Gamma;\Phi\vdash (L_\alpha x.t)_\alpha t} =
%\relsem{\Gamma;\Phi \vdash t}$, as well as
%term extensionality
%and $\relsem{\Gamma;\Phi\vdash
%  (L_\alpha x.t)_\alpha \top} = \relsem{\Gamma;\Phi \vdash t}$
--- follow (when both sides of the equations are defined). Similar
properties hold for relational interpretations.



\bibliography{references}

\end{document}
